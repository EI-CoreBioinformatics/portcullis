![alt text](doc/source/images/portcullis_logo.png "Portcullis")

Portcullis
==========

[![Version](https://img.shields.io/github/tag/maplesond/portcullis.svg)](https://github.com/maplesond/portcullis/releases)
[![Build Status](https://jenkins.sdlmapleson.net/buildStatus/icon?job=portcullis%2Fdevelop)](https://jenkins.sdlmapleson.net/job/portcullis/job/develop/)
[![License: GPL v3](https://img.shields.io/badge/License-GPL%20v3-brightgreen.svg)](https://github.com/maplesond/portcullis/blob/master/LICENSE)
[![Issues](https://img.shields.io/github/issues-raw/maplesond/portcullis.svg)](https://github.com/maplesond/portcullis/issues)

Portcullis stands for PORTable CULLing of Invalid Splice junctions from pre-aligned RNA-seq data.  It is known that RNAseq mapping tools generate many invalid junction predictions, particularly in deep datasets with high coverage over splice sites.  In order to address this, instead for creating a new RNAseq mapper, with a focus on SJ accuracy we created a tool that takes in a BAM file generated by an RNAseq mapper of the user's own choice (e.g. Tophat2, Gsnap, STAR2 or HISAT2) as input (i.e. it's portable).  It then, analyses and quantifies all splice junctions in the file before, filtering (culling) those which are unlikely to be genuine.  Portcullis output's junctions in a variety of formats making it suitable for downstream analysis (such as differential splicing analysis and gene modelling) without additional work.  Portcullis can also filter the original BAM file removing alignments associated with *bad* junctions.  Both the filtered junctions and BAM files are cleaner and more usable resources which can more effectively be used to assist in downstream analyses such as gene prediction and genome annotation.

Installation
------------

We support multiple methods for installing and running portcullis.  Hopefully your favourite container or package manager is supported below.  If not let us know and we'll try to work to get it integrated there.

**Docker**

[![Docker Pulls](https://img.shields.io/docker/pulls/maplesond/portcullis.svg)](https://hub.docker.com/r/maplesond/portcullis)  

```
# Keep in mind you need to mount in any working directories to the container with the `-v` option.
# Ideally, mount these into the /data directory which is the container's working directory.
docker run --it --rm -v /abspath/to/data/on/host:/data maplesond/portcullis:stable portcullis --help
```

**Singularity**


```
# First download the container:
singularity pull --name portcullis.img shub://maplesond/portcullis:master

# Then to execute commands in the container:
singularity exec portcullis.img portcullis --help
```

**Conda**

[![Anaconda-Server Badge](https://anaconda.org/bioconda/portcullis/badges/latest_release_date.svg)](https://anaconda.org/bioconda/portcullis)
[![Anaconda-Server Badge](https://anaconda.org/bioconda/portcullis/badges/platforms.svg)](https://anaconda.org/bioconda/portcullis)
[![Anaconda-Server Badge](https://anaconda.org/bioconda/portcullis/badges/downloads.svg)](https://anaconda.org/bioconda/portcullis)

```
conda install portcullis --channel=bioconda
```

**Brew**

```
brew install brewsci/bio/portcullis
```


**From source**

[![Downloads](https://img.shields.io/github/downloads/maplesond/portcullis/total.svg)](https://github.com/maplesond/portcullis/releases)

If you wish to install from source please first confirm that first you have these dependencies are installed and configured:

 - **GCC** V4.8+
 - **autoconf** V2.53+
 - **automake** V1.11+
 - **make**
 - **libtool** V2.4.2+
 - **zlib-dev**
 - **pthreads**
 - **boost-dev** V1.52+
 - **samtools** V1.2+
 - **Python3-dev** V3.5+ (Make sure the following packages are installed: *pandas*, *matplotlib*, *setuptools*, *sphinx*, *tabulate*)

Then proceed with the following steps:

```
# Clone the repo
git clone git@github.com:maplesond/portcullis.git

# Move into repo directory
cd portcullis

# Generate configure script
./autogen.sh

# Confirm dependencies and generate makefiles
# Adding --prefix <dir> will tell make install to put everything in a 
# particular directory.  Default is /usr/local.
./configure

# Compile (increasing -j will make it go faster!
make -j 2

# Run some unit tests (you can increase -j here too)
make -j 2 check

# Install to prefix dir
make install
```

**Common problems**

- Many system python installations do not come with the C API immediately available, which prevents Portcullis from embedding python code.  We typically would recommend installing anaconda3 as this would include the latest version of python, all required python packages as well as the C API.  If you are running a debian system and the C libraries are not available by default and you wish to use the system python installation the you can install them using: ``sudo apt-get install python-dev``.  Also, if you have installed python to a custom location please verify that the *bin* directors on the *PATH* environment variable, and the lib (or lib64) directory is on the *LD_LIBRARY_PATH* or *LD_RUN_PATH* as appropriate.

- If Portcullis is failing at the ```./autogen.sh``` step you will likely need to install autotools.  The following command should do this on MacOS: ```brew install autoconf automake libtool```.  On a debian system this can be done with: ```sudo apt-get install autoconf automake libtool```.


Quickstart
----------

After portcullis has been installed, the ```portcullis``` executable should be available.  Typing ```portcullis``` or ```portcullis --help``` at the command line will present you with the portcullis help message.

These modes are available:

 - **prep**    - Prepares input data so that it is suitable for junction analysis
 - **junc**    - Calculates junction metrics for the prepared data
 - **filter**  - Separates alignments based on whether they are likely to represent genuine splice junctions or not
 - **bamfilt** - Filters a BAM to remove any reads associated with invalid junctions
 - **full**    - Runs prep, junc, filter and optionally bamfilt as a complete pipeline

Typing ```portcullis <mode> --help``` will bring up help and usage information specific to that mode.

In addition to portcullis, we provide a tool-suite for manipulating junction files called junctools.  Typing ```junctools --help``` will provide you with the program options.

For much more information about portcullis' capabilities and how to configure and run it, an online version of the manual can be found here: [https://portcullis.readthedocs.org/en/latest/](https://portcullis.readthedocs.org/en/latest/).


Licensing
---------

GNU GPL V3.  See COPYING file for more details.


Authors
-------

 * Daniel Mapleson
 * Luca Venturini
 * David Swarbreck

See AUTHORS file for more details.


Acknowledgements
----------------

Affiliation: The Earlham Institute (EI)
Funding: The Biotechnology and Biological Sciences Research Council (BBSRC)
