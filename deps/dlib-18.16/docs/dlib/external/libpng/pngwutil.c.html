<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - pngwutil.c</title></head><body bgcolor='white'><pre>

<font color='#009900'>/* pngwutil.c - utilities to write a PNG file
 *
 * Last changed in libpng 1.6.2 [April 25, 2013]
 * Copyright (c) 1998-2013 Glenn Randers-Pehrson
 * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
 * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
 *
 * This code is released under the libpng license.
 * For conditions of distribution and use, see the disclaimer
 * and license in png.h
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pngpriv.h.html'>pngpriv.h</a>"

<font color='#0000FF'>#ifdef</font> PNG_WRITE_SUPPORTED

<font color='#0000FF'>#ifdef</font> PNG_WRITE_INT_FUNCTIONS_SUPPORTED
<font color='#009900'>/* Place a 32-bit number into a buffer in PNG byte order.  We work
 * with unsigned numbers for convenience, although one supported
 * ancillary chunk uses signed (two's complement) numbers.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_save_uint_32'></a>png_save_uint_32</b><font face='Lucida Console'>(</font>png_bytep buf, png_uint_32 i<font face='Lucida Console'>)</font>
<b>{</b>
   buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Place a 16-bit number into a buffer in PNG byte order.
 * The parameter is declared unsigned int, not png_uint_16,
 * just to avoid potential problems on pre-ANSI C compilers.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_save_uint_16'></a>png_save_uint_16</b><font face='Lucida Console'>(</font>png_bytep buf, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i<font face='Lucida Console'>)</font>
<b>{</b>
   buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Simple function to write the signature.  If we have already written
 * the magic bytes of the signature, or more likely, the PNG stream is
 * being embedded into another stream and doesn't need its own signature,
 * we should call png_set_sig_bytes() to tell libpng how many of the
 * bytes have already been written.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_write_sig'></a>png_write_sig</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte png_signature[<font color='#979000'>8</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>137</font>, <font color='#979000'>80</font>, <font color='#979000'>78</font>, <font color='#979000'>71</font>, <font color='#979000'>13</font>, <font color='#979000'>10</font>, <font color='#979000'>26</font>, <font color='#979000'>10</font><b>}</b>;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   <font color='#009900'>/* Inform the I/O callback that the signature is being written */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_WRITING <font color='#5555FF'>|</font> PNG_IO_SIGNATURE;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Write the rest of the 8 byte signature */</font>
   <font color='#BB00BB'>png_write_data</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_signature[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes],
      <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes <font color='#5555FF'>&lt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_PNG_SIGNATURE;
<b>}</b>

<font color='#009900'>/* Write the start of a PNG chunk.  The type is the chunk type.
 * The total_length is the sum of the lengths of all the data you will be
 * passing in png_write_chunk_data().
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_write_chunk_header'></a>png_write_chunk_header</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 chunk_name,
    png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>8</font>];

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_DEBUG<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_DEBUG <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <font color='#BB00BB'>PNG_CSTRING_FROM_CHUNK</font><font face='Lucida Console'>(</font>buf, chunk_name<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug2</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, "<font color='#CC0000'>Writing %s chunk, length = %lu</font>", buf, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   <font color='#009900'>/* Inform the I/O callback that the chunk header is being written.
    * PNG_IO_CHUNK_HDR requires a single I/O call.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_WRITING <font color='#5555FF'>|</font> PNG_IO_CHUNK_HDR;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Write the length and the chunk name */</font>
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf, length<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, chunk_name<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>8</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Put the chunk name into png_ptr-&gt;chunk_name */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name <font color='#5555FF'>=</font> chunk_name;

   <font color='#009900'>/* Reset the crc and run it over the chunk name */</font>
   <font color='#BB00BB'>png_reset_crc</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_calculate_crc</font><font face='Lucida Console'>(</font>png_ptr, buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, <font color='#979000'>4</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   <font color='#009900'>/* Inform the I/O callback that chunk data will (possibly) be written.
    * PNG_IO_CHUNK_DATA does NOT require a specific number of I/O calls.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_WRITING <font color='#5555FF'>|</font> PNG_IO_CHUNK_DATA;
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_write_chunk_start'></a>png_write_chunk_start</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep chunk_string,
    png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>PNG_CHUNK_FROM_STRING</font><font face='Lucida Console'>(</font>chunk_string<font face='Lucida Console'>)</font>, length<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Write the data of a PNG chunk started with png_write_chunk_header().
 * Note that multiple calls to this function are allowed, and that the
 * sum of the lengths from these calls *must* add up to the total_length
 * given to png_write_chunk_header().
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_write_chunk_data'></a>png_write_chunk_data</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep data,
    png_size_t length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Write the data, and run the CRC over it */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>data <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_write_data</font><font face='Lucida Console'>(</font>png_ptr, data, length<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Update the CRC after writing the data,
       * in case that the user I/O routine alters it.
       */</font>
      <font color='#BB00BB'>png_calculate_crc</font><font face='Lucida Console'>(</font>png_ptr, data, length<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Finish a chunk started with png_write_chunk_header(). */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_write_chunk_end'></a>png_write_chunk_end</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>4</font>];

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font>;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   <font color='#009900'>/* Inform the I/O callback that the chunk CRC is being written.
    * PNG_IO_CHUNK_CRC requires a single I/O function call.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_WRITING <font color='#5555FF'>|</font> PNG_IO_CHUNK_CRC;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Write the crc in a single operation */</font>
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>crc<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>4</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Write a PNG chunk all at once.  The type is an array of ASCII characters
 * representing the chunk name.  The array must be at least 4 bytes in
 * length, and does not need to be null terminated.  To be safe, pass the
 * pre-defined chunk names here, and if you need a new one, define it
 * where the others are defined.  The length is the length of the data.
 * All the data must be present.  If that is not possible, use the
 * png_write_chunk_start(), png_write_chunk_data(), and png_write_chunk_end()
 * functions instead.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_write_complete_chunk'></a>png_write_complete_chunk</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 chunk_name,
   png_const_bytep data, png_size_t length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* On 64 bit architectures 'length' may not fit in a png_uint_32. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>length exceeds PNG maxima</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, chunk_name, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>length<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, data, length<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* This is the API that calls the internal function above. */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_write_chunk'></a>png_write_chunk</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep chunk_string,
   png_const_bytep data, png_size_t length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>PNG_CHUNK_FROM_STRING</font><font face='Lucida Console'>(</font>chunk_string<font face='Lucida Console'>)</font>, data,
      length<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* This is used below to find the size of an image to pass to png_deflate_claim,
 * so it only needs to be accurate if the size is less than 16384 bytes (the
 * point at which a lower LZ window size can be used.)
 */</font>
<font color='#0000FF'>static</font> png_alloc_size_t
<b><a name='png_image_size'></a>png_image_size</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Only return sizes up to the maximum of a png_uint_32, do this by limiting
    * the width and height used to 15 bits.
    */</font>
   png_uint_32 h <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>&lt;</font> <font color='#979000'>32768</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> h <font color='#5555FF'>&lt;</font> <font color='#979000'>32768</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Interlacing makes the image larger because of the replication of
          * both the filter byte and the padding to a byte boundary.
          */</font>
         png_uint_32 w <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> pd <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth;
         png_alloc_size_t cb_base;
         <font color='#0000FF'><u>int</u></font> pass;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>cb_base<font color='#5555FF'>=</font><font color='#979000'>0</font>, pass<font color='#5555FF'>=</font><font color='#979000'>0</font>; pass<font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font><font color='#979000'>6</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pass<font face='Lucida Console'>)</font>
         <b>{</b>
            png_uint_32 pw <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_COLS</font><font face='Lucida Console'>(</font>w, pass<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pw <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               cb_base <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>pd, pw<font face='Lucida Console'>)</font><font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#BB00BB'>PNG_PASS_ROWS</font><font face='Lucida Console'>(</font>h, pass<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>return</font> cb_base;
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> h;
   <b>}</b>

   <font color='#0000FF'>else</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0xffffffffU</font>;
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_OPTIMIZE_CMF_SUPPORTED
   <font color='#009900'>/* This is the code to hack the first two bytes of the deflate stream (the
    * deflate header) to correct the windowBits value to match the actual data
    * size.  Note that the second argument is the *uncompressed* size but the
    * first argument is the *compressed* data (and it must be deflate
    * compressed.)
    */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='optimize_cmf'></a>optimize_cmf</b><font face='Lucida Console'>(</font>png_bytep data, png_alloc_size_t data_size<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Optimize the CMF field in the zlib stream.  The resultant zlib stream is
    * still compliant to the stream specification.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>data_size <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>16384</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else windowBits must be 15 */</font>
   <b>{</b>
      <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> z_cmf <font color='#5555FF'>=</font> data[<font color='#979000'>0</font>];  <font color='#009900'>/* zlib compression method and flags */</font>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>z_cmf <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>z_cmf <font color='#5555FF'>&amp;</font> <font color='#979000'>0xf0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0x70</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> z_cinfo;
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> half_z_window_size;

         z_cinfo <font color='#5555FF'>=</font> z_cmf <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>4</font>;
         half_z_window_size <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>z_cinfo <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>data_size <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> half_z_window_size<font face='Lucida Console'>)</font> <font color='#009900'>/* else no change */</font>
         <b>{</b>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp;

            <font color='#0000FF'>do</font>
            <b>{</b>
               half_z_window_size <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <font color='#5555FF'>-</font><font color='#5555FF'>-</font>z_cinfo;
            <b>}</b>
            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>z_cinfo <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> data_size <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> half_z_window_size<font face='Lucida Console'>)</font>;

            z_cmf <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>z_cmf <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>z_cinfo <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;

            data[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>z_cmf;
            tmp <font color='#5555FF'>=</font> data[<font color='#979000'>1</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0xe0</font>;
            tmp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>0x1f</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>z_cmf <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> tmp<font face='Lucida Console'>)</font> <font color='#5555FF'>%</font> <font color='#979000'>0x1f</font>;
            data[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>tmp;
         <b>}</b>
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#else</font>
#  define <b><a name='optimize_cmf'></a>optimize_cmf</b><font face='Lucida Console'>(</font>dp,dl<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_WRITE_OPTIMIZE_CMF_SUPPORTED */</font>

<font color='#009900'>/* Initialize the compressor for the appropriate type of compression. */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_deflate_claim'></a>png_deflate_claim</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 owner,
   png_alloc_size_t data_size<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>char</u></font> msg[<font color='#979000'>64</font>];

      <font color='#BB00BB'>PNG_STRING_FROM_CHUNK</font><font face='Lucida Console'>(</font>msg, owner<font face='Lucida Console'>)</font>;
      msg[<font color='#979000'>4</font>] <font color='#5555FF'>=</font> '<font color='#FF0000'>:</font>';
      msg[<font color='#979000'>5</font>] <font color='#5555FF'>=</font> '<font color='#FF0000'> </font>';
      <font color='#BB00BB'>PNG_STRING_FROM_CHUNK</font><font face='Lucida Console'>(</font>msg<font color='#5555FF'>+</font><font color='#979000'>6</font>, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* So the message that results is "&lt;chunk&gt; using zstream"; this is an
       * internal error, but is very useful for debugging.  i18n requirements
       * are minimal.
       */</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>msg, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> msg<font face='Lucida Console'>)</font>, <font color='#979000'>10</font>, "<font color='#CC0000'> using zstream</font>"<font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>if</font> PNG_LIBPNG_BUILD_BASE_TYPE <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_LIBPNG_BUILD_RC
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, msg<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Attempt sane error recovery */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font> <font color='#009900'>/* don't steal from IDAT */</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>in use by IDAT</font>"<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> Z_STREAM_ERROR;
         <b>}</b>

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, msg<font face='Lucida Console'>)</font>;
#     endif
   <b>}</b>

   <b>{</b>
      <font color='#0000FF'><u>int</u></font> level <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_level;
      <font color='#0000FF'><u>int</u></font> method <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_method;
      <font color='#0000FF'><u>int</u></font> windowBits <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_window_bits;
      <font color='#0000FF'><u>int</u></font> memLevel <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_mem_level;
      <font color='#0000FF'><u>int</u></font> strategy; <font color='#009900'>/* set below */</font>
      <font color='#0000FF'><u>int</u></font> ret; <font color='#009900'>/* zlib return code */</font>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>owner <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ZLIB_CUSTOM_STRATEGY<font face='Lucida Console'>)</font>
            strategy <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_strategy;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_FILTER_NONE<font face='Lucida Console'>)</font>
            strategy <font color='#5555FF'>=</font> PNG_Z_DEFAULT_STRATEGY;

         <font color='#0000FF'>else</font>
            strategy <font color='#5555FF'>=</font> PNG_Z_DEFAULT_NOFILTER_STRATEGY;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
#        ifdef PNG_WRITE_CUSTOMIZE_ZTXT_COMPRESSION_SUPPORTED
            level <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_text_level;
            method <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_text_method;
            windowBits <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_text_window_bits;
            memLevel <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_text_mem_level;
            strategy <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_text_strategy;
#        <font color='#0000FF'>else</font>
            <font color='#009900'>/* If customization is not supported the values all come from the
             * IDAT values except for the strategy, which is fixed to the
             * default.  (This is the pre-1.6.0 behavior too, although it was
             * implemented in a very different way.)
             */</font>
            strategy <font color='#5555FF'>=</font> Z_DEFAULT_STRATEGY;
#        endif
      <b>}</b>

      <font color='#009900'>/* Adjust 'windowBits' down if larger than 'data_size'; to stop this
       * happening just pass 32768 as the data_size parameter.  Notice that zlib
       * requires an extra 262 bytes in the window in addition to the data to be
       * able to see the whole of the data, so if data_size+262 takes us to the
       * next windowBits size we need to fix up the value later.  (Because even
       * though deflate needs the extra window, inflate does not!)
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>data_size <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>16384</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* IMPLEMENTATION NOTE: this 'half_window_size' stuff is only here to
          * work round a Microsoft Visual C misbehavior which, contrary to C-90,
          * widens the result of the following shift to 64-bits if (and,
          * apparently, only if) it is used in a test.
          */</font>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> half_window_size <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>windowBits<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>data_size <font color='#5555FF'>+</font> <font color='#979000'>262</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> half_window_size<font face='Lucida Console'>)</font>
         <b>{</b>
            half_window_size <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            <font color='#5555FF'>-</font><font color='#5555FF'>-</font>windowBits;
         <b>}</b>
      <b>}</b>

      <font color='#009900'>/* Check against the previous initialized values, if any. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ZSTREAM_INITIALIZED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_set_level <font color='#5555FF'>!</font><font color='#5555FF'>=</font> level <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_set_method <font color='#5555FF'>!</font><font color='#5555FF'>=</font> method <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_set_window_bits <font color='#5555FF'>!</font><font color='#5555FF'>=</font> windowBits <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_set_mem_level <font color='#5555FF'>!</font><font color='#5555FF'>=</font> memLevel <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zlib_set_strategy <font color='#5555FF'>!</font><font color='#5555FF'>=</font> strategy<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>deflateEnd</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>deflateEnd failed (ignored)</font>"<font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_ZSTREAM_INITIALIZED;
      <b>}</b>

      <font color='#009900'>/* For safety clear out the input and output pointers (currently zlib
       * doesn't use them on Init, but it might in the future).
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* Now initialize if required, setting the new parameters, otherwise just
       * to a simple reset to the previous parameters.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ZSTREAM_INITIALIZED<font face='Lucida Console'>)</font>
         ret <font color='#5555FF'>=</font> <font color='#BB00BB'>deflateReset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font>
      <b>{</b>
         ret <font color='#5555FF'>=</font> <font color='#BB00BB'>deflateInit2</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream, level, method, windowBits,
            memLevel, strategy<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_ZSTREAM_INITIALIZED;
      <b>}</b>

      <font color='#009900'>/* The return code is from either deflateReset or deflateInit2; they have
       * pretty much the same set of error codes.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> owner;

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font> ret;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Clean up (or trim) a linked list of compression buffers. */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_free_buffer_list'></a>png_free_buffer_list</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_compression_bufferp <font color='#5555FF'>*</font>listp<font face='Lucida Console'>)</font>
<b>{</b>
   png_compression_bufferp list <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>listp;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>list <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>listp <font color='#5555FF'>=</font> NULL;

      <font color='#0000FF'>do</font>
      <b>{</b>
         png_compression_bufferp next <font color='#5555FF'>=</font> list<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next;

         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, list<font face='Lucida Console'>)</font>;
         list <font color='#5555FF'>=</font> next;
      <b>}</b>
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>list <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_COMPRESSED_TEXT_SUPPORTED
<font color='#009900'>/* This pair of functions encapsulates the operation of (a) compressing a
 * text string, and (b) issuing it later as a series of chunk data writes.
 * The compression_state structure is shared context for these functions
 * set up by the caller to allow access to the relevant local variables.
 *
 * compression_buffer (new in 1.6.0) is just a linked list of zbuffer_size
 * temporary buffers.  From 1.6.0 it is retained in png_struct so that it will
 * be correctly freed in the event of a write error (previous implementations
 * just leaked memory.)
 */</font>
<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font>
<b>{</b>
   png_const_bytep      input;        <font color='#009900'>/* The uncompressed input data */</font>
   png_alloc_size_t     input_len;    <font color='#009900'>/* Its length */</font>
   png_uint_32          output_len;   <font color='#009900'>/* Final compressed length */</font>
   png_byte             output[<font color='#979000'>1024</font>]; <font color='#009900'>/* First block of output */</font>
<b>}</b> compression_state;

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_text_compress_init'></a>png_text_compress_init</b><font face='Lucida Console'>(</font>compression_state <font color='#5555FF'>*</font>comp, png_const_bytep input,
   png_alloc_size_t input_len<font face='Lucida Console'>)</font>
<b>{</b>
   comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input <font color='#5555FF'>=</font> input;
   comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_len <font color='#5555FF'>=</font> input_len;
   comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output_len <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#009900'>/* Compress the data in the compression state input */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_text_compress'></a>png_text_compress</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 chunk_name,
   compression_state <font color='#5555FF'>*</font>comp, png_uint_32 prefix_len<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> ret;

   <font color='#009900'>/* To find the length of the output it is necessary to first compress the
    * input, the result is buffered rather than using the two-pass algorithm
    * that is used on the inflate side; deflate is assumed to be slower and a
    * PNG writer is assumed to have more memory available than a PNG reader.
    *
    * IMPLEMENTATION NOTE: the zlib API deflateBound() can be used to find an
    * upper limit on the output size, but it is always bigger than the input
    * size so it is likely to be more efficient to use this linked-list
    * approach.
    */</font>
   ret <font color='#5555FF'>=</font> <font color='#BB00BB'>png_deflate_claim</font><font face='Lucida Console'>(</font>png_ptr, chunk_name, comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_len<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> ret;

   <font color='#009900'>/* Set up the compression buffers, we need a loop here to avoid overflowing a
    * uInt.  Use ZLIB_IO_MAX to limit the input.  The output is always limited
    * by the output buffer size, so there is no need to check that.  Since this
    * is ANSI-C we know that an 'int', hence a uInt, is always at least 16 bits
    * in size.
    */</font>
   <b>{</b>
      png_compression_bufferp <font color='#5555FF'>*</font>end <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list;
      png_alloc_size_t input_len <font color='#5555FF'>=</font> comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_len; <font color='#009900'>/* may be zero! */</font>
      png_uint_32 output_len;

      <font color='#009900'>/* zlib updates these for us: */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_INPUT_CAST</font><font face='Lucida Console'>(</font>comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input<font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* Set below */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output<font face='Lucida Console'>)</font>;

      output_len <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;

      <font color='#0000FF'>do</font>
      <b>{</b>
         uInt avail_in <font color='#5555FF'>=</font> ZLIB_IO_MAX;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_in <font color='#5555FF'>&gt;</font> input_len<font face='Lucida Console'>)</font>
            avail_in <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>input_len;

         input_len <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail_in;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> avail_in;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_compression_buffer <font color='#5555FF'>*</font>next;

            <font color='#009900'>/* Chunk data is limited to 2^31 bytes in length, so the prefix
             * length must be counted here.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_len <font color='#5555FF'>+</font> prefix_len <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
            <b>{</b>
               ret <font color='#5555FF'>=</font> Z_MEM_ERROR;
               <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#009900'>/* Need a new (malloc'ed) buffer, but there may be one present
             * already.
             */</font>
            next <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>end;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>next <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <b>{</b>
               next <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_compression_bufferp, <font color='#BB00BB'>png_malloc_base</font>
                  <font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>PNG_COMPRESSION_BUFFER_SIZE</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>next <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  ret <font color='#5555FF'>=</font> Z_MEM_ERROR;
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#009900'>/* Link in this buffer (so that it will be freed later) */</font>
               next<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next <font color='#5555FF'>=</font> NULL;
               <font color='#5555FF'>*</font>end <font color='#5555FF'>=</font> next;
            <b>}</b>

            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> next<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_size;
            output_len <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;

            <font color='#009900'>/* Move 'end' to the next buffer pointer. */</font>
            end <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>next<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next;
         <b>}</b>

         <font color='#009900'>/* Compress the data */</font>
         ret <font color='#5555FF'>=</font> <font color='#BB00BB'>deflate</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream,
            input_len <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? Z_NO_FLUSH : Z_FINISH<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Claw back input data that was not consumed (because avail_in is
          * reset above every time round the loop).
          */</font>
         input_len <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* safety */</font>
      <b>}</b>
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* There may be some space left in the last output buffer, this needs to
       * be subtracted from output_len.
       */</font>
      output_len <font color='#5555FF'>-</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* safety */</font>
      comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output_len <font color='#5555FF'>=</font> output_len;

      <font color='#009900'>/* Now double check the output length, put in a custom message if it is
       * too long.  Otherwise ensure the z_stream::msg pointer is set to
       * something.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_len <font color='#5555FF'>+</font> prefix_len <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>compressed data too long</font>"<font face='Lucida Console'>)</font>;
         ret <font color='#5555FF'>=</font> Z_MEM_ERROR;
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Reset zlib for another zTXt/iTXt or image data */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* The only success case is Z_STREAM_END, input_len must be 0, if not this
       * is an internal error.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> input_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Fix up the deflate header, if required */</font>
         <font color='#BB00BB'>optimize_cmf</font><font face='Lucida Console'>(</font>comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output, comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>input_len<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* But Z_OK is returned, not Z_STREAM_END; this allows the claim
          * function above to return Z_STREAM_END on an error (though it never
          * does in the current versions of zlib.)
          */</font>
         <font color='#0000FF'>return</font> Z_OK;
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> ret;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Ship the compressed text out via chunk writes */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_write_compressed_data_out'></a>png_write_compressed_data_out</b><font face='Lucida Console'>(</font>png_structrp png_ptr, compression_state <font color='#5555FF'>*</font>comp<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 output_len <font color='#5555FF'>=</font> comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output_len;
   png_const_bytep output <font color='#5555FF'>=</font> comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
   png_uint_32 avail <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> comp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output<font face='Lucida Console'>)</font>;
   png_compression_buffer <font color='#5555FF'>*</font>next <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail <font color='#5555FF'>&gt;</font> output_len<font face='Lucida Console'>)</font>
         avail <font color='#5555FF'>=</font> output_len;

      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, output, avail<font face='Lucida Console'>)</font>;

      output_len <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> next <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#0000FF'>break</font>;

      avail <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_size;
      output <font color='#5555FF'>=</font> next<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
      next <font color='#5555FF'>=</font> next<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next;
   <b>}</b>

   <font color='#009900'>/* This is an internal error; 'next' must have been NULL! */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_len <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>error writing ancillary chunked compressed data</font>"<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_WRITE_COMPRESSED_TEXT_SUPPORTED */</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_TEXT_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_pCAL_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
    <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>PNG_WRITE_iCCP_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>PNG_WRITE_sPLT_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* Check that the tEXt or zTXt keyword is valid per PNG 1.0 specification,
 * and if invalid, correct the keyword rather than discarding the entire
 * chunk.  The PNG 1.0 specification requires keywords 1-79 characters in
 * length, forbids leading or trailing whitespace, multiple internal spaces,
 * and the non-break space (0x80) from ISO 8859-1.  Returns keyword length.
 *
 * The 'new_key' buffer must be 80 characters in size (for the keyword plus a
 * trailing '\0').  If this routine returns 0 then there was no keyword, or a
 * valid one could not be generated, and the caller must png_error.
 */</font>
<font color='#0000FF'>static</font> png_uint_32
<b><a name='png_check_keyword'></a>png_check_keyword</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_charp key, png_bytep new_key<font face='Lucida Console'>)</font>
<b>{</b>
   png_const_charp orig_key <font color='#5555FF'>=</font> key;
   png_uint_32 key_len <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>int</u></font> bad_character <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>int</u></font> space <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_check_keyword</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>new_key <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>key <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> key_len <font color='#5555FF'>&lt;</font> <font color='#979000'>79</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte ch <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>0xff</font> <font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font>key<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ch <font color='#5555FF'>&gt;</font> <font color='#979000'>32</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>126</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>161</font> <font color='#009900'>/*&amp;&amp; ch &lt;= 255*/</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#5555FF'>*</font>new_key<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> ch, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len, space <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>space<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* A space or an invalid character when one wasn't seen immediately
          * before; output just a space.
          */</font>
         <font color='#5555FF'>*</font>new_key<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>32</font>, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len, space <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

         <font color='#009900'>/* If the character was not a space then it is invalid. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>32</font><font face='Lucida Console'>)</font>
            bad_character <font color='#5555FF'>=</font> ch;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>bad_character<font face='Lucida Console'>)</font>
         bad_character <font color='#5555FF'>=</font> ch; <font color='#009900'>/* just skip it, record the first error */</font>
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key_len <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> space<font face='Lucida Console'>)</font> <font color='#009900'>/* trailing space */</font>
   <b>{</b>
      <font color='#5555FF'>-</font><font color='#5555FF'>-</font>key_len, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>new_key;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>bad_character<font face='Lucida Console'>)</font>
         bad_character <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
   <b>}</b>

   <font color='#009900'>/* Terminate the keyword */</font>
   <font color='#5555FF'>*</font>new_key <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* Try to only output one warning per keyword: */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>key<font face='Lucida Console'>)</font> <font color='#009900'>/* keyword too long */</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>keyword truncated</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bad_character<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>PNG_WARNING_PARAMETERS</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>

      <font color='#BB00BB'>png_warning_parameter</font><font face='Lucida Console'>(</font>p, <font color='#979000'>1</font>, orig_key<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_warning_parameter_signed</font><font face='Lucida Console'>(</font>p, <font color='#979000'>2</font>, PNG_NUMBER_FORMAT_02x, bad_character<font face='Lucida Console'>)</font>;

      <font color='#BB00BB'>png_formatted_warning</font><font face='Lucida Console'>(</font>png_ptr, p, "<font color='#CC0000'>keyword \"@1\": bad character '0x@2'</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> key_len;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Write the IHDR chunk, and update the png_struct with the necessary
 * information.  Note that the rest of this code depends upon this
 * information being correct.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_IHDR'></a>png_write_IHDR</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 width, png_uint_32 height,
    <font color='#0000FF'><u>int</u></font> bit_depth, <font color='#0000FF'><u>int</u></font> color_type, <font color='#0000FF'><u>int</u></font> compression_type, <font color='#0000FF'><u>int</u></font> filter_type,
    <font color='#0000FF'><u>int</u></font> interlace_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>13</font>]; <font color='#009900'>/* Buffer to store the IHDR info */</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Check that we have valid input data from the application info */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>color_type<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY:
         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>bit_depth<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
            <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
            <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
<font color='#0000FF'>#ifdef</font> PNG_WRITE_16BIT_SUPPORTED
            <font color='#0000FF'>case</font> <font color='#979000'>16</font>:
<font color='#0000FF'>#endif</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>; <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>:
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr,
                   "<font color='#CC0000'>Invalid bit depth for grayscale image</font>"<font face='Lucida Console'>)</font>;
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB:
<font color='#0000FF'>#ifdef</font> PNG_WRITE_16BIT_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid bit depth for RGB image</font>"<font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_PALETTE:
         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>bit_depth<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
            <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
            <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>:
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid bit depth for paletted image</font>"<font face='Lucida Console'>)</font>;
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY_ALPHA:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid bit depth for grayscale+alpha image</font>"<font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB_ALPHA:
<font color='#0000FF'>#ifdef</font> PNG_WRITE_16BIT_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid bit depth for RGBA image</font>"<font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid image color type specified</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compression_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid compression type specified</font>"<font face='Lucida Console'>)</font>;
      compression_type <font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE;
   <b>}</b>

   <font color='#009900'>/* Write filter_method 64 (intrapixel differencing) only if
    * 1. Libpng was compiled with PNG_MNG_FEATURES_SUPPORTED and
    * 2. Libpng did not write a PNG signature (this filter_method is only
    *    used in PNG datastreams that are embedded in MNG datastreams) and
    * 3. The application called png_permit_mng_features with a mask that
    *    included PNG_FLAG_MNG_FILTER_64 and
    * 4. The filter_method is 64 and
    * 5. The color_type is RGB or RGBA
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>
<font color='#0000FF'>#ifdef</font> PNG_MNG_FEATURES_SUPPORTED
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mng_features_permitted <font color='#5555FF'>&amp;</font> PNG_FLAG_MNG_FILTER_64<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode<font color='#5555FF'>&amp;</font>PNG_HAVE_PNG_SIGNATURE<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>filter_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTRAPIXEL_DIFFERENCING<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
<font color='#0000FF'>#endif</font>
       filter_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_FILTER_TYPE_BASE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid filter type specified</font>"<font face='Lucida Console'>)</font>;
      filter_type <font color='#5555FF'>=</font> PNG_FILTER_TYPE_BASE;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_INTERLACING_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>interlace_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_INTERLACE_NONE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       interlace_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid interlace type specified</font>"<font face='Lucida Console'>)</font>;
      interlace_type <font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7;
   <b>}</b>
<font color='#0000FF'>#else</font>
   interlace_type<font color='#5555FF'>=</font>PNG_INTERLACE_NONE;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Save the relevent information */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>bit_depth;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>color_type;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>interlace_type;
<font color='#0000FF'>#ifdef</font> PNG_MNG_FEATURES_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>filter_type;
<font color='#0000FF'>#endif</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>compression_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>compression_type;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>=</font> width;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>=</font> height;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, width<font face='Lucida Console'>)</font>;
   <font color='#009900'>/* Set the usr info, so any transformations can modify it */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_width <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_bit_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_channels <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels;

   <font color='#009900'>/* Pack the header information into the buffer */</font>
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf, width<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, height<font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>8</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>bit_depth;
   buf[<font color='#979000'>9</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>color_type;
   buf[<font color='#979000'>10</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>compression_type;
   buf[<font color='#979000'>11</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>filter_type;
   buf[<font color='#979000'>12</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>interlace_type;

   <font color='#009900'>/* Write the chunk */</font>
   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_IHDR, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>13</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>=</font> PNG_FILTER_NONE;

      <font color='#0000FF'>else</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>=</font> PNG_ALL_FILTERS;
   <b>}</b>

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>=</font> PNG_HAVE_IHDR; <font color='#009900'>/* not READY_FOR_ZTXT */</font>
<b>}</b>

<font color='#009900'>/* Write the palette.  We are careful not to trust png_color to be in the
 * correct order for PNG, so people can redefine it to any convenient
 * structure.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_PLTE'></a>png_write_PLTE</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_colorp palette,
    png_uint_32 num_pal<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 i;
   png_const_colorp pal_ptr;
   png_byte buf[<font color='#979000'>3</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_PLTE</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>
<font color='#0000FF'>#ifdef</font> PNG_MNG_FEATURES_SUPPORTED
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mng_features_permitted <font color='#5555FF'>&amp;</font> PNG_FLAG_MNG_EMPTY_PLTE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
<font color='#0000FF'>#endif</font>
       num_pal <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> num_pal <font color='#5555FF'>&gt;</font> <font color='#979000'>256</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid number of colors in palette</font>"<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid number of colors in palette</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font color='#5555FF'>&amp;</font>PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr,
          "<font color='#CC0000'>Ignoring request to write a PLTE chunk in grayscale PNG</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font>;
   <b>}</b>

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>num_pal;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>num_palette = %d</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_PLTE, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_pal <font color='#5555FF'>*</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> PNG_POINTER_INDEXING_SUPPORTED

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, pal_ptr <font color='#5555FF'>=</font> palette; i <font color='#5555FF'>&lt;</font> num_pal; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, pal_ptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> pal_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red;
      buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> pal_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
      buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> pal_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue;
      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>3</font><font face='Lucida Console'>)</font>;
   <b>}</b>

<font color='#0000FF'>#else</font>
   <font color='#009900'>/* This is a little slower but some buggy compilers need to do this
    * instead
    */</font>
   pal_ptr<font color='#5555FF'>=</font>palette;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_pal; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> pal_ptr[i].red;
      buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> pal_ptr[i].green;
      buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> pal_ptr[i].blue;
      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>3</font><font face='Lucida Console'>)</font>;
   <b>}</b>

<font color='#0000FF'>#endif</font>
   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_PLTE;
<b>}</b>

<font color='#009900'>/* This is similar to png_text_compress, above, except that it does not require
 * all of the data at once and, instead of buffering the compressed result,
 * writes it as IDAT chunks.  Unlike png_text_compress it *can* png_error out
 * because it calls the write interface.  As a result it does its own error
 * reporting and does not return an error code.  In the event of error it will
 * just call png_error.  The input data length may exceed 32-bits.  The 'flush'
 * parameter is exactly the same as that to deflate, with the following
 * meanings:
 *
 * Z_NO_FLUSH: normal incremental output of compressed data
 * Z_SYNC_FLUSH: do a SYNC_FLUSH, used by png_write_flush
 * Z_FINISH: this is the end of the input, do a Z_FINISH and clean up
 *
 * The routine manages the acquire and release of the png_ptr-&gt;zstream by
 * checking and (at the end) clearing png_ptr-&gt;zowner, it does some sanity
 * checks on the 'mode' flags while doing this.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_compress_IDAT'></a>png_compress_IDAT</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep input,
   png_alloc_size_t input_len, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* First time.   Ensure we have a temporary buffer for compression and
       * trim the buffer list if it has more than one entry to free memory.
       * If 'WRITE_COMPRESSED_TEXT' is not set the list will never have been
       * created at this point, but the check here is quick and safe.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_compression_bufferp,
            <font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>PNG_COMPRESSION_BUFFER_SIZE</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next <font color='#5555FF'>=</font> NULL;
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_free_buffer_list</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* It is a terminal error if we can't claim the zstream. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_deflate_claim</font><font face='Lucida Console'>(</font>png_ptr, png_IDAT, <font color='#BB00BB'>png_image_size</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* The output state is maintained in png_ptr-&gt;zstream, so it must be
       * initialized here after the claim.
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_size;
   <b>}</b>

   <font color='#009900'>/* Now loop reading and writing until all the input is consumed or an error
    * terminates the operation.  The _out values are maintained across calls to
    * this function, but the input must be reset each time.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_INPUT_CAST</font><font face='Lucida Console'>(</font>input<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* set below */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> ret;

      <font color='#009900'>/* INPUT: from the row data */</font>
      uInt avail <font color='#5555FF'>=</font> ZLIB_IO_MAX;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail <font color='#5555FF'>&gt;</font> input_len<font face='Lucida Console'>)</font>
         avail <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>input_len; <font color='#009900'>/* safe because of the check */</font>

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> avail;
      input_len <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail;

      ret <font color='#5555FF'>=</font> <font color='#BB00BB'>deflate</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream, input_len <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? Z_NO_FLUSH : flush<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Include as-yet unconsumed input */</font>
      input_len <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* OUTPUT: write complete IDAT chunks when avail_out drops to zero, note
       * that these two zstream fields are preserved across the calls, therefore
       * there is no need to set these up on entry to the loop.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_bytep data <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
         uInt size <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_size;

         <font color='#009900'>/* Write an IDAT containing the data then reset the buffer.  The
          * first IDAT may need deflate header optimization.
          */</font>
#        ifdef PNG_WRITE_OPTIMIZE_CMF_SUPPORTED
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>compression_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>optimize_cmf</font><font face='Lucida Console'>(</font>data, <font color='#BB00BB'>png_image_size</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
#        endif

         <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_IDAT, data, size<font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_IDAT;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> data;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> size;

         <font color='#009900'>/* For SYNC_FLUSH or FINISH it is essential to keep calling zlib with
          * the same flush parameter until it has finished output, for NO_FLUSH
          * it doesn't matter.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NO_FLUSH<font face='Lucida Console'>)</font>
            <font color='#0000FF'>continue</font>;
      <b>}</b>

      <font color='#009900'>/* The order of these checks doesn't matter much; it just effect which
       * possible error might be detected if multiple things go wrong at once.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font> <font color='#009900'>/* most likely return code! */</font>
      <b>{</b>
         <font color='#009900'>/* If all the input has been consumed then just return.  If Z_FINISH
          * was used as the flush parameter something has gone wrong if we get
          * here.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>input_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Z_OK on Z_FINISH with output space</font>"<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>return</font>;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This is the end of the IDAT data; any pending output must be
          * flushed.  For small PNG files we may still be at the beginning.
          */</font>
         png_bytep data <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_list<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>output;
         uInt size <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zbuffer_size <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;

#        ifdef PNG_WRITE_OPTIMIZE_CMF_SUPPORTED
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>compression_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>optimize_cmf</font><font face='Lucida Console'>(</font>data, <font color='#BB00BB'>png_image_size</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
#        endif

         <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_IDAT, data, size<font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> NULL;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_IDAT <font color='#5555FF'>|</font> PNG_AFTER_IDAT;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* Release the stream */</font>
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* This is an error condition. */</font>
         <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Write an IEND chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_IEND'></a>png_write_IEND</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_IEND</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_IEND, NULL, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_IEND;
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_gAMA_SUPPORTED
<font color='#009900'>/* Write a gAMA chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_gAMA_fixed'></a>png_write_gAMA_fixed</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_fixed_point file_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>4</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_gAMA</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* file_gamma is saved in 1/100,000ths */</font>
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>file_gamma<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_gAMA, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>4</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_sRGB_SUPPORTED
<font color='#009900'>/* Write a sRGB chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_sRGB'></a>png_write_sRGB</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> srgb_intent<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>1</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_sRGB</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>srgb_intent <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_sRGB_INTENT_LAST<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr,
          "<font color='#CC0000'>Invalid sRGB rendering intent specified</font>"<font face='Lucida Console'>)</font>;

   buf[<font color='#979000'>0</font>]<font color='#5555FF'>=</font><font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>srgb_intent;
   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_sRGB, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_iCCP_SUPPORTED
<font color='#009900'>/* Write an iCCP chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_iCCP'></a>png_write_iCCP</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_charp name,
    png_const_bytep profile<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 name_len;
   png_uint_32 profile_len;
   png_byte new_name[<font color='#979000'>81</font>]; <font color='#009900'>/* 1 byte for the compression byte */</font>
   compression_state comp;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_iCCP</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* These are all internal problems: the profile should have been checked
    * before when it was stored.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>No profile for iCCP chunk</font>"<font face='Lucida Console'>)</font>; <font color='#009900'>/* internal error */</font>

   profile_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile_len <font color='#5555FF'>&lt;</font> <font color='#979000'>132</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>ICC profile too short</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile_len <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>ICC profile length invalid (not a multiple of 4)</font>"<font face='Lucida Console'>)</font>;

   <b>{</b>
      png_uint_32 embedded_profile_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile_len <font color='#5555FF'>!</font><font color='#5555FF'>=</font> embedded_profile_len<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Profile length does not match profile</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   name_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_check_keyword</font><font face='Lucida Console'>(</font>png_ptr, name, new_name<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>name_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>iCCP: invalid keyword</font>"<font face='Lucida Console'>)</font>;

   new_name[<font color='#5555FF'>+</font><font color='#5555FF'>+</font>name_len] <font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE;

   <font color='#009900'>/* Make sure we include the NULL after the name and the compression type */</font>
   <font color='#5555FF'>+</font><font color='#5555FF'>+</font>name_len;

   <font color='#BB00BB'>png_text_compress_init</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>comp, profile, profile_len<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Allow for keyword terminator and compression byte */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_text_compress</font><font face='Lucida Console'>(</font>png_ptr, png_iCCP, <font color='#5555FF'>&amp;</font>comp, name_len<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_iCCP, name_len <font color='#5555FF'>+</font> comp.output_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, new_name, name_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_compressed_data_out</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>comp<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_sPLT_SUPPORTED
<font color='#009900'>/* Write a sPLT chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_sPLT'></a>png_write_sPLT</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_sPLT_tp spalette<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 name_len;
   png_byte new_name[<font color='#979000'>80</font>];
   png_byte entrybuf[<font color='#979000'>10</font>];
   png_size_t entry_size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> ? <font color='#979000'>6</font> : <font color='#979000'>10</font><font face='Lucida Console'>)</font>;
   png_size_t palette_size <font color='#5555FF'>=</font> entry_size <font color='#5555FF'>*</font> spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nentries;
   png_sPLT_entryp ep;
<font color='#0000FF'>#ifndef</font> PNG_POINTER_INDEXING_SUPPORTED
   <font color='#0000FF'><u>int</u></font> i;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_sPLT</font>"<font face='Lucida Console'>)</font>;

   name_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_check_keyword</font><font face='Lucida Console'>(</font>png_ptr, spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>name, new_name<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>name_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>sPLT: invalid keyword</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Make sure we include the NULL after the name */</font>
   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_sPLT,
       <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>name_len <font color='#5555FF'>+</font> <font color='#979000'>2</font> <font color='#5555FF'>+</font> palette_size<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font>new_name,
       <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>name_len <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>depth, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Loop through each palette entry, writing appropriately */</font>
<font color='#0000FF'>#ifdef</font> PNG_POINTER_INDEXING_SUPPORTED
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>ep <font color='#5555FF'>=</font> spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>entries; ep<font color='#5555FF'>&lt;</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>entries <font color='#5555FF'>+</font> spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nentries; ep<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         entrybuf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red;
         entrybuf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
         entrybuf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue;
         entrybuf[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>frequency<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>0</font>, ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>2</font>, ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>6</font>, ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>8</font>, ep<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>frequency<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, entrybuf, entry_size<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#else</font>
   ep<font color='#5555FF'>=</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>entries;
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i<font color='#5555FF'>&gt;</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nentries; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>spalette<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         entrybuf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep[i].red;
         entrybuf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep[i].green;
         entrybuf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep[i].blue;
         entrybuf[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>ep[i].alpha;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, ep[i].frequency<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>0</font>, ep[i].red<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>2</font>, ep[i].green<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, ep[i].blue<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>6</font>, ep[i].alpha<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>entrybuf <font color='#5555FF'>+</font> <font color='#979000'>8</font>, ep[i].frequency<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, entrybuf, entry_size<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_sBIT_SUPPORTED
<font color='#009900'>/* Write the sBIT chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_sBIT'></a>png_write_sBIT</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_color_8p sbit, <font color='#0000FF'><u>int</u></font> color_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>4</font>];
   png_size_t size;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_sBIT</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Make sure we don't depend upon the order of PNG_COLOR_8 */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte maxbits;

      maxbits <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>color_type<font color='#5555FF'>=</font><font color='#5555FF'>=</font>PNG_COLOR_TYPE_PALETTE ? <font color='#979000'>8</font> :
          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_bit_depth<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>&gt;</font> maxbits <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>&gt;</font> maxbits <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>&gt;</font> maxbits<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid sBIT depth specified</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red;
      buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
      buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue;
      size <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_bit_depth<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid sBIT depth specified</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray;
      size <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_bit_depth<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid sBIT depth specified</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      buf[size<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> sbit<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha;
   <b>}</b>

   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_sBIT, buf, size<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_cHRM_SUPPORTED
<font color='#009900'>/* Write the cHRM chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_cHRM_fixed'></a>png_write_cHRM_fixed</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>32</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_cHRM</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Each value is saved in 1/100,000ths */</font>
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf,      xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font>  <font color='#979000'>4</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font>  <font color='#979000'>8</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>12</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>16</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>20</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>24</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>28</font>, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_cHRM, buf, <font color='#979000'>32</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_tRNS_SUPPORTED
<font color='#009900'>/* Write the tRNS chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_tRNS'></a>png_write_tRNS</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep trans_alpha,
    png_const_color_16p tran, <font color='#0000FF'><u>int</u></font> num_trans, <font color='#0000FF'><u>int</u></font> color_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>6</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_tRNS</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_trans <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> num_trans <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_app_warning</font><font face='Lucida Console'>(</font>png_ptr,
             "<font color='#CC0000'>Invalid number of transparent colors specified</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#009900'>/* Write the chunk out as it is */</font>
      <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_tRNS, trans_alpha,
         <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>num_trans<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* One 16 bit value */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>tran<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_app_warning</font><font face='Lucida Console'>(</font>png_ptr,
             "<font color='#CC0000'>Ignoring attempt to write tRNS chunk out-of-range for bit_depth</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf, tran<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_tRNS, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Three 16 bit values */</font>
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf, tran<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>2</font>, tran<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, tran<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> PNG_WRITE_16BIT_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>buf[<font color='#979000'>0</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>2</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>4</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buf[<font color='#979000'>0</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>2</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>4</font>]<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
      <b>{</b>
         <font color='#BB00BB'>png_app_warning</font><font face='Lucida Console'>(</font>png_ptr,
           "<font color='#CC0000'>Ignoring attempt to write 16-bit tRNS chunk when bit_depth is 8</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_tRNS, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>6</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#BB00BB'>png_app_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Can't write tRNS with an alpha channel</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_bKGD_SUPPORTED
<font color='#009900'>/* Write the background chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_bKGD'></a>png_write_bKGD</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_color_16p back, <font color='#0000FF'><u>int</u></font> color_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>6</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_bKGD</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>
<font color='#0000FF'>#ifdef</font> <font color='#BB00BB'>PNG_MNG_FEATURES_SUPPORTED</font>
          <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mng_features_permitted <font color='#5555FF'>&amp;</font> PNG_FLAG_MNG_EMPTY_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
<font color='#0000FF'>#endif</font>
         back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid background palette index</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index;
      <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_bKGD, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf, back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>2</font>, back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> PNG_WRITE_16BIT_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>buf[<font color='#979000'>0</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>2</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>4</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buf[<font color='#979000'>0</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>2</font>] <font color='#5555FF'>|</font> buf[<font color='#979000'>4</font>]<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr,
             "<font color='#CC0000'>Ignoring attempt to write 16-bit bKGD chunk when bit_depth is 8</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_bKGD, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>6</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr,
             "<font color='#CC0000'>Ignoring attempt to write bKGD chunk out-of-range for bit_depth</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf, back<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_bKGD, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_hIST_SUPPORTED
<font color='#009900'>/* Write the histogram */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_hIST'></a>png_write_hIST</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_uint_16p hist, <font color='#0000FF'><u>int</u></font> num_hist<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> i;
   png_byte buf[<font color='#979000'>3</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_hIST</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_hist <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_debug2</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>num_hist = %d, num_palette = %d</font>", num_hist,
          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>;

      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid number of histogram entries specified</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_hIST, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_hist <font color='#5555FF'>*</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_hist; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf, hist[i]<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_tEXt_SUPPORTED
<font color='#009900'>/* Write a tEXt chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_tEXt'></a>png_write_tEXt</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_charp key, png_const_charp text,
    png_size_t text_len<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 key_len;
   png_byte new_key[<font color='#979000'>80</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_tEXt</font>"<font face='Lucida Console'>)</font>;

   key_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_check_keyword</font><font face='Lucida Console'>(</font>png_ptr, key, new_key<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>tEXt: invalid keyword</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>text <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#5555FF'>*</font>text <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>\0</font>'<font face='Lucida Console'>)</font>
      text_len <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>else</font>
      text_len <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>text<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>text_len <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>key_len<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>tEXt: text too long</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Make sure we include the 0 after the key */</font>
   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_tEXt,
       <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#009900'>/*checked above*/</font><font face='Lucida Console'>(</font>key_len <font color='#5555FF'>+</font> text_len <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
   <font color='#009900'>/*
    * We leave it to the application to meet PNG-1.0 requirements on the
    * contents of the text.  PNG-1.0 through PNG-1.2 discourage the use of
    * any non-Latin-1 characters except for NEWLINE.  ISO PNG will forbid them.
    * The NUL character is forbidden by PNG-1.0 through PNG-1.2 and ISO PNG.
    */</font>
   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, new_key, key_len <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>text_len<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>text, text_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_zTXt_SUPPORTED
<font color='#009900'>/* Write a compressed text chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_zTXt'></a>png_write_zTXt</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_charp key, png_const_charp text,
    png_size_t text_len, <font color='#0000FF'><u>int</u></font> compression<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 key_len;
   png_byte new_key[<font color='#979000'>81</font>];
   compression_state comp;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_zTXt</font>"<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>text_len<font face='Lucida Console'>)</font> <font color='#009900'>/* Always use strlen */</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compression <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_TEXT_COMPRESSION_NONE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_write_tEXt</font><font face='Lucida Console'>(</font>png_ptr, key, text, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compression <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_TEXT_COMPRESSION_zTXt<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>zTXt: invalid compression type</font>"<font face='Lucida Console'>)</font>;

   key_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_check_keyword</font><font face='Lucida Console'>(</font>png_ptr, key, new_key<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>zTXt: invalid keyword</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Add the compression method and 1 for the keyword separator. */</font>
   new_key[<font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len] <font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE;
   <font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len;

   <font color='#009900'>/* Compute the compressed data; do it now for the length */</font>
   <font color='#BB00BB'>png_text_compress_init</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>comp, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>text,
      text <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL ? <font color='#979000'>0</font> : <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>text<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_text_compress</font><font face='Lucida Console'>(</font>png_ptr, png_zTXt, <font color='#5555FF'>&amp;</font>comp, key_len<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Write start of chunk */</font>
   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_zTXt, key_len <font color='#5555FF'>+</font> comp.output_len<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Write key */</font>
   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, new_key, key_len<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Write the compressed data */</font>
   <font color='#BB00BB'>png_write_compressed_data_out</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>comp<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Close the chunk */</font>
   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_iTXt_SUPPORTED
<font color='#009900'>/* Write an iTXt chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_iTXt'></a>png_write_iTXt</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> compression, png_const_charp key,
    png_const_charp lang, png_const_charp lang_key, png_const_charp text<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 key_len, prefix_len;
   png_size_t lang_len, lang_key_len;
   png_byte new_key[<font color='#979000'>82</font>];
   compression_state comp;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_iTXt</font>"<font face='Lucida Console'>)</font>;

   key_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_check_keyword</font><font face='Lucida Console'>(</font>png_ptr, key, new_key<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>iTXt: invalid keyword</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Set the compression flag */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>compression<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_ITXT_COMPRESSION_NONE:
      <font color='#0000FF'>case</font> PNG_TEXT_COMPRESSION_NONE:
         compression <font color='#5555FF'>=</font> new_key[<font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len] <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* no compression */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_TEXT_COMPRESSION_zTXt:
      <font color='#0000FF'>case</font> PNG_ITXT_COMPRESSION_zTXt:
         compression <font color='#5555FF'>=</font> new_key[<font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len] <font color='#5555FF'>=</font> <font color='#979000'>1</font>; <font color='#009900'>/* compressed */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>iTXt: invalid compression</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   new_key[<font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len] <font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE;
   <font color='#5555FF'>+</font><font color='#5555FF'>+</font>key_len; <font color='#009900'>/* for the keywod separator */</font>

   <font color='#009900'>/* We leave it to the application to meet PNG-1.0 requirements on the
    * contents of the text.  PNG-1.0 through PNG-1.2 discourage the use of
    * any non-Latin-1 characters except for NEWLINE.  ISO PNG, however,
    * specifies that the text is UTF-8 and this really doesn't require any
    * checking.
    *
    * The NUL character is forbidden by PNG-1.0 through PNG-1.2 and ISO PNG.
    *
    * TODO: validate the language tag correctly (see the spec.)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lang <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> lang <font color='#5555FF'>=</font> "<font color='#CC0000'></font>"; <font color='#009900'>/* empty language is valid */</font>
   lang_len <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>lang<font face='Lucida Console'>)</font><font color='#5555FF'>+</font><font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lang_key <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> lang_key <font color='#5555FF'>=</font> "<font color='#CC0000'></font>"; <font color='#009900'>/* may be empty */</font>
   lang_key_len <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>lang_key<font face='Lucida Console'>)</font><font color='#5555FF'>+</font><font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>text <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> text <font color='#5555FF'>=</font> "<font color='#CC0000'></font>"; <font color='#009900'>/* may be empty */</font>

   prefix_len <font color='#5555FF'>=</font> key_len;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lang_len <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font color='#5555FF'>-</font>prefix_len<font face='Lucida Console'>)</font>
      prefix_len <font color='#5555FF'>=</font> PNG_UINT_31_MAX;
   <font color='#0000FF'>else</font>
      prefix_len <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>prefix_len <font color='#5555FF'>+</font> lang_len<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lang_key_len <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font color='#5555FF'>-</font>prefix_len<font face='Lucida Console'>)</font>
      prefix_len <font color='#5555FF'>=</font> PNG_UINT_31_MAX;
   <font color='#0000FF'>else</font>
      prefix_len <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>prefix_len <font color='#5555FF'>+</font> lang_key_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_text_compress_init</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>comp, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>text, <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>text<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compression<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_text_compress</font><font face='Lucida Console'>(</font>png_ptr, png_iTXt, <font color='#5555FF'>&amp;</font>comp, prefix_len<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>comp.input_len <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font color='#5555FF'>-</font>prefix_len<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>iTXt: uncompressed text too long</font>"<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* So the string will fit in a chunk: */</font>
      comp.output_len <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#009900'>/*SAFE*/</font>comp.input_len;
   <b>}</b>

   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_iTXt, comp.output_len <font color='#5555FF'>+</font> prefix_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, new_key, key_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>lang, lang_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>lang_key, lang_key_len<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compression<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_write_compressed_data_out</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>comp<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font>
      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>text, comp.input_len<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_oFFs_SUPPORTED
<font color='#009900'>/* Write the oFFs chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_oFFs'></a>png_write_oFFs</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_int_32 x_offset, png_int_32 y_offset,
    <font color='#0000FF'><u>int</u></font> unit_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>9</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_oFFs</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>unit_type <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_OFFSET_LAST<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unrecognized unit type for oFFs chunk</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf, x_offset<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, y_offset<font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>8</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>unit_type;

   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_oFFs, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>9</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#ifdef</font> PNG_WRITE_pCAL_SUPPORTED
<font color='#009900'>/* Write the pCAL chunk (described in the PNG extensions document) */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_pCAL'></a>png_write_pCAL</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_charp purpose, png_int_32 X0,
    png_int_32 X1, <font color='#0000FF'><u>int</u></font> type, <font color='#0000FF'><u>int</u></font> nparams, png_const_charp units,
    png_charpp params<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 purpose_len;
   png_size_t units_len, total_len;
   png_size_tp params_len;
   png_byte buf[<font color='#979000'>10</font>];
   png_byte new_purpose[<font color='#979000'>80</font>];
   <font color='#0000FF'><u>int</u></font> i;

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_pCAL (%d parameters)</font>", nparams<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>type <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_EQUATION_LAST<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unrecognized equation type for pCAL chunk</font>"<font face='Lucida Console'>)</font>;

   purpose_len <font color='#5555FF'>=</font> <font color='#BB00BB'>png_check_keyword</font><font face='Lucida Console'>(</font>png_ptr, purpose, new_purpose<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>purpose_len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>pCAL: invalid keyword</font>"<font face='Lucida Console'>)</font>;

   <font color='#5555FF'>+</font><font color='#5555FF'>+</font>purpose_len; <font color='#009900'>/* terminator */</font>

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>pCAL purpose length = %d</font>", <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>purpose_len<font face='Lucida Console'>)</font>;
   units_len <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>units<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>nparams <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> ? <font color='#979000'>0</font> : <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>pCAL units length = %d</font>", <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>units_len<font face='Lucida Console'>)</font>;
   total_len <font color='#5555FF'>=</font> purpose_len <font color='#5555FF'>+</font> units_len <font color='#5555FF'>+</font> <font color='#979000'>10</font>;

   params_len <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_size_tp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
       <font face='Lucida Console'>(</font>png_alloc_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>nparams <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Find the length of each parameter, making sure we don't count the
    * null terminator for the last parameter.
    */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> nparams; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      params_len[i] <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>params[i]<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font><font color='#5555FF'>=</font> nparams <font color='#5555FF'>-</font> <font color='#979000'>1</font> ? <font color='#979000'>0</font> : <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_debug2</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>pCAL parameter %d length = %lu</font>", i,
          <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>params_len[i]<font face='Lucida Console'>)</font>;
      total_len <font color='#5555FF'>+</font><font color='#5555FF'>=</font> params_len[i];
   <b>}</b>

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>pCAL total length = %d</font>", <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>total_len<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_chunk_header</font><font face='Lucida Console'>(</font>png_ptr, png_pCAL, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>total_len<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, new_purpose, purpose_len<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf, X0<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, X1<font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>8</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>type;
   buf[<font color='#979000'>9</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>nparams;
   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>10</font><font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>units, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>units_len<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> nparams; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_write_chunk_data</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>params[i], params_len[i]<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, params_len<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_chunk_end</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_sCAL_SUPPORTED
<font color='#009900'>/* Write the sCAL chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_sCAL_s'></a>png_write_sCAL_s</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> unit, png_const_charp width,
    png_const_charp height<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>64</font>];
   png_size_t wlen, hlen, total_len;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_sCAL_s</font>"<font face='Lucida Console'>)</font>;

   wlen <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>width<font face='Lucida Console'>)</font>;
   hlen <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>height<font face='Lucida Console'>)</font>;
   total_len <font color='#5555FF'>=</font> wlen <font color='#5555FF'>+</font> hlen <font color='#5555FF'>+</font> <font color='#979000'>2</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>total_len <font color='#5555FF'>&gt;</font> <font color='#979000'>64</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Can't write sCAL (buffer too small)</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>unit;
   <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, width, wlen <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;      <font color='#009900'>/* Append the '\0' here */</font>
   <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> wlen <font color='#5555FF'>+</font> <font color='#979000'>2</font>, height, hlen<font face='Lucida Console'>)</font>;  <font color='#009900'>/* Do NOT append the '\0' here */</font>

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>sCAL total length = %u</font>", <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>total_len<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_sCAL, buf, total_len<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_pHYs_SUPPORTED
<font color='#009900'>/* Write the pHYs chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_pHYs'></a>png_write_pHYs</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 x_pixels_per_unit,
    png_uint_32 y_pixels_per_unit,
    <font color='#0000FF'><u>int</u></font> unit_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>9</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_pHYs</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>unit_type <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_RESOLUTION_LAST<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unrecognized unit type for pHYs chunk</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf, x_pixels_per_unit<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_save_uint_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, y_pixels_per_unit<font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>8</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>unit_type;

   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_pHYs, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>9</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_tIME_SUPPORTED
<font color='#009900'>/* Write the tIME chunk.  Use either png_convert_from_struct_tm()
 * or png_convert_from_time_t(), or fill in the structure yourself.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_tIME'></a>png_write_tIME</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_timep mod_time<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>7</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_tIME</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>month  <font color='#5555FF'>&gt;</font> <font color='#979000'>12</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>month  <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>day    <font color='#5555FF'>&gt;</font> <font color='#979000'>31</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>day    <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hour   <font color='#5555FF'>&gt;</font> <font color='#979000'>23</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second <font color='#5555FF'>&gt;</font> <font color='#979000'>60</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid time specified for tIME chunk</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_save_uint_16</font><font face='Lucida Console'>(</font>buf, mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>year<font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>month;
   buf[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>day;
   buf[<font color='#979000'>4</font>] <font color='#5555FF'>=</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hour;
   buf[<font color='#979000'>5</font>] <font color='#5555FF'>=</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>minute;
   buf[<font color='#979000'>6</font>] <font color='#5555FF'>=</font> mod_time<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second;

   <font color='#BB00BB'>png_write_complete_chunk</font><font face='Lucida Console'>(</font>png_ptr, png_tIME, buf, <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>7</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Initializes the row writing capability of libpng */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_start_row'></a>png_write_start_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_WRITE_INTERLACING_SUPPORTED
   <font color='#009900'>/* Arrays to facilitate easy interlacing - use pass (0 - 6) as index */</font>

   <font color='#009900'>/* Start of interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_start[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_inc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Start of interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_ystart[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_yinc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font><b>}</b>;
<font color='#0000FF'>#endif</font>

   png_alloc_size_t buf_size;
   <font color='#0000FF'><u>int</u></font> usr_pixel_depth;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_start_row</font>"<font face='Lucida Console'>)</font>;

   usr_pixel_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_channels <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_bit_depth;
   buf_size <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>usr_pixel_depth, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* 1.5.6: added to allow checking in the row write code. */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformed_pixel_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>maximum_pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>usr_pixel_depth;

   <font color='#009900'>/* Set up row buffer */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, buf_size<font face='Lucida Console'>)</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> PNG_FILTER_VALUE_NONE;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_FILTER_SUPPORTED
   <font color='#009900'>/* Set up filtering buffer, if using this filter */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>&amp;</font> PNG_FILTER_SUB<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sub_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sub_row[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> PNG_FILTER_VALUE_SUB;
   <b>}</b>

   <font color='#009900'>/* We only need to keep the previous row if we are using one of these. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_FILTER_AVG <font color='#5555FF'>|</font> PNG_FILTER_UP <font color='#5555FF'>|</font> PNG_FILTER_PAETH<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Set up previous row buffer */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_calloc</font><font face='Lucida Console'>(</font>png_ptr, buf_size<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>&amp;</font> PNG_FILTER_UP<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>up_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>up_row[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> PNG_FILTER_VALUE_UP;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>&amp;</font> PNG_FILTER_AVG<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avg_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avg_row[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> PNG_FILTER_VALUE_AVG;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter <font color='#5555FF'>&amp;</font> PNG_FILTER_PAETH<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>paeth_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>paeth_row[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> PNG_FILTER_VALUE_PAETH;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_WRITE_FILTER_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_INTERLACING_SUPPORTED
   <font color='#009900'>/* If interlaced, we need to set up width and height of pass */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>+</font> png_pass_yinc[<font color='#979000'>0</font>] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
             png_pass_ystart[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> png_pass_yinc[<font color='#979000'>0</font>];

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> png_pass_inc[<font color='#979000'>0</font>] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
             png_pass_start[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> png_pass_inc[<font color='#979000'>0</font>];
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_width <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_width <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Internal use only.  Called when finished processing a row of data. */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_finish_row'></a>png_write_finish_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_WRITE_INTERLACING_SUPPORTED
   <font color='#009900'>/* Arrays to facilitate easy interlacing - use pass (0 - 6) as index */</font>

   <font color='#009900'>/* Start of interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_start[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_inc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Start of interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_ystart[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_yinc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font><b>}</b>;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_finish_row</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Next row */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

   <font color='#009900'>/* See if we are done */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_INTERLACING_SUPPORTED
   <font color='#009900'>/* If interlaced, go to next pass */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* Loop until we find a non-zero width or height pass */</font>
         <font color='#0000FF'>do</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
               <font color='#0000FF'>break</font>;

            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font>
                png_pass_inc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
                png_pass_start[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
                png_pass_inc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass];

            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>+</font>
                png_pass_yinc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
                png_pass_ystart[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
                png_pass_yinc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass];

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font>
               <font color='#0000FF'>break</font>;

         <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_width <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

      <b>}</b>

      <font color='#009900'>/* Reset the row above the image for the next pass */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass <font color='#5555FF'>&lt;</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row, <font color='#979000'>0</font>,
                <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_channels<font color='#5555FF'>*</font>
                png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>usr_bit_depth, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* If we get here, we've just written the last row, so we need
      to flush the compressor */</font>
   <font color='#BB00BB'>png_compress_IDAT</font><font face='Lucida Console'>(</font>png_ptr, NULL, <font color='#979000'>0</font>, Z_FINISH<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_INTERLACING_SUPPORTED
<font color='#009900'>/* Pick out the correct pixels for the interlace pass.
 * The basic idea here is to go through the row with a source
 * pointer and a destination pointer (sp and dp), and copy the
 * correct pixels for the pass.  As the row gets compacted,
 * sp will always be &gt;= dp, so we should never overwrite anything.
 * See the default: case for the easiest code to understand.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_write_interlace'></a>png_do_write_interlace</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row, <font color='#0000FF'><u>int</u></font> pass<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Arrays to facilitate easy interlacing - use pass (0 - 6) as index */</font>

   <font color='#009900'>/* Start of interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_start[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte  png_pass_inc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_write_interlace</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* We don't have to do anything on the last pass (6) */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pass <font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Each pixel depth is handled separately */</font>
      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
         <b>{</b>
            png_bytep sp;
            png_bytep dp;
            <font color='#0000FF'><u>int</u></font> shift;
            <font color='#0000FF'><u>int</u></font> d;
            <font color='#0000FF'><u>int</u></font> value;
            png_uint_32 i;
            png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

            dp <font color='#5555FF'>=</font> row;
            d <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            shift <font color='#5555FF'>=</font> <font color='#979000'>7</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> png_pass_start[pass]; i <font color='#5555FF'>&lt;</font> row_width;
               i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_pass_inc[pass]<font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
               value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>7</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font>;
               d <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>7</font>;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;
                  d <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  shift<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;

            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;

            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
         <b>{</b>
            png_bytep sp;
            png_bytep dp;
            <font color='#0000FF'><u>int</u></font> shift;
            <font color='#0000FF'><u>int</u></font> d;
            <font color='#0000FF'><u>int</u></font> value;
            png_uint_32 i;
            png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

            dp <font color='#5555FF'>=</font> row;
            shift <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
            d <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> png_pass_start[pass]; i <font color='#5555FF'>&lt;</font> row_width;
               i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_pass_inc[pass]<font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>3</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font>;
               d <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;
                  d <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  shift <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;

            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
         <b>{</b>
            png_bytep sp;
            png_bytep dp;
            <font color='#0000FF'><u>int</u></font> shift;
            <font color='#0000FF'><u>int</u></font> d;
            <font color='#0000FF'><u>int</u></font> value;
            png_uint_32 i;
            png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

            dp <font color='#5555FF'>=</font> row;
            shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            d <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> png_pass_start[pass]; i <font color='#5555FF'>&lt;</font> row_width;
                i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_pass_inc[pass]<font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font>;
               d <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;
                  d <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  shift <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;

            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>default</font>:
         <b>{</b>
            png_bytep sp;
            png_bytep dp;
            png_uint_32 i;
            png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
            png_size_t pixel_bytes;

            <font color='#009900'>/* Start at the beginning */</font>
            dp <font color='#5555FF'>=</font> row;

            <font color='#009900'>/* Find out how many bytes each pixel takes up */</font>
            pixel_bytes <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;

            <font color='#009900'>/* Loop through the row, only looking at the pixels that matter */</font>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> png_pass_start[pass]; i <font color='#5555FF'>&lt;</font> row_width;
               i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_pass_inc[pass]<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Find out where the original pixel is */</font>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>i <font color='#5555FF'>*</font> pixel_bytes;

               <font color='#009900'>/* Move the pixel */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> sp<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>dp, sp, pixel_bytes<font face='Lucida Console'>)</font>;

               <font color='#009900'>/* Next pixel */</font>
               dp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> pixel_bytes;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>
      <b>}</b>
      <font color='#009900'>/* Set new row width */</font>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font>
          png_pass_inc[pass] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
          png_pass_start[pass]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
          png_pass_inc[pass];

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth,
          row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* This filters the row, chooses which filter to use, if it has not already
 * been specified by the application, and then writes the row out with the
 * chosen filter.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <b><a name='png_write_filtered_row'></a>png_write_filtered_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytep filtered_row,
   png_size_t row_bytes<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#define</font> PNG_MAXSUM <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> PNG_HISHIFT <font color='#979000'>10</font>
<font color='#0000FF'>#define</font> PNG_LOMASK <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#979000'>0xffffL</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> PNG_HIMASK <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>~PNG_LOMASK <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_write_find_filter'></a>png_write_find_filter</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_row_infop row_info<font face='Lucida Console'>)</font>
<b>{</b>
   png_bytep best_row;
<font color='#0000FF'>#ifdef</font> PNG_WRITE_FILTER_SUPPORTED
   png_bytep prev_row, row_buf;
   png_uint_32 mins, bpp;
   png_byte filter_to_do <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>do_filter;
   png_size_t row_bytes <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
   <font color='#0000FF'><u>int</u></font> num_p_filters <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_prev_filters;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_find_filter</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifndef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> filter_to_do <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_ALL_FILTERS<font face='Lucida Console'>)</font>
  <b>{</b>
     <font color='#009900'>/* These will never be selected so we need not test them. */</font>
     filter_to_do <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~<font face='Lucida Console'>(</font>PNG_FILTER_UP <font color='#5555FF'>|</font> PNG_FILTER_PAETH<font face='Lucida Console'>)</font>;
  <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Find out how many bytes offset each pixel is */</font>
   bpp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font>;

   prev_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row;
<font color='#0000FF'>#endif</font>
   best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf;
<font color='#0000FF'>#ifdef</font> PNG_WRITE_FILTER_SUPPORTED
   row_buf <font color='#5555FF'>=</font> best_row;
   mins <font color='#5555FF'>=</font> PNG_MAXSUM;

   <font color='#009900'>/* The prediction method we use is to find which method provides the
    * smallest value when summing the absolute values of the distances
    * from zero, using anything &gt;= 128 as negative numbers.  This is known
    * as the "minimum sum of absolute differences" heuristic.  Other
    * heuristics are the "weighted minimum sum of absolute differences"
    * (experimental and can in theory improve compression), and the "zlib
    * predictive" method (not implemented yet), which does test compressions
    * of lines using different filter methods, and then chooses the
    * (series of) filter(s) that give minimum compressed data size (VERY
    * computationally expensive).
    *
    * GRR 980525:  consider also
    *
    *   (1) minimum sum of absolute differences from running average (i.e.,
    *       keep running sum of non-absolute differences &amp; count of bytes)
    *       [track dispersion, too?  restart average if dispersion too large?]
    *
    *  (1b) minimum sum of absolute differences from sliding average, probably
    *       with window size &lt;= deflate window (usually 32K)
    *
    *   (2) minimum sum of squared differences from zero or running average
    *       (i.e., ~ root-mean-square approach)
    */</font>


   <font color='#009900'>/* We don't need to test the 'no filter' case if this is the only filter
    * that has been chosen, as it doesn't actually do anything to the data.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>&amp;</font> PNG_FILTER_NONE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> filter_to_do <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_FILTER_NONE<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp;
      png_uint_32 sum <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      png_size_t i;
      <font color='#0000FF'><u>int</u></font> v;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>rp;
         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_32 sumhi, sumlo;
         <font color='#0000FF'><u>int</u></font> j;
         sumlo <font color='#5555FF'>=</font> sum <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK; <font color='#009900'>/* Gives us some footroom */</font>

         <font color='#009900'>/* Reduce the sum if we match any of the previous rows */</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_NONE<font face='Lucida Console'>)</font>
            <b>{</b>
               sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         <font color='#009900'>/* Factor in the cost of this filter (this is here for completeness,
          * but it makes no sense to have a "cost" for the NONE filter, as
          * it has the minimum possible computational cost - none).
          */</font>
         sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_NONE]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_NONE]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            sum <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            sum <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> sumlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>
      mins <font color='#5555FF'>=</font> sum;
   <b>}</b>

   <font color='#009900'>/* Sub filter */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_SUB<font face='Lucida Console'>)</font>
   <font color='#009900'>/* It's the only filter so no testing is needed */</font>
   <b>{</b>
      png_bytep rp, lp, dp;
      png_size_t i;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sub_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> bpp;
           i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>rp;
      <b>}</b>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>lp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes;
         i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, lp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>lp<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      <b>}</b>

      best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sub_row;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>&amp;</font> PNG_FILTER_SUB<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, lp;
      png_uint_32 sum <font color='#5555FF'>=</font> <font color='#979000'>0</font>, lmins <font color='#5555FF'>=</font> mins;
      png_size_t i;
      <font color='#0000FF'><u>int</u></font> v;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#009900'>/* We temporarily increase the "minimum sum" by the factor we
       * would reduce the sum of this filter, so that we can do the
       * early exit comparison without scaling the sum each time.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 lmhi, lmlo;
         lmlo <font color='#5555FF'>=</font> lmins <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmins <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_SUB<font face='Lucida Console'>)</font>
            <b>{</b>
               lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_SUB]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_SUB]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            lmins <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            lmins <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> lmlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sub_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> bpp;
           i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>rp;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;
      <b>}</b>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>lp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes;
         i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, lp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>lp<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font> lmins<font face='Lucida Console'>)</font>  <font color='#009900'>/* We are already worse, don't continue. */</font>
            <font color='#0000FF'>break</font>;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 sumhi, sumlo;
         sumlo <font color='#5555FF'>=</font> sum <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_SUB<font face='Lucida Console'>)</font>
            <b>{</b>
               sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_SUB]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_SUB]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            sum <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            sum <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> sumlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&lt;</font> mins<font face='Lucida Console'>)</font>
      <b>{</b>
         mins <font color='#5555FF'>=</font> sum;
         best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sub_row;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Up filter */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_UP<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, pp;
      png_size_t i;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>up_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          pp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes;
          i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      <b>}</b>

      best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>up_row;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>&amp;</font> PNG_FILTER_UP<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, pp;
      png_uint_32 sum <font color='#5555FF'>=</font> <font color='#979000'>0</font>, lmins <font color='#5555FF'>=</font> mins;
      png_size_t i;
      <font color='#0000FF'><u>int</u></font> v;


<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 lmhi, lmlo;
         lmlo <font color='#5555FF'>=</font> lmins <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmins <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_UP<font face='Lucida Console'>)</font>
            <b>{</b>
               lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_UP]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_UP]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            lmins <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            lmins <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> lmlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>up_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          pp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font> lmins<font face='Lucida Console'>)</font>  <font color='#009900'>/* We are already worse, don't continue. */</font>
            <font color='#0000FF'>break</font>;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 sumhi, sumlo;
         sumlo <font color='#5555FF'>=</font> sum <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_UP<font face='Lucida Console'>)</font>
            <b>{</b>
               sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_UP]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_UP]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            sum <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            sum <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> sumlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&lt;</font> mins<font face='Lucida Console'>)</font>
      <b>{</b>
         mins <font color='#5555FF'>=</font> sum;
         best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>up_row;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Avg filter */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_AVG<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, pp, lp;
      png_uint_32 i;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avg_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
           pp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> bpp; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>/</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>lp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>lp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                 <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      <b>}</b>
      best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avg_row;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>&amp;</font> PNG_FILTER_AVG<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, pp, lp;
      png_uint_32 sum <font color='#5555FF'>=</font> <font color='#979000'>0</font>, lmins <font color='#5555FF'>=</font> mins;
      png_size_t i;
      <font color='#0000FF'><u>int</u></font> v;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 lmhi, lmlo;
         lmlo <font color='#5555FF'>=</font> lmins <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmins <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_AVG<font face='Lucida Console'>)</font>
            <b>{</b>
               lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_AVG]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_AVG]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            lmins <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            lmins <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> lmlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avg_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
           pp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> bpp; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>/</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;
      <b>}</b>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>lp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font>
             <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>lp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font> lmins<font face='Lucida Console'>)</font>  <font color='#009900'>/* We are already worse, don't continue. */</font>
            <font color='#0000FF'>break</font>;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 sumhi, sumlo;
         sumlo <font color='#5555FF'>=</font> sum <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_NONE<font face='Lucida Console'>)</font>
            <b>{</b>
               sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_AVG]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_AVG]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            sum <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            sum <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> sumlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&lt;</font> mins<font face='Lucida Console'>)</font>
      <b>{</b>
         mins <font color='#5555FF'>=</font> sum;
         best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avg_row;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Paeth filter */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_PAETH<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, pp, cp, lp;
      png_size_t i;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>paeth_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          pp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> bpp; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>lp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, cp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> a, b, c, pa, pb, pc, p;

         b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         c <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>cp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>lp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

         p <font color='#5555FF'>=</font> b <font color='#5555FF'>-</font> c;
         pc <font color='#5555FF'>=</font> a <font color='#5555FF'>-</font> c;

<font color='#0000FF'>#ifdef</font> PNG_USE_ABS
         pa <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>;
         pb <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>pc<font face='Lucida Console'>)</font>;
         pc <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
         pa <font color='#5555FF'>=</font> p <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>p : p;
         pb <font color='#5555FF'>=</font> pc <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>pc : pc;
         pc <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> : p <font color='#5555FF'>+</font> pc;
<font color='#0000FF'>#endif</font>

         p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>pa <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pb <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> pa <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font>pc<font face='Lucida Console'>)</font> ? a : <font face='Lucida Console'>(</font>pb <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pc<font face='Lucida Console'>)</font> ? b : c;

         <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> p<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      <b>}</b>
      best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>paeth_row;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_to_do <font color='#5555FF'>&amp;</font> PNG_FILTER_PAETH<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep rp, dp, pp, cp, lp;
      png_uint_32 sum <font color='#5555FF'>=</font> <font color='#979000'>0</font>, lmins <font color='#5555FF'>=</font> mins;
      png_size_t i;
      <font color='#0000FF'><u>int</u></font> v;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 lmhi, lmlo;
         lmlo <font color='#5555FF'>=</font> lmins <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmins <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_PAETH<font face='Lucida Console'>)</font>
            <b>{</b>
               lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         lmlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_PAETH]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         lmhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>inv_filter_costs[PNG_FILTER_VALUE_PAETH]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            lmins <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            lmins <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>lmhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> lmlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, dp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>paeth_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          pp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> bpp; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;
      <b>}</b>

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>lp <font color='#5555FF'>=</font> row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, cp <font color='#5555FF'>=</font> prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_bytes; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> a, b, c, pa, pb, pc, p;

         b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         c <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>cp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>lp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

<font color='#0000FF'>#ifndef</font> PNG_SLOW_PAETH
         p <font color='#5555FF'>=</font> b <font color='#5555FF'>-</font> c;
         pc <font color='#5555FF'>=</font> a <font color='#5555FF'>-</font> c;
<font color='#0000FF'>#ifdef</font> PNG_USE_ABS
         pa <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>;
         pb <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>pc<font face='Lucida Console'>)</font>;
         pc <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
         pa <font color='#5555FF'>=</font> p <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>p : p;
         pb <font color='#5555FF'>=</font> pc <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>pc : pc;
         pc <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> : p <font color='#5555FF'>+</font> pc;
<font color='#0000FF'>#endif</font>
         p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>pa <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pb <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> pa <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font>pc<font face='Lucida Console'>)</font> ? a : <font face='Lucida Console'>(</font>pb <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pc<font face='Lucida Console'>)</font> ? b : c;
<font color='#0000FF'>#else</font> <font color='#009900'>/* PNG_SLOW_PAETH */</font>
         p <font color='#5555FF'>=</font> a <font color='#5555FF'>+</font> b <font color='#5555FF'>-</font> c;
         pa <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>-</font> a<font face='Lucida Console'>)</font>;
         pb <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>-</font> b<font face='Lucida Console'>)</font>;
         pc <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>-</font> c<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pa <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pb <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> pa <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pc<font face='Lucida Console'>)</font>
            p <font color='#5555FF'>=</font> a;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pb <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pc<font face='Lucida Console'>)</font>
            p <font color='#5555FF'>=</font> b;

         <font color='#0000FF'>else</font>
            p <font color='#5555FF'>=</font> c;
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SLOW_PAETH */</font>

         v <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> p<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

         sum <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> ? v : <font color='#979000'>256</font> <font color='#5555FF'>-</font> v;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font> lmins<font face='Lucida Console'>)</font>  <font color='#009900'>/* We are already worse, don't continue. */</font>
            <font color='#0000FF'>break</font>;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>heuristic_method <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_HEURISTIC_WEIGHTED<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> j;
         png_uint_32 sumhi, sumlo;
         sumlo <font color='#5555FF'>=</font> sum <font color='#5555FF'>&amp;</font> PNG_LOMASK;
         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_HIMASK;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FILTER_VALUE_PAETH<font face='Lucida Console'>)</font>
            <b>{</b>
               sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;

               sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_weights[j]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                   PNG_WEIGHT_SHIFT;
            <b>}</b>
         <b>}</b>

         sumlo <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumlo <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_PAETH]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         sumhi <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>*</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_costs[PNG_FILTER_VALUE_PAETH]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
             PNG_COST_SHIFT;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&gt;</font> PNG_HIMASK<font face='Lucida Console'>)</font>
            sum <font color='#5555FF'>=</font> PNG_MAXSUM;

         <font color='#0000FF'>else</font>
            sum <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>sumhi <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_HISHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> sumlo;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sum <font color='#5555FF'>&lt;</font> mins<font face='Lucida Console'>)</font>
      <b>{</b>
         best_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>paeth_row;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_WRITE_FILTER_SUPPORTED */</font>

   <font color='#009900'>/* Do the actual writing of the filtered row data from the chosen filter. */</font>
   <font color='#BB00BB'>png_write_filtered_row</font><font face='Lucida Console'>(</font>png_ptr, best_row, row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_FILTER_SUPPORTED
<font color='#0000FF'>#ifdef</font> PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
   <font color='#009900'>/* Save the type of filter we picked this time for future calculations */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_prev_filters <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> j;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>1</font>; j <font color='#5555FF'>&lt;</font> num_p_filters; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j <font color='#5555FF'>-</font> <font color='#979000'>1</font>];
      <b>}</b>

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_filters[j] <font color='#5555FF'>=</font> best_row[<font color='#979000'>0</font>];
   <b>}</b>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_WRITE_FILTER_SUPPORTED */</font>
<b>}</b>


<font color='#009900'>/* Do the actual writing of a previously filtered row. */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_write_filtered_row'></a>png_write_filtered_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytep filtered_row,
   png_size_t full_row_length<font color='#009900'>/*includes filter byte*/</font><font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_write_filtered_row</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>, "<font color='#CC0000'>filter = %d</font>", filtered_row[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_compress_IDAT</font><font face='Lucida Console'>(</font>png_ptr, filtered_row, full_row_length, Z_NO_FLUSH<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Swap the current and previous rows */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep tptr;

      tptr <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>=</font> tptr;
   <b>}</b>

   <font color='#009900'>/* Finish row - updates counters and flushes zlib if last row */</font>
   <font color='#BB00BB'>png_write_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_WRITE_FLUSH_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flush_rows<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flush_dist <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flush_rows <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flush_dist<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_write_flush</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_WRITE_SUPPORTED */</font>

</pre></body></html>