<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - pngrutil.c</title></head><body bgcolor='white'><pre>

<font color='#009900'>/* pngrutil.c - utilities to read a PNG file
 *
 * Last changed in libpng 1.6.7 [November 14, 2013]
 * Copyright (c) 1998-2013 Glenn Randers-Pehrson
 * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
 * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
 *
 * This code is released under the libpng license.
 * For conditions of distribution and use, see the disclaimer
 * and license in png.h
 *
 * This file contains routines that are only called from within
 * libpng itself during the course of reading an image.
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pngpriv.h.html'>pngpriv.h</a>"

<font color='#0000FF'>#ifdef</font> PNG_READ_SUPPORTED

png_uint_32 PNGAPI
<b><a name='png_get_uint_31'></a>png_get_uint_31</b><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_const_bytep buf<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 uval <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>uval <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG unsigned integer out of range</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>uval<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_gAMA_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_READ_cHRM_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* The following is a variation on the above for use with the fixed
 * point values used for gAMA and cHRM.  Instead of png_error it
 * issues a warning and returns (-1) - an invalid value because both
 * gAMA and cHRM use *unsigned* integers for fixed point values.
 */</font>
<font color='#0000FF'>#define</font> PNG_FIXED_ERROR <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>

<font color='#0000FF'>static</font> png_fixed_point <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_get_fixed_point'></a>png_get_fixed_point</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep buf<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 uval <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>uval <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>uval; <font color='#009900'>/* known to be in range */</font>

   <font color='#009900'>/* The caller can turn off the warning by passing NULL. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG fixed point integer out of range</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> PNG_FIXED_ERROR;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_INT_FUNCTIONS_SUPPORTED
<font color='#009900'>/* NOTE: the read macros will obscure these definitions, so that if
 * PNG_USE_READ_MACROS is set the library will not use them internally,
 * but the APIs will still be available externally.
 *
 * The parentheses around "PNGAPI function_name" in the following three
 * functions are necessary because they allow the macros to co-exist with
 * these (unused but exported) functions.
 */</font>

<font color='#009900'>/* Grab an unsigned 32-bit integer from a buffer in big-endian format. */</font>
<b><a name='png_uint_32'></a>png_uint_32</b> <font face='Lucida Console'>(</font>PNGAPI
png_get_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_const_bytep buf<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 uval <font color='#5555FF'>=</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>buf    <font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>  <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>      <font face='Lucida Console'>)</font> ;

   <font color='#0000FF'>return</font> uval;
<b>}</b>

<font color='#009900'>/* Grab a signed 32-bit integer from a buffer in big-endian format.  The
 * data is stored in the PNG file in two's complement format and there
 * is no guarantee that a 'png_int_32' is exactly 32 bits, therefore
 * the following code does a two's complement to native conversion.
 */</font>
<b><a name='png_int_32'></a>png_int_32</b> <font face='Lucida Console'>(</font>PNGAPI
png_get_int_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_const_bytep buf<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 uval <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>uval <font color='#5555FF'>&amp;</font> <font color='#979000'>0x80000000</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* non-negative */</font>
      <font color='#0000FF'>return</font> uval;

   uval <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uval ^ <font color='#979000'>0xffffffff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>1</font>;  <font color='#009900'>/* 2's complement: -x = ~x+1 */</font>
   <font color='#0000FF'>return</font> <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>png_int_32<font face='Lucida Console'>)</font>uval;
<b>}</b>

<font color='#009900'>/* Grab an unsigned 16-bit integer from a buffer in big-endian format. */</font>
<b><a name='png_uint_16'></a>png_uint_16</b> <font face='Lucida Console'>(</font>PNGAPI
png_get_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_const_bytep buf<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* ANSI-C requires an int value to accomodate at least 16 bits so this
    * works and allows the compiler not to worry about possible narrowing
    * on 32 bit systems.  (Pre-ANSI systems did not make integers smaller
    * than 16 bits either.)
    */</font>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> val <font color='#5555FF'>=</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>buf<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>val;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_INT_FUNCTIONS_SUPPORTED */</font>

<font color='#009900'>/* Read and check the PNG file signature */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_sig'></a>png_read_sig</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_size_t num_checked, num_to_check;

   <font color='#009900'>/* Exit if the user application does not expect a signature. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   num_checked <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes;
   num_to_check <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>-</font> num_checked;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_READING <font color='#5555FF'>|</font> PNG_IO_SIGNATURE;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* The signature must be serialized in a single I/O call. */</font>
   <font color='#BB00BB'>png_read_data</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>signature[num_checked]<font face='Lucida Console'>)</font>, num_to_check<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes <font color='#5555FF'>=</font> <font color='#979000'>8</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_sig_cmp</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>signature, num_checked, num_to_check<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_checked <font color='#5555FF'>&lt;</font> <font color='#979000'>4</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
          <font color='#BB00BB'>png_sig_cmp</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>signature, num_checked, num_to_check <font color='#5555FF'>-</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Not a PNG file</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG file corrupted by ASCII conversion</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_checked <font color='#5555FF'>&lt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_PNG_SIGNATURE;
<b>}</b>

<font color='#009900'>/* Read the chunk header (length + type name).
 * Put the type name into png_ptr-&gt;chunk_name, and return the length.
 */</font>
png_uint_32 <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_chunk_header'></a>png_read_chunk_header</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>8</font>];
   png_uint_32 length;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_READING <font color='#5555FF'>|</font> PNG_IO_CHUNK_HDR;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Read the length and the chunk name.
    * This must be performed in a single I/O call.
    */</font>
   <font color='#BB00BB'>png_read_data</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
   length <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_31</font><font face='Lucida Console'>(</font>png_ptr, buf<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Put the chunk name into png_ptr-&gt;chunk_name. */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_CHUNK_FROM_STRING</font><font face='Lucida Console'>(</font>buf<font color='#5555FF'>+</font><font color='#979000'>4</font><font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_debug2</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, "<font color='#CC0000'>Reading %lx chunk, length = %lu</font>",
       <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>length<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Reset the crc and run it over the chunk name. */</font>
   <font color='#BB00BB'>png_reset_crc</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_calculate_crc</font><font face='Lucida Console'>(</font>png_ptr, buf <font color='#5555FF'>+</font> <font color='#979000'>4</font>, <font color='#979000'>4</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Check to see if chunk name is valid. */</font>
   <font color='#BB00BB'>png_check_chunk_name</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_READING <font color='#5555FF'>|</font> PNG_IO_CHUNK_DATA;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>return</font> length;
<b>}</b>

<font color='#009900'>/* Read data, and (optionally) run it through the CRC. */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_crc_read'></a>png_crc_read</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytep buf, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#BB00BB'>png_read_data</font><font face='Lucida Console'>(</font>png_ptr, buf, length<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_calculate_crc</font><font face='Lucida Console'>(</font>png_ptr, buf, length<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Optionally skip data and then check the CRC.  Depending on whether we
 * are reading an ancillary or critical chunk, and how the program has set
 * things up, we may calculate the CRC on the data and print a message.
 * Returns '1' if there was a CRC error, '0' otherwise.
 */</font>
<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_crc_finish'></a>png_crc_finish</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 skip<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The size of the local buffer for inflate is a good guess as to a
    * reasonable size to use for buffering reads from the application.
    */</font>
   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>skip <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 len;
      png_byte tmpbuf[PNG_INFLATE_BUF_SIZE];

      len <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> tmpbuf<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>&gt;</font> skip<font face='Lucida Console'>)</font>
         len <font color='#5555FF'>=</font> skip;
      skip <font color='#5555FF'>-</font><font color='#5555FF'>=</font> len;

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, tmpbuf, len<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_error</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_CHUNK_ANCILLARY</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font> ?
          <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_ANCILLARY_NOWARN<font face='Lucida Console'>)</font> :
          <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_CRITICAL_USE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>CRC error</font>"<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>CRC error</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Compare the CRC stored in the PNG file with that calculated by libpng from
 * the data it has read thus far.
 */</font>
<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_crc_error'></a>png_crc_error</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte crc_bytes[<font color='#979000'>4</font>];
   png_uint_32 crc;
   <font color='#0000FF'><u>int</u></font> need_crc <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_CHUNK_ANCILLARY</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_ANCILLARY_MASK<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
          <font face='Lucida Console'>(</font>PNG_FLAG_CRC_ANCILLARY_USE <font color='#5555FF'>|</font> PNG_FLAG_CRC_ANCILLARY_NOWARN<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         need_crc <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#009900'>/* critical */</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_CRITICAL_IGNORE<font face='Lucida Console'>)</font>
         need_crc <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_IO_STATE_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_state <font color='#5555FF'>=</font> PNG_IO_READING <font color='#5555FF'>|</font> PNG_IO_CHUNK_CRC;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* The chunk CRC must be serialized in a single I/O call. */</font>
   <font color='#BB00BB'>png_read_data</font><font face='Lucida Console'>(</font>png_ptr, crc_bytes, <font color='#979000'>4</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>need_crc<font face='Lucida Console'>)</font>
   <b>{</b>
      crc <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>crc_bytes<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>crc <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>crc<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Manage the read buffer; this simply reallocates the buffer if it is not small
 * enough (or if it is not allocated).  The routine returns a pointer to the
 * buffer; if an error occurs and 'warn' is set the routine returns NULL, else
 * it will call png_error (via png_malloc) on failure.  (warn == 2 means
 * 'silent').
 */</font>
<font color='#0000FF'>static</font> png_bytep
<b><a name='png_read_buffer'></a>png_read_buffer</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_alloc_size_t new_size, <font color='#0000FF'><u>int</u></font> warn<font face='Lucida Console'>)</font>
<b>{</b>
   png_bytep buffer <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> new_size <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer_size<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer_size <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, buffer<font face='Lucida Console'>)</font>;
      buffer <font color='#5555FF'>=</font> NULL;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, <font color='#BB00BB'>png_malloc_base</font><font face='Lucida Console'>(</font>png_ptr, new_size<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>=</font> buffer;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer_size <font color='#5555FF'>=</font> new_size;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>warn <font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else silent */</font>
      <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_WARNINGS_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>warn<font face='Lucida Console'>)</font>
             <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>insufficient memory to read chunk</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
         <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_ERROR_TEXT_SUPPORTED
             <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>insufficient memory to read chunk</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
         <b>}</b>
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> buffer;
<b>}</b>

<font color='#009900'>/* png_inflate_claim: claim the zstream for some nefarious purpose that involves
 * decompression.  Returns Z_OK on success, else a zlib error code.  It checks
 * the owner but, in final release builds, just issues a warning if some other
 * chunk apparently owns the stream.  Prior to release it does a png_error.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_inflate_claim'></a>png_inflate_claim</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 owner<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>char</u></font> msg[<font color='#979000'>64</font>];

      <font color='#BB00BB'>PNG_STRING_FROM_CHUNK</font><font face='Lucida Console'>(</font>msg, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* So the message that results is "&lt;chunk&gt; using zstream"; this is an
       * internal error, but is very useful for debugging.  i18n requirements
       * are minimal.
       */</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>msg, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> msg<font face='Lucida Console'>)</font>, <font color='#979000'>4</font>, "<font color='#CC0000'> using zstream</font>"<font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>if</font> PNG_LIBPNG_BUILD_BASE_TYPE <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_LIBPNG_BUILD_RC
         <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr, msg<font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, msg<font face='Lucida Console'>)</font>;
#     endif
   <b>}</b>

   <font color='#009900'>/* Implementation note: unlike 'png_deflate_claim' this internal function
    * does not take the size of the data as an argument.  Some efficiency could
    * be gained by using this when it is known *if* the zlib stream itself does
    * not record the number; however, this is an illusion: the original writer
    * of the PNG may have selected a lower window size, and we really must
    * follow that because, for systems with with limited capabilities, we
    * would otherwise reject the application's attempts to use a smaller window
    * size (zlib doesn't have an interface to say "this or lower"!).
    *
    * inflateReset2 was added to zlib 1.2.4; before this the window could not be
    * reset, therefore it is necessary to always allocate the maximum window
    * size with earlier zlibs just in case later compressed chunks need it.
    */</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> ret; <font color='#009900'>/* zlib return code */</font>
#     <font color='#0000FF'>if</font> PNG_ZLIB_VERNUM <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0x1240</font>

#        <font color='#0000FF'>if</font> <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_SET_OPTION_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
            <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_MAXIMUM_INFLATE_WINDOW<font face='Lucida Console'>)</font>
            <font color='#0000FF'><u>int</u></font> window_bits;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>options <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> PNG_MAXIMUM_INFLATE_WINDOW<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
               PNG_OPTION_ON<font face='Lucida Console'>)</font>
               window_bits <font color='#5555FF'>=</font> <font color='#979000'>15</font>;

            <font color='#0000FF'>else</font>
               window_bits <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#        <font color='#0000FF'>else</font>
#           define window_bits <font color='#979000'>0</font>
#        endif
#     endif

      <font color='#009900'>/* Set this for safety, just in case the previous owner left pointers to
       * memory allocations.
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ZSTREAM_INITIALIZED<font face='Lucida Console'>)</font>
      <b>{</b>
#        <font color='#0000FF'>if</font> PNG_ZLIB_VERNUM <font color='#5555FF'>&lt;</font> <font color='#979000'>0x1240</font>
            ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflateReset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font>;
#        <font color='#0000FF'>else</font>
            ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflateReset2</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream, window_bits<font face='Lucida Console'>)</font>;
#        endif
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
#        <font color='#0000FF'>if</font> PNG_ZLIB_VERNUM <font color='#5555FF'>&lt;</font> <font color='#979000'>0x1240</font>
            ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflateInit</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font>;
#        <font color='#0000FF'>else</font>
            ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflateInit2</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream, window_bits<font face='Lucida Console'>)</font>;
#        endif

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_ZSTREAM_INITIALIZED;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> owner;

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font> ret;
   <b>}</b>

#  ifdef window_bits
#     undef window_bits
#  endif
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_COMPRESSED_TEXT_SUPPORTED
<font color='#009900'>/* png_inflate now returns zlib error codes including Z_OK and Z_STREAM_END to
 * allow the caller to do multiple calls if required.  If the 'finish' flag is
 * set Z_FINISH will be passed to the final inflate() call and Z_STREAM_END must
 * be returned or there has been a problem, otherwise Z_SYNC_FLUSH is used and
 * Z_OK or Z_STREAM_END will be returned on success.
 *
 * The input and output sizes are updated to the actual amounts of data consumed
 * or written, not the amount available (as in a z_stream).  The data pointers
 * are not changed, so the next input is (data+input_size) and the next
 * available output is (output+output_size).
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_inflate'></a>png_inflate</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 owner, <font color='#0000FF'><u>int</u></font> finish,
    <font color='#009900'>/* INPUT: */</font> png_const_bytep input, png_uint_32p input_size_ptr,
    <font color='#009900'>/* OUTPUT: */</font> png_bytep output, png_alloc_size_t <font color='#5555FF'>*</font>output_size_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font><font color='#5555FF'>=</font> owner<font face='Lucida Console'>)</font> <font color='#009900'>/* Else not claimed */</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> ret;
      png_alloc_size_t avail_out <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>output_size_ptr;
      png_uint_32 avail_in <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>input_size_ptr;

      <font color='#009900'>/* zlib can't necessarily handle more than 65535 bytes at once (i.e. it
       * can't even necessarily handle 65536 bytes) because the type uInt is
       * "16 bits or more".  Consequently it is necessary to chunk the input to
       * zlib.  This code uses ZLIB_IO_MAX, from pngpriv.h, as the maximum (the
       * maximum value that can be stored in a uInt.)  It is possible to set
       * ZLIB_IO_MAX to a lower value in pngpriv.h and this may sometimes have
       * a performance advantage, because it reduces the amount of data accessed
       * at each step and that may give the OS more time to page it in.
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_INPUT_CAST</font><font face='Lucida Console'>(</font>input<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* avail_in and avail_out are set below from 'size' */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* Read directly into the output if it is available (this is set to
       * a local buffer below if output is NULL).
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> output;

      <font color='#0000FF'>do</font>
      <b>{</b>
         uInt avail;
         Byte local_buffer[PNG_INFLATE_BUF_SIZE];

         <font color='#009900'>/* zlib INPUT BUFFER */</font>
         <font color='#009900'>/* The setting of 'avail_in' used to be outside the loop; by setting it
          * inside it is possible to chunk the input to zlib and simply rely on
          * zlib to advance the 'next_in' pointer.  This allows arbitrary
          * amounts of data to be passed through zlib at the unavoidable cost of
          * requiring a window save (memcpy of up to 32768 output bytes)
          * every ZLIB_IO_MAX input bytes.
          */</font>
         avail_in <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in; <font color='#009900'>/* not consumed last time */</font>

         avail <font color='#5555FF'>=</font> ZLIB_IO_MAX;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_in <font color='#5555FF'>&lt;</font> avail<font face='Lucida Console'>)</font>
            avail <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>avail_in; <font color='#009900'>/* safe: &lt; than ZLIB_IO_MAX */</font>

         avail_in <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> avail;

         <font color='#009900'>/* zlib OUTPUT BUFFER */</font>
         avail_out <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out; <font color='#009900'>/* not written last time */</font>

         avail <font color='#5555FF'>=</font> ZLIB_IO_MAX; <font color='#009900'>/* maximum zlib can process */</font>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Reset the output buffer each time round if output is NULL and
             * make available the full buffer, up to 'remaining_space'
             */</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> local_buffer;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> local_buffer<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> avail<font face='Lucida Console'>)</font>
               avail <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> local_buffer<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_out <font color='#5555FF'>&lt;</font> avail<font face='Lucida Console'>)</font>
            avail <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>avail_out; <font color='#009900'>/* safe: &lt; ZLIB_IO_MAX */</font>

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> avail;
         avail_out <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail;

         <font color='#009900'>/* zlib inflate call */</font>
         <font color='#009900'>/* In fact 'avail_out' may be 0 at this point, that happens at the end
          * of the read when the final LZ end code was not passed at the end of
          * the previous chunk of input data.  Tell zlib if we have reached the
          * end of the output buffer.
          */</font>
         ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflate</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream, avail_out <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? Z_NO_FLUSH :
            <font face='Lucida Console'>(</font>finish ? Z_FINISH : Z_SYNC_FLUSH<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* For safety kill the local buffer pointer now */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> NULL;

      <font color='#009900'>/* Claw back the 'size' and 'remaining_space' byte counts. */</font>
      avail_in <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in;
      avail_out <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;

      <font color='#009900'>/* Update the input and output sizes; the updated values are the amount
       * consumed or written, effectively the inverse of what zlib uses.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_out <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#5555FF'>*</font>output_size_ptr <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail_out;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_in <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#5555FF'>*</font>input_size_ptr <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail_in;

      <font color='#009900'>/* Ensure png_ptr-&gt;zstream.msg is set (even in the success case!) */</font>
      <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> ret;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#009900'>/* This is a bad internal error.  The recovery assigns to the zstream msg
       * pointer, which is not owned by the caller, but this is safe; it's only
       * used on errors!
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>zstream unclaimed</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> Z_STREAM_ERROR;
   <b>}</b>
<b>}</b>

<font color='#009900'>/*
 * Decompress trailing data in a chunk.  The assumption is that read_buffer
 * points at an allocated area holding the contents of a chunk with a
 * trailing compressed part.  What we get back is an allocated area
 * holding the original prefix part and an uncompressed version of the
 * trailing part (the malloc area passed in is freed).
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_decompress_chunk'></a>png_decompress_chunk</b><font face='Lucida Console'>(</font>png_structrp png_ptr,
   png_uint_32 chunklength, png_uint_32 prefix_size,
   png_alloc_size_t <font color='#5555FF'>*</font>newlength <font color='#009900'>/* must be initialized to the maximum! */</font>,
   <font color='#0000FF'><u>int</u></font> terminate <font color='#009900'>/*add a '\0' to the end of the uncompressed data*/</font><font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* TODO: implement different limits for different types of chunk.
    *
    * The caller supplies *newlength set to the maximum length of the
    * uncompressed data, but this routine allocates space for the prefix and
    * maybe a '\0' terminator too.  We have to assume that 'prefix_size' is
    * limited only by the maximum chunk size.
    */</font>
   png_alloc_size_t limit <font color='#5555FF'>=</font> PNG_SIZE_MAX;

#  ifdef PNG_SET_CHUNK_MALLOC_LIMIT_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_malloc_max <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_malloc_max <font color='#5555FF'>&lt;</font> limit<font face='Lucida Console'>)</font>
         limit <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_malloc_max;
#  elif PNG_USER_CHUNK_MALLOC_MAX <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_USER_CHUNK_MALLOC_MAX <font color='#5555FF'>&lt;</font> limit<font face='Lucida Console'>)</font>
         limit <font color='#5555FF'>=</font> PNG_USER_CHUNK_MALLOC_MAX;
#  endif

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>limit <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> prefix_size <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>terminate <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> ret;

      limit <font color='#5555FF'>-</font><font color='#5555FF'>=</font> prefix_size <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>terminate <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>limit <font color='#5555FF'>&lt;</font> <font color='#5555FF'>*</font>newlength<font face='Lucida Console'>)</font>
         <font color='#5555FF'>*</font>newlength <font color='#5555FF'>=</font> limit;

      <font color='#009900'>/* Now try to claim the stream. */</font>
      ret <font color='#5555FF'>=</font> <font color='#BB00BB'>png_inflate_claim</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_32 lzsize <font color='#5555FF'>=</font> chunklength <font color='#5555FF'>-</font> prefix_size;

         ret <font color='#5555FF'>=</font> <font color='#BB00BB'>png_inflate</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name, <font color='#979000'>1</font><font color='#009900'>/*finish*/</font>,
            <font color='#009900'>/* input: */</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>+</font> prefix_size, <font color='#5555FF'>&amp;</font>lzsize,
            <font color='#009900'>/* output: */</font> NULL, newlength<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Use 'inflateReset' here, not 'inflateReset2' because this
             * preserves the previously decided window size (otherwise it would
             * be necessary to store the previous window size.)  In practice
             * this doesn't matter anyway, because png_inflate will call inflate
             * with Z_FINISH in almost all cases, so the window will not be
             * maintained.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>inflateReset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Because of the limit checks above we know that the new,
                * expanded, size will fit in a size_t (let alone an
                * png_alloc_size_t).  Use png_malloc_base here to avoid an
                * extra OOM message.
                */</font>
               png_alloc_size_t new_size <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>newlength;
               png_alloc_size_t buffer_size <font color='#5555FF'>=</font> prefix_size <font color='#5555FF'>+</font> new_size <font color='#5555FF'>+</font>
                  <font face='Lucida Console'>(</font>terminate <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
               png_bytep text <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, <font color='#BB00BB'>png_malloc_base</font><font face='Lucida Console'>(</font>png_ptr,
                  buffer_size<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>text <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  ret <font color='#5555FF'>=</font> <font color='#BB00BB'>png_inflate</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name, <font color='#979000'>1</font><font color='#009900'>/*finish*/</font>,
                     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>+</font> prefix_size, <font color='#5555FF'>&amp;</font>lzsize,
                     text <font color='#5555FF'>+</font> prefix_size, newlength<font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>new_size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>newlength<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>terminate<font face='Lucida Console'>)</font>
                           text[prefix_size <font color='#5555FF'>+</font> <font color='#5555FF'>*</font>newlength] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>prefix_size <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                           <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>text, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer, prefix_size<font face='Lucida Console'>)</font>;

                        <b>{</b>
                           png_bytep old_ptr <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer;

                           png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>=</font> text;
                           png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer_size <font color='#5555FF'>=</font> buffer_size;
                           text <font color='#5555FF'>=</font> old_ptr; <font color='#009900'>/* freed below */</font>
                        <b>}</b>
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        <font color='#009900'>/* The size changed on the second read, there can be no
                         * guarantee that anything is correct at this point.
                         * The 'msg' pointer has been set to "unexpected end of
                         * LZ stream", which is fine, but return an error code
                         * that the caller won't accept.
                         */</font>
                        ret <font color='#5555FF'>=</font> PNG_UNEXPECTED_ZLIB_RETURN;
                     <b>}</b>
                  <b>}</b>

                  <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
                     ret <font color='#5555FF'>=</font> PNG_UNEXPECTED_ZLIB_RETURN; <font color='#009900'>/* for safety */</font>

                  <font color='#009900'>/* Free the text pointer (this is the old read_buffer on
                   * success)
                   */</font>
                  <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, text<font face='Lucida Console'>)</font>;

                  <font color='#009900'>/* This really is very benign, but it's still an error because
                   * the extra space may otherwise be used as a Trojan Horse.
                   */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                     chunklength <font color='#5555FF'>-</font> prefix_size <font color='#5555FF'>!</font><font color='#5555FF'>=</font> lzsize<font face='Lucida Console'>)</font>
                     <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>extra compressed data</font>"<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  <font color='#009900'>/* Out of memory allocating the buffer */</font>
                  ret <font color='#5555FF'>=</font> Z_MEM_ERROR;
                  <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, Z_MEM_ERROR<font face='Lucida Console'>)</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font>
            <b>{</b>
               <font color='#009900'>/* inflateReset failed, store the error message */</font>
               <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font>
                  ret <font color='#5555FF'>=</font> PNG_UNEXPECTED_ZLIB_RETURN;
            <b>}</b>
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
            ret <font color='#5555FF'>=</font> PNG_UNEXPECTED_ZLIB_RETURN;

         <font color='#009900'>/* Release the claimed stream */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#009900'>/* the claim failed */</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font> <font color='#009900'>/* impossible! */</font>
         ret <font color='#5555FF'>=</font> PNG_UNEXPECTED_ZLIB_RETURN;

      <font color='#0000FF'>return</font> ret;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#009900'>/* Application/configuration limits exceeded */</font>
      <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, Z_MEM_ERROR<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> Z_MEM_ERROR;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_COMPRESSED_TEXT_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iCCP_SUPPORTED
<font color='#009900'>/* Perform a partial read and decompress, producing 'avail_out' bytes and
 * reading from the current chunk as required.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_inflate_read'></a>png_inflate_read</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytep read_buffer, uInt read_size,
   png_uint_32p chunk_bytes, png_bytep next_out, png_alloc_size_t <font color='#5555FF'>*</font>out_size,
   <font color='#0000FF'><u>int</u></font> finish<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> ret;

      <font color='#009900'>/* next_in and avail_in must have been initialized by the caller. */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> next_out;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* set in the loop */</font>

      <font color='#0000FF'>do</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>read_size <font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font>chunk_bytes<font face='Lucida Console'>)</font>
               read_size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>chunk_bytes;
            <font color='#5555FF'>*</font>chunk_bytes <font color='#5555FF'>-</font><font color='#5555FF'>=</font> read_size;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>read_size <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, read_buffer, read_size<font face='Lucida Console'>)</font>;

            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> read_buffer;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> read_size;
         <b>}</b>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            uInt avail <font color='#5555FF'>=</font> ZLIB_IO_MAX;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail <font color='#5555FF'>&gt;</font> <font color='#5555FF'>*</font>out_size<font face='Lucida Console'>)</font>
               avail <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>out_size;
            <font color='#5555FF'>*</font>out_size <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail;

            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> avail;
         <b>}</b>

         <font color='#009900'>/* Use Z_SYNC_FLUSH when there is no more chunk data to ensure that all
          * the available output is produced; this allows reading of truncated
          * streams.
          */</font>
         ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflate</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream,
            <font color='#5555FF'>*</font>chunk_bytes <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? Z_NO_FLUSH : <font face='Lucida Console'>(</font>finish ? Z_FINISH : Z_SYNC_FLUSH<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <b>}</b>
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>out_size <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      <font color='#5555FF'>*</font>out_size <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* Should not be required, but is safe */</font>

      <font color='#009900'>/* Ensure the error message pointer is always set: */</font>
      <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> ret;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>zstream unclaimed</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> Z_STREAM_ERROR;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Read and check the IDHR chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_IHDR'></a>png_handle_IHDR</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>13</font>];
   png_uint_32 width, height;
   <font color='#0000FF'><u>int</u></font> bit_depth, color_type, compression_type, filter_type;
   <font color='#0000FF'><u>int</u></font> interlace_type;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Check the length */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>13</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_IHDR;

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>13</font><font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

   width <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_31</font><font face='Lucida Console'>(</font>png_ptr, buf<font face='Lucida Console'>)</font>;
   height <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_31</font><font face='Lucida Console'>(</font>png_ptr, buf <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
   bit_depth <font color='#5555FF'>=</font> buf[<font color='#979000'>8</font>];
   color_type <font color='#5555FF'>=</font> buf[<font color='#979000'>9</font>];
   compression_type <font color='#5555FF'>=</font> buf[<font color='#979000'>10</font>];
   filter_type <font color='#5555FF'>=</font> buf[<font color='#979000'>11</font>];
   interlace_type <font color='#5555FF'>=</font> buf[<font color='#979000'>12</font>];

   <font color='#009900'>/* Set internal variables */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>=</font> width;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>=</font> height;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>bit_depth;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>interlace_type;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>color_type;
<font color='#0000FF'>#ifdef</font> PNG_MNG_FEATURES_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>filter_type;
<font color='#0000FF'>#endif</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>compression_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>compression_type;

   <font color='#009900'>/* Find number of channels */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>default</font>: <font color='#009900'>/* invalid, png_set_IHDR calls png_error */</font>
      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY:
      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_PALETTE:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY_ALPHA:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB_ALPHA:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#009900'>/* Set up other useful info */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>*</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>bit_depth = %d</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>channels = %d</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>rowbytes = %lu</font>", <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_set_IHDR</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, width, height, bit_depth,
       color_type, interlace_type, compression_type, filter_type<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Read and check the palette */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_PLTE'></a>png_handle_PLTE</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_color palette[PNG_MAX_PALETTE_LENGTH];
   <font color='#0000FF'><u>int</u></font> num, i;
<font color='#0000FF'>#ifdef</font> PNG_POINTER_INDEXING_SUPPORTED
   png_colorp pal_ptr;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_PLTE</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Moved to before the 'after IDAT' check below because otherwise duplicate
    * PLTE chunks are potentially ignored (the spec says there shall not be more
    * than one PLTE, the error is not treated as benign, so this check trumps
    * the requirement that PLTE appears before IDAT.)
    */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PLTE<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* This is benign because the non-benign error happened before, when an
       * IDAT was encountered in a color-mapped image with no PLTE.
       */</font>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_PLTE;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>ignored in grayscale PNG</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

<font color='#0000FF'>#ifndef</font> PNG_READ_OPT_PLTE_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font color='#5555FF'>*</font>PNG_MAX_PALETTE_LENGTH <font color='#5555FF'>|</font><font color='#5555FF'>|</font> length <font color='#5555FF'>%</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* The cast is safe because 'length' is less than 3*PNG_MAX_PALETTE_LENGTH */</font>
   num <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>length <font color='#5555FF'>/</font> <font color='#979000'>3</font>;

<font color='#0000FF'>#ifdef</font> PNG_POINTER_INDEXING_SUPPORTED
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, pal_ptr <font color='#5555FF'>=</font> palette; i <font color='#5555FF'>&lt;</font> num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, pal_ptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte buf[<font color='#979000'>3</font>];

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
      pal_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      pal_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>=</font> buf[<font color='#979000'>1</font>];
      pal_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>=</font> buf[<font color='#979000'>2</font>];
   <b>}</b>
<font color='#0000FF'>#else</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte buf[<font color='#979000'>3</font>];

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
      <font color='#009900'>/* Don't depend upon png_color being any order */</font>
      palette[i].red <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      palette[i].green <font color='#5555FF'>=</font> buf[<font color='#979000'>1</font>];
      palette[i].blue <font color='#5555FF'>=</font> buf[<font color='#979000'>2</font>];
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* If we actually need the PLTE chunk (ie for a paletted image), we do
    * whatever the normal CRC configuration tells us.  However, if we
    * have an RGB image, the PLTE can be considered ancillary, so
    * we will act as though it is.
    */</font>
<font color='#0000FF'>#ifndef</font> PNG_READ_OPT_PLTE_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
   <b>}</b>

<font color='#0000FF'>#ifndef</font> PNG_READ_OPT_PLTE_SUPPORTED
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_error</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>  <font color='#009900'>/* Only if we have a CRC error */</font>
   <b>{</b>
      <font color='#009900'>/* If we don't want to use the data from an ancillary chunk,
       * we have two options: an error abort, or a warning and we
       * ignore the data in this chunk (which should be OK, since
       * it's considered ancillary for a RGB or RGBA image).
       *
       * IMPLEMENTATION NOTE: this is only here because png_crc_finish uses the
       * chunk type to determine whether to check the ancillary or the critical
       * flags.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_ANCILLARY_USE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_ANCILLARY_NOWARN<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>CRC error</font>"<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>CRC error</font>"<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font>;
         <b>}</b>
      <b>}</b>

      <font color='#009900'>/* Otherwise, we (optionally) emit a warning and use the chunk. */</font>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_ANCILLARY_NOWARN<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>CRC error</font>"<font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* TODO: png_set_PLTE has the side effect of setting png_ptr-&gt;palette to its
    * own copy of the palette.  This has the side effect that when png_start_row
    * is called (this happens after any call to png_read_update_info) the
    * info_ptr palette gets changed.  This is extremely unexpected and
    * confusing.
    *
    * Fix this by not sharing the palette in this way.
    */</font>
   <font color='#BB00BB'>png_set_PLTE</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, palette, num<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The three chunks, bKGD, hIST and tRNS *must* appear after PLTE and before
    * IDAT.  Prior to 1.6.0 this was not checked; instead the code merely
    * checked the apparent validity of a tRNS chunk inserted before PLTE on a
    * palette PNG.  1.6.0 attempts to rigorously follow the standard and
    * therefore does a benign error if the erroneous condition is detected *and*
    * cancels the tRNS if the benign error returns.  The alternative is to
    * amend the standard since it would be rather hypocritical of the standards
    * maintainers to ignore it.
    */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_tRNS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_tRNS<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Cancel this because otherwise it would be used if the transforms
       * require it.  Don't cancel the 'valid' flag because this would prevent
       * detection of duplicate chunks.
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>tRNS must be after</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_hIST_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_hIST<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>hIST must be after</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_bKGD_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_bKGD<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bKGD must be after</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_IEND'></a>png_handle_IEND</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_IEND</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>PNG_AFTER_IDAT <font color='#5555FF'>|</font> PNG_HAVE_IEND<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>info_ptr<font face='Lucida Console'>)</font>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_gAMA_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_gAMA'></a>png_handle_gAMA</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_fixed_point igamma;
   png_byte buf[<font color='#979000'>4</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_gAMA</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_HAVE_IDAT<font color='#5555FF'>|</font>PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>4</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   igamma <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_colorspace_set_gamma</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace, igamma<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sBIT_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_sBIT'></a>png_handle_sBIT</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> truelen;
   png_byte buf[<font color='#979000'>4</font>];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_sBIT</font>"<font face='Lucida Console'>)</font>;

   buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> buf[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_HAVE_IDAT<font color='#5555FF'>|</font>PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_sBIT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      truelen <font color='#5555FF'>=</font> <font color='#979000'>3</font>;

   <font color='#0000FF'>else</font>
      truelen <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> truelen <font color='#5555FF'>|</font><font color='#5555FF'>|</font> length <font color='#5555FF'>&gt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, truelen<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.red <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.green <font color='#5555FF'>=</font> buf[<font color='#979000'>1</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.blue <font color='#5555FF'>=</font> buf[<font color='#979000'>2</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.alpha <font color='#5555FF'>=</font> buf[<font color='#979000'>3</font>];
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.gray <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.red <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.green <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.blue <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.alpha <font color='#5555FF'>=</font> buf[<font color='#979000'>1</font>];
   <b>}</b>

   <font color='#BB00BB'>png_set_sBIT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_cHRM_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_cHRM'></a>png_handle_cHRM</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>32</font>];
   png_xy xy;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_cHRM</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_HAVE_IDAT<font color='#5555FF'>|</font>PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>32</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>32</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   xy.whitex <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf<font face='Lucida Console'>)</font>;
   xy.whitey <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
   xy.redx   <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
   xy.redy   <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font>;
   xy.greenx <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
   xy.greeny <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>20</font><font face='Lucida Console'>)</font>;
   xy.bluex  <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font>;
   xy.bluey  <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_fixed_point</font><font face='Lucida Console'>(</font>NULL, buf <font color='#5555FF'>+</font> <font color='#979000'>28</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy.whitex <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.whitey <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.redx   <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.redy   <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.greenx <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.greeny <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.bluex  <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       xy.bluey  <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FIXED_ERROR<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid values</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* If a colorspace error has already been output skip this chunk */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_FROM_cHRM<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
      <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_FROM_cHRM;
   <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_colorspace_set_chromaticities</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace, <font color='#5555FF'>&amp;</font>xy,
      <font color='#979000'>1</font><font color='#009900'>/*prefer cHRM values*/</font><font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sRGB_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_sRGB'></a>png_handle_sRGB</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte intent;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_sRGB</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_HAVE_IDAT<font color='#5555FF'>|</font>PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>intent, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* If a colorspace error has already been output skip this chunk */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* Only one sRGB or iCCP chunk is allowed, use the HAVE_INTENT flag to detect
    * this.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_INTENT<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
      <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>too many profiles</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_colorspace_set_sRGB</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace, intent<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_sRGB_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iCCP_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_iCCP'></a>png_handle_iCCP</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<font color='#009900'>/* Note: this does not properly handle profiles that are &gt; 64K under DOS */</font>
<b>{</b>
   png_const_charp errmsg <font color='#5555FF'>=</font> NULL; <font color='#009900'>/* error message output, or no error */</font>
   <font color='#0000FF'><u>int</u></font> finished <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* crc checked */</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_iCCP</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_HAVE_IDAT<font color='#5555FF'>|</font>PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* Consistent with all the above colorspace handling an obviously *invalid*
    * chunk is just ignored, so does not invalidate the color space.  An
    * alternative is to set the 'invalid' flags at the start of this routine
    * and only clear them in they were not set before and all the tests pass.
    * The minimum 'deflate' stream is assumed to be just the 2 byte header and 4
    * byte checksum.  The keyword must be one character and there is a
    * terminator (0) byte and the compression method.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&lt;</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>too short</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* If a colorspace error has already been output skip this chunk */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* Only one sRGB or iCCP chunk is allowed, use the HAVE_INTENT flag to detect
    * this.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_INTENT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      uInt read_length, keyword_length;
      <font color='#0000FF'><u>char</u></font> keyword[<font color='#979000'>81</font>];

      <font color='#009900'>/* Find the keyword; the keyword plus separator and compression method
       * bytes can be at most 81 characters long.
       */</font>
      read_length <font color='#5555FF'>=</font> <font color='#979000'>81</font>; <font color='#009900'>/* maximum */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>read_length <font color='#5555FF'>&gt;</font> length<font face='Lucida Console'>)</font>
         read_length <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>length;

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font>keyword, read_length<font face='Lucida Console'>)</font>;
      length <font color='#5555FF'>-</font><font color='#5555FF'>=</font> read_length;

      keyword_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>keyword_length <font color='#5555FF'>&lt;</font> <font color='#979000'>80</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> keyword_length <font color='#5555FF'>&lt;</font> read_length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         keyword[keyword_length] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#5555FF'>+</font><font color='#5555FF'>+</font>keyword_length;

      <font color='#009900'>/* TODO: make the keyword checking common */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keyword_length <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> keyword_length <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>79</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* We only understand '0' compression - deflate - so if we get a
          * different value we can't safely decode the chunk.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keyword_length<font color='#5555FF'>+</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font> read_length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            keyword[keyword_length<font color='#5555FF'>+</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font>
         <b>{</b>
            read_length <font color='#5555FF'>-</font><font color='#5555FF'>=</font> keyword_length<font color='#5555FF'>+</font><font color='#979000'>2</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_inflate_claim</font><font face='Lucida Console'>(</font>png_ptr, png_iCCP<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
            <b>{</b>
               Byte profile_header[<font color='#979000'>132</font>];
               Byte local_buffer[PNG_INFLATE_BUF_SIZE];
               png_alloc_size_t size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> profile_header<font face='Lucida Console'>)</font>;

               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Bytef<font color='#5555FF'>*</font><font face='Lucida Console'>)</font>keyword <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>keyword_length<font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> read_length;
               <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_inflate_read</font><font face='Lucida Console'>(</font>png_ptr, local_buffer,
                  <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> local_buffer<font face='Lucida Console'>)</font>, <font color='#5555FF'>&amp;</font>length, profile_header, <font color='#5555FF'>&amp;</font>size,
                  <font color='#979000'>0</font><font color='#009900'>/*finish: don't, because the output is too small*/</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#009900'>/* We have the ICC profile header; do the basic header checks.
                   */</font>
                  <font color='#0000FF'>const</font> png_uint_32 profile_length <font color='#5555FF'>=</font>
                     <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile_header<font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_icc_check_length</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace,
                     keyword, profile_length<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* The length is apparently ok, so we can check the 132
                      * byte header.
                      */</font>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_icc_check_header</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace,
                        keyword, profile_length, profile_header,
                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#009900'>/* Now read the tag table; a variable size buffer is
                         * needed at this point, allocate one for the whole
                         * profile.  The header check has already validated
                         * that none of these stuff will overflow.
                         */</font>
                        <font color='#0000FF'>const</font> png_uint_32 tag_count <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>
                           profile_header<font color='#5555FF'>+</font><font color='#979000'>128</font><font face='Lucida Console'>)</font>;
                        png_bytep profile <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr,
                           profile_length, <font color='#979000'>2</font><font color='#009900'>/*silent*/</font><font face='Lucida Console'>)</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>profile, profile_header,
                              <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> profile_header<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                           size <font color='#5555FF'>=</font> <font color='#979000'>12</font> <font color='#5555FF'>*</font> tag_count;

                           <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_inflate_read</font><font face='Lucida Console'>(</font>png_ptr, local_buffer,
                              <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> local_buffer<font face='Lucida Console'>)</font>, <font color='#5555FF'>&amp;</font>length,
                              profile <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> profile_header<font face='Lucida Console'>)</font>, <font color='#5555FF'>&amp;</font>size, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

                           <font color='#009900'>/* Still expect a a buffer error because we expect
                            * there to be some tag data!
                            */</font>
                           <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                           <b>{</b>
                              <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_icc_check_tag_table</font><font face='Lucida Console'>(</font>png_ptr,
                                 <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace, keyword, profile_length,
                                 profile<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                              <b>{</b>
                                 <font color='#009900'>/* The profile has been validated for basic
                                  * security issues, so read the whole thing in.
                                  */</font>
                                 size <font color='#5555FF'>=</font> profile_length <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> profile_header<font face='Lucida Console'>)</font>
                                    <font color='#5555FF'>-</font> <font color='#979000'>12</font> <font color='#5555FF'>*</font> tag_count;

                                 <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_inflate_read</font><font face='Lucida Console'>(</font>png_ptr, local_buffer,
                                    <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> local_buffer<font face='Lucida Console'>)</font>, <font color='#5555FF'>&amp;</font>length,
                                    profile <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> profile_header<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                                    <font color='#979000'>12</font> <font color='#5555FF'>*</font> tag_count, <font color='#5555FF'>&amp;</font>size, <font color='#979000'>1</font><font color='#009900'>/*finish*/</font><font face='Lucida Console'>)</font>;

                                 <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font>
                                       PNG_FLAG_BENIGN_ERRORS_WARN<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                                    errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>extra compressed data</font>";

                                 <font color='#009900'>/* But otherwise allow extra data: */</font>
                                 <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                                 <b>{</b>
                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                                    <b>{</b>
                                       <font color='#009900'>/* This can be handled completely, so
                                        * keep going.
                                        */</font>
                                       <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr,
                                          "<font color='#CC0000'>extra compressed data</font>"<font face='Lucida Console'>)</font>;
                                    <b>}</b>

                                    <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
                                    finished <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

#                                   ifdef PNG_sRGB_SUPPORTED
                                       <font color='#009900'>/* Check for a match against sRGB */</font>
                                       <font color='#BB00BB'>png_icc_set_sRGB</font><font face='Lucida Console'>(</font>png_ptr,
                                          <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace, profile,
                                          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.adler<font face='Lucida Console'>)</font>;
#                                   endif

                                    <font color='#009900'>/* Steal the profile for info_ptr. */</font>
                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                                    <b>{</b>
                                       <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr,
                                          PNG_FREE_ICCP, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

                                       info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_name <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font color='#5555FF'>*</font>,
                                          <font color='#BB00BB'>png_malloc_base</font><font face='Lucida Console'>(</font>png_ptr,
                                          keyword_length<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                                       <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_name <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                                       <b>{</b>
                                          <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_name, keyword,
                                             keyword_length<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                                          info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_proflen <font color='#5555FF'>=</font>
                                             profile_length;
                                          info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_profile <font color='#5555FF'>=</font> profile;
                                          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>=</font> NULL; <font color='#009900'>/*steal*/</font>
                                          info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FREE_ICCP;
                                          info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_INFO_iCCP;
                                       <b>}</b>

                                       <font color='#0000FF'>else</font>
                                       <b>{</b>
                                          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font>
                                             PNG_COLORSPACE_INVALID;
                                          errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>out of memory</font>";
                                       <b>}</b>
                                    <b>}</b>

                                    <font color='#009900'>/* else the profile remains in the read
                                     * buffer which gets reused for subsequent
                                     * chunks.
                                     */</font>

                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                                       <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>errmsg <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                                    <b>{</b>
                                       png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                                       <font color='#0000FF'>return</font>;
                                    <b>}</b>
                                 <b>}</b>

                                 <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                                    errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>truncated</font>";

                                 <font color='#0000FF'>else</font>
                                    errmsg <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg;
                              <b>}</b>

                              <font color='#009900'>/* else png_icc_check_tag_table output an error */</font>
                           <b>}</b>

                           <font color='#0000FF'>else</font> <font color='#009900'>/* profile truncated */</font>
                              errmsg <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                           errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>out of memory</font>";
                     <b>}</b>

                     <font color='#009900'>/* else png_icc_check_header output an error */</font>
                  <b>}</b>

                  <font color='#009900'>/* else png_icc_check_length output an error */</font>
               <b>}</b>

               <font color='#0000FF'>else</font> <font color='#009900'>/* profile truncated */</font>
                  errmsg <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg;

               <font color='#009900'>/* Release the stream */</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* png_inflate_claim failed */</font>
               errmsg <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg;
         <b>}</b>

         <font color='#0000FF'>else</font>
            errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>bad compression method</font>"; <font color='#009900'>/* or missing */</font>
      <b>}</b>

      <font color='#0000FF'>else</font>
         errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>bad keyword</font>";
   <b>}</b>

   <font color='#0000FF'>else</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>too many profiles</font>";

   <font color='#009900'>/* Failure: the reason is in 'errmsg' */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>finished<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
   <font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>errmsg <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <font color='#009900'>/* else already output */</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, errmsg<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_iCCP_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sPLT_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_sPLT'></a>png_handle_sPLT</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<font color='#009900'>/* Note: this does not properly handle chunks that are &gt; 64K under DOS */</font>
<b>{</b>
   png_bytep entry_start, buffer;
   png_sPLT_t new_palette;
   png_sPLT_entryp pp;
   png_uint_32 data_length;
   <font color='#0000FF'><u>int</u></font> entry_size, i;
   png_uint_32 skip <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   png_uint_32 dl;
   png_size_t max_dl;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_sPLT</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_USER_LIMITS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>No space in chunk cache for sPLT</font>"<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_MAX_MALLOC_64K
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>65535</font>U<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>too large to fit in memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, length<font color='#5555FF'>+</font><font color='#979000'>1</font>, <font color='#979000'>2</font><font color='#009900'>/*silent*/</font><font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>


   <font color='#009900'>/* WARNING: this may break if size_t is less than 32 bits; it is assumed
    * that the PNG_MAX_MALLOC_64K test is enabled in this case, but this is a
    * potential breakage point if the types in pngconf.h aren't exactly right.
    */</font>
   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, length<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, skip<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   buffer[length] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>entry_start <font color='#5555FF'>=</font> buffer; <font color='#5555FF'>*</font>entry_start; entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <font color='#009900'>/* Empty loop to find end of name */</font> ;

   <font color='#5555FF'>+</font><font color='#5555FF'>+</font>entry_start;

   <font color='#009900'>/* A sample depth should follow the separator, and we should be on it  */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>entry_start <font color='#5555FF'>&gt;</font> buffer <font color='#5555FF'>+</font> length <font color='#5555FF'>-</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>malformed sPLT chunk</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   new_palette.depth <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   entry_size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>new_palette.depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> ? <font color='#979000'>6</font> : <font color='#979000'>10</font><font face='Lucida Console'>)</font>;
   <font color='#009900'>/* This must fit in a png_uint_32 because it is derived from the original
    * chunk data length.
    */</font>
   data_length <font color='#5555FF'>=</font> length <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>entry_start <font color='#5555FF'>-</font> buffer<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Integrity-check the data length */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>data_length <font color='#5555FF'>%</font> entry_size<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>sPLT chunk has bad length</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   dl <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_int_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>data_length <font color='#5555FF'>/</font> entry_size<font face='Lucida Console'>)</font>;
   max_dl <font color='#5555FF'>=</font> PNG_SIZE_MAX <font color='#5555FF'>/</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_sPLT_entry<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dl <font color='#5555FF'>&gt;</font> max_dl<font face='Lucida Console'>)</font>
   <b>{</b>
       <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>sPLT chunk too long</font>"<font face='Lucida Console'>)</font>;
       <font color='#0000FF'>return</font>;
   <b>}</b>

   new_palette.nentries <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_int_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>data_length <font color='#5555FF'>/</font> entry_size<font face='Lucida Console'>)</font>;

   new_palette.entries <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_sPLT_entryp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font>
       png_ptr, new_palette.nentries <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_sPLT_entry<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>new_palette.entries <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
       <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>sPLT chunk requires too much memory</font>"<font face='Lucida Console'>)</font>;
       <font color='#0000FF'>return</font>;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_POINTER_INDEXING_SUPPORTED
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> new_palette.nentries; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      pp <font color='#5555FF'>=</font> new_palette.entries <font color='#5555FF'>+</font> i;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>new_palette.depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red   <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue  <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
      <b>}</b>

      pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>frequency <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
   <b>}</b>
<font color='#0000FF'>#else</font>
   pp <font color='#5555FF'>=</font> new_palette.entries;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> new_palette.nentries; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>new_palette.depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         pp[i].red   <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         pp[i].green <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         pp[i].blue  <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         pp[i].alpha <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>entry_start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         pp[i].red   <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         pp[i].green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         pp[i].blue  <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         pp[i].alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
      <b>}</b>

      pp[i].frequency <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>entry_start<font face='Lucida Console'>)</font>; entry_start <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Discard all chunk data except the name and stash that */</font>
   new_palette.name <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer;

   <font color='#BB00BB'>png_set_sPLT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>new_palette, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, new_palette.entries<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_sPLT_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tRNS_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_tRNS'></a>png_handle_tRNS</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte readbuf[PNG_MAX_PALETTE_LENGTH];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_tRNS</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_tRNS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte buf[<font color='#979000'>2</font>];

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte buf[<font color='#979000'>6</font>];

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, length<font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* TODO: is this actually an error in the ISO spec? */</font>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette <font color='#5555FF'>|</font><font color='#5555FF'>|</font> length <font color='#5555FF'>&gt;</font> PNG_MAX_PALETTE_LENGTH <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         length <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, readbuf, length<font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>length;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid with alpha channel</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* TODO: this is a horrible side effect in the palette case because the
    * png_struct ends up with a pointer to the tRNS buffer owned by the
    * png_info.  Fix this.
    */</font>
   <font color='#BB00BB'>png_set_tRNS</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, readbuf, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans,
       <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_bKGD_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_bKGD'></a>png_handle_bKGD</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> truelen;
   png_byte buf[<font color='#979000'>6</font>];
   png_color_16 background;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_bKGD</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_bKGD<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      truelen <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
      truelen <font color='#5555FF'>=</font> <font color='#979000'>6</font>;

   <font color='#0000FF'>else</font>
      truelen <font color='#5555FF'>=</font> <font color='#979000'>2</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> truelen<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, truelen<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* We convert the index value into RGB components so that we can allow
    * arbitrary RGB values for background when we have transparency, and
    * so it is easy to determine the RGB values of the background color
    * from the info_ptr struct.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      background.index <font color='#5555FF'>=</font> buf[<font color='#979000'>0</font>];

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buf[<font color='#979000'>0</font>] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid index</font>"<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font>;
         <b>}</b>

         background.red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[buf[<font color='#979000'>0</font>]].red;
         background.green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[buf[<font color='#979000'>0</font>]].green;
         background.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[buf[<font color='#979000'>0</font>]].blue;
      <b>}</b>

      <font color='#0000FF'>else</font>
         background.red <font color='#5555FF'>=</font> background.green <font color='#5555FF'>=</font> background.blue <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      background.gray <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#009900'>/* GRAY */</font>
   <b>{</b>
      background.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      background.red <font color='#5555FF'>=</font>
      background.green <font color='#5555FF'>=</font>
      background.blue <font color='#5555FF'>=</font>
      background.gray <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      background.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      background.red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
      background.green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
      background.blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
      background.gray <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#BB00BB'>png_set_bKGD</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>background<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_hIST_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_hIST'></a>png_handle_hIST</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> num, i;
   png_uint_16 readbuf[PNG_MAX_PALETTE_LENGTH];

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_hIST</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_hIST<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   num <font color='#5555FF'>=</font> length <font color='#5555FF'>/</font> <font color='#979000'>2</font> ;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette <font color='#5555FF'>|</font><font color='#5555FF'>|</font> num <font color='#5555FF'>&gt;</font> PNG_MAX_PALETTE_LENGTH<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_byte buf[<font color='#979000'>2</font>];

      <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
      readbuf[i] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#BB00BB'>png_set_hIST</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, readbuf<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_pHYs_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_pHYs'></a>png_handle_pHYs</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>9</font>];
   png_uint_32 res_x, res_y;
   <font color='#0000FF'><u>int</u></font> unit_type;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_pHYs</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_pHYs<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>9</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   res_x <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
   res_y <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
   unit_type <font color='#5555FF'>=</font> buf[<font color='#979000'>8</font>];
   <font color='#BB00BB'>png_set_pHYs</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, res_x, res_y, unit_type<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_oFFs_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_oFFs'></a>png_handle_oFFs</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>9</font>];
   png_int_32 offset_x, offset_y;
   <font color='#0000FF'><u>int</u></font> unit_type;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_oFFs</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_oFFs<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>9</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   offset_x <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_int_32</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;
   offset_y <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_int_32</font><font face='Lucida Console'>(</font>buf <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>;
   unit_type <font color='#5555FF'>=</font> buf[<font color='#979000'>8</font>];
   <font color='#BB00BB'>png_set_oFFs</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, offset_x, offset_y, unit_type<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_pCAL_SUPPORTED
<font color='#009900'>/* Read the pCAL chunk (described in the PNG Extensions document) */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_pCAL'></a>png_handle_pCAL</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_int_32 X0, X1;
   png_byte type, nparams;
   png_bytep buffer, buf, units, endptr;
   png_charpp params;
   <font color='#0000FF'><u>int</u></font> i;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_pCAL</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_pCAL<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>, "<font color='#CC0000'>Allocating and reading pCAL chunk data (%u bytes)</font>",
       length <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, length<font color='#5555FF'>+</font><font color='#979000'>1</font>, <font color='#979000'>2</font><font color='#009900'>/*silent*/</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, length<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   buffer[length] <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* Null terminate the last string */</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>Finding end of pCAL purpose string</font>"<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>buf <font color='#5555FF'>=</font> buffer; <font color='#5555FF'>*</font>buf; buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <font color='#009900'>/* Empty loop */</font> ;

   endptr <font color='#5555FF'>=</font> buffer <font color='#5555FF'>+</font> length;

   <font color='#009900'>/* We need to have at least 12 bytes after the purpose string
    * in order to get the parameter information.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>endptr <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> buf <font color='#5555FF'>+</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>Reading pCAL X0, X1, type, nparams, and units</font>"<font face='Lucida Console'>)</font>;
   X0 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_int_32</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font>buf<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
   X1 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_int_32</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font>buf<font color='#5555FF'>+</font><font color='#979000'>5</font><font face='Lucida Console'>)</font>;
   type <font color='#5555FF'>=</font> buf[<font color='#979000'>9</font>];
   nparams <font color='#5555FF'>=</font> buf[<font color='#979000'>10</font>];
   units <font color='#5555FF'>=</font> buf <font color='#5555FF'>+</font> <font color='#979000'>11</font>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>Checking pCAL equation type and number of parameters</font>"<font face='Lucida Console'>)</font>;
   <font color='#009900'>/* Check that we have the right number of parameters for known
    * equation types.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_EQUATION_LINEAR <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> nparams <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font>type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_EQUATION_BASE_E <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> nparams <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font>type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_EQUATION_ARBITRARY <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> nparams <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font>type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_EQUATION_HYPERBOLIC <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> nparams <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid parameter count</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>type <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_EQUATION_LAST<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unrecognized equation type</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>buf <font color='#5555FF'>=</font> units; <font color='#5555FF'>*</font>buf; buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <font color='#009900'>/* Empty loop to move past the units string. */</font> ;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>Allocating pCAL parameters array</font>"<font face='Lucida Console'>)</font>;

   params <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_charpp, <font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font>png_ptr,
       nparams <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>params <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* Get pointers to the start of each parameter string. */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> nparams; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font>; <font color='#009900'>/* Skip the null string terminator from previous parameter. */</font>

      <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>Reading pCAL parameter %d</font>", i<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>params[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buf; buf <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> endptr <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font>buf <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>; buf<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <font color='#009900'>/* Empty loop to move past each parameter string */</font> ;

      <font color='#009900'>/* Make sure we haven't run out of data yet */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buf <font color='#5555FF'>&gt;</font> endptr<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, params<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid data</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>

   <font color='#BB00BB'>png_set_pCAL</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer, X0, X1, type, nparams,
      <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>units, params<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, params<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sCAL_SUPPORTED
<font color='#009900'>/* Read the sCAL chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_sCAL'></a>png_handle_sCAL</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_bytep buffer;
   png_size_t i;
   <font color='#0000FF'><u>int</u></font> state;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_sCAL</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of place</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_sCAL<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* Need unit type, width, \0, height: minimum 4 bytes */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>, "<font color='#CC0000'>Allocating and reading sCAL chunk data (%u bytes)</font>",
      length <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, length<font color='#5555FF'>+</font><font color='#979000'>1</font>, <font color='#979000'>2</font><font color='#009900'>/*silent*/</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, length<font face='Lucida Console'>)</font>;
   buffer[length] <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* Null terminate the last string */</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* Validate the unit. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer[<font color='#979000'>0</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> buffer[<font color='#979000'>0</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid unit</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* Validate the ASCII numbers, need two ASCII numbers separated by
    * a '\0' and they need to fit exactly in the chunk data.
    */</font>
   i <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   state <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_check_fp_number</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_const_charp<font face='Lucida Console'>)</font>buffer, length, <font color='#5555FF'>&amp;</font>state, <font color='#5555FF'>&amp;</font>i<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       i <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> length <font color='#5555FF'>|</font><font color='#5555FF'>|</font> buffer[i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad width format</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PNG_FP_IS_POSITIVE</font><font face='Lucida Console'>(</font>state<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>non-positive width</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font>
   <b>{</b>
      png_size_t heighti <font color='#5555FF'>=</font> i;

      state <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_check_fp_number</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_const_charp<font face='Lucida Console'>)</font>buffer, length, <font color='#5555FF'>&amp;</font>state, <font color='#5555FF'>&amp;</font>i<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         i <font color='#5555FF'>!</font><font color='#5555FF'>=</font> length<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad height format</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>PNG_FP_IS_POSITIVE</font><font face='Lucida Console'>(</font>state<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>non-positive height</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font>
         <font color='#009900'>/* This is the (only) success case. */</font>
         <font color='#BB00BB'>png_set_sCAL_s</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, buffer[<font color='#979000'>0</font>],
            <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer<font color='#5555FF'>+</font><font color='#979000'>1</font>, <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer<font color='#5555FF'>+</font>heighti<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tIME_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_tIME'></a>png_handle_tIME</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte buf[<font color='#979000'>7</font>];
   png_time mod_time;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_tIME</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font> PNG_INFO_tIME<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buf, <font color='#979000'>7</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   mod_time.second <font color='#5555FF'>=</font> buf[<font color='#979000'>6</font>];
   mod_time.minute <font color='#5555FF'>=</font> buf[<font color='#979000'>5</font>];
   mod_time.hour <font color='#5555FF'>=</font> buf[<font color='#979000'>4</font>];
   mod_time.day <font color='#5555FF'>=</font> buf[<font color='#979000'>3</font>];
   mod_time.month <font color='#5555FF'>=</font> buf[<font color='#979000'>2</font>];
   mod_time.year <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_16</font><font face='Lucida Console'>(</font>buf<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_set_tIME</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>mod_time<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tEXt_SUPPORTED
<font color='#009900'>/* Note: this does not properly handle chunks that are &gt; 64K under DOS */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_tEXt'></a>png_handle_tEXt</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_text  text_info;
   png_bytep buffer;
   png_charp key;
   png_charp text;
   png_uint_32 skip <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_tEXt</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_USER_LIMITS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>no space in chunk cache</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;

<font color='#0000FF'>#ifdef</font> PNG_MAX_MALLOC_64K
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>65535</font>U<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>too large to fit in memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, length<font color='#5555FF'>+</font><font color='#979000'>1</font>, <font color='#979000'>1</font><font color='#009900'>/*warn*/</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
     <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
     <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, length<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, skip<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   key <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer;
   key[length] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>text <font color='#5555FF'>=</font> key; <font color='#5555FF'>*</font>text; text<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <font color='#009900'>/* Empty loop to find end of key */</font> ;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>text <font color='#5555FF'>!</font><font color='#5555FF'>=</font> key <font color='#5555FF'>+</font> length<font face='Lucida Console'>)</font>
      text<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

   text_info.compression <font color='#5555FF'>=</font> PNG_TEXT_COMPRESSION_NONE;
   text_info.key <font color='#5555FF'>=</font> key;
   text_info.lang <font color='#5555FF'>=</font> NULL;
   text_info.lang_key <font color='#5555FF'>=</font> NULL;
   text_info.itxt_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   text_info.text <font color='#5555FF'>=</font> text;
   text_info.text_length <font color='#5555FF'>=</font> <font color='#BB00BB'>strlen</font><font face='Lucida Console'>(</font>text<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_set_text_2</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>text_info, <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Insufficient memory to process text chunk</font>"<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_zTXt_SUPPORTED
<font color='#009900'>/* Note: this does not correctly handle chunks that are &gt; 64K under DOS */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_zTXt'></a>png_handle_zTXt</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_const_charp errmsg <font color='#5555FF'>=</font> NULL;
   png_bytep       buffer;
   png_uint_32     keyword_length;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_zTXt</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_USER_LIMITS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>no space in chunk cache</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;

   buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, length, <font color='#979000'>2</font><font color='#009900'>/*silent*/</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, length<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* TODO: also check that the keyword contents match the spec! */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>keyword_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      keyword_length <font color='#5555FF'>&lt;</font> length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> buffer[keyword_length] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#5555FF'>+</font><font color='#5555FF'>+</font>keyword_length<font face='Lucida Console'>)</font>
      <font color='#009900'>/* Empty loop to find end of name */</font> ;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keyword_length <font color='#5555FF'>&gt;</font> <font color='#979000'>79</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> keyword_length <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>bad keyword</font>";

   <font color='#009900'>/* zTXt must have some LZ data after the keyword, although it may expand to
    * zero bytes; we need a '\0' at the end of the keyword, the compression type
    * then the LZ data:
    */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keyword_length <font color='#5555FF'>+</font> <font color='#979000'>3</font> <font color='#5555FF'>&gt;</font> length<font face='Lucida Console'>)</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>truncated</font>";

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer[keyword_length<font color='#5555FF'>+</font><font color='#979000'>1</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>unknown compression type</font>";

   <font color='#0000FF'>else</font>
   <b>{</b>
      png_alloc_size_t uncompressed_length <font color='#5555FF'>=</font> PNG_SIZE_MAX;

      <font color='#009900'>/* TODO: at present png_decompress_chunk imposes a single application
       * level memory limit, this should be split to different values for iCCP
       * and text chunks.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_decompress_chunk</font><font face='Lucida Console'>(</font>png_ptr, length, keyword_length<font color='#5555FF'>+</font><font color='#979000'>2</font>,
         <font color='#5555FF'>&amp;</font>uncompressed_length, <font color='#979000'>1</font><font color='#009900'>/*terminate*/</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font>
      <b>{</b>
         png_text text;

         <font color='#009900'>/* It worked; png_ptr-&gt;read_buffer now looks like a tEXt chunk except
          * for the extra compression type byte and the fact that it isn't
          * necessarily '\0' terminated.
          */</font>
         buffer <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer;
         buffer[uncompressed_length<font color='#5555FF'>+</font><font face='Lucida Console'>(</font>keyword_length<font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

         text.compression <font color='#5555FF'>=</font> PNG_TEXT_COMPRESSION_zTXt;
         text.key <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer;
         text.text <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>buffer <font color='#5555FF'>+</font> keyword_length<font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
         text.text_length <font color='#5555FF'>=</font> uncompressed_length;
         text.itxt_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         text.lang <font color='#5555FF'>=</font> NULL;
         text.lang_key <font color='#5555FF'>=</font> NULL;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_set_text_2</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>text, <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>insufficient memory</font>";
      <b>}</b>

      <font color='#0000FF'>else</font>
         errmsg <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>errmsg <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, errmsg<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iTXt_SUPPORTED
<font color='#009900'>/* Note: this does not correctly handle chunks that are &gt; 64K under DOS */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_iTXt'></a>png_handle_iTXt</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_const_charp errmsg <font color='#5555FF'>=</font> NULL;
   png_bytep buffer;
   png_uint_32 prefix_length;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_iTXt</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_USER_LIMITS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>no space in chunk cache</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>missing IHDR</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;

   buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, length<font color='#5555FF'>+</font><font color='#979000'>1</font>, <font color='#979000'>1</font><font color='#009900'>/*warn*/</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>out of memory</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, length<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* First the keyword. */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>prefix_length<font color='#5555FF'>=</font><font color='#979000'>0</font>;
      prefix_length <font color='#5555FF'>&lt;</font> length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> buffer[prefix_length] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#5555FF'>+</font><font color='#5555FF'>+</font>prefix_length<font face='Lucida Console'>)</font>
      <font color='#009900'>/* Empty loop */</font> ;

   <font color='#009900'>/* Perform a basic check on the keyword length here. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>prefix_length <font color='#5555FF'>&gt;</font> <font color='#979000'>79</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> prefix_length <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>bad keyword</font>";

   <font color='#009900'>/* Expect keyword, compression flag, compression type, language, translated
    * keyword (both may be empty but are 0 terminated) then the text, which may
    * be empty.
    */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>prefix_length <font color='#5555FF'>+</font> <font color='#979000'>5</font> <font color='#5555FF'>&gt;</font> length<font face='Lucida Console'>)</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>truncated</font>";

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>buffer[prefix_length<font color='#5555FF'>+</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font face='Lucida Console'>(</font>buffer[prefix_length<font color='#5555FF'>+</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      buffer[prefix_length<font color='#5555FF'>+</font><font color='#979000'>2</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> compressed <font color='#5555FF'>=</font> buffer[prefix_length<font color='#5555FF'>+</font><font color='#979000'>1</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      png_uint_32 language_offset, translated_keyword_offset;
      png_alloc_size_t uncompressed_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* Now the language tag */</font>
      prefix_length <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>;
      language_offset <font color='#5555FF'>=</font> prefix_length;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; prefix_length <font color='#5555FF'>&lt;</font> length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> buffer[prefix_length] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#5555FF'>+</font><font color='#5555FF'>+</font>prefix_length<font face='Lucida Console'>)</font>
         <font color='#009900'>/* Empty loop */</font> ;

      <font color='#009900'>/* WARNING: the length may be invalid here, this is checked below. */</font>
      translated_keyword_offset <font color='#5555FF'>=</font> <font color='#5555FF'>+</font><font color='#5555FF'>+</font>prefix_length;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; prefix_length <font color='#5555FF'>&lt;</font> length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> buffer[prefix_length] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#5555FF'>+</font><font color='#5555FF'>+</font>prefix_length<font face='Lucida Console'>)</font>
         <font color='#009900'>/* Empty loop */</font> ;

      <font color='#009900'>/* prefix_length should now be at the trailing '\0' of the translated
       * keyword, but it may already be over the end.  None of this arithmetic
       * can overflow because chunks are at most 2^31 bytes long, but on 16-bit
       * systems the available allocaton may overflow.
       */</font>
      <font color='#5555FF'>+</font><font color='#5555FF'>+</font>prefix_length;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>compressed <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prefix_length <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> length<font face='Lucida Console'>)</font>
         uncompressed_length <font color='#5555FF'>=</font> length <font color='#5555FF'>-</font> prefix_length;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compressed <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prefix_length <font color='#5555FF'>&lt;</font> length<font face='Lucida Console'>)</font>
      <b>{</b>
         uncompressed_length <font color='#5555FF'>=</font> PNG_SIZE_MAX;

         <font color='#009900'>/* TODO: at present png_decompress_chunk imposes a single application
          * level memory limit, this should be split to different values for
          * iCCP and text chunks.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_decompress_chunk</font><font face='Lucida Console'>(</font>png_ptr, length, prefix_length,
            <font color='#5555FF'>&amp;</font>uncompressed_length, <font color='#979000'>1</font><font color='#009900'>/*terminate*/</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font>
            buffer <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer;

         <font color='#0000FF'>else</font>
            errmsg <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg;
      <b>}</b>

      <font color='#0000FF'>else</font>
         errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>truncated</font>";

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>errmsg <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         png_text text;

         buffer[uncompressed_length<font color='#5555FF'>+</font>prefix_length] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compressed<font face='Lucida Console'>)</font>
            text.compression <font color='#5555FF'>=</font> PNG_ITXT_COMPRESSION_NONE;

         <font color='#0000FF'>else</font>
            text.compression <font color='#5555FF'>=</font> PNG_ITXT_COMPRESSION_zTXt;

         text.key <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer;
         text.lang <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer <font color='#5555FF'>+</font> language_offset;
         text.lang_key <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer <font color='#5555FF'>+</font> translated_keyword_offset;
         text.text <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_charp<font face='Lucida Console'>)</font>buffer <font color='#5555FF'>+</font> prefix_length;
         text.text_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         text.itxt_length <font color='#5555FF'>=</font> uncompressed_length;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_set_text_2</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>text, <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>insufficient memory</font>";
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>else</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>bad compression info</font>";

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>errmsg <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, errmsg<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_UNKNOWN_CHUNKS_SUPPORTED
<font color='#009900'>/* Utility function for png_handle_unknown; set up png_ptr::unknown_chunk */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_cache_unknown_chunk'></a>png_cache_unknown_chunk</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 length<font face='Lucida Console'>)</font>
<b>{</b>
   png_alloc_size_t limit <font color='#5555FF'>=</font> PNG_SIZE_MAX;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data<font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>=</font> NULL;
   <b>}</b>

#  ifdef PNG_SET_CHUNK_MALLOC_LIMIT_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_malloc_max <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_malloc_max <font color='#5555FF'>&lt;</font> limit<font face='Lucida Console'>)</font>
         limit <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_malloc_max;

#  elif PNG_USER_CHUNK_MALLOC_MAX <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_USER_CHUNK_MALLOC_MAX <font color='#5555FF'>&lt;</font> limit<font face='Lucida Console'>)</font>
         limit <font color='#5555FF'>=</font> PNG_USER_CHUNK_MALLOC_MAX;
#  endif

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> limit<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>PNG_CSTRING_FROM_CHUNK</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.name, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* The following is safe because of the PNG_SIZE_MAX init above */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>length<font color='#009900'>/*SAFE*/</font>;
      <font color='#009900'>/* 'mode' is a flag array, only the bottom four bits matter here */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.location <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode<font color='#009900'>/*SAFE*/</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>=</font> NULL;

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* Do a 'warn' here - it is handled below. */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep,
            <font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* This is benign because we clean up correctly */</font>
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unknown chunk exceeds memory limits</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data, length<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_UNKNOWN_CHUNKS_SUPPORTED */</font>

<font color='#009900'>/* Handle an unknown, or known but disabled, chunk */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_handle_unknown'></a>png_handle_unknown</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr,
   png_uint_32 length, <font color='#0000FF'><u>int</u></font> keep<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> handled <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* the chunk was handled */</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_handle_unknown</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_UNKNOWN_CHUNKS_SUPPORTED
   <font color='#009900'>/* NOTE: this code is based on the code in libpng-1.4.12 except for fixing
    * the bug which meant that setting a non-default behavior for a specific
    * chunk would be ignored (the default was always used unless a user
    * callback was installed).
    *
    * 'keep' is the value from the png_chunk_unknown_handling, the setting for
    * this specific chunk_name, if PNG_HANDLE_AS_UNKNOWN_SUPPORTED, if not it
    * will always be PNG_HANDLE_CHUNK_AS_DEFAULT and it needs to be set here.
    * This is just an optimization to avoid multiple calls to the lookup
    * function.
    */</font>
#  ifndef PNG_HANDLE_AS_UNKNOWN_SUPPORTED
#     ifdef PNG_SET_UNKNOWN_CHUNKS_SUPPORTED
         keep <font color='#5555FF'>=</font> <font color='#BB00BB'>png_chunk_unknown_handling</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font>;
#     endif
#  endif

   <font color='#009900'>/* One of the following methods will read the chunk or skip it (at least one
    * of these is always defined because this is the only way to switch on
    * PNG_READ_UNKNOWN_CHUNKS_SUPPORTED)
    */</font>
#  ifdef PNG_READ_USER_CHUNKS_SUPPORTED
      <font color='#009900'>/* The user callback takes precedence over the chunk keep value, but the
       * keep value is still required to validate a save of a critical chunk.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_user_chunk_fn <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_cache_unknown_chunk</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Callback to user unknown chunk handler */</font>
            <font color='#0000FF'><u>int</u></font> ret <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_user_chunk_fn<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr,
               <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk<font face='Lucida Console'>)</font>;

            <font color='#009900'>/* ret is:
             * negative: An error occured, png_chunk_error will be called.
             *     zero: The chunk was not handled, the chunk will be discarded
             *           unless png_set_keep_unknown_chunks has been used to set
             *           a 'keep' behavior for this particular chunk, in which
             *           case that will be used.  A critical chunk will cause an
             *           error at this point unless it is to be saved.
             * positive: The chunk was handled, libpng will ignore/discard it.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>error in user chunk</font>"<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* If the keep value is 'default' or 'never' override it, but
                * still error out on critical chunks unless the keep value is
                * 'always'  While this is weird it is the behavior in 1.4.12.
                * A possible improvement would be to obey the value set for the
                * chunk, but this would be an API change that would probably
                * damage some applications.
                *
                * The png_app_warning below catches the case that matters, where
                * the application has not set specific save or ignore for this
                * chunk or global save or ignore.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keep <font color='#5555FF'>&lt;</font> PNG_HANDLE_CHUNK_IF_SAFE<font face='Lucida Console'>)</font>
               <b>{</b>
#                 ifdef PNG_SET_UNKNOWN_CHUNKS_SUPPORTED
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_default <font color='#5555FF'>&lt;</font> PNG_HANDLE_CHUNK_IF_SAFE<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#BB00BB'>png_chunk_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Saving unknown chunk:</font>"<font face='Lucida Console'>)</font>;
                        <font color='#BB00BB'>png_app_warning</font><font face='Lucida Console'>(</font>png_ptr,
                           "<font color='#CC0000'>forcing save of an unhandled chunk;</font>"
                           "<font color='#CC0000'> please call png_set_keep_unknown_chunks</font>"<font face='Lucida Console'>)</font>;
                           <font color='#009900'>/* with keep = PNG_HANDLE_CHUNK_IF_SAFE */</font>
                     <b>}</b>
#                 endif
                  keep <font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_IF_SAFE;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* chunk was handled */</font>
            <b>{</b>
               handled <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <font color='#009900'>/* Critical chunks can be safely discarded at this point. */</font>
               keep <font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_NEVER;
            <b>}</b>
         <b>}</b>

         <font color='#0000FF'>else</font>
            keep <font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_NEVER; <font color='#009900'>/* insufficient memory */</font>
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#009900'>/* Use the SAVE_UNKNOWN_CHUNKS code or skip the chunk */</font>
#  endif <font color='#009900'>/* PNG_READ_USER_CHUNKS_SUPPORTED */</font>

#  ifdef PNG_SAVE_UNKNOWN_CHUNKS_SUPPORTED
      <b>{</b>
         <font color='#009900'>/* keep is currently just the per-chunk setting, if there was no
          * setting change it to the global default now (not that this may
          * still be AS_DEFAULT) then obtain the cache of the chunk if required,
          * if not simply skip the chunk.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_AS_DEFAULT<font face='Lucida Console'>)</font>
            keep <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_default;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_ALWAYS <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_IF_SAFE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             <font color='#BB00BB'>PNG_CHUNK_ANCILLARY</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_cache_unknown_chunk</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               keep <font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_NEVER;
         <b>}</b>

         <font color='#0000FF'>else</font>
            <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <b>}</b>
#  <font color='#0000FF'>else</font>
#     ifndef PNG_READ_USER_CHUNKS_SUPPORTED
#        error no method to support READ_UNKNOWN_CHUNKS
#     endif

      <b>{</b>
         <font color='#009900'>/* If here there is no read callback pointer set and no support is
          * compiled in to just save the unknown chunks, so simply skip this
          * chunk.  If 'keep' is something other than AS_DEFAULT or NEVER then
          * the app has erroneously asked for unknown chunk saving when there
          * is no support.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keep <font color='#5555FF'>&gt;</font> PNG_HANDLE_CHUNK_NEVER<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_app_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>no unknown chunk support available</font>"<font face='Lucida Console'>)</font>;

         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <b>}</b>
#  endif

#  ifdef PNG_STORE_UNKNOWN_CHUNKS_SUPPORTED
      <font color='#009900'>/* Now store the chunk in the chunk list if appropriate, and if the limits
       * permit it.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_ALWAYS <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         <font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_HANDLE_CHUNK_IF_SAFE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
          <font color='#BB00BB'>PNG_CHUNK_ANCILLARY</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
#     ifdef PNG_USER_LIMITS_SUPPORTED
         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>no space in chunk cache</font>"<font face='Lucida Console'>)</font>;
               <font color='#009900'>/* FALL THROUGH */</font>
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               <font color='#009900'>/* NOTE: prior to 1.6.0 this case resulted in an unknown critical
                * chunk being skipped, now there will be a hard error below.
                */</font>
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>: <font color='#009900'>/* not at limit */</font>
               <font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_chunk_cache_max<font face='Lucida Console'>)</font>;
               <font color='#009900'>/* FALL THROUGH */</font>
            <font color='#0000FF'>case</font> <font color='#979000'>0</font>: <font color='#009900'>/* no limit */</font>
#     endif <font color='#009900'>/* PNG_USER_LIMITS_SUPPORTED */</font>
               <font color='#009900'>/* Here when the limit isn't reached or when limits are compiled
                * out; store the chunk.
                */</font>
               <font color='#BB00BB'>png_set_unknown_chunks</font><font face='Lucida Console'>(</font>png_ptr, info_ptr,
                  <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               handled <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
#     ifdef PNG_USER_LIMITS_SUPPORTED
               <font color='#0000FF'>break</font>;
         <b>}</b>
#     endif
      <b>}</b>
#  <font color='#0000FF'>else</font> <font color='#009900'>/* no store support: the chunk must be handled by the user callback */</font>
      <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>info_ptr<font face='Lucida Console'>)</font>
#  endif

   <font color='#009900'>/* Regardless of the error handling below the cached data (if any) can be
    * freed now.  Notice that the data is not freed if there is a png_error, but
    * it will be freed by destroy_read_struct.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data <font color='#5555FF'>=</font> NULL;

<font color='#0000FF'>#else</font> <font color='#009900'>/* !PNG_READ_UNKNOWN_CHUNKS_SUPPORTED */</font>
   <font color='#009900'>/* There is no support to read an unknown chunk, so just skip it. */</font>
   <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>info_ptr<font face='Lucida Console'>)</font>
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>keep<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* !PNG_READ_UNKNOWN_CHUNKS_SUPPORTED */</font>

   <font color='#009900'>/* Check for unhandled critical chunks */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>handled <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>PNG_CHUNK_CRITICAL</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unhandled critical chunk</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* This function is called to verify that a chunk name is valid.
 * This function can't have the "critical chunk check" incorporated
 * into it, since in the future we will need to be able to call user
 * functions to handle unknown critical chunks after we check that
 * the chunk name itself is valid.
 */</font>

<font color='#009900'>/* Bit hacking: the test for an invalid byte in the 4 byte chunk name is:
 *
 * ((c) &lt; 65 || (c) &gt; 122 || ((c) &gt; 90 &amp;&amp; (c) &lt; 97))
 */</font>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_check_chunk_name'></a>png_check_chunk_name</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_32 chunk_name<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> i;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_check_chunk_name</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>1</font>; i<font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font><font color='#979000'>4</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> c <font color='#5555FF'>=</font> chunk_name <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>c <font color='#5555FF'>&lt;</font> <font color='#979000'>65</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> c <font color='#5555FF'>&gt;</font> <font color='#979000'>122</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>c <font color='#5555FF'>&gt;</font> <font color='#979000'>90</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> c <font color='#5555FF'>&lt;</font> <font color='#979000'>97</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid chunk type</font>"<font face='Lucida Console'>)</font>;

      chunk_name <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font>;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Combines the row recently read in with the existing pixels in the row.  This
 * routine takes care of alpha and transparency if requested.  This routine also
 * handles the two methods of progressive display of interlaced images,
 * depending on the 'display' value; if 'display' is true then the whole row
 * (dp) is filled from the start by replicating the available pixels.  If
 * 'display' is false only those pixels present in the pass are filled in.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_combine_row'></a>png_combine_row</b><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_bytep dp, <font color='#0000FF'><u>int</u></font> display<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> pixel_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformed_pixel_depth;
   png_const_bytep sp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>;
   png_uint_32 row_width <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> pass <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass;
   png_bytep end_ptr <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   png_byte end_byte <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> end_mask;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_combine_row</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Added in 1.5.6: it should not be possible to enter this routine until at
    * least one row has been read from the PNG data and transformed.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pixel_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal row logic error</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Added in 1.5.4: the pixel depth should match the information returned by
    * any call to png_read_update_info at this point.  Do not continue if we got
    * this wrong.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_rowbytes <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_rowbytes <font color='#5555FF'>!</font><font color='#5555FF'>=</font>
          <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>pixel_depth, row_width<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal row size calculation error</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Don't expect this to ever happen: */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal row width error</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Preserve the last byte in cases where only part of it will be overwritten,
    * the multiply below may overflow, we don't care because ANSI-C guarantees
    * we get the low bits.
    */</font>
   end_mask <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>pixel_depth <font color='#5555FF'>*</font> row_width<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>7</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>end_mask <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* end_ptr == NULL is a flag to say do nothing */</font>
      end_ptr <font color='#5555FF'>=</font> dp <font color='#5555FF'>+</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>pixel_depth, row_width<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
      end_byte <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>end_ptr;
#     ifdef PNG_READ_PACKSWAP_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font> <font color='#009900'>/* little-endian byte */</font>
            end_mask <font color='#5555FF'>=</font> <font color='#979000'>0xff</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> end_mask;

         <font color='#0000FF'>else</font> <font color='#009900'>/* big-endian byte */</font>
#     endif
         end_mask <font color='#5555FF'>=</font> <font color='#979000'>0xff</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> end_mask;
      <font color='#009900'>/* end_mask is now the bits to *keep* from the destination row */</font>
   <b>}</b>

   <font color='#009900'>/* For non-interlaced images this reduces to a memcpy(). A memcpy()
    * will also happen if interlacing isn't supported or if the application
    * does not call png_set_interlace_handling().  In the latter cases the
    * caller just gets a sequence of the unexpanded rows from each interlace
    * pass.
    */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      pass <font color='#5555FF'>&lt;</font> <font color='#979000'>6</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>display <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#009900'>/* The following copies everything for 'display' on passes 0, 2 and 4. */</font>
      <font face='Lucida Console'>(</font>display <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>pass <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Narrow images may have no bits in a pass; the caller should handle
       * this, but this test is cheap:
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_COL</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>return</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pixel_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* For pixel depths up to 4 bpp the 8-pixel mask can be expanded to fit
          * into 32 bits, then a single loop over the bytes using the four byte
          * values in the 32-bit mask can be used.  For the 'display' option the
          * expanded mask may also not require any masking within a byte.  To
          * make this work the PACKSWAP option must be taken into account - it
          * simply requires the pixels to be reversed in each byte.
          *
          * The 'regular' case requires a mask for each of the first 6 passes,
          * the 'display' case does a copy for the even passes in the range
          * 0..6.  This has already been handled in the test above.
          *
          * The masks are arranged as four bytes with the first byte to use in
          * the lowest bits (little-endian) regardless of the order (PACKSWAP or
          * not) of the pixels in each byte.
          *
          * NOTE: the whole of this logic depends on the caller of this function
          * only calling it on rows appropriate to the pass.  This function only
          * understands the 'x' logic; the 'y' logic is handled by the caller.
          *
          * The following defines allow generation of compile time constant bit
          * masks for each pixel depth and each possibility of swapped or not
          * swapped bytes.  Pass 'p' is in the range 0..6; 'x', a pixel index,
          * is in the range 0..7; and the result is 1 if the pixel is to be
          * copied in the pass, 0 if not.  'S' is for the sparkle method, 'B'
          * for the block method.
          *
          * With some compilers a compile time expression of the general form:
          *
          *    (shift &gt;= 32) ? (a &gt;&gt; (shift-32)) : (b &gt;&gt; shift)
          *
          * Produces warnings with values of 'shift' in the range 33 to 63
          * because the right hand side of the ?: expression is evaluated by
          * the compiler even though it isn't used.  Microsoft Visual C (various
          * versions) and the Intel C compiler are known to do this.  To avoid
          * this the following macros are used in 1.5.6.  This is a temporary
          * solution to avoid destabilizing the code during the release process.
          */</font>
#        <font color='#0000FF'>if</font> PNG_USE_COMPILE_TIME_MASKS
#           define <font color='#BB00BB'>PNG_LSR</font><font face='Lucida Console'>(</font>x,s<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x1f</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#           define <font color='#BB00BB'>PNG_LSL</font><font face='Lucida Console'>(</font>x,s<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x1f</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#        <font color='#0000FF'>else</font>
#           define <font color='#BB00BB'>PNG_LSR</font><font face='Lucida Console'>(</font>x,s<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#           define <font color='#BB00BB'>PNG_LSL</font><font face='Lucida Console'>(</font>x,s<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#        endif
#        define <font color='#BB00BB'>S_COPY</font><font face='Lucida Console'>(</font>p,x<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#979000'>4</font> ? <font color='#BB00BB'>PNG_LSR</font><font face='Lucida Console'>(</font><font color='#979000'>0x80088822</font>,<font face='Lucida Console'>(</font><font color='#979000'>3</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#979000'>8</font><font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> :\
           <font color='#BB00BB'>PNG_LSR</font><font face='Lucida Console'>(</font><font color='#979000'>0xaa55ff00</font>,<font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#979000'>8</font><font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
#        define <font color='#BB00BB'>B_COPY</font><font face='Lucida Console'>(</font>p,x<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#979000'>4</font> ? <font color='#BB00BB'>PNG_LSR</font><font face='Lucida Console'>(</font><font color='#979000'>0xff0fff33</font>,<font face='Lucida Console'>(</font><font color='#979000'>3</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#979000'>8</font><font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> :\
           <font color='#BB00BB'>PNG_LSR</font><font face='Lucida Console'>(</font><font color='#979000'>0xff55ff00</font>,<font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#979000'>8</font><font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#979000'>7</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>

         <font color='#009900'>/* Return a mask for pass 'p' pixel 'x' at depth 'd'.  The mask is
          * little endian - the first pixel is at bit 0 - however the extra
          * parameter 's' can be set to cause the mask position to be swapped
          * within each byte, to match the PNG format.  This is done by XOR of
          * the shift with 7, 6 or 4 for bit depths 1, 2 and 4.
          */</font>
#        define <font color='#BB00BB'>PIXEL_MASK</font><font face='Lucida Console'>(</font>p,x,d,s<font face='Lucida Console'>)</font> \
            <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_LSL</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_LSL</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>U,<font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>,<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>^<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>?<font color='#979000'>8</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font>:<font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

         <font color='#009900'>/* Hence generate the appropriate 'block' or 'sparkle' pixel copy mask.
          */</font>
#        define <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,x,d,s<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>S_COPY</font><font face='Lucida Console'>(</font>p,x<font face='Lucida Console'>)</font>?<font color='#BB00BB'>PIXEL_MASK</font><font face='Lucida Console'>(</font>p,x,d,s<font face='Lucida Console'>)</font>:<font color='#979000'>0</font><font face='Lucida Console'>)</font>
#        define <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,x,d,s<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>B_COPY</font><font face='Lucida Console'>(</font>p,x<font face='Lucida Console'>)</font>?<font color='#BB00BB'>PIXEL_MASK</font><font face='Lucida Console'>(</font>p,x,d,s<font face='Lucida Console'>)</font>:<font color='#979000'>0</font><font face='Lucida Console'>)</font>

         <font color='#009900'>/* Combine 8 of these to get the full mask.  For the 1-bpp and 2-bpp
          * cases the result needs replicating, for the 4-bpp case the above
          * generates a full 32 bits.
          */</font>
#        define <font color='#BB00BB'>MASK_EXPAND</font><font face='Lucida Console'>(</font>m,d<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>m<font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font><font color='#5555FF'>=</font><font color='#5555FF'>=</font><font color='#979000'>1</font>?<font color='#979000'>0x01010101</font>:<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font><font color='#5555FF'>=</font><font color='#5555FF'>=</font><font color='#979000'>2</font>?<font color='#979000'>0x00010001</font>:<font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

#        define <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font>p,d,s<font face='Lucida Console'>)</font> <font color='#BB00BB'>MASK_EXPAND</font><font face='Lucida Console'>(</font><font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>0</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>1</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>\
            <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>2</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>3</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>4</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>\
            <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>5</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>6</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>S_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>7</font>,d,s<font face='Lucida Console'>)</font>, d<font face='Lucida Console'>)</font>

#        define <font color='#BB00BB'>B_MASK</font><font face='Lucida Console'>(</font>p,d,s<font face='Lucida Console'>)</font> <font color='#BB00BB'>MASK_EXPAND</font><font face='Lucida Console'>(</font><font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>0</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>1</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>\
            <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>2</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>3</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>4</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>\
            <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>5</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>6</font>,d,s<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>B_MASKx</font><font face='Lucida Console'>(</font>p,<font color='#979000'>7</font>,d,s<font face='Lucida Console'>)</font>, d<font face='Lucida Console'>)</font>

<font color='#0000FF'>#if</font> PNG_USE_COMPILE_TIME_MASKS
         <font color='#009900'>/* Utility macros to construct all the masks for a depth/swap
          * combination.  The 's' parameter says whether the format is PNG
          * (big endian bytes) or not.  Only the three odd-numbered passes are
          * required for the display/block algorithm.
          */</font>
#        define <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font>d,s<font face='Lucida Console'>)</font> <b>{</b> <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>,d,s<font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,d,s<font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>,d,s<font face='Lucida Console'>)</font>,\
            <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>,d,s<font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>4</font>,d,s<font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>5</font>,d,s<font face='Lucida Console'>)</font> <b>}</b>

#        define <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font>d,s<font face='Lucida Console'>)</font> <b>{</b> <font color='#BB00BB'>B_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,d,s<font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>,d,s<font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font><font color='#979000'>5</font>,d,s<font face='Lucida Console'>)</font> <b>}</b>

#        define <font color='#BB00BB'>DEPTH_INDEX</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font><font color='#5555FF'>=</font><font color='#5555FF'>=</font><font color='#979000'>1</font>?<font color='#979000'>0</font>:<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>d<font face='Lucida Console'>)</font><font color='#5555FF'>=</font><font color='#5555FF'>=</font><font color='#979000'>2</font>?<font color='#979000'>1</font>:<font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

         <font color='#009900'>/* Hence the pre-compiled masks indexed by PACKSWAP (or not), depth and
          * then pass:
          */</font>
         <font color='#0000FF'>static</font> PNG_CONST png_uint_32 row_mask[<font color='#979000'>2</font><font color='#009900'>/*PACKSWAP*/</font>][<font color='#979000'>3</font><font color='#009900'>/*depth*/</font>][<font color='#979000'>6</font>] <font color='#5555FF'>=</font>
         <b>{</b>
            <font color='#009900'>/* Little-endian byte masks for PACKSWAP */</font>
            <b>{</b> <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,<font color='#979000'>0</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>,<font color='#979000'>0</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>4</font>,<font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>}</b>,
            <font color='#009900'>/* Normal (big-endian byte) masks - PNG format */</font>
            <b>{</b> <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,<font color='#979000'>1</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>,<font color='#979000'>1</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>S_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>4</font>,<font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>}</b>
         <b>}</b>;

         <font color='#009900'>/* display_mask has only three entries for the odd passes, so index by
          * pass&gt;&gt;1.
          */</font>
         <font color='#0000FF'>static</font> PNG_CONST png_uint_32 display_mask[<font color='#979000'>2</font>][<font color='#979000'>3</font>][<font color='#979000'>3</font>] <font color='#5555FF'>=</font>
         <b>{</b>
            <font color='#009900'>/* Little-endian byte masks for PACKSWAP */</font>
            <b>{</b> <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,<font color='#979000'>0</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>,<font color='#979000'>0</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>4</font>,<font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>}</b>,
            <font color='#009900'>/* Normal (big-endian byte) masks - PNG format */</font>
            <b>{</b> <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>,<font color='#979000'>1</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>,<font color='#979000'>1</font><font face='Lucida Console'>)</font>, <font color='#BB00BB'>B_MASKS</font><font face='Lucida Console'>(</font><font color='#979000'>4</font>,<font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>}</b>
         <b>}</b>;

#        define <font color='#BB00BB'>MASK</font><font face='Lucida Console'>(</font>pass,depth,display,png<font face='Lucida Console'>)</font>\
            <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>?display_mask[png][<font color='#BB00BB'>DEPTH_INDEX</font><font face='Lucida Console'>(</font>depth<font face='Lucida Console'>)</font>][pass<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>1</font>]:\
               row_mask[png][<font color='#BB00BB'>DEPTH_INDEX</font><font face='Lucida Console'>(</font>depth<font face='Lucida Console'>)</font>][pass]<font face='Lucida Console'>)</font>

<font color='#0000FF'>#else</font> <font color='#009900'>/* !PNG_USE_COMPILE_TIME_MASKS */</font>
         <font color='#009900'>/* This is the runtime alternative: it seems unlikely that this will
          * ever be either smaller or faster than the compile time approach.
          */</font>
#        define <font color='#BB00BB'>MASK</font><font face='Lucida Console'>(</font>pass,depth,display,png<font face='Lucida Console'>)</font>\
            <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>?<font color='#BB00BB'>B_MASK</font><font face='Lucida Console'>(</font>pass,depth,png<font face='Lucida Console'>)</font>:<font color='#BB00BB'>S_MASK</font><font face='Lucida Console'>(</font>pass,depth,png<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* !PNG_USE_COMPILE_TIME_MASKS */</font>

         <font color='#009900'>/* Use the appropriate mask to copy the required bits.  In some cases
          * the byte mask will be 0 or 0xff, optimize these cases.  row_width is
          * the number of pixels, but the code copies bytes, so it is necessary
          * to special case the end.
          */</font>
         png_uint_32 pixels_per_byte <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>/</font> pixel_depth;
         png_uint_32 mask;

#        ifdef PNG_READ_PACKSWAP_SUPPORTED
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font>
               mask <font color='#5555FF'>=</font> <font color='#BB00BB'>MASK</font><font face='Lucida Console'>(</font>pass, pixel_depth, display, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

            <font color='#0000FF'>else</font>
#        endif
            mask <font color='#5555FF'>=</font> <font color='#BB00BB'>MASK</font><font face='Lucida Console'>(</font>pass, pixel_depth, display, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
         <b>{</b>
            png_uint_32 m;

            <font color='#009900'>/* It doesn't matter in the following if png_uint_32 has more than
             * 32 bits because the high bits always match those in m&lt;&lt;24; it is,
             * however, essential to use OR here, not +, because of this.
             */</font>
            m <font color='#5555FF'>=</font> mask;
            mask <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>m <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>m <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* rotate right to good compilers */</font>
            m <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>m <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* something to copy */</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>m <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>dp <font color='#5555FF'>&amp;</font> ~m<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> m<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'>else</font>
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
            <b>}</b>

            <font color='#009900'>/* NOTE: this may overwrite the last byte with garbage if the image
             * is not an exact number of bytes wide; libpng has always done
             * this.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> pixels_per_byte<font face='Lucida Console'>)</font>
               <font color='#0000FF'>break</font>; <font color='#009900'>/* May need to restore part of the last byte */</font>

            row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> pixels_per_byte;
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>dp;
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>sp;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#009900'>/* pixel_depth &gt;= 8 */</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> bytes_to_copy, bytes_to_jump;

         <font color='#009900'>/* Validate the depth - it must be a multiple of 8 */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pixel_depth <font color='#5555FF'>&amp;</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid user transform pixel depth</font>"<font face='Lucida Console'>)</font>;

         pixel_depth <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>; <font color='#009900'>/* now in bytes */</font>
         row_width <font color='#5555FF'>*</font><font color='#5555FF'>=</font> pixel_depth;

         <font color='#009900'>/* Regardless of pass number the Adam 7 interlace always results in a
          * fixed number of pixels to copy then to skip.  There may be a
          * different number of pixels to skip at the start though.
          */</font>
         <b>{</b>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> offset <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_COL</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> pixel_depth;

            row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> offset;
            dp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> offset;
            sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> offset;
         <b>}</b>

         <font color='#009900'>/* Work out the bytes to copy. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* When doing the 'block' algorithm the pixel in the pass gets
             * replicated to adjacent pixels.  This is why the even (0,2,4,6)
             * passes are skipped above - the entire expanded row is copied.
             */</font>
            bytes_to_copy <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>6</font><font color='#5555FF'>-</font>pass<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> pixel_depth;

            <font color='#009900'>/* But don't allow this number to exceed the actual row width. */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bytes_to_copy <font color='#5555FF'>&gt;</font> row_width<font face='Lucida Console'>)</font>
               bytes_to_copy <font color='#5555FF'>=</font> row_width;
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#009900'>/* normal row; Adam7 only ever gives us one pixel to copy. */</font>
            bytes_to_copy <font color='#5555FF'>=</font> pixel_depth;

         <font color='#009900'>/* In Adam7 there is a constant offset between where the pixels go. */</font>
         bytes_to_jump <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_COL_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> pixel_depth;

         <font color='#009900'>/* And simply copy these bytes.  Some optimization is possible here,
          * depending on the value of 'bytes_to_copy'.  Special case the low
          * byte counts, which we know to be frequent.
          *
          * Notice that these cases all 'return' rather than 'break' - this
          * avoids an unnecessary test on whether to restore the last byte
          * below.
          */</font>
         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>bytes_to_copy<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> bytes_to_jump<font face='Lucida Console'>)</font>
                     <font color='#0000FF'>return</font>;

                  dp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> bytes_to_jump;
               <b>}</b>

            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               <font color='#009900'>/* There is a possibility of a partial copy at the end here; this
                * slows the code down somewhat.
                */</font>
               <font color='#0000FF'>do</font>
               <b>{</b>
                  dp[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> sp[<font color='#979000'>0</font>], dp[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> sp[<font color='#979000'>1</font>];

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> bytes_to_jump<font face='Lucida Console'>)</font>
                     <font color='#0000FF'>return</font>;

                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  dp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> bytes_to_jump;
               <b>}</b>
               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

               <font color='#009900'>/* And there can only be one byte left at this point: */</font>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#0000FF'>return</font>;

            <font color='#0000FF'>case</font> <font color='#979000'>3</font>:
               <font color='#009900'>/* This can only be the RGB case, so each copy is exactly one
                * pixel and it is not necessary to check for a partial copy.
                */</font>
               <font color='#0000FF'>for</font><font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
               <b>{</b>
                  dp[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> sp[<font color='#979000'>0</font>], dp[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> sp[<font color='#979000'>1</font>], dp[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> sp[<font color='#979000'>2</font>];

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> bytes_to_jump<font face='Lucida Console'>)</font>
                     <font color='#0000FF'>return</font>;

                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  dp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> bytes_to_jump;
               <b>}</b>

            <font color='#0000FF'>default</font>:
<font color='#0000FF'>#if</font> PNG_ALIGN_TYPE <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_ALIGN_NONE
               <font color='#009900'>/* Check for double byte alignment and, if possible, use a
                * 16-bit copy.  Don't attempt this for narrow images - ones that
                * are less than an interlace panel wide.  Don't attempt it for
                * wide bytes_to_copy either - use the memcpy there.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bytes_to_copy <font color='#5555FF'>&lt;</font> <font color='#979000'>16</font> <font color='#009900'>/*else use memcpy*/</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                  <font color='#BB00BB'>png_isaligned</font><font face='Lucida Console'>(</font>dp, png_uint_16<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                  <font color='#BB00BB'>png_isaligned</font><font face='Lucida Console'>(</font>sp, png_uint_16<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                  bytes_to_copy <font color='#5555FF'>%</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                  bytes_to_jump <font color='#5555FF'>%</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#009900'>/* Everything is aligned for png_uint_16 copies, but try for
                   * png_uint_32 first.
                   */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_isaligned</font><font face='Lucida Console'>(</font>dp, png_uint_32<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                     <font color='#BB00BB'>png_isaligned</font><font face='Lucida Console'>(</font>sp, png_uint_32<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                     bytes_to_copy <font color='#5555FF'>%</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                     bytes_to_jump <font color='#5555FF'>%</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_32p dp32 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_aligncast</font><font face='Lucida Console'>(</font>png_uint_32p,dp<font face='Lucida Console'>)</font>;
                     png_const_uint_32p sp32 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_aligncastconst</font><font face='Lucida Console'>(</font>
                        png_const_uint_32p, sp<font face='Lucida Console'>)</font>;
                     <font color='#0000FF'><u>size_t</u></font> skip <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bytes_to_jump<font color='#5555FF'>-</font>bytes_to_copy<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
                        <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>do</font>
                     <b>{</b>
                        <font color='#0000FF'><u>size_t</u></font> c <font color='#5555FF'>=</font> bytes_to_copy;
                        <font color='#0000FF'>do</font>
                        <b>{</b>
                           <font color='#5555FF'>*</font>dp32<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp32<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                           c <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>c <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> bytes_to_jump<font face='Lucida Console'>)</font>
                           <font color='#0000FF'>return</font>;

                        dp32 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> skip;
                        sp32 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> skip;
                        row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> bytes_to_jump;
                     <b>}</b>
                     <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bytes_to_copy <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> row_width<font face='Lucida Console'>)</font>;

                     <font color='#009900'>/* Get to here when the row_width truncates the final copy.
                      * There will be 1-3 bytes left to copy, so don't try the
                      * 16-bit loop below.
                      */</font>
                     dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font>dp32;
                     sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>sp32;
                     <font color='#0000FF'>do</font>
                        <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                     <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>row_width <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                     <font color='#0000FF'>return</font>;
                  <b>}</b>

                  <font color='#009900'>/* Else do it in 16-bit quantities, but only if the size is
                   * not too large.
                   */</font>
                  <font color='#0000FF'>else</font>
                  <b>{</b>
                     png_uint_16p dp16 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_aligncast</font><font face='Lucida Console'>(</font>png_uint_16p, dp<font face='Lucida Console'>)</font>;
                     png_const_uint_16p sp16 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_aligncastconst</font><font face='Lucida Console'>(</font>
                        png_const_uint_16p, sp<font face='Lucida Console'>)</font>;
                     <font color='#0000FF'><u>size_t</u></font> skip <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bytes_to_jump<font color='#5555FF'>-</font>bytes_to_copy<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
                        <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>do</font>
                     <b>{</b>
                        <font color='#0000FF'><u>size_t</u></font> c <font color='#5555FF'>=</font> bytes_to_copy;
                        <font color='#0000FF'>do</font>
                        <b>{</b>
                           <font color='#5555FF'>*</font>dp16<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp16<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                           c <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>c <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> bytes_to_jump<font face='Lucida Console'>)</font>
                           <font color='#0000FF'>return</font>;

                        dp16 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> skip;
                        sp16 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> skip;
                        row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> bytes_to_jump;
                     <b>}</b>
                     <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bytes_to_copy <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> row_width<font face='Lucida Console'>)</font>;

                     <font color='#009900'>/* End of row - 1 byte left, bytes_to_copy &gt; row_width: */</font>
                     dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font>dp16;
                     sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>sp16;
                     <font color='#0000FF'>do</font>
                        <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                     <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>row_width <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                     <font color='#0000FF'>return</font>;
                  <b>}</b>
               <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_ALIGN_ code */</font>

               <font color='#009900'>/* The true default - use a memcpy: */</font>
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>dp, sp, bytes_to_copy<font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> bytes_to_jump<font face='Lucida Console'>)</font>
                     <font color='#0000FF'>return</font>;

                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  dp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_to_jump;
                  row_width <font color='#5555FF'>-</font><font color='#5555FF'>=</font> bytes_to_jump;
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bytes_to_copy <font color='#5555FF'>&gt;</font> row_width<font face='Lucida Console'>)</font>
                     bytes_to_copy <font color='#5555FF'>=</font> row_width;
               <b>}</b>
         <b>}</b>

         <font color='#009900'>/* NOT REACHED*/</font>
      <b>}</b> <font color='#009900'>/* pixel_depth &gt;= 8 */</font>

      <font color='#009900'>/* Here if pixel_depth &lt; 8 to check 'end_ptr' below. */</font>
   <b>}</b>
   <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* If here then the switch above wasn't used so just memcpy the whole row
    * from the temporary row buffer (notice that this overwrites the end of the
    * destination row if it is a partial byte.)
    */</font>
   <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>dp, sp, <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>pixel_depth, row_width<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Restore the overwritten bits from the last byte if necessary. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>end_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#5555FF'>*</font>end_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>end_byte <font color='#5555FF'>&amp;</font> end_mask<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>end_ptr <font color='#5555FF'>&amp;</font> ~end_mask<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_read_interlace'></a>png_do_read_interlace</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row, <font color='#0000FF'><u>int</u></font> pass,
   png_uint_32 transformations <font color='#009900'>/* Because these may affect the byte layout */</font><font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Arrays to facilitate easy interlacing - use pass (0 - 6) as index */</font>
   <font color='#009900'>/* Offset to next interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST <font color='#0000FF'><u>int</u></font> png_pass_inc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_read_interlace</font>"<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> row_info <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 final_width;

      final_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>*</font> png_pass_inc[pass];

      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>int</u></font> sshift, dshift;
            <font color='#0000FF'><u>int</u></font> s_start, s_end, s_inc;
            <font color='#0000FF'><u>int</u></font> jstop <font color='#5555FF'>=</font> png_pass_inc[pass];
            png_byte v;
            png_uint_32 i;
            <font color='#0000FF'><u>int</u></font> j;

<font color='#0000FF'>#ifdef</font> PNG_READ_PACKSWAP_SUPPORTED
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font>
            <b>{</b>
                sshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
                dshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
                s_start <font color='#5555FF'>=</font> <font color='#979000'>7</font>;
                s_end <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                s_inc <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;
            <b>}</b>

            <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
            <b>{</b>
                sshift <font color='#5555FF'>=</font> <font color='#979000'>7</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
                dshift <font color='#5555FF'>=</font> <font color='#979000'>7</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
                s_start <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                s_end <font color='#5555FF'>=</font> <font color='#979000'>7</font>;
                s_inc <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            <b>}</b>

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               v <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> sshift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> jstop; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0x7f7f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>7</font> <font color='#5555FF'>-</font> dshift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                  tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> v <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> dshift;
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dshift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s_end<font face='Lucida Console'>)</font>
                  <b>{</b>
                     dshift <font color='#5555FF'>=</font> s_start;
                     dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     dshift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s_inc;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sshift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s_end<font face='Lucida Console'>)</font>
               <b>{</b>
                  sshift <font color='#5555FF'>=</font> s_start;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  sshift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s_inc;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>int</u></font> sshift, dshift;
            <font color='#0000FF'><u>int</u></font> s_start, s_end, s_inc;
            <font color='#0000FF'><u>int</u></font> jstop <font color='#5555FF'>=</font> png_pass_inc[pass];
            png_uint_32 i;

<font color='#0000FF'>#ifdef</font> PNG_READ_PACKSWAP_SUPPORTED
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font>
            <b>{</b>
               sshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               dshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               s_start <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
               s_end <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               s_inc <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>2</font>;
            <b>}</b>

            <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
            <b>{</b>
               sshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>3</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               dshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>3</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               s_start <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               s_end <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
               s_inc <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            <b>}</b>

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_byte v;
               <font color='#0000FF'><u>int</u></font> j;

               v <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> sshift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> jstop; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0x3f3f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>6</font> <font color='#5555FF'>-</font> dshift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                  tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> v <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> dshift;
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dshift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s_end<font face='Lucida Console'>)</font>
                  <b>{</b>
                     dshift <font color='#5555FF'>=</font> s_start;
                     dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     dshift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s_inc;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sshift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s_end<font face='Lucida Console'>)</font>
               <b>{</b>
                  sshift <font color='#5555FF'>=</font> s_start;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  sshift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s_inc;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>int</u></font> sshift, dshift;
            <font color='#0000FF'><u>int</u></font> s_start, s_end, s_inc;
            png_uint_32 i;
            <font color='#0000FF'><u>int</u></font> jstop <font color='#5555FF'>=</font> png_pass_inc[pass];

<font color='#0000FF'>#ifdef</font> PNG_READ_PACKSWAP_SUPPORTED
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font>
            <b>{</b>
               sshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               dshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               s_start <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
               s_end <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               s_inc <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>4</font>;
            <b>}</b>

            <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
            <b>{</b>
               sshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               dshift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               s_start <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               s_end <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
               s_inc <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            <b>}</b>

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_byte v <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> sshift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'><u>int</u></font> j;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> jstop; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0xf0f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>4</font> <font color='#5555FF'>-</font> dshift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                  tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> v <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> dshift;
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dshift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s_end<font face='Lucida Console'>)</font>
                  <b>{</b>
                     dshift <font color='#5555FF'>=</font> s_start;
                     dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     dshift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s_inc;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sshift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s_end<font face='Lucida Console'>)</font>
               <b>{</b>
                  sshift <font color='#5555FF'>=</font> s_start;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  sshift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s_inc;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>default</font>:
         <b>{</b>
            png_size_t pixel_bytes <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;

            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
                <font color='#5555FF'>*</font> pixel_bytes;

            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>final_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> pixel_bytes;

            <font color='#0000FF'><u>int</u></font> jstop <font color='#5555FF'>=</font> png_pass_inc[pass];
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_byte v[<font color='#979000'>8</font>]; <font color='#009900'>/* SAFE; pixel_depth does not exceed 64 */</font>
               <font color='#0000FF'><u>int</u></font> j;

               <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>v, sp, pixel_bytes<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> jstop; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>dp, v, pixel_bytes<font face='Lucida Console'>)</font>;
                  dp <font color='#5555FF'>-</font><font color='#5555FF'>=</font> pixel_bytes;
               <b>}</b>

               sp <font color='#5555FF'>-</font><font color='#5555FF'>=</font> pixel_bytes;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>
      <b>}</b>

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>=</font> final_width;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, final_width<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#ifndef</font> PNG_READ_PACKSWAP_SUPPORTED
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>transformations<font face='Lucida Console'>)</font>  <font color='#009900'>/* Silence compiler warning */</font>
<font color='#0000FF'>#endif</font>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_INTERLACING_SUPPORTED */</font>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_read_filter_row_sub'></a>png_read_filter_row_sub</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
   png_const_bytep prev_row<font face='Lucida Console'>)</font>
<b>{</b>
   png_size_t i;
   png_size_t istop <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> bpp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font>;
   png_bytep rp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> bpp;

   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>prev_row<font face='Lucida Console'>)</font>

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> bpp; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>rp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>rp<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp<font color='#5555FF'>-</font>bpp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_read_filter_row_up'></a>png_read_filter_row_up</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
   png_const_bytep prev_row<font face='Lucida Console'>)</font>
<b>{</b>
   png_size_t i;
   png_size_t istop <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
   png_bytep rp <font color='#5555FF'>=</font> row;
   png_const_bytep pp <font color='#5555FF'>=</font> prev_row;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>rp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>rp<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
      rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_read_filter_row_avg'></a>png_read_filter_row_avg</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
   png_const_bytep prev_row<font face='Lucida Console'>)</font>
<b>{</b>
   png_size_t i;
   png_bytep rp <font color='#5555FF'>=</font> row;
   png_const_bytep pp <font color='#5555FF'>=</font> prev_row;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> bpp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font>;
   png_size_t istop <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>-</font> bpp;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> bpp; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>rp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>rp<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
         <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#979000'>2</font> <font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

      rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   <b>}</b>

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>rp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>rp<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>pp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp<font color='#5555FF'>-</font>bpp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#979000'>2</font> <font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

      rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_read_filter_row_paeth_1byte_pixel'></a>png_read_filter_row_paeth_1byte_pixel</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
   png_const_bytep prev_row<font face='Lucida Console'>)</font>
<b>{</b>
   png_bytep rp_end <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
   <font color='#0000FF'><u>int</u></font> a, c;

   <font color='#009900'>/* First pixel/byte */</font>
   c <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>prev_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>row <font color='#5555FF'>+</font> c;
   <font color='#5555FF'>*</font>row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>a;

   <font color='#009900'>/* Remainder */</font>
   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>&lt;</font> rp_end<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> b, pa, pb, pc, p;

      a <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font>; <font color='#009900'>/* From previous iteration or start */</font>
      b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>prev_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

      p <font color='#5555FF'>=</font> b <font color='#5555FF'>-</font> c;
      pc <font color='#5555FF'>=</font> a <font color='#5555FF'>-</font> c;

#     ifdef PNG_USE_ABS
         pa <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>;
         pb <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>pc<font face='Lucida Console'>)</font>;
         pc <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>else</font>
         pa <font color='#5555FF'>=</font> p <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>p : p;
         pb <font color='#5555FF'>=</font> pc <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>pc : pc;
         pc <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> : p <font color='#5555FF'>+</font> pc;
#     endif

      <font color='#009900'>/* Find the best predictor, the least of pa, pb, pc favoring the earlier
       * ones in the case of a tie.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pb <font color='#5555FF'>&lt;</font> pa<font face='Lucida Console'>)</font> pa <font color='#5555FF'>=</font> pb, a <font color='#5555FF'>=</font> b;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pc <font color='#5555FF'>&lt;</font> pa<font face='Lucida Console'>)</font> a <font color='#5555FF'>=</font> c;

      <font color='#009900'>/* Calculate the current pixel in a, and move the previous row pixel to c
       * for the next time round the loop
       */</font>
      c <font color='#5555FF'>=</font> b;
      a <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>row;
      <font color='#5555FF'>*</font>row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>a;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_read_filter_row_paeth_multibyte_pixel'></a>png_read_filter_row_paeth_multibyte_pixel</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
   png_const_bytep prev_row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> bpp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font>;
   png_bytep rp_end <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> bpp;

   <font color='#009900'>/* Process the first pixel in the row completely (this is the same as 'up'
    * because there is only one candidate predictor for the first row).
    */</font>
   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>&lt;</font> rp_end<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>row <font color='#5555FF'>+</font> <font color='#5555FF'>*</font>prev_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <font color='#5555FF'>*</font>row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>a;
   <b>}</b>

   <font color='#009900'>/* Remainder */</font>
   rp_end <font color='#5555FF'>+</font><font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>-</font> bpp;

   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>&lt;</font> rp_end<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> a, b, c, pa, pb, pc, p;

      c <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>prev_row <font color='#5555FF'>-</font> bpp<font face='Lucida Console'>)</font>;
      a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>row <font color='#5555FF'>-</font> bpp<font face='Lucida Console'>)</font>;
      b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>prev_row<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

      p <font color='#5555FF'>=</font> b <font color='#5555FF'>-</font> c;
      pc <font color='#5555FF'>=</font> a <font color='#5555FF'>-</font> c;

#     ifdef PNG_USE_ABS
         pa <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>;
         pb <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>pc<font face='Lucida Console'>)</font>;
         pc <font color='#5555FF'>=</font> <font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>else</font>
         pa <font color='#5555FF'>=</font> p <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>p : p;
         pb <font color='#5555FF'>=</font> pc <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font>pc : pc;
         pc <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>p <font color='#5555FF'>+</font> pc<font face='Lucida Console'>)</font> : p <font color='#5555FF'>+</font> pc;
#     endif

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pb <font color='#5555FF'>&lt;</font> pa<font face='Lucida Console'>)</font> pa <font color='#5555FF'>=</font> pb, a <font color='#5555FF'>=</font> b;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pc <font color='#5555FF'>&lt;</font> pa<font face='Lucida Console'>)</font> a <font color='#5555FF'>=</font> c;

      c <font color='#5555FF'>=</font> b;
      a <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>row;
      <font color='#5555FF'>*</font>row<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>a;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_init_filter_functions'></a>png_init_filter_functions</b><font face='Lucida Console'>(</font>png_structrp pp<font face='Lucida Console'>)</font>
   <font color='#009900'>/* This function is called once for every PNG image (except for PNG images
    * that only use PNG_FILTER_VALUE_NONE for all rows) to set the
    * implementations required to reverse the filtering of PNG rows.  Reversing
    * the filter is the first transformation performed on the row data.  It is
    * performed in place, therefore an implementation can be selected based on
    * the image pixel format.  If the implementation depends on image width then
    * take care to ensure that it works correctly if the image is interlaced -
    * interlacing causes the actual row width to vary.
    */</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> bpp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font>;

   pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[PNG_FILTER_VALUE_SUB<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font> png_read_filter_row_sub;
   pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[PNG_FILTER_VALUE_UP<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font> png_read_filter_row_up;
   pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[PNG_FILTER_VALUE_AVG<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font> png_read_filter_row_avg;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bpp <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[PNG_FILTER_VALUE_PAETH<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font>
         png_read_filter_row_paeth_1byte_pixel;
   <font color='#0000FF'>else</font>
      pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[PNG_FILTER_VALUE_PAETH<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font>
         png_read_filter_row_paeth_multibyte_pixel;

<font color='#0000FF'>#ifdef</font> PNG_FILTER_OPTIMIZATIONS
   <font color='#009900'>/* To use this define PNG_FILTER_OPTIMIZATIONS as the name of a function to
    * call to install hardware optimizations for the above functions; simply
    * replace whatever elements of the pp-&gt;read_filter[] array with a hardware
    * specific (or, for that matter, generic) optimization.
    *
    * To see an example of this examine what configure.ac does when
    * --enable-arm-neon is specified on the command line.
    */</font>
   <font color='#BB00BB'>PNG_FILTER_OPTIMIZATIONS</font><font face='Lucida Console'>(</font>pp, bpp<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_filter_row'></a>png_read_filter_row</b><font face='Lucida Console'>(</font>png_structrp pp, png_row_infop row_info, png_bytep row,
   png_const_bytep prev_row, <font color='#0000FF'><u>int</u></font> filter<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* OPTIMIZATION: DO NOT MODIFY THIS FUNCTION, instead #define
    * PNG_FILTER_OPTIMIZATIONS to a function that overrides the generic
    * implementations.  See png_init_filter_functions above.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter <font color='#5555FF'>&gt;</font> PNG_FILTER_VALUE_NONE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> filter <font color='#5555FF'>&lt;</font> PNG_FILTER_VALUE_LAST<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[<font color='#979000'>0</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_init_filter_functions</font><font face='Lucida Console'>(</font>pp<font face='Lucida Console'>)</font>;

      pp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_filter[filter<font color='#5555FF'>-</font><font color='#979000'>1</font>]<font face='Lucida Console'>(</font>row_info, row, prev_row<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_IDAT_data'></a>png_read_IDAT_data</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytep output,
   png_alloc_size_t avail_out<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Loop reading IDATs and decompressing the result into output[avail_out] */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> output;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* safety: set below */</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>do</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> ret;
      png_byte tmpbuf[PNG_INFLATE_BUF_SIZE];

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         uInt avail_in;
         png_bytep buffer;

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_chunk_header</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
            <font color='#009900'>/* This is an error even in the 'check' case because the code just
             * consumed a non-IDAT header.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Not enough image data</font>"<font face='Lucida Console'>)</font>;
         <b>}</b>

         avail_in <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>IDAT_read_size;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_in <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size<font face='Lucida Console'>)</font>
            avail_in <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size;

         <font color='#009900'>/* A PNG with a gradually increasing IDAT size will defeat this attempt
          * to minimize memory usage by causing lots of re-allocs, but
          * realistically doing IDAT_read_size re-allocs is not likely to be a
          * big problem.
          */</font>
         buffer <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_buffer</font><font face='Lucida Console'>(</font>png_ptr, avail_in, <font color='#979000'>0</font><font color='#009900'>/*error*/</font><font face='Lucida Console'>)</font>;

         <font color='#BB00BB'>png_crc_read</font><font face='Lucida Console'>(</font>png_ptr, buffer, avail_in<font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size <font color='#5555FF'>-</font><font color='#5555FF'>=</font> avail_in;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> buffer;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> avail_in;
      <b>}</b>

      <font color='#009900'>/* And set up the output side. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <font color='#009900'>/* standard read */</font>
      <b>{</b>
         uInt out <font color='#5555FF'>=</font> ZLIB_IO_MAX;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>out <font color='#5555FF'>&gt;</font> avail_out<font face='Lucida Console'>)</font>
            out <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>avail_out;

         avail_out <font color='#5555FF'>-</font><font color='#5555FF'>=</font> out;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> out;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#009900'>/* after last row, checking for end */</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> tmpbuf;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> tmpbuf<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#009900'>/* Use NO_FLUSH; this gives zlib the maximum opportunity to optimize the
       * process.  If the LZ stream is truncated the sequential reader will
       * terminally damage the stream, above, by reading the chunk header of the
       * following chunk (it then exits with png_error).
       *
       * TODO: deal more elegantly with truncated IDAT lists.
       */</font>
      ret <font color='#5555FF'>=</font> <font color='#BB00BB'>inflate</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream, Z_NO_FLUSH<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Take the unconsumed output back. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         avail_out <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;

      <font color='#0000FF'>else</font> <font color='#009900'>/* avail_out counts the extra bytes */</font>
         avail_out <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> tmpbuf<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_STREAM_END<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Do this for safety; we won't read any more into this row. */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> NULL;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_ZSTREAM_ENDED;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Extra compressed data</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_ptr, ret<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font> <font color='#009900'>/* checking */</font>
         <b>{</b>
            <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font>;
         <b>}</b>
      <b>}</b>
   <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>avail_out <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>avail_out <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* The stream ended before the image; this is the same as too few IDATs so
       * should be handled the same way.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Not enough image data</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#009900'>/* the deflate stream contained extra data */</font>
         <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Too much image data</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_finish_IDAT'></a>png_read_finish_IDAT</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* We don't need any more data and the stream should have ended, however the
    * LZ end code may actually not have been processed.  In this case we must
    * read it otherwise stray unread IDAT data or, more likely, an IDAT chunk
    * may still remain to be consumed.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ZSTREAM_ENDED<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* The NULL causes png_read_IDAT_data to swallow any remaining bytes in
       * the compressed stream, but the stream may be damaged too, so even after
       * this call we may need to terminate the zstream ownership.
       */</font>
      <font color='#BB00BB'>png_read_IDAT_data</font><font face='Lucida Console'>(</font>png_ptr, NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_out <font color='#5555FF'>=</font> NULL; <font color='#009900'>/* safety */</font>

      <font color='#009900'>/* Now clear everything out for safety; the following may not have been
       * done.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ZSTREAM_ENDED<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_ZSTREAM_ENDED;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* If the zstream has not been released do it now *and* terminate the reading
    * of the final IDAT chunk.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Always do this; the pointers otherwise point into the read buffer. */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.next_in <font color='#5555FF'>=</font> NULL;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.avail_in <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* Now we no longer own the zstream. */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zowner <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* The slightly weird semantics of the sequential IDAT reading is that we
       * are always in or at the end of an IDAT chunk, so we always need to do a
       * crc_finish here.  If idat_size is non-zero we also need to read the
       * spurious bytes at the end of the chunk now.
       */</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_finish_row'></a>png_read_finish_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#009900'>/* Arrays to facilitate easy interlacing - use pass (0 - 6) as index */</font>

   <font color='#009900'>/* Start of interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_start[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_inc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Start of interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_ystart[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_yinc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font><b>}</b>;
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_INTERLACING_SUPPORTED */</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_finish_row</font>"<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#009900'>/* TO DO: don't do this if prev_row isn't needed (requires
       * read-ahead of the next row's filter byte.
       */</font>
      <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row, <font color='#979000'>0</font>, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>do</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>break</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font>
            png_pass_inc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
            png_pass_start[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
            png_pass_inc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass];

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>+</font>
                png_pass_yinc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
                png_pass_ystart[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
                png_pass_yinc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass];
         <b>}</b>

         <font color='#0000FF'>else</font>  <font color='#009900'>/* if (png_ptr-&gt;transformations &amp; PNG_INTERLACE) */</font>
            <font color='#0000FF'>break</font>; <font color='#009900'>/* libpng deinterlacing sees every row */</font>

      <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass <font color='#5555FF'>&lt;</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>return</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_INTERLACING_SUPPORTED */</font>

   <font color='#009900'>/* Here after at the end of the last row of the last pass. */</font>
   <font color='#BB00BB'>png_read_finish_IDAT</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_start_row'></a>png_read_start_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#009900'>/* Arrays to facilitate easy interlacing - use pass (0 - 6) as index */</font>

   <font color='#009900'>/* Start of interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_start[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_inc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Start of interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_ystart[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>0</font>, <font color='#979000'>0</font>, <font color='#979000'>4</font>, <font color='#979000'>0</font>, <font color='#979000'>2</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font><b>}</b>;

   <font color='#009900'>/* Offset to next interlace block in the y direction */</font>
   <font color='#0000FF'>static</font> PNG_CONST png_byte png_pass_yinc[<font color='#979000'>7</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>8</font>, <font color='#979000'>4</font>, <font color='#979000'>4</font>, <font color='#979000'>2</font>, <font color='#979000'>2</font><b>}</b>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'><u>int</u></font> max_pixel_depth;
   png_size_t row_bytes;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_start_row</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_TRANSFORMS_SUPPORTED
   <font color='#BB00BB'>png_init_read_transformations</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>+</font> png_pass_yinc[<font color='#979000'>0</font>] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
             png_pass_ystart[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> png_pass_yinc[<font color='#979000'>0</font>];

      <font color='#0000FF'>else</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font>
          png_pass_inc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass] <font color='#5555FF'>-</font> <font color='#979000'>1</font> <font color='#5555FF'>-</font>
          png_pass_start[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass]<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font>
          png_pass_inc[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass];
   <b>}</b>

   <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_INTERLACING_SUPPORTED */</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   <b>}</b>

   max_pixel_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth;

   <font color='#009900'>/* WARNING: * png_read_transform_info (pngrtran.c) performs a simpliar set of
    * calculations to calculate the final pixel depth, then
    * png_do_read_transforms actually does the transforms.  This means that the
    * code which effectively calculates this value is actually repeated in three
    * separate places.  They must all match.  Innocent changes to the order of
    * transformations can and will break libpng in a way that causes memory
    * overwrites.
    *
    * TODO: fix this.
    */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_PACK_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACK<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans<font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;

         <font color='#0000FF'>else</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>24</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_pixel_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans<font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans<font face='Lucida Console'>)</font>
         <b>{</b>
            max_pixel_depth <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            max_pixel_depth <font color='#5555FF'>/</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>;
         <b>}</b>
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_16_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_16<font face='Lucida Console'>)</font>
   <b>{</b>
#     ifdef PNG_READ_EXPAND_SUPPORTED
         <font color='#009900'>/* In fact it is an error if it isn't supported, but checking is
          * the safe way.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
               max_pixel_depth <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         <b>}</b>
         <font color='#0000FF'>else</font>
#     endif
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_EXPAND_16;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_FILLER_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_FILLER<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_pixel_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>16</font>;

         <font color='#0000FF'>else</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_pixel_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>32</font><font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;

         <font color='#0000FF'>else</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>64</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GRAY_TO_RGB<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>
<font color='#0000FF'>#ifdef</font> <font color='#BB00BB'>PNG_READ_EXPAND_SUPPORTED</font>
          <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#ifdef</font> <font color='#BB00BB'>PNG_READ_FILLER_SUPPORTED</font>
          <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_FILLER<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
<font color='#0000FF'>#endif</font>
          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_pixel_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;

         <font color='#0000FF'>else</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>64</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_pixel_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font>
               max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;

            <font color='#0000FF'>else</font>
               max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>24</font>;
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>64</font>;

         <font color='#0000FF'>else</font>
            max_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>48</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_USER_TRANSFORM_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
<font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_USER_TRANSFORM_PTR_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_USER_TRANSFORM<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> user_pixel_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_depth <font color='#5555FF'>*</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_channels;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>user_pixel_depth <font color='#5555FF'>&gt;</font> max_pixel_depth<font face='Lucida Console'>)</font>
         max_pixel_depth <font color='#5555FF'>=</font> user_pixel_depth;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* This value is stored in png_struct and double checked in the row read
    * code.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>maximum_pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>max_pixel_depth;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformed_pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* calculated on demand */</font>

   <font color='#009900'>/* Align the width on the next larger 8 pixels.  Mainly used
    * for interlacing
    */</font>
   row_bytes <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> ~<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
   <font color='#009900'>/* Calculate the maximum bytes needed, adding a byte and a pixel
    * for safety's sake
    */</font>
   row_bytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>max_pixel_depth, row_bytes<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
       <font color='#979000'>1</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>max_pixel_depth <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_MAX_MALLOC_64K
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_bytes <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#979000'>65536</font>L<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>This image requires a row greater than 64KB</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_bytes <font color='#5555FF'>+</font> <font color='#979000'>48</font> <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>old_big_row_buf_size<font face='Lucida Console'>)</font>
   <b>{</b>
     <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_row_buf<font face='Lucida Console'>)</font>;
     <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_prev_row<font face='Lucida Console'>)</font>;

     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_row_buf <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_calloc</font><font face='Lucida Console'>(</font>png_ptr,
            row_bytes <font color='#5555FF'>+</font> <font color='#979000'>48</font><font face='Lucida Console'>)</font>;

     <font color='#0000FF'>else</font>
        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_row_buf <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, row_bytes <font color='#5555FF'>+</font> <font color='#979000'>48</font><font face='Lucida Console'>)</font>;

     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_prev_row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, row_bytes <font color='#5555FF'>+</font> <font color='#979000'>48</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_ALIGNED_MEMORY_SUPPORTED
     <font color='#009900'>/* Use 16-byte aligned memory for row_buf with at least 16 bytes
      * of padding before and after row_buf; treat prev_row similarly.
      * NOTE: the alignment is to the start of the pixels, one beyond the start
      * of the buffer, because of the filter byte.  Prior to libpng 1.5.6 this
      * was incorrect; the filter byte was aligned, which had the exact
      * opposite effect of that intended.
      */</font>
     <b>{</b>
        png_bytep temp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_row_buf <font color='#5555FF'>+</font> <font color='#979000'>32</font>;
        <font color='#0000FF'><u>int</u></font> extra <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>temp <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font>;
        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>=</font> temp <font color='#5555FF'>-</font> extra <font color='#5555FF'>-</font> <font color='#979000'>1</font><font color='#009900'>/*filter byte*/</font>;

        temp <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_prev_row <font color='#5555FF'>+</font> <font color='#979000'>32</font>;
        extra <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>temp <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font>;
        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>=</font> temp <font color='#5555FF'>-</font> extra <font color='#5555FF'>-</font> <font color='#979000'>1</font><font color='#009900'>/*filter byte*/</font>;
     <b>}</b>

<font color='#0000FF'>#else</font>
     <font color='#009900'>/* Use 31 bytes of padding before and 17 bytes after row_buf. */</font>
     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_row_buf <font color='#5555FF'>+</font> <font color='#979000'>31</font>;
     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_prev_row <font color='#5555FF'>+</font> <font color='#979000'>31</font>;
<font color='#0000FF'>#endif</font>
     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>old_big_row_buf_size <font color='#5555FF'>=</font> row_bytes <font color='#5555FF'>+</font> <font color='#979000'>48</font>;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_MAX_MALLOC_64K
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>&gt;</font> <font color='#979000'>65535</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>This image requires a row greater than 64KB</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#endif</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font>PNG_SIZE_MAX <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Row has too many bytes to allocate in memory</font>"<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row, <font color='#979000'>0</font>, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>width = %u,</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>height = %u,</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>iwidth = %u,</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>num_rows = %u,</font>", png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>rowbytes = %lu,</font>", <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_debug1</font><font face='Lucida Console'>(</font><font color='#979000'>3</font>, "<font color='#CC0000'>irowbytes = %lu</font>",
       <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The sequential reader needs a buffer for IDAT, but the progressive reader
    * does not, so free the read buffer now regardless; the sequential reader
    * reallocates it on demand.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer<font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep buffer <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer_size <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer <font color='#5555FF'>=</font> NULL;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, buffer<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* Finally claim the zstream for the inflate of the IDAT data, use the bits
    * value from the stream (note that this will result in a fatal error if the
    * IDAT stream has a bogus deflate header window_bits value, but this should
    * not be happening any longer!)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_inflate_claim</font><font face='Lucida Console'>(</font>png_ptr, png_IDAT<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg<font face='Lucida Console'>)</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_ROW_INIT;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_SUPPORTED */</font>

</pre></body></html>