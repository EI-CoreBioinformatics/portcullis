<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - png.c</title></head><body bgcolor='white'><pre>

<font color='#009900'>/* png.c - location for general purpose libpng functions
 *
 * Last changed in libpng 1.6.2 [April 25, 2013]
 * Copyright (c) 1998-2013 Glenn Randers-Pehrson
 * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
 * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
 *
 * This code is released under the libpng license.
 * For conditions of distribution and use, see the disclaimer
 * and license in png.h
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pngpriv.h.html'>pngpriv.h</a>"

<font color='#009900'>/* Generate a compiler error if there is an old png.h in the search path. */</font>
<font color='#0000FF'>typedef</font> png_libpng_version_1_6_7 Your_png_h_is_not_version_1_6_7;

<font color='#009900'>/* Tells libpng that we have already handled the first "num_bytes" bytes
 * of the PNG file signature.  If the PNG data is embedded into another
 * stream we can set num_bytes = 8 so that libpng will not attempt to read
 * or write any of the magic bytes before it starts on the IHDR.
 */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_sig_bytes'></a>png_set_sig_bytes</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> num_bytes<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_sig_bytes</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_bytes <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Too many bytes for PNG signature</font>"<font face='Lucida Console'>)</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bytes <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_bytes <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> ? <font color='#979000'>0</font> : num_bytes<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Checks whether the supplied bytes match the PNG signature.  We allow
 * checking less than the full 8-byte signature so that those apps that
 * already read the first few bytes of a file to determine the file type
 * can simply check the remaining bytes for extra assurance.  Returns
 * an integer less than, equal to, or greater than zero if sig is found,
 * respectively, to be less than, to match, or be greater than the correct
 * PNG signature (this is the same behavior as strcmp, memcmp, etc).
 */</font>
<font color='#0000FF'><u>int</u></font> PNGAPI
<b><a name='png_sig_cmp'></a>png_sig_cmp</b><font face='Lucida Console'>(</font>png_const_bytep sig, png_size_t start, png_size_t num_to_check<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte png_signature[<font color='#979000'>8</font>] <font color='#5555FF'>=</font> <b>{</b><font color='#979000'>137</font>, <font color='#979000'>80</font>, <font color='#979000'>78</font>, <font color='#979000'>71</font>, <font color='#979000'>13</font>, <font color='#979000'>10</font>, <font color='#979000'>26</font>, <font color='#979000'>10</font><b>}</b>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_to_check <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      num_to_check <font color='#5555FF'>=</font> <font color='#979000'>8</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_to_check <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>start <font color='#5555FF'>&gt;</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>start <font color='#5555FF'>+</font> num_to_check <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      num_to_check <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>-</font> start;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#BB00BB'>memcmp</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>sig[start], <font color='#5555FF'>&amp;</font>png_signature[start], num_to_check<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_SUPPORTED */</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* Function to allocate memory for zlib */</font>
<b><a name='PNG_FUNCTION'></a>PNG_FUNCTION</b><font face='Lucida Console'>(</font>voidpf <font color='#009900'>/* PRIVATE */</font>,
png_zalloc,<font face='Lucida Console'>(</font>voidpf png_ptr, uInt items, uInt size<font face='Lucida Console'>)</font>,PNG_ALLOCATED<font face='Lucida Console'>)</font>
<b>{</b>
   png_alloc_size_t num_bytes <font color='#5555FF'>=</font> size;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> NULL;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>items <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>~<font face='Lucida Console'>(</font>png_alloc_size_t<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font>size<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_structrp, png_ptr<font face='Lucida Console'>)</font>,
         "<font color='#CC0000'>Potential overflow in png_zalloc()</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> NULL;
   <b>}</b>

   num_bytes <font color='#5555FF'>*</font><font color='#5555FF'>=</font> items;
   <font color='#0000FF'>return</font> <font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font><font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_structrp, png_ptr<font face='Lucida Console'>)</font>, num_bytes<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Function to free memory for zlib */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_zfree'></a>png_zfree</b><font face='Lucida Console'>(</font>voidpf png_ptr, voidpf ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font><font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_const_structrp,png_ptr<font face='Lucida Console'>)</font>, ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Reset the CRC variable to 32 bits of 1's.  Care must be taken
 * in case CRC is &gt; 32 bits to leave the top bits 0.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_reset_crc'></a>png_reset_crc</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The cast is safe because the crc is a 32 bit value. */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>crc <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, Z_NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Calculate the CRC over a section of data.  We can only pass as
 * much data to this routine as the largest single buffer size.  We
 * also check that this data will actually be used before going to the
 * trouble of calculating it.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_calculate_crc'></a>png_calculate_crc</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_bytep ptr, png_size_t length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> need_crc <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_CHUNK_ANCILLARY</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_ANCILLARY_MASK<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
          <font face='Lucida Console'>(</font>PNG_FLAG_CRC_ANCILLARY_USE <font color='#5555FF'>|</font> PNG_FLAG_CRC_ANCILLARY_NOWARN<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         need_crc <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#009900'>/* critical */</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_CRC_CRITICAL_IGNORE<font face='Lucida Console'>)</font>
         need_crc <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#009900'>/* 'uLong' is defined in zlib.h as unsigned long; this means that on some
    * systems it is a 64 bit value.  crc32, however, returns 32 bits so the
    * following cast is safe.  'uInt' may be no more than 16 bits, so it is
    * necessary to perform a loop here.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>need_crc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      uLong crc <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>crc; <font color='#009900'>/* Should never issue a warning */</font>

      <font color='#0000FF'>do</font>
      <b>{</b>
         uInt safe_length <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>length;
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>safe_length <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            safe_length <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font>; <font color='#009900'>/* evil, but safe */</font>

         crc <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>crc, ptr, safe_length<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* The following should never issue compiler warnings; if they do the
          * target system has characteristics that will probably violate other
          * assumptions within the libpng code.
          */</font>
         ptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> safe_length;
         length <font color='#5555FF'>-</font><font color='#5555FF'>=</font> safe_length;
      <b>}</b>
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

      <font color='#009900'>/* And the following is always safe because the crc is only 32 bits. */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>crc <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>crc;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Check a user supplied version number, called from both read and write
 * functions that create a png_struct.
 */</font>
<font color='#0000FF'><u>int</u></font>
<b><a name='png_user_version_check'></a>png_user_version_check</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_charp user_png_ver<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>user_png_ver<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>do</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>user_png_ver[i] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_libpng_ver[i]<font face='Lucida Console'>)</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_LIBRARY_MISMATCH;
      <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>png_libpng_ver[i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>]<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_LIBRARY_MISMATCH;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_LIBRARY_MISMATCH<font face='Lucida Console'>)</font>
   <b>{</b>
     <font color='#009900'>/* Libpng 0.90 and later are binary incompatible with libpng 0.89, so
      * we must recompile any applications that use any older library version.
      * For versions after libpng 1.0, we will be compatible, so we need
      * only check the first and third digits (note that when we reach version
      * 1.10 we will need to check the fourth symbol, namely user_png_ver[3]).
      */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>user_png_ver <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> user_png_ver[<font color='#979000'>0</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_libpng_ver[<font color='#979000'>0</font>] <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          <font face='Lucida Console'>(</font>user_png_ver[<font color='#979000'>0</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>1</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>user_png_ver[<font color='#979000'>2</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_libpng_ver[<font color='#979000'>2</font>] <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          user_png_ver[<font color='#979000'>3</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_libpng_ver[<font color='#979000'>3</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          <font face='Lucida Console'>(</font>user_png_ver[<font color='#979000'>0</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>0</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> user_png_ver[<font color='#979000'>2</font>] <font color='#5555FF'>&lt;</font> '<font color='#FF0000'>9</font>'<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_WARNINGS_SUPPORTED
         <font color='#0000FF'><u>size_t</u></font> pos <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#0000FF'><u>char</u></font> m[<font color='#979000'>128</font>];

         pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>m, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> m<font face='Lucida Console'>)</font>, pos,
             "<font color='#CC0000'>Application built with libpng-</font>"<font face='Lucida Console'>)</font>;
         pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>m, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> m<font face='Lucida Console'>)</font>, pos, user_png_ver<font face='Lucida Console'>)</font>;
         pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>m, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> m<font face='Lucida Console'>)</font>, pos, "<font color='#CC0000'> but running with </font>"<font face='Lucida Console'>)</font>;
         pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>m, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> m<font face='Lucida Console'>)</font>, pos, png_libpng_ver<font face='Lucida Console'>)</font>;

         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, m<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_ERROR_NUMBERS_SUPPORTED
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
<font color='#0000FF'>#endif</font>

         <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Success return. */</font>
   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>/* Generic function to create a png_struct for either read or write - this
 * contains the common initialization.
 */</font>
<b><a name='PNG_FUNCTION'></a>PNG_FUNCTION</b><font face='Lucida Console'>(</font>png_structp <font color='#009900'>/* PRIVATE */</font>,
png_create_png_struct,<font face='Lucida Console'>(</font>png_const_charp user_png_ver, png_voidp error_ptr,
    png_error_ptr error_fn, png_error_ptr warn_fn, png_voidp mem_ptr,
    png_malloc_ptr malloc_fn, png_free_ptr free_fn<font face='Lucida Console'>)</font>,PNG_ALLOCATED<font face='Lucida Console'>)</font>
<b>{</b>
   png_struct create_struct;
#  ifdef PNG_SETJMP_SUPPORTED
      jmp_buf create_jmp_buf;
#  endif

   <font color='#009900'>/* This temporary stack-allocated structure is used to provide a place to
    * build enough context to allow the user provided memory allocator (if any)
    * to be called.
    */</font>
   <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>create_struct, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> create_struct<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Added at libpng-1.2.6 */</font>
#  ifdef PNG_USER_LIMITS_SUPPORTED
      create_struct.user_width_max <font color='#5555FF'>=</font> PNG_USER_WIDTH_MAX;
      create_struct.user_height_max <font color='#5555FF'>=</font> PNG_USER_HEIGHT_MAX;

#     ifdef PNG_USER_CHUNK_CACHE_MAX
         <font color='#009900'>/* Added at libpng-1.2.43 and 1.4.0 */</font>
         create_struct.user_chunk_cache_max <font color='#5555FF'>=</font> PNG_USER_CHUNK_CACHE_MAX;
#     endif

#     ifdef PNG_USER_CHUNK_MALLOC_MAX
         <font color='#009900'>/* Added at libpng-1.2.43 and 1.4.1, required only for read but exists
          * in png_struct regardless.
          */</font>
         create_struct.user_chunk_malloc_max <font color='#5555FF'>=</font> PNG_USER_CHUNK_MALLOC_MAX;
#     endif
#  endif

   <font color='#009900'>/* The following two API calls simply set fields in png_struct, so it is safe
    * to do them now even though error handling is not yet set up.
    */</font>
#  ifdef PNG_USER_MEM_SUPPORTED
      <font color='#BB00BB'>png_set_mem_fn</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>create_struct, mem_ptr, malloc_fn, free_fn<font face='Lucida Console'>)</font>;
#  endif

   <font color='#009900'>/* (*error_fn) can return control to the caller after the error_ptr is set,
    * this will result in a memory leak unless the error_fn does something
    * extremely sophisticated.  The design lacks merit but is implicit in the
    * API.
    */</font>
   <font color='#BB00BB'>png_set_error_fn</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>create_struct, error_ptr, error_fn, warn_fn<font face='Lucida Console'>)</font>;

#  ifdef PNG_SETJMP_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>setjmp</font><font face='Lucida Console'>(</font>create_jmp_buf<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Temporarily fake out the longjmp information until we have
          * successfully completed this function.  This only works if we have
          * setjmp() support compiled in, but it is safe - this stuff should
          * never happen.
          */</font>
         create_struct.jmp_buf_ptr <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>create_jmp_buf;
         create_struct.jmp_buf_size <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/*stack allocation*/</font>
         create_struct.longjmp_fn <font color='#5555FF'>=</font> longjmp;
#  <font color='#0000FF'>else</font>
      <b>{</b>
#  endif
         <font color='#009900'>/* Call the general version checker (shared with read and write code):
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_user_version_check</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>create_struct, user_png_ver<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_structrp png_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_structrp,
               <font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>create_struct, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>png_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* png_ptr-&gt;zstream holds a back-pointer to the png_struct, so
                * this can only be done now:
                */</font>
               create_struct.zstream.zalloc <font color='#5555FF'>=</font> png_zalloc;
               create_struct.zstream.zfree <font color='#5555FF'>=</font> png_zfree;
               create_struct.zstream.opaque <font color='#5555FF'>=</font> png_ptr;

#              ifdef PNG_SETJMP_SUPPORTED
                  <font color='#009900'>/* Eliminate the local error handling: */</font>
                  create_struct.jmp_buf_ptr <font color='#5555FF'>=</font> NULL;
                  create_struct.jmp_buf_size <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  create_struct.longjmp_fn <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#              endif

               <font color='#5555FF'>*</font>png_ptr <font color='#5555FF'>=</font> create_struct;

               <font color='#009900'>/* This is the successful return point */</font>
               <font color='#0000FF'>return</font> png_ptr;
            <b>}</b>
         <b>}</b>
      <b>}</b>

   <font color='#009900'>/* A longjmp because of a bug in the application storage allocator or a
    * simple failure to allocate the png_struct.
    */</font>
   <font color='#0000FF'>return</font> NULL;
<b>}</b>

<font color='#009900'>/* Allocate the memory for an info_struct for the application. */</font>
<font color='#BB00BB'>PNG_FUNCTION</font><font face='Lucida Console'>(</font>png_infop,PNGAPI
png_create_info_struct,<font face='Lucida Console'>(</font>png_const_structrp png_ptr<font face='Lucida Console'>)</font>,PNG_ALLOCATED<font face='Lucida Console'>)</font>
<b>{</b>
   png_inforp info_ptr;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_create_info_struct</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> NULL;

   <font color='#009900'>/* Use the internal API that does not (or at least should not) error out, so
    * that this call always returns ok.  The application typically sets up the
    * error handling *after* creating the info_struct because this is the way it
    * has always been done in 'example.c'.
    */</font>
   info_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_inforp, <font color='#BB00BB'>png_malloc_base</font><font face='Lucida Console'>(</font>png_ptr,
      <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>info_ptr, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> info_ptr;
<b>}</b>

<font color='#009900'>/* This function frees the memory associated with a single info struct.
 * Normally, one would use either png_destroy_read_struct() or
 * png_destroy_write_struct() to free an info struct, but this may be
 * useful for some applications.  From libpng 1.6.0 this function is also used
 * internally to implement the png_info release part of the 'struct' destroy
 * APIs.  This ensures that all possible approaches free the same data (all of
 * it).
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<font color='#BB00BB'>png_destroy_info_struct</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_infopp info_ptr_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_inforp info_ptr <font color='#5555FF'>=</font> NULL;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_destroy_info_struct</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      info_ptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>info_ptr_ptr;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Do this first in case of an error below; if the app implements its own
       * memory management this can lead to png_free calling png_error, which
       * will abort this routine and return control to the app error handler.
       * An infinite loop may result if it then tries to free the same info
       * ptr.
       */</font>
      <font color='#5555FF'>*</font>info_ptr_ptr <font color='#5555FF'>=</font> NULL;

      <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_FREE_ALL, <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>info_ptr, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Initialize the info structure.  This is now an internal function (0.89)
 * and applications using it are urged to use png_create_info_struct()
 * instead.  Use deprecated in 1.6.0, internal use removed (used internally it
 * is just a memset).
 *
 * NOTE: it is almost inconceivable that this API is used because it bypasses
 * the user-memory mechanism and the user error handling/warning mechanisms in
 * those cases where it does anything other than a memset.
 */</font>
<font color='#BB00BB'>PNG_FUNCTION</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font>,PNGAPI
png_info_init_3,<font face='Lucida Console'>(</font>png_infopp ptr_ptr, png_size_t png_info_struct_size<font face='Lucida Console'>)</font>,
   PNG_DEPRECATED<font face='Lucida Console'>)</font>
<b>{</b>
   png_inforp info_ptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>ptr_ptr;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_info_init_3</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_info<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> png_info_struct_size<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#5555FF'>*</font>ptr_ptr <font color='#5555FF'>=</font> NULL;
      <font color='#009900'>/* The following line is why this API should not be used: */</font>
      <font color='#BB00BB'>free</font><font face='Lucida Console'>(</font>info_ptr<font face='Lucida Console'>)</font>;
      info_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_inforp, <font color='#BB00BB'>png_malloc_base</font><font face='Lucida Console'>(</font>NULL,
         <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#5555FF'>*</font>ptr_ptr <font color='#5555FF'>=</font> info_ptr;
   <b>}</b>

   <font color='#009900'>/* Set everything to 0 */</font>
   <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>info_ptr, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* The following API is not called internally */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<font color='#BB00BB'>png_data_freer</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_inforp info_ptr,
   <font color='#0000FF'><u>int</u></font> freer, png_uint_32 mask<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_data_freer</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> info_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>freer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_DESTROY_WILL_FREE_DATA<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>|</font><font color='#5555FF'>=</font> mask;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>freer <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_USER_WILL_FREE_DATA<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~mask;

   <font color='#0000FF'>else</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unknown freer parameter in png_data_freer</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'><u>void</u></font> PNGAPI
<font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_inforp info_ptr, png_uint_32 mask,
   <font color='#0000FF'><u>int</u></font> num<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_free_data</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> info_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

<font color='#0000FF'>#ifdef</font> PNG_TEXT_SUPPORTED
   <font color='#009900'>/* Free text item num or (if num == -1) all text items */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_TEXT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text[num].key<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text[num].key<font face='Lucida Console'>)</font>;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text[num].key <font color='#5555FF'>=</font> NULL;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> i;
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_text; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
             <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_FREE_TEXT, i<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text<font face='Lucida Console'>)</font>;
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text <font color='#5555FF'>=</font> NULL;
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_text<font color='#5555FF'>=</font><font color='#979000'>0</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_tRNS_SUPPORTED
   <font color='#009900'>/* Free any tRNS entry */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_TRNS<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_tRNS;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_sCAL_SUPPORTED
   <font color='#009900'>/* Free any sCAL entry */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_SCAL<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>scal_s_width<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>scal_s_height<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>scal_s_width <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>scal_s_height <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_sCAL;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_pCAL_SUPPORTED
   <font color='#009900'>/* Free any pCAL entry */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_PCAL<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_purpose<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_units<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_purpose <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_units <font color='#5555FF'>=</font> NULL;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_params <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_nparams; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_params[i]<font face='Lucida Console'>)</font>;
               info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_params[i] <font color='#5555FF'>=</font> NULL;
            <b>}</b>
            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_params<font face='Lucida Console'>)</font>;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pcal_params <font color='#5555FF'>=</font> NULL;
         <b>}</b>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_pCAL;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_iCCP_SUPPORTED
   <font color='#009900'>/* Free any profile entry */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_ICCP<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_name<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_profile<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_name <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iccp_profile <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_iCCP;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_sPLT_SUPPORTED
   <font color='#009900'>/* Free a given sPLT entry, or (if num == -1) all sPLT entries */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_SPLT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes[num].name<font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes[num].entries<font face='Lucida Console'>)</font>;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes[num].name <font color='#5555FF'>=</font> NULL;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes[num].entries <font color='#5555FF'>=</font> NULL;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes_num<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> i;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes_num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_FREE_SPLT, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>i<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes<font face='Lucida Console'>)</font>;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes <font color='#5555FF'>=</font> NULL;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>splt_palettes_num <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <b>}</b>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_sPLT;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_STORE_UNKNOWN_CHUNKS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_UNKN<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <b>{</b>
          <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks<font face='Lucida Console'>)</font>
          <b>{</b>
             <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks[num].data<font face='Lucida Console'>)</font>;
             info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks[num].data <font color='#5555FF'>=</font> NULL;
          <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> i;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks_num<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks_num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_FREE_UNKN, <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>i<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks<font face='Lucida Console'>)</font>;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks <font color='#5555FF'>=</font> NULL;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunks_num <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <b>}</b>
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_hIST_SUPPORTED
   <font color='#009900'>/* Free any hIST entry */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_HIST<font face='Lucida Console'>)</font>  <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hist<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hist <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_hIST;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Free any PLTE entry that was internally allocated */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_PLTE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette <font color='#5555FF'>=</font> NULL;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_PLTE;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_INFO_IMAGE_SUPPORTED
   <font color='#009900'>/* Free any image bits attached to the info structure */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>mask <font color='#5555FF'>&amp;</font> PNG_FREE_ROWS<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers<font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_32 row;
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>=</font> <font color='#979000'>0</font>; row <font color='#5555FF'>&lt;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height; row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers[row]<font face='Lucida Console'>)</font>;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers[row] <font color='#5555FF'>=</font> NULL;
         <b>}</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers<font face='Lucida Console'>)</font>;
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers <font color='#5555FF'>=</font> NULL;
      <b>}</b>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_IDAT;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>
      mask <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FREE_MUL;

   info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~mask;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* defined(PNG_READ_SUPPORTED) || defined(PNG_WRITE_SUPPORTED) */</font>

<font color='#009900'>/* This function returns a pointer to the io_ptr associated with the user
 * functions.  The application should free any memory associated with this
 * pointer before png_write_destroy() or png_read_destroy() are called.
 */</font>
png_voidp PNGAPI
<font color='#BB00BB'>png_get_io_ptr</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>NULL<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_SUPPORTED<font face='Lucida Console'>)</font>
#  ifdef PNG_STDIO_SUPPORTED
<font color='#009900'>/* Initialize the default input/output functions for the PNG file.  If you
 * use your own read or write routines, you can call either png_set_read_fn()
 * or png_set_write_fn() instead of png_init_io().  If you have defined
 * PNG_NO_STDIO or otherwise disabled PNG_STDIO_SUPPORTED, you must use a
 * function of your own because "FILE *" isn't necessarily available.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<font color='#BB00BB'>png_init_io</font><font face='Lucida Console'>(</font>png_structrp png_ptr, png_FILE_p fp<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_init_io</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_voidp<font face='Lucida Console'>)</font>fp;
<b>}</b>
#  endif

<font color='#0000FF'>#ifdef</font> PNG_SAVE_INT_32_SUPPORTED
<font color='#009900'>/* The png_save_int_32 function assumes integers are stored in two's
 * complement format.  If this isn't the case, then this routine needs to
 * be modified to write data in two's complement format.  Note that,
 * the following works correctly even if png_int_32 has more than 32 bits
 * (compare the more complex code required on read for sign extension.)
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<font color='#BB00BB'>png_save_int_32</font><font face='Lucida Console'>(</font>png_bytep buf, png_int_32 i<font face='Lucida Console'>)</font>
<b>{</b>
   buf[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
   buf[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

#  ifdef PNG_TIME_RFC1123_SUPPORTED
<font color='#009900'>/* Convert the supplied time into an RFC 1123 string suitable for use in
 * a "Creation Time" or other text-based time string.
 */</font>
<font color='#0000FF'><u>int</u></font> PNGAPI
<font color='#BB00BB'>png_convert_to_rfc1123_buffer</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font> out[<font color='#979000'>29</font>], png_const_timep ptime<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>static</font> PNG_CONST <font color='#0000FF'><u>char</u></font> short_months[<font color='#979000'>12</font>][<font color='#979000'>4</font>] <font color='#5555FF'>=</font>
        <b>{</b>"<font color='#CC0000'>Jan</font>", "<font color='#CC0000'>Feb</font>", "<font color='#CC0000'>Mar</font>", "<font color='#CC0000'>Apr</font>", "<font color='#CC0000'>May</font>", "<font color='#CC0000'>Jun</font>",
         "<font color='#CC0000'>Jul</font>", "<font color='#CC0000'>Aug</font>", "<font color='#CC0000'>Sep</font>", "<font color='#CC0000'>Oct</font>", "<font color='#CC0000'>Nov</font>", "<font color='#CC0000'>Dec</font>"<b>}</b>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>year <font color='#5555FF'>&gt;</font> <font color='#979000'>9999</font> <font color='#009900'>/* RFC1123 limitation */</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>month <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>    <font color='#5555FF'>|</font><font color='#5555FF'>|</font>  ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>month <font color='#5555FF'>&gt;</font> <font color='#979000'>12</font>  <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>day   <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>    <font color='#5555FF'>|</font><font color='#5555FF'>|</font>  ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>day   <font color='#5555FF'>&gt;</font> <font color='#979000'>31</font>  <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hour  <font color='#5555FF'>&gt;</font> <font color='#979000'>23</font>    <font color='#5555FF'>|</font><font color='#5555FF'>|</font>  ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>minute <font color='#5555FF'>&gt;</font> <font color='#979000'>59</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second <font color='#5555FF'>&gt;</font> <font color='#979000'>60</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <b>{</b>
      <font color='#0000FF'><u>size_t</u></font> pos <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'><u>char</u></font> number_buf[<font color='#979000'>5</font>]; <font color='#009900'>/* enough for a four-digit year */</font>

#     define <font color='#BB00BB'>APPEND_STRING</font><font face='Lucida Console'>(</font>string<font face='Lucida Console'>)</font> pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>out, <font color='#979000'>29</font>, pos, <font face='Lucida Console'>(</font>string<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#     define <font color='#BB00BB'>APPEND_NUMBER</font><font face='Lucida Console'>(</font>format, value<font face='Lucida Console'>)</font>\
         <font color='#BB00BB'>APPEND_STRING</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_FORMAT_NUMBER</font><font face='Lucida Console'>(</font>number_buf, format, <font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#     define <font color='#BB00BB'>APPEND</font><font face='Lucida Console'>(</font>ch<font face='Lucida Console'>)</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>&lt;</font> <font color='#979000'>28</font><font face='Lucida Console'>)</font> out[pos<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ch<font face='Lucida Console'>)</font>

      <font color='#BB00BB'>APPEND_NUMBER</font><font face='Lucida Console'>(</font>PNG_NUMBER_FORMAT_u, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>day<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND</font><font face='Lucida Console'>(</font>'<font color='#FF0000'> </font>'<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND_STRING</font><font face='Lucida Console'>(</font>short_months[<font face='Lucida Console'>(</font>ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>month <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND</font><font face='Lucida Console'>(</font>'<font color='#FF0000'> </font>'<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND_NUMBER</font><font face='Lucida Console'>(</font>PNG_NUMBER_FORMAT_u, ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>year<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND</font><font face='Lucida Console'>(</font>'<font color='#FF0000'> </font>'<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND_NUMBER</font><font face='Lucida Console'>(</font>PNG_NUMBER_FORMAT_02u, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hour<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND</font><font face='Lucida Console'>(</font>'<font color='#FF0000'>:</font>'<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND_NUMBER</font><font face='Lucida Console'>(</font>PNG_NUMBER_FORMAT_02u, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>minute<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND</font><font face='Lucida Console'>(</font>'<font color='#FF0000'>:</font>'<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND_NUMBER</font><font face='Lucida Console'>(</font>PNG_NUMBER_FORMAT_02u, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>ptime<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>second<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>APPEND_STRING</font><font face='Lucida Console'>(</font>"<font color='#CC0000'> +0000</font>"<font face='Lucida Console'>)</font>; <font color='#009900'>/* This reliably terminates the buffer */</font>

#     undef APPEND
#     undef APPEND_NUMBER
#     undef APPEND_STRING
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

#     <font color='#0000FF'>if</font> PNG_LIBPNG_VER <font color='#5555FF'>&lt;</font> <font color='#979000'>10700</font>
<font color='#009900'>/* To do: remove the following from libpng-1.7 */</font>
<font color='#009900'>/* Original API that uses a private buffer in png_struct.
 * Deprecated because it causes png_struct to carry a spurious temporary
 * buffer (png_struct::time_buffer), better to have the caller pass this in.
 */</font>
png_const_charp PNGAPI
<font color='#BB00BB'>png_convert_to_rfc1123</font><font face='Lucida Console'>(</font>png_structrp png_ptr, png_const_timep ptime<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* The only failure above if png_ptr != NULL is from an invalid ptime */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_convert_to_rfc1123_buffer</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>time_buffer, ptime<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Ignoring invalid time value</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>time_buffer;
   <b>}</b>

   <font color='#0000FF'>return</font> NULL;
<b>}</b>
#     endif
#  endif <font color='#009900'>/* PNG_TIME_RFC1123_SUPPORTED */</font>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* defined(PNG_READ_SUPPORTED) || defined(PNG_WRITE_SUPPORTED) */</font>

png_const_charp PNGAPI
<font color='#BB00BB'>png_get_copyright</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>  <font color='#009900'>/* Silence compiler warning about unused png_ptr */</font>
<font color='#0000FF'>#ifdef</font> PNG_STRING_COPYRIGHT
   <font color='#0000FF'>return</font> PNG_STRING_COPYRIGHT
<font color='#0000FF'>#else</font>
#  ifdef __STDC__
   <font color='#0000FF'>return</font> PNG_STRING_NEWLINE \
     "<font color='#CC0000'>libpng version 1.6.7 - November 14, 2013</font>" PNG_STRING_NEWLINE \
     "<font color='#CC0000'>Copyright (c) 1998-2013 Glenn Randers-Pehrson</font>" PNG_STRING_NEWLINE \
     "<font color='#CC0000'>Copyright (c) 1996-1997 Andreas Dilger</font>" PNG_STRING_NEWLINE \
     "<font color='#CC0000'>Copyright (c) 1995-1996 Guy Eric Schalnat, Group 42, Inc.</font>" \
     PNG_STRING_NEWLINE;
#  <font color='#0000FF'>else</font>
      <font color='#0000FF'>return</font> "<font color='#CC0000'>libpng version 1.6.7 - November 14, 2013\
      Copyright (c) 1998-2013 Glenn Randers-Pehrson\
      Copyright (c) 1996-1997 Andreas Dilger\
      Copyright (c) 1995-1996 Guy Eric Schalnat, Group 42, Inc.</font>";
#  endif
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#009900'>/* The following return the library version as a short string in the
 * format 1.0.0 through 99.99.99zz.  To get the version of *.h files
 * used with your application, print out PNG_LIBPNG_VER_STRING, which
 * is defined in png.h.
 * Note: now there is no difference between png_get_libpng_ver() and
 * png_get_header_ver().  Due to the version_nn_nn_nn typedef guard,
 * it is guaranteed that png.c uses the correct version of png.h.
 */</font>
png_const_charp PNGAPI
<font color='#BB00BB'>png_get_libpng_ver</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Version of *.c files used when building libpng */</font>
   <font color='#0000FF'>return</font> <font color='#BB00BB'>png_get_header_ver</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>

png_const_charp PNGAPI
<font color='#BB00BB'>png_get_header_ver</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Version of *.h files used when building libpng */</font>
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>  <font color='#009900'>/* Silence compiler warning about unused png_ptr */</font>
   <font color='#0000FF'>return</font> PNG_LIBPNG_VER_STRING;
<b>}</b>

png_const_charp PNGAPI
<font color='#BB00BB'>png_get_header_version</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Returns longer string containing both version and date */</font>
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>  <font color='#009900'>/* Silence compiler warning about unused png_ptr */</font>
<font color='#0000FF'>#ifdef</font> __STDC__
   <font color='#0000FF'>return</font> PNG_HEADER_VERSION_STRING
#  ifndef PNG_READ_SUPPORTED
   "<font color='#CC0000'>     (NO READ SUPPORT)</font>"
#  endif
   PNG_STRING_NEWLINE;
<font color='#0000FF'>#else</font>
   <font color='#0000FF'>return</font> PNG_HEADER_VERSION_STRING;
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_SET_UNKNOWN_CHUNKS_SUPPORTED
<font color='#0000FF'><u>int</u></font> PNGAPI
<font color='#BB00BB'>png_handle_as_unknown</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_const_bytep chunk_name<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Check chunk_name and return "keep" value if it's on the list, else 0 */</font>
   png_const_bytep p, p_end;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_chunk_list <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> PNG_HANDLE_CHUNK_AS_DEFAULT;

   p_end <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_list;
   p <font color='#5555FF'>=</font> p_end <font color='#5555FF'>+</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_chunk_list<font color='#5555FF'>*</font><font color='#979000'>5</font>; <font color='#009900'>/* beyond end */</font>

   <font color='#009900'>/* The code is the fifth byte after each four byte string.  Historically this
    * code was always searched from the end of the list, this is no longer
    * necessary because the 'set' routine handles duplicate entries correcty.
    */</font>
   <font color='#0000FF'>do</font> <font color='#009900'>/* num_chunk_list &gt; 0, so at least one */</font>
   <b>{</b>
      p <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>5</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>memcmp</font><font face='Lucida Console'>(</font>chunk_name, p, <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>return</font> p[<font color='#979000'>4</font>];
   <b>}</b>
   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>&gt;</font> p_end<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* This means that known chunks should be processed and unknown chunks should
    * be handled according to the value of png_ptr-&gt;unknown_default; this can be
    * confusing because, as a result, there are two levels of defaulting for
    * unknown chunks.
    */</font>
   <font color='#0000FF'>return</font> PNG_HANDLE_CHUNK_AS_DEFAULT;
<b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_UNKNOWN_CHUNKS_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_HANDLE_AS_UNKNOWN_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_chunk_unknown_handling</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_uint_32 chunk_name<font face='Lucida Console'>)</font>
<b>{</b>
   png_byte chunk_string[<font color='#979000'>5</font>];

   <font color='#BB00BB'>PNG_CSTRING_FROM_CHUNK</font><font face='Lucida Console'>(</font>chunk_string, chunk_name<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>return</font> <font color='#BB00BB'>png_handle_as_unknown</font><font face='Lucida Console'>(</font>png_ptr, chunk_string<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_UNKNOWN_CHUNKS || HANDLE_AS_UNKNOWN */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* SET_UNKNOWN_CHUNKS */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SUPPORTED
<font color='#009900'>/* This function, added to libpng-1.0.6g, is untested. */</font>
<font color='#0000FF'><u>int</u></font> PNGAPI
<font color='#BB00BB'>png_reset_zstream</font><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> Z_STREAM_ERROR;

   <font color='#009900'>/* WARNING: this resets the window bits to the maximum! */</font>
   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>inflateReset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_SUPPORTED */</font>

<font color='#009900'>/* This function was added to libpng-1.0.7 */</font>
png_uint_32 PNGAPI
<font color='#BB00BB'>png_access_version_number</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Version of *.c files used when building libpng */</font>
   <font color='#0000FF'>return</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>PNG_LIBPNG_VER<font face='Lucida Console'>)</font>;
<b>}</b>



<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* Ensure that png_ptr-&gt;zstream.msg holds some appropriate error message string.
 * If it doesn't 'ret' is used to set it to something appropriate, even in cases
 * like Z_OK or Z_STREAM_END where the error code is apparently a success code.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_zstream_error</font><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> ret<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Translate 'ret' into an appropriate error string, priority is given to the
    * one in zstream if set.  This always returns a string, even in cases like
    * Z_OK or Z_STREAM_END where the error code is a success code.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>ret<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>default</font>:
      <font color='#0000FF'>case</font> Z_OK:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>unexpected zlib return code</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_STREAM_END:
         <font color='#009900'>/* Normal exit */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>unexpected end of LZ stream</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_NEED_DICT:
         <font color='#009900'>/* This means the deflate stream did not have a dictionary; this
          * indicates a bogus PNG.
          */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>missing LZ dictionary</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_ERRNO:
         <font color='#009900'>/* gz APIs only: should not happen */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>zlib IO error</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_STREAM_ERROR:
         <font color='#009900'>/* internal libpng error */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>bad parameters to zlib</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_DATA_ERROR:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>damaged LZ stream</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_MEM_ERROR:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>insufficient memory</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_BUF_ERROR:
         <font color='#009900'>/* End of input or output; not a problem if the caller is doing
          * incremental read or write.
          */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>truncated</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> Z_VERSION_ERROR:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>unsupported zlib version</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_UNEXPECTED_ZLIB_RETURN:
         <font color='#009900'>/* Compile errors here mean that zlib now uses the value co-opted in
          * pngpriv.h for PNG_UNEXPECTED_ZLIB_RETURN; update the switch above
          * and change pngpriv.h.  Note that this message is "... return",
          * whereas the default/Z_OK one is "... return code".
          */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream.msg <font color='#5555FF'>=</font> <font color='#BB00BB'>PNGZ_MSG_CAST</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>unexpected zlib return</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* png_convert_size: a PNGAPI but no longer in png.h, so deleted
 * at libpng 1.5.5!
 */</font>

<font color='#009900'>/* Added at libpng version 1.2.34 and 1.4.0 (moved from pngset.c) */</font>
<font color='#0000FF'>#ifdef</font> PNG_GAMMA_SUPPORTED <font color='#009900'>/* always set if COLORSPACE */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_colorspace_check_gamma</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_colorspacerp colorspace, png_fixed_point gAMA, <font color='#0000FF'><u>int</u></font> from<font face='Lucida Console'>)</font>
   <font color='#009900'>/* This is called to check a new gamma value against an existing one.  The
    * routine returns false if the new gamma value should not be written.
    *
    * 'from' says where the new gamma value comes from:
    *
    *    0: the new gamma value is the libpng estimate for an ICC profile
    *    1: the new gamma value comes from a gAMA chunk
    *    2: the new gamma value comes from an sRGB chunk
    */</font>
<b>{</b>
   png_fixed_point gtest;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_GAMMA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>gtest, colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma, PNG_FP_1, gAMA<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gtest<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Either this is an sRGB image, in which case the calculated gamma
       * approximation should match, or this is an image with a profile and the
       * value libpng calculates for the gamma of the profile does not match the
       * value recorded in the file.  The former, sRGB, case is an error, the
       * latter is just a warning.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_FROM_sRGB<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> from <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gamma value does not match sRGB</font>",
            PNG_CHUNK_ERROR<font face='Lucida Console'>)</font>;
         <font color='#009900'>/* Do not overwrite an sRGB value */</font>
         <font color='#0000FF'>return</font> from <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#009900'>/* sRGB tag not involved */</font>
      <b>{</b>
         <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gamma value does not match libpng estimate</font>",
            PNG_CHUNK_WARNING<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font> from <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_set_gamma</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_colorspacerp colorspace, png_fixed_point gAMA<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Changed in libpng-1.5.4 to limit the values to ensure overflow can't
    * occur.  Since the fixed point representation is assymetrical it is
    * possible for 1/gamma to overflow the limit of 21474 and this means the
    * gamma value must be at least 5/100000 and hence at most 20000.0.  For
    * safety the limits here are a little narrower.  The values are 0.00016 to
    * 6250.0, which are truly ridiculous gamma values (and will produce
    * displays that are all black or all white.)
    *
    * In 1.6.0 this test replaces the ones in pngrutil.c, in the gAMA chunk
    * handling code, which only required the value to be &gt;0.
    */</font>
   png_const_charp errmsg;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gAMA <font color='#5555FF'>&lt;</font> <font color='#979000'>16</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> gAMA <font color='#5555FF'>&gt;</font> <font color='#979000'>625000000</font><font face='Lucida Console'>)</font>
      errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>gamma value out of range</font>";

#  ifdef PNG_READ_gAMA_SUPPORTED
      <font color='#009900'>/* Allow the application to set the gamma value more than once */</font>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_IS_READ_STRUCT<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         <font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_FROM_gAMA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         errmsg <font color='#5555FF'>=</font> "<font color='#CC0000'>duplicate</font>";
#  endif

   <font color='#009900'>/* Do nothing if the colorspace is already invalid */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_colorspace_check_gamma</font><font face='Lucida Console'>(</font>png_ptr, colorspace, gAMA, <font color='#979000'>1</font><font color='#009900'>/*from gAMA*/</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Store this gamma value. */</font>
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma <font color='#5555FF'>=</font> gAMA;
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font>
            <font face='Lucida Console'>(</font>PNG_COLORSPACE_HAVE_GAMMA <font color='#5555FF'>|</font> PNG_COLORSPACE_FROM_gAMA<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#009900'>/* At present if the check_gamma test fails the gamma of the colorspace is
       * not updated however the colorspace is not invalidated.  This
       * corresponds to the case where the existing gamma comes from an sRGB
       * chunk or profile.  An error message has already been output.
       */</font>
      <font color='#0000FF'>return</font>;
   <b>}</b>

   <font color='#009900'>/* Error exit - errmsg has been set. */</font>
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
   <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr, errmsg, PNG_CHUNK_WRITE_ERROR<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_sync_info</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Everything is invalid */</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~<font face='Lucida Console'>(</font>PNG_INFO_gAMA<font color='#5555FF'>|</font>PNG_INFO_cHRM<font color='#5555FF'>|</font>PNG_INFO_sRGB<font color='#5555FF'>|</font>
         PNG_INFO_iCCP<font face='Lucida Console'>)</font>;

#     ifdef PNG_COLORSPACE_SUPPORTED
         <font color='#009900'>/* Clean up the iCCP profile now if it won't be used. */</font>
         <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_FREE_ICCP, <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#009900'>/*not used*/</font><font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>
#     endif
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
#     ifdef PNG_COLORSPACE_SUPPORTED
         <font color='#009900'>/* Leave the INFO_iCCP flag set if the pngset.c code has already set
          * it; this allows a PNG to contain a profile which matches sRGB and
          * yet still have that profile retrievable by the application.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_MATCHES_sRGB<font face='Lucida Console'>)</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_INFO_sRGB;

         <font color='#0000FF'>else</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_sRGB;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_ENDPOINTS<font face='Lucida Console'>)</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_INFO_cHRM;

         <font color='#0000FF'>else</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_cHRM;
#     endif

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_GAMMA<font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_INFO_gAMA;

      <font color='#0000FF'>else</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_INFO_gAMA;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_sync</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <font color='#009900'>/* reduce code size; check here not in the caller */</font>
      <font color='#0000FF'>return</font>;

   info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace;
   <font color='#BB00BB'>png_colorspace_sync_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_COLORSPACE_SUPPORTED
<font color='#009900'>/* Added at libpng-1.5.5 to support read and write of true CIEXYZ values for
 * cHRM, as opposed to using chromaticities.  These internal APIs return
 * non-zero on a parameter error.  The X, Y and Z values are required to be
 * positive and less than 1.0.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_xy_from_XYZ</font><font face='Lucida Console'>(</font>png_xy <font color='#5555FF'>*</font>xy, <font color='#0000FF'>const</font> png_XYZ <font color='#5555FF'>*</font>XYZ<font face='Lucida Console'>)</font>
<b>{</b>
   png_int_32 d, dwhite, whiteX, whiteY;

   d <font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X <font color='#5555FF'>+</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y <font color='#5555FF'>+</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Z;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X, PNG_FP_1, d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y, PNG_FP_1, d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   dwhite <font color='#5555FF'>=</font> d;
   whiteX <font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X;
   whiteY <font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y;

   d <font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X <font color='#5555FF'>+</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y <font color='#5555FF'>+</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Z;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X, PNG_FP_1, d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y, PNG_FP_1, d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   dwhite <font color='#5555FF'>+</font><font color='#5555FF'>=</font> d;
   whiteX <font color='#5555FF'>+</font><font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X;
   whiteY <font color='#5555FF'>+</font><font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y;

   d <font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X <font color='#5555FF'>+</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y <font color='#5555FF'>+</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Z;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X, PNG_FP_1, d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y, PNG_FP_1, d<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   dwhite <font color='#5555FF'>+</font><font color='#5555FF'>=</font> d;
   whiteX <font color='#5555FF'>+</font><font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X;
   whiteY <font color='#5555FF'>+</font><font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y;

   <font color='#009900'>/* The reference white is simply the sum of the end-point (X,Y,Z) vectors,
    * thus:
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex, whiteX, PNG_FP_1, dwhite<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey, whiteY, PNG_FP_1, dwhite<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_XYZ_from_xy</font><font face='Lucida Console'>(</font>png_XYZ <font color='#5555FF'>*</font>XYZ, <font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy<font face='Lucida Console'>)</font>
<b>{</b>
   png_fixed_point red_inverse, green_inverse, blue_scale;
   png_fixed_point left, right, denominator;

   <font color='#009900'>/* Check xy and, implicitly, z.  Note that wide gamut color spaces typically
    * have end points with 0 tristimulus values (these are impossible end
    * points, but they are used to cover the possible colors.)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx <font color='#5555FF'>&gt;</font> PNG_FP_1<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy <font color='#5555FF'>&gt;</font> PNG_FP_1<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx <font color='#5555FF'>&gt;</font> PNG_FP_1<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny <font color='#5555FF'>&gt;</font> PNG_FP_1<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex <font color='#5555FF'>&gt;</font> PNG_FP_1<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey <font color='#5555FF'>&gt;</font> PNG_FP_1<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex <font color='#5555FF'>&gt;</font> PNG_FP_1<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey <font color='#5555FF'>&gt;</font> PNG_FP_1<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* The reverse calculation is more difficult because the original tristimulus
    * value had 9 independent values (red,green,blue)x(X,Y,Z) however only 8
    * derived values were recorded in the cHRM chunk;
    * (red,green,blue,white)x(x,y).  This loses one degree of freedom and
    * therefore an arbitrary ninth value has to be introduced to undo the
    * original transformations.
    *
    * Think of the original end-points as points in (X,Y,Z) space.  The
    * chromaticity values (c) have the property:
    *
    *           C
    *   c = ---------
    *       X + Y + Z
    *
    * For each c (x,y,z) from the corresponding original C (X,Y,Z).  Thus the
    * three chromaticity values (x,y,z) for each end-point obey the
    * relationship:
    *
    *   x + y + z = 1
    *
    * This describes the plane in (X,Y,Z) space that intersects each axis at the
    * value 1.0; call this the chromaticity plane.  Thus the chromaticity
    * calculation has scaled each end-point so that it is on the x+y+z=1 plane
    * and chromaticity is the intersection of the vector from the origin to the
    * (X,Y,Z) value with the chromaticity plane.
    *
    * To fully invert the chromaticity calculation we would need the three
    * end-point scale factors, (red-scale, green-scale, blue-scale), but these
    * were not recorded.  Instead we calculated the reference white (X,Y,Z) and
    * recorded the chromaticity of this.  The reference white (X,Y,Z) would have
    * given all three of the scale factors since:
    *
    *    color-C = color-c * color-scale
    *    white-C = red-C + green-C + blue-C
    *            = red-c*red-scale + green-c*green-scale + blue-c*blue-scale
    *
    * But cHRM records only white-x and white-y, so we have lost the white scale
    * factor:
    *
    *    white-C = white-c*white-scale
    *
    * To handle this the inverse transformation makes an arbitrary assumption
    * about white-scale:
    *
    *    Assume: white-Y = 1.0
    *    Hence:  white-scale = 1/white-y
    *    Or:     red-Y + green-Y + blue-Y = 1.0
    *
    * Notice the last statement of the assumption gives an equation in three of
    * the nine values we want to calculate.  8 more equations come from the
    * above routine as summarised at the top above (the chromaticity
    * calculation):
    *
    *    Given: color-x = color-X / (color-X + color-Y + color-Z)
    *    Hence: (color-x - 1)*color-X + color.x*color-Y + color.x*color-Z = 0
    *
    * This is 9 simultaneous equations in the 9 variables "color-C" and can be
    * solved by Cramer's rule.  Cramer's rule requires calculating 10 9x9 matrix
    * determinants, however this is not as bad as it seems because only 28 of
    * the total of 90 terms in the various matrices are non-zero.  Nevertheless
    * Cramer's rule is notoriously numerically unstable because the determinant
    * calculation involves the difference of large, but similar, numbers.  It is
    * difficult to be sure that the calculation is stable for real world values
    * and it is certain that it becomes unstable where the end points are close
    * together.
    *
    * So this code uses the perhaps slightly less optimal but more
    * understandable and totally obvious approach of calculating color-scale.
    *
    * This algorithm depends on the precision in white-scale and that is
    * (1/white-y), so we can immediately see that as white-y approaches 0 the
    * accuracy inherent in the cHRM chunk drops off substantially.
    *
    * libpng arithmetic: a simple invertion of the above equations
    * ------------------------------------------------------------
    *
    *    white_scale = 1/white-y
    *    white-X = white-x * white-scale
    *    white-Y = 1.0
    *    white-Z = (1 - white-x - white-y) * white_scale
    *
    *    white-C = red-C + green-C + blue-C
    *            = red-c*red-scale + green-c*green-scale + blue-c*blue-scale
    *
    * This gives us three equations in (red-scale,green-scale,blue-scale) where
    * all the coefficients are now known:
    *
    *    red-x*red-scale + green-x*green-scale + blue-x*blue-scale
    *       = white-x/white-y
    *    red-y*red-scale + green-y*green-scale + blue-y*blue-scale = 1
    *    red-z*red-scale + green-z*green-scale + blue-z*blue-scale
    *       = (1 - white-x - white-y)/white-y
    *
    * In the last equation color-z is (1 - color-x - color-y) so we can add all
    * three equations together to get an alternative third:
    *
    *    red-scale + green-scale + blue-scale = 1/white-y = white-scale
    *
    * So now we have a Cramer's rule solution where the determinants are just
    * 3x3 - far more tractible.  Unfortunately 3x3 determinants still involve
    * multiplication of three coefficients so we can't guarantee to avoid
    * overflow in the libpng fixed point representation.  Using Cramer's rule in
    * floating point is probably a good choice here, but it's not an option for
    * fixed point.  Instead proceed to simplify the first two equations by
    * eliminating what is likely to be the largest value, blue-scale:
    *
    *    blue-scale = white-scale - red-scale - green-scale
    *
    * Hence:
    *
    *    (red-x - blue-x)*red-scale + (green-x - blue-x)*green-scale =
    *                (white-x - blue-x)*white-scale
    *
    *    (red-y - blue-y)*red-scale + (green-y - blue-y)*green-scale =
    *                1 - blue-y*white-scale
    *
    * And now we can trivially solve for (red-scale,green-scale):
    *
    *    green-scale =
    *                (white-x - blue-x)*white-scale - (red-x - blue-x)*red-scale
    *                -----------------------------------------------------------
    *                                  green-x - blue-x
    *
    *    red-scale =
    *                1 - blue-y*white-scale - (green-y - blue-y) * green-scale
    *                ---------------------------------------------------------
    *                                  red-y - blue-y
    *
    * Hence:
    *
    *    red-scale =
    *          ( (green-x - blue-x) * (white-y - blue-y) -
    *            (green-y - blue-y) * (white-x - blue-x) ) / white-y
    * -------------------------------------------------------------------------
    *  (green-x - blue-x)*(red-y - blue-y)-(green-y - blue-y)*(red-x - blue-x)
    *
    *    green-scale =
    *          ( (red-y - blue-y) * (white-x - blue-x) -
    *            (red-x - blue-x) * (white-y - blue-y) ) / white-y
    * -------------------------------------------------------------------------
    *  (green-x - blue-x)*(red-y - blue-y)-(green-y - blue-y)*(red-x - blue-x)
    *
    * Accuracy:
    * The input values have 5 decimal digits of accuracy.  The values are all in
    * the range 0 &lt; value &lt; 1, so simple products are in the same range but may
    * need up to 10 decimal digits to preserve the original precision and avoid
    * underflow.  Because we are using a 32-bit signed representation we cannot
    * match this; the best is a little over 9 decimal digits, less than 10.
    *
    * The approach used here is to preserve the maximum precision within the
    * signed representation.  Because the red-scale calculation above uses the
    * difference between two products of values that must be in the range -1..+1
    * it is sufficient to divide the product by 7; ceil(100,000/32767*2).  The
    * factor is irrelevant in the calculation because it is applied to both
    * numerator and denominator.
    *
    * Note that the values of the differences of the products of the
    * chromaticities in the above equations tend to be small, for example for
    * the sRGB chromaticities they are:
    *
    * red numerator:    -0.04751
    * green numerator:  -0.08788
    * denominator:      -0.2241 (without white-y multiplication)
    *
    *  The resultant Y coefficients from the chromaticities of some widely used
    *  color space definitions are (to 15 decimal places):
    *
    *  sRGB
    *    0.212639005871510 0.715168678767756 0.072192315360734
    *  Kodak ProPhoto
    *    0.288071128229293 0.711843217810102 0.000085653960605
    *  Adobe RGB
    *    0.297344975250536 0.627363566255466 0.075291458493998
    *  Adobe Wide Gamut RGB
    *    0.258728243040113 0.724682314948566 0.016589442011321
    */</font>
   <font color='#009900'>/* By the argument, above overflow should be impossible here. The return
    * value of 2 indicates an internal error to the caller.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>left, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>2</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>right, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>2</font>;
   denominator <font color='#5555FF'>=</font> left <font color='#5555FF'>-</font> right;

   <font color='#009900'>/* Now find the red numerator. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>left, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>2</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>right, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>2</font>;

   <font color='#009900'>/* Overflow is possible here and it indicates an extreme set of PNG cHRM
    * chunk values.  This calculation actually returns the reciprocal of the
    * scale value because this allows us to delay the multiplication of white-y
    * into the denominator, which tends to produce a small number.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>red_inverse, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey, denominator, left<font color='#5555FF'>-</font>right<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       red_inverse <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey <font color='#009900'>/* r+g+b scales = white scale */</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* Similarly for green_inverse: */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>left, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>2</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>right, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey<font color='#5555FF'>-</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>2</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>green_inverse, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey, denominator, left<font color='#5555FF'>-</font>right<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       green_inverse <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* And the blue scale, the checks above guarantee this can't overflow but it
    * can still produce 0 for extreme cHRM values.
    */</font>
   blue_scale <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>red_inverse<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font>
      <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>green_inverse<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>blue_scale <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;


   <font color='#009900'>/* And fill in the png_XYZ: */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx, PNG_FP_1, red_inverse<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy, PNG_FP_1, red_inverse<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Z, PNG_FP_1 <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy, PNG_FP_1,
      red_inverse<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx, PNG_FP_1, green_inverse<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny, PNG_FP_1, green_inverse<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Z, PNG_FP_1 <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny, PNG_FP_1,
      green_inverse<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, blue_scale, PNG_FP_1<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y, xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, blue_scale, PNG_FP_1<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Z, PNG_FP_1 <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex <font color='#5555FF'>-</font> xy<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, blue_scale,
      PNG_FP_1<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/*success*/</font>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_XYZ_normalize</font><font face='Lucida Console'>(</font>png_XYZ <font color='#5555FF'>*</font>XYZ<font face='Lucida Console'>)</font>
<b>{</b>
   png_int_32 Y;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Z <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Z <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Z <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* Normalize by scaling so the sum of the end-point Y values is PNG_FP_1.
    * IMPLEMENTATION NOTE: ANSI requires signed overflow not to occur, therefore
    * relying on addition of two positive values producing a negative one is not
    * safe.
    */</font>
   Y <font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#979000'>0x7fffffff</font> <font color='#5555FF'>-</font> Y <font color='#5555FF'>&lt;</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   Y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#979000'>0x7fffffff</font> <font color='#5555FF'>-</font> Y <font color='#5555FF'>&lt;</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   Y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>Y <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_FP_1<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_X, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Y, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Z, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red_Z, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_X, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Y, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Z, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green_Z, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_X, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Y, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Z, XYZ<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue_Z, PNG_FP_1, Y<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_colorspace_endpoints_match</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy1, <font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy2, <font color='#0000FF'><u>int</u></font> delta<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Allow an error of +/-0.01 (absolute value) on each chromaticity */</font>
   <font color='#0000FF'>return</font> <font color='#5555FF'>!</font><font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex, xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitex,delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey, xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>whitey,delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx,   xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redx,  delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy,   xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>redy,  delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx, xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greenx,delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny, xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>greeny,delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex,  xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluex, delta<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font color='#BB00BB'>PNG_OUT_OF_RANGE</font><font face='Lucida Console'>(</font>xy1<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey,  xy2<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bluey, delta<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Added in libpng-1.6.0, a different check for the validity of a set of cHRM
 * chunk chromaticities.  Earlier checks used to simply look for the overflow
 * condition (where the determinant of the matrix to solve for XYZ ends up zero
 * because the chromaticity values are not all distinct.)  Despite this it is
 * theoretically possible to produce chromaticities that are apparently valid
 * but that rapidly degrade to invalid, potentially crashing, sets because of
 * arithmetic inaccuracies when calculations are performed on them.  The new
 * check is to round-trip xy -&gt; XYZ -&gt; xy and then check that the result is
 * within a small percentage of the original.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_colorspace_check_xy</font><font face='Lucida Console'>(</font>png_XYZ <font color='#5555FF'>*</font>XYZ, <font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> result;
   png_xy xy_test;

   <font color='#009900'>/* As a side-effect this routine also returns the XYZ endpoints. */</font>
   result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_XYZ_from_xy</font><font face='Lucida Console'>(</font>XYZ, xy<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> result;

   result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_xy_from_XYZ</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy_test, XYZ<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> result;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_colorspace_endpoints_match</font><font face='Lucida Console'>(</font>xy, <font color='#5555FF'>&amp;</font>xy_test,
      <font color='#979000'>5</font><font color='#009900'>/*actually, the math is pretty accurate*/</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* Too much slip */</font>
   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>/* This is the check going the other way.  The XYZ is modified to normalize it
 * (another side-effect) and the xy chromaticities are returned.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_colorspace_check_XYZ</font><font face='Lucida Console'>(</font>png_xy <font color='#5555FF'>*</font>xy, png_XYZ <font color='#5555FF'>*</font>XYZ<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> result;
   png_XYZ XYZtemp;

   result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_XYZ_normalize</font><font face='Lucida Console'>(</font>XYZ<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> result;

   result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_xy_from_XYZ</font><font face='Lucida Console'>(</font>xy, XYZ<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>result<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> result;

   XYZtemp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>XYZ;
   <font color='#0000FF'>return</font> <font color='#BB00BB'>png_colorspace_check_xy</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZtemp, xy<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Used to check for an endpoint match against sRGB */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'>const</font> png_xy sRGB_xy <font color='#5555FF'>=</font> <font color='#009900'>/* From ITU-R BT.709-3 */</font>
<b>{</b>
   <font color='#009900'>/* color      x       y */</font>
   <font color='#009900'>/* red   */</font> <font color='#979000'>64000</font>, <font color='#979000'>33000</font>,
   <font color='#009900'>/* green */</font> <font color='#979000'>30000</font>, <font color='#979000'>60000</font>,
   <font color='#009900'>/* blue  */</font> <font color='#979000'>15000</font>,  <font color='#979000'>6000</font>,
   <font color='#009900'>/* white */</font> <font color='#979000'>31270</font>, <font color='#979000'>32900</font>
<b>}</b>;

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_colorspace_set_xy_and_XYZ</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_colorspacerp colorspace, <font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy, <font color='#0000FF'>const</font> png_XYZ <font color='#5555FF'>*</font>XYZ,
   <font color='#0000FF'><u>int</u></font> preferred<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* The consistency check is performed on the chromaticities; this factors out
    * variations because of the normalization (or not) of the end point Y
    * values.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>preferred <font color='#5555FF'>&lt;</font> <font color='#979000'>2</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_ENDPOINTS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* The end points must be reasonably close to any we already have.  The
       * following allows an error of up to +/-.001
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_colorspace_endpoints_match</font><font face='Lucida Console'>(</font>xy, <font color='#5555FF'>&amp;</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>end_points_xy, <font color='#979000'>100</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
         <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>inconsistent chromaticities</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* failed */</font>
      <b>}</b>

      <font color='#009900'>/* Only overwrite with preferred values */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>preferred<font face='Lucida Console'>)</font>
         <font color='#0000FF'>return</font> <font color='#979000'>1</font>; <font color='#009900'>/* ok, but no change */</font>
   <b>}</b>

   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>end_points_xy <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>xy;
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>end_points_XYZ <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>XYZ;
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_ENDPOINTS;

   <font color='#009900'>/* The end points are normally quoted to two decimal digits, so allow +/-0.01
    * on this test.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_colorspace_endpoints_match</font><font face='Lucida Console'>(</font>xy, <font color='#5555FF'>&amp;</font>sRGB_xy, <font color='#979000'>1000</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_ENDPOINTS_MATCH_sRGB;

   <font color='#0000FF'>else</font>
      colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_COLORSPACE_CANCEL</font><font face='Lucida Console'>(</font>
         PNG_COLORSPACE_ENDPOINTS_MATCH_sRGB<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>2</font>; <font color='#009900'>/* ok and changed */</font>
<b>}</b>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_set_chromaticities</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_colorspacerp colorspace, <font color='#0000FF'>const</font> png_xy <font color='#5555FF'>*</font>xy, <font color='#0000FF'><u>int</u></font> preferred<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* We must check the end points to ensure they are reasonable - in the past
    * color management systems have crashed as a result of getting bogus
    * colorant values, while this isn't the fault of libpng it is the
    * responsibility of libpng because PNG carries the bomb and libpng is in a
    * position to protect against it.
    */</font>
   png_XYZ XYZ;

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_colorspace_check_xy</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>XYZ, xy<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>0</font>: <font color='#009900'>/* success */</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_colorspace_set_xy_and_XYZ</font><font face='Lucida Console'>(</font>png_ptr, colorspace, xy, <font color='#5555FF'>&amp;</font>XYZ,
            preferred<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
         <font color='#009900'>/* We can't invert the chromaticities so we can't produce value XYZ
          * values.  Likely as not a color management system will fail too.
          */</font>
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
         <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid chromaticities</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#009900'>/* libpng is broken; this should be a warning but if it happens we
          * want error reports so for the moment it is an error.
          */</font>
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal error checking chromaticities</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* failed */</font>
<b>}</b>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_set_endpoints</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_colorspacerp colorspace, <font color='#0000FF'>const</font> png_XYZ <font color='#5555FF'>*</font>XYZ_in, <font color='#0000FF'><u>int</u></font> preferred<font face='Lucida Console'>)</font>
<b>{</b>
   png_XYZ XYZ <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>XYZ_in;
   png_xy xy;

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_colorspace_check_XYZ</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>xy, <font color='#5555FF'>&amp;</font>XYZ<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>0</font>:
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_colorspace_set_xy_and_XYZ</font><font face='Lucida Console'>(</font>png_ptr, colorspace, <font color='#5555FF'>&amp;</font>xy, <font color='#5555FF'>&amp;</font>XYZ,
            preferred<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
         <font color='#009900'>/* End points are invalid. */</font>
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
         <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid end points</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal error checking chromaticities</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* failed */</font>
<b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_sRGB_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_iCCP_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* Error message generation */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>char</u></font>
<font color='#BB00BB'>png_icc_tag_char</font><font face='Lucida Console'>(</font>png_uint_32 byte<font face='Lucida Console'>)</font>
<b>{</b>
   byte <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>byte <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>32</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> byte <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>126</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font face='Lucida Console'>)</font>byte;
   <font color='#0000FF'>else</font>
      <font color='#0000FF'>return</font> '<font color='#FF0000'>?</font>';
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<font color='#BB00BB'>png_icc_tag_name</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>name, png_uint_32 tag<font face='Lucida Console'>)</font>
<b>{</b>
   name[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> '<font color='#FF0000'>\'</font>';
   name[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_icc_tag_char</font><font face='Lucida Console'>(</font>tag <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font>;
   name[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_icc_tag_char</font><font face='Lucida Console'>(</font>tag <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
   name[<font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_icc_tag_char</font><font face='Lucida Console'>(</font>tag <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>  <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
   name[<font color='#979000'>4</font>] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_icc_tag_char</font><font face='Lucida Console'>(</font>tag      <font face='Lucida Console'>)</font>;
   name[<font color='#979000'>5</font>] <font color='#5555FF'>=</font> '<font color='#FF0000'>\'</font>';
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>is_ICC_signature_char</font><font face='Lucida Console'>(</font>png_alloc_size_t it<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>return</font> it <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>32</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>48</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> it <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>57</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>it <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>65</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> it <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>90</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      <font face='Lucida Console'>(</font>it <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>97</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> it <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>122</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font> <font color='#BB00BB'>is_ICC_signature</font><font face='Lucida Console'>(</font>png_alloc_size_t it<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>return</font> <font color='#BB00BB'>is_ICC_signature_char</font><font face='Lucida Console'>(</font>it <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#009900'>/* checks all the top bits */</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#BB00BB'>is_ICC_signature_char</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>it <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#BB00BB'>is_ICC_signature_char</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>it <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#BB00BB'>is_ICC_signature_char</font><font face='Lucida Console'>(</font>it <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_colorspacerp colorspace,
   png_const_charp name, png_alloc_size_t value, png_const_charp reason<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>size_t</u></font> pos;
   <font color='#0000FF'><u>char</u></font> message[<font color='#979000'>196</font>]; <font color='#009900'>/* see below for calculation */</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>colorspace <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_INVALID;

   pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>message, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> message<font face='Lucida Console'>)</font>, <font color='#979000'>0</font>, "<font color='#CC0000'>profile '</font>"<font face='Lucida Console'>)</font>; <font color='#009900'>/* 9 chars */</font>
   pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>message, pos<font color='#5555FF'>+</font><font color='#979000'>79</font>, pos, name<font face='Lucida Console'>)</font>; <font color='#009900'>/* Truncate to 79 chars */</font>
   pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>message, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> message<font face='Lucida Console'>)</font>, pos, "<font color='#CC0000'>': </font>"<font face='Lucida Console'>)</font>; <font color='#009900'>/* +2 = 90 */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>is_ICC_signature</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* So 'value' is at most 4 bytes and the following cast is safe */</font>
      <font color='#BB00BB'>png_icc_tag_name</font><font face='Lucida Console'>(</font>message<font color='#5555FF'>+</font>pos, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>value<font face='Lucida Console'>)</font>;
      pos <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>6</font>; <font color='#009900'>/* total +8; less than the else clause */</font>
      message[pos<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> '<font color='#FF0000'>:</font>';
      message[pos<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> '<font color='#FF0000'> </font>';
   <b>}</b>
#  ifdef PNG_WARNINGS_SUPPORTED
   <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'><u>char</u></font> number[PNG_NUMBER_BUFFER_SIZE]; <font color='#009900'>/* +24 = 114*/</font>

         pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>message, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> message<font face='Lucida Console'>)</font>, pos,
            <font color='#BB00BB'>png_format_number</font><font face='Lucida Console'>(</font>number, number<font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> number<font face='Lucida Console'>)</font>,
               PNG_NUMBER_FORMAT_x, value<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
         pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>message, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> message<font face='Lucida Console'>)</font>, pos, "<font color='#CC0000'>h: </font>"<font face='Lucida Console'>)</font>; <font color='#009900'>/*+2 = 116*/</font>
      <b>}</b>
#  endif
   <font color='#009900'>/* The 'reason' is an arbitrary message, allow +79 maximum 195 */</font>
   pos <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>message, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> message<font face='Lucida Console'>)</font>, pos, reason<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* This is recoverable, but make it unconditionally an app_error on write to
    * avoid writing invalid ICC profiles into PNG files.  (I.e.  we handle them
    * on read, with a warning, but on write unless the app turns off
    * application errors the PNG won't be written.)
    */</font>
   <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr, message,
      <font face='Lucida Console'>(</font>colorspace <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> ? PNG_CHUNK_ERROR : PNG_CHUNK_WRITE_ERROR<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* sRGB || iCCP */</font>

<font color='#0000FF'>#ifdef</font> PNG_sRGB_SUPPORTED
<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_set_sRGB</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_colorspacerp colorspace,
   <font color='#0000FF'><u>int</u></font> intent<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* sRGB sets known gamma, end points and (from the chunk) intent. */</font>
   <font color='#009900'>/* IMPORTANT: these are not necessarily the values found in an ICC profile
    * because ICC profiles store values adapted to a D50 environment; it is
    * expected that the ICC profile mediaWhitePointTag will be D50, see the
    * checks and code elsewhere to understand this better.
    *
    * These XYZ values, which are accurate to 5dp, produce rgb to gray
    * coefficients of (6968,23435,2366), which are reduced (because they add up
    * to 32769 not 32768) to (6968,23434,2366).  These are the values that
    * libpng has traditionally used (and are the best values given the 15bit
    * algorithm used by the rgb to gray code.)
    */</font>
   <font color='#0000FF'>static</font> <font color='#0000FF'>const</font> png_XYZ sRGB_XYZ <font color='#5555FF'>=</font> <font color='#009900'>/* D65 XYZ (*not* the D50 adapted values!) */</font>
   <b>{</b>
      <font color='#009900'>/* color      X      Y      Z */</font>
      <font color='#009900'>/* red   */</font> <font color='#979000'>41239</font>, <font color='#979000'>21264</font>,  <font color='#979000'>1933</font>,
      <font color='#009900'>/* green */</font> <font color='#979000'>35758</font>, <font color='#979000'>71517</font>, <font color='#979000'>11919</font>,
      <font color='#009900'>/* blue  */</font> <font color='#979000'>18048</font>,  <font color='#979000'>7219</font>, <font color='#979000'>95053</font>
   <b>}</b>;

   <font color='#009900'>/* Do nothing if the colorspace is already invalidated. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* Check the intent, then check for existing settings.  It is valid for the
    * PNG file to have cHRM or gAMA chunks along with sRGB, but the values must
    * be consistent with the correct values.  If, however, this function is
    * called below because an iCCP chunk matches sRGB then it is quite
    * conceivable that an older app recorded incorrect gAMA and cHRM because of
    * an incorrect calculation based on the values in the profile - this does
    * *not* invalidate the profile (though it still produces an error, which can
    * be ignored.)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>intent <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> intent <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_sRGB_INTENT_LAST<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, "<font color='#CC0000'>sRGB</font>",
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>intent, "<font color='#CC0000'>invalid sRGB rendering intent</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_INTENT<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rendering_intent <font color='#5555FF'>!</font><font color='#5555FF'>=</font> intent<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, "<font color='#CC0000'>sRGB</font>",
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>intent, "<font color='#CC0000'>inconsistent rendering intents</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_FROM_sRGB<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>duplicate sRGB information ignored</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
   <b>}</b>

   <font color='#009900'>/* If the standard sRGB cHRM chunk does not match the one from the PNG file
    * warn but overwrite the value with the correct one.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_ENDPOINTS<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font color='#BB00BB'>png_colorspace_endpoints_match</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>sRGB_xy, <font color='#5555FF'>&amp;</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>end_points_xy,
         <font color='#979000'>100</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>cHRM chunk does not match sRGB</font>",
         PNG_CHUNK_ERROR<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* This check is just done for the error reporting - the routine always
    * returns true when the 'from' argument corresponds to sRGB (2).
    */</font>
   <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_colorspace_check_gamma</font><font face='Lucida Console'>(</font>png_ptr, colorspace, PNG_GAMMA_sRGB_INVERSE,
      <font color='#979000'>2</font><font color='#009900'>/*from sRGB*/</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* intent: bugs in GCC force 'int' to be used as the parameter type. */</font>
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rendering_intent <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>intent;
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_INTENT;

   <font color='#009900'>/* endpoints */</font>
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>end_points_xy <font color='#5555FF'>=</font> sRGB_xy;
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>end_points_XYZ <font color='#5555FF'>=</font> sRGB_XYZ;
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font>
      <font face='Lucida Console'>(</font>PNG_COLORSPACE_HAVE_ENDPOINTS<font color='#5555FF'>|</font>PNG_COLORSPACE_ENDPOINTS_MATCH_sRGB<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* gamma */</font>
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma <font color='#5555FF'>=</font> PNG_GAMMA_sRGB_INVERSE;
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_GAMMA;

   <font color='#009900'>/* Finally record that we have an sRGB profile */</font>
   colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font>
      <font face='Lucida Console'>(</font>PNG_COLORSPACE_MATCHES_sRGB<font color='#5555FF'>|</font>PNG_COLORSPACE_FROM_sRGB<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>; <font color='#009900'>/* set */</font>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* sRGB */</font>

<font color='#0000FF'>#ifdef</font> PNG_iCCP_SUPPORTED
<font color='#009900'>/* Encoded value of D50 as an ICC XYZNumber.  From the ICC 2010 spec the value
 * is XYZ(0.9642,1.0,0.8249), which scales to:
 *
 *    (63189.8112, 65536, 54060.6464)
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'>const</font> png_byte D50_nCIEXYZ[<font color='#979000'>12</font>] <font color='#5555FF'>=</font>
   <b>{</b> <font color='#979000'>0x00</font>, <font color='#979000'>0x00</font>, <font color='#979000'>0xf6</font>, <font color='#979000'>0xd6</font>, <font color='#979000'>0x00</font>, <font color='#979000'>0x01</font>, <font color='#979000'>0x00</font>, <font color='#979000'>0x00</font>, <font color='#979000'>0x00</font>, <font color='#979000'>0x00</font>, <font color='#979000'>0xd3</font>, <font color='#979000'>0x2d</font> <b>}</b>;

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_icc_check_length</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_colorspacerp colorspace,
   png_const_charp name, png_uint_32 profile_length<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile_length <font color='#5555FF'>&lt;</font> <font color='#979000'>132</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, profile_length,
         "<font color='#CC0000'>too short</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>profile_length <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, profile_length,
         "<font color='#CC0000'>invalid length</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_icc_check_header</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_colorspacerp colorspace,
   png_const_charp name, png_uint_32 profile_length,
   png_const_bytep profile<font color='#009900'>/* first 132 bytes only */</font>, <font color='#0000FF'><u>int</u></font> color_type<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 temp;

   <font color='#009900'>/* Length check; this cannot be ignored in this code because profile_length
    * is used later to check the tag table, so even if the profile seems over
    * long profile_length from the caller must be correct.  The caller can fix
    * this up on read or write by just passing in the profile header length.
    */</font>
   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> profile_length<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
         "<font color='#CC0000'>length does not match profile</font>"<font face='Lucida Console'>)</font>;

   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>128</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* tag count: 12 bytes/tag */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>&gt;</font> <font color='#979000'>357913930</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#009900'>/* (2^32-4-132)/12: maximum possible tag count */</font>
      profile_length <font color='#5555FF'>&lt;</font> <font color='#979000'>132</font><font color='#5555FF'>+</font><font color='#979000'>12</font><font color='#5555FF'>*</font>temp<font face='Lucida Console'>)</font> <font color='#009900'>/* truncated tag table */</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
         "<font color='#CC0000'>tag count too large</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The 'intent' must be valid or we can't store it, ICC limits the intent to
    * 16 bits.
    */</font>
   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>64</font><font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font> <font color='#009900'>/* The ICC limit */</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
         "<font color='#CC0000'>invalid rendering intent</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* This is just a warning because the profile may be valid in future
    * versions.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_sRGB_INTENT_LAST<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, NULL, name, temp,
         "<font color='#CC0000'>intent outside defined range</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* At this point the tag table can't be checked because it hasn't necessarily
    * been loaded; however, various header fields can be checked.  These checks
    * are for values permitted by the PNG spec in an ICC profile; the PNG spec
    * restricts the profiles that can be passed in an iCCP chunk (they must be
    * appropriate to processing PNG data!)
    */</font>

   <font color='#009900'>/* Data checks (could be skipped).  These checks must be independent of the
    * version number; however, the version number doesn't accomodate changes in
    * the header fields (just the known tags and the interpretation of the
    * data.)
    */</font>
   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>36</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* signature 'ascp' */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0x61637370</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
         "<font color='#CC0000'>invalid signature</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Currently the PCS illuminant/adopted white point (the computational
    * white point) are required to be D50,
    * however the profile contains a record of the illuminant so perhaps ICC
    * expects to be able to change this in the future (despite the rationale in
    * the introduction for using a fixed PCS adopted white.)  Consequently the
    * following is just a warning.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>memcmp</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>68</font>, D50_nCIEXYZ, <font color='#979000'>12</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, NULL, name, <font color='#979000'>0</font><font color='#009900'>/*no tag value*/</font>,
         "<font color='#CC0000'>PCS illuminant is not D50</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The PNG spec requires this:
    * "If the iCCP chunk is present, the image samples conform to the colour
    * space represented by the embedded ICC profile as defined by the
    * International Color Consortium [ICC]. The colour space of the ICC profile
    * shall be an RGB colour space for colour images (PNG colour types 2, 3, and
    * 6), or a greyscale colour space for greyscale images (PNG colour types 0
    * and 4)."
    *
    * This checking code ensures the embedded profile (on either read or write)
    * conforms to the specification requirements.  Notice that an ICC 'gray'
    * color-space profile contains the information to transform the monochrome
    * data to XYZ or L*a*b (according to which PCS the profile uses) and this
    * should be used in preference to the standard libpng K channel replication
    * into R, G and B channels.
    *
    * Previously it was suggested that an RGB profile on grayscale data could be
    * handled.  However it it is clear that using an RGB profile in this context
    * must be an error - there is no specification of what it means.  Thus it is
    * almost certainly more correct to ignore the profile.
    */</font>
   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>16</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* data colour space field */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>0x52474220</font>: <font color='#009900'>/* 'RGB ' */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
               "<font color='#CC0000'>RGB color space not permitted on grayscale PNG</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>0x47524159</font>: <font color='#009900'>/* 'GRAY' */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
               "<font color='#CC0000'>Gray color space not permitted on RGB PNG</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
            "<font color='#CC0000'>invalid ICC profile color space</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* It is up to the application to check that the profile class matches the
    * application requirements; the spec provides no guidance, but it's pretty
    * weird if the profile is not scanner ('scnr'), monitor ('mntr'), printer
    * ('prtr') or 'spac' (for generic color spaces).  Issue a warning in these
    * cases.  Issue an error for device link or abstract profiles - these don't
    * contain the records necessary to transform the color-space to anything
    * other than the target device (and not even that for an abstract profile).
    * Profiles of these classes may not be embedded in images.
    */</font>
   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>12</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* profile/device class */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>0x73636E72</font>: <font color='#009900'>/* 'scnr' */</font>
      <font color='#0000FF'>case</font> <font color='#979000'>0x6D6E7472</font>: <font color='#009900'>/* 'mntr' */</font>
      <font color='#0000FF'>case</font> <font color='#979000'>0x70727472</font>: <font color='#009900'>/* 'prtr' */</font>
      <font color='#0000FF'>case</font> <font color='#979000'>0x73706163</font>: <font color='#009900'>/* 'spac' */</font>
         <font color='#009900'>/* All supported */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>0x61627374</font>: <font color='#009900'>/* 'abst' */</font>
         <font color='#009900'>/* May not be embedded in an image */</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
            "<font color='#CC0000'>invalid embedded Abstract ICC profile</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>0x6C696E6B</font>: <font color='#009900'>/* 'link' */</font>
         <font color='#009900'>/* DeviceLink profiles cannnot be interpreted in a non-device specific
          * fashion, if an app uses the AToB0Tag in the profile the results are
          * undefined unless the result is sent to the intended device,
          * therefore a DeviceLink profile should not be found embedded in a
          * PNG.
          */</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
            "<font color='#CC0000'>unexpected DeviceLink ICC profile class</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>0x6E6D636C</font>: <font color='#009900'>/* 'nmcl' */</font>
         <font color='#009900'>/* A NamedColor profile is also device specific, however it doesn't
          * contain an AToB0 tag that is open to misintrepretation.  Almost
          * certainly it will fail the tests below.
          */</font>
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, NULL, name, temp,
            "<font color='#CC0000'>unexpected NamedColor ICC profile class</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#009900'>/* To allow for future enhancements to the profile accept unrecognized
          * profile classes with a warning, these then hit the test below on the
          * tag content to ensure they are backward compatible with one of the
          * understood profiles.
          */</font>
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, NULL, name, temp,
            "<font color='#CC0000'>unrecognized ICC profile class</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#009900'>/* For any profile other than a device link one the PCS must be encoded
    * either in XYZ or Lab.
    */</font>
   temp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>20</font><font face='Lucida Console'>)</font>;
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>0x58595A20</font>: <font color='#009900'>/* 'XYZ ' */</font>
      <font color='#0000FF'>case</font> <font color='#979000'>0x4C616220</font>: <font color='#009900'>/* 'Lab ' */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, temp,
            "<font color='#CC0000'>unexpected ICC PCS encoding</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_icc_check_tag_table</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_colorspacerp colorspace,
   png_const_charp name, png_uint_32 profile_length,
   png_const_bytep profile <font color='#009900'>/* header plus whole tag table */</font><font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 tag_count <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>128</font><font face='Lucida Console'>)</font>;
   png_uint_32 itag;
   png_const_bytep tag <font color='#5555FF'>=</font> profile<font color='#5555FF'>+</font><font color='#979000'>132</font>; <font color='#009900'>/* The first tag */</font>

   <font color='#009900'>/* First scan all the tags in the table and add bits to the icc_info value
    * (temporarily in 'tags').
    */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>itag<font color='#5555FF'>=</font><font color='#979000'>0</font>; itag <font color='#5555FF'>&lt;</font> tag_count; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>itag, tag <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 tag_id <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>tag<font color='#5555FF'>+</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
      png_uint_32 tag_start <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>tag<font color='#5555FF'>+</font><font color='#979000'>4</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* must be aligned */</font>
      png_uint_32 tag_length <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>tag<font color='#5555FF'>+</font><font color='#979000'>8</font><font face='Lucida Console'>)</font>;<font color='#009900'>/* not padded */</font>

      <font color='#009900'>/* The ICC specification does not exclude zero length tags, therefore the
       * start might actually be anywhere if there is no data, but this would be
       * a clear abuse of the intent of the standard so the start is checked for
       * being in range.  All defined tag types have an 8 byte header - a 4 byte
       * type signature then 0.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>tag_start <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* CNHP730S.icc shipped with Microsoft Windows 64 violates this, it is
          * only a warning here because libpng does not care about the
          * alignment.
          */</font>
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, NULL, name, tag_id,
            "<font color='#CC0000'>ICC profile tag start not a multiple of 4</font>"<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#009900'>/* This is a hard error; potentially it can cause read outside the
       * profile.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>tag_start <font color='#5555FF'>&gt;</font> profile_length <font color='#5555FF'>|</font><font color='#5555FF'>|</font> tag_length <font color='#5555FF'>&gt;</font> profile_length <font color='#5555FF'>-</font> tag_start<font face='Lucida Console'>)</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_icc_profile_error</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, tag_id,
            "<font color='#CC0000'>ICC profile tag outside profile</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>; <font color='#009900'>/* success, maybe with warnings */</font>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_sRGB_SUPPORTED
<font color='#009900'>/* Information about the known ICC sRGB profiles */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'>const</font> <font color='#0000FF'>struct</font>
<b>{</b>
   png_uint_32 adler, crc, length;
   png_uint_32 md5[<font color='#979000'>4</font>];
   png_byte    have_md5;
   png_byte    is_broken;
   png_uint_16 intent;

#  define <b><a name='PNG_MD5'></a>PNG_MD5</b><font face='Lucida Console'>(</font>a,b,c,d<font face='Lucida Console'>)</font> <b>{</b> a, b, c, d <b>}</b>, <font face='Lucida Console'>(</font>a<font color='#5555FF'>!</font><font color='#5555FF'>=</font><font color='#979000'>0</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>b<font color='#5555FF'>!</font><font color='#5555FF'>=</font><font color='#979000'>0</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>c<font color='#5555FF'>!</font><font color='#5555FF'>=</font><font color='#979000'>0</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>d<font color='#5555FF'>!</font><font color='#5555FF'>=</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>
#  define <b><a name='PNG_ICC_CHECKSUM'></a>PNG_ICC_CHECKSUM</b><font face='Lucida Console'>(</font>adler, crc, md5, intent, broke, date, length, fname<font face='Lucida Console'>)</font>\
      <b>{</b> adler, crc, length, md5, broke, intent <b>}</b>,

<b>}</b> png_sRGB_checks[] <font color='#5555FF'>=</font>
<b>{</b>
   <font color='#009900'>/* This data comes from contrib/tools/checksum-icc run on downloads of
    * all four ICC sRGB profiles from www.color.org.
    */</font>
   <font color='#009900'>/* adler32, crc32, MD5[4], intent, date, length, file-name */</font>
   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0x0a3fd9f6</font>, <font color='#979000'>0x3b8772b9</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0x29f83dde</font>, <font color='#979000'>0xaff255ae</font>, <font color='#979000'>0x7842fae4</font>, <font color='#979000'>0xca83390d</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font>, <font color='#979000'>0</font>,
      "<font color='#CC0000'>2009/03/27 21:36:31</font>", <font color='#979000'>3048</font>, "<font color='#CC0000'>sRGB_IEC61966-2-1_black_scaled.icc</font>"<font face='Lucida Console'>)</font>

   <font color='#009900'>/* ICC sRGB v2 perceptual no black-compensation: */</font>
   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0x4909e5e1</font>, <font color='#979000'>0x427ebb21</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0xc95bd637</font>, <font color='#979000'>0xe95d8a3b</font>, <font color='#979000'>0x0df38f99</font>, <font color='#979000'>0xc1320389</font><font face='Lucida Console'>)</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font>,
      "<font color='#CC0000'>2009/03/27 21:37:45</font>", <font color='#979000'>3052</font>, "<font color='#CC0000'>sRGB_IEC61966-2-1_no_black_scaling.icc</font>"<font face='Lucida Console'>)</font>

   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0xfd2144a1</font>, <font color='#979000'>0x306fd8ae</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0xfc663378</font>, <font color='#979000'>0x37e2886b</font>, <font color='#979000'>0xfd72e983</font>, <font color='#979000'>0x8228f1b8</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font>, <font color='#979000'>0</font>,
      "<font color='#CC0000'>2009/08/10 17:28:01</font>", <font color='#979000'>60988</font>, "<font color='#CC0000'>sRGB_v4_ICC_preference_displayclass.icc</font>"<font face='Lucida Console'>)</font>

   <font color='#009900'>/* ICC sRGB v4 perceptual */</font>
   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0x209c35d2</font>, <font color='#979000'>0xbbef7812</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0x34562abf</font>, <font color='#979000'>0x994ccd06</font>, <font color='#979000'>0x6d2c5721</font>, <font color='#979000'>0xd0d68c5d</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font>, <font color='#979000'>0</font>,
      "<font color='#CC0000'>2007/07/25 00:05:37</font>", <font color='#979000'>60960</font>, "<font color='#CC0000'>sRGB_v4_ICC_preference.icc</font>"<font face='Lucida Console'>)</font>

   <font color='#009900'>/* The following profiles have no known MD5 checksum. If there is a match
    * on the (empty) MD5 the other fields are used to attempt a match and
    * a warning is produced.  The first two of these profiles have a 'cprt' tag
    * which suggests that they were also made by Hewlett Packard.
    */</font>
   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0xa054d762</font>, <font color='#979000'>0x5d5129ce</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font><font face='Lucida Console'>)</font>, <font color='#979000'>1</font>, <font color='#979000'>0</font>,
      "<font color='#CC0000'>2004/07/21 18:57:42</font>", <font color='#979000'>3024</font>, "<font color='#CC0000'>sRGB_IEC61966-2-1_noBPC.icc</font>"<font face='Lucida Console'>)</font>

   <font color='#009900'>/* This is a 'mntr' (display) profile with a mediaWhitePointTag that does not
    * match the D50 PCS illuminant in the header (it is in fact the D65 values,
    * so the white point is recorded as the un-adapted value.)  The profiles
    * below only differ in one byte - the intent - and are basically the same as
    * the previous profile except for the mediaWhitePointTag error and a missing
    * chromaticAdaptationTag.
    */</font>
   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0xf784f3fb</font>, <font color='#979000'>0x182ea552</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font><font face='Lucida Console'>)</font>, <font color='#979000'>0</font>, <font color='#979000'>1</font><font color='#009900'>/*broken*/</font>,
      "<font color='#CC0000'>1998/02/09 06:49:00</font>", <font color='#979000'>3144</font>, "<font color='#CC0000'>HP-Microsoft sRGB v2 perceptual</font>"<font face='Lucida Console'>)</font>

   <font color='#BB00BB'>PNG_ICC_CHECKSUM</font><font face='Lucida Console'>(</font><font color='#979000'>0x0398f3fc</font>, <font color='#979000'>0xf29e526d</font>,
      <font color='#BB00BB'>PNG_MD5</font><font face='Lucida Console'>(</font><font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font>, <font color='#979000'>0x00000000</font><font face='Lucida Console'>)</font>, <font color='#979000'>1</font>, <font color='#979000'>1</font><font color='#009900'>/*broken*/</font>,
      "<font color='#CC0000'>1998/02/09 06:49:00</font>", <font color='#979000'>3144</font>, "<font color='#CC0000'>HP-Microsoft sRGB v2 media-relative</font>"<font face='Lucida Console'>)</font>
<b>}</b>;

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_compare_ICC_profile_with_sRGB</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_const_bytep profile, uLong adler<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The quick check is to verify just the MD5 signature and trust the
    * rest of the data.  Because the profile has already been verified for
    * correctness this is safe.  png_colorspace_set_sRGB will check the 'intent'
    * field too, so if the profile has been edited with an intent not defined
    * by sRGB (but maybe defined by a later ICC specification) the read of
    * the profile will fail at that point.
    */</font>
   png_uint_32 length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   png_uint_32 intent <font color='#5555FF'>=</font> <font color='#979000'>0x10000</font>; <font color='#009900'>/* invalid */</font>
<font color='#0000FF'>#if</font> PNG_sRGB_PROFILE_CHECKS <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font>
   uLong crc <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* the value for 0 length data */</font>
<font color='#0000FF'>#endif</font>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> png_sRGB_checks<font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> png_sRGB_checks[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>84</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].md5[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>88</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].md5[<font color='#979000'>1</font>] <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>92</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].md5[<font color='#979000'>2</font>] <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>96</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].md5[<font color='#979000'>3</font>]<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This may be one of the old HP profiles without an MD5, in that
          * case we can only use the length and Adler32 (note that these
          * are not used by default if there is an MD5!)
          */</font>
#        <font color='#0000FF'>if</font> PNG_sRGB_PROFILE_CHECKS <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_sRGB_checks[i].have_md5<font face='Lucida Console'>)</font>
               <font color='#0000FF'>return</font> <font color='#979000'>1</font><font color='#5555FF'>+</font>png_sRGB_checks[i].is_broken;
#        endif

         <font color='#009900'>/* Profile is unsigned or more checks have been configured in. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            length <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font face='Lucida Console'>)</font>;
            intent <font color='#5555FF'>=</font> <font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>64</font><font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#009900'>/* Length *and* intent must match */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>length <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            intent <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].intent<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Now calculate the adler32 if not done already. */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>adler <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               adler <font color='#5555FF'>=</font> <font color='#BB00BB'>adler32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
               adler <font color='#5555FF'>=</font> <font color='#BB00BB'>adler32</font><font face='Lucida Console'>(</font>adler, profile, length<font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>adler <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].adler<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* These basic checks suggest that the data has not been
                * modified, but if the check level is more than 1 perform
                * our own crc32 checksum on the data.
                */</font>
#              <font color='#0000FF'>if</font> PNG_sRGB_PROFILE_CHECKS <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>crc <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     crc <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                     crc <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>crc, profile, length<font face='Lucida Console'>)</font>;
                  <b>}</b>

                  <font color='#009900'>/* So this check must pass for the 'return' below to happen.
                   */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>crc <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB_checks[i].crc<font face='Lucida Console'>)</font>
#              endif
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_sRGB_checks[i].is_broken<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* These profiles are known to have bad data that may cause
                      * problems if they are used, therefore attempt to
                      * discourage their use, skip the 'have_md5' warning below,
                      * which is made irrelevant by this error.
                      */</font>
                     <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>known incorrect sRGB profile</font>",
                        PNG_CHUNK_ERROR<font face='Lucida Console'>)</font>;
                  <b>}</b>

                  <font color='#009900'>/* Warn that this being done; this isn't even an error since
                   * the profile is perfectly valid, but it would be nice if
                   * people used the up-to-date ones.
                   */</font>
                  <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>png_sRGB_checks[i].have_md5<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#BB00BB'>png_chunk_report</font><font face='Lucida Console'>(</font>png_ptr,
                        "<font color='#CC0000'>out-of-date sRGB profile with no signature</font>",
                        PNG_CHUNK_WARNING<font face='Lucida Console'>)</font>;
                  <b>}</b>

                  <font color='#0000FF'>return</font> <font color='#979000'>1</font><font color='#5555FF'>+</font>png_sRGB_checks[i].is_broken;
               <b>}</b>
            <b>}</b>
         <b>}</b>

#        <font color='#0000FF'>if</font> PNG_sRGB_PROFILE_CHECKS <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>
            <font color='#009900'>/* The signature matched, but the profile had been changed in some
             * way.  This is an apparent violation of the ICC terms of use and,
             * anyway, probably indicates a data error or uninformed hacking.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_sRGB_checks[i].have_md5<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr,
                  "<font color='#CC0000'>copyright violation: edited ICC profile ignored</font>"<font face='Lucida Console'>)</font>;
#        endif
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* no match */</font>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_sRGB_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_icc_set_sRGB</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_colorspacerp colorspace, png_const_bytep profile, uLong adler<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Is this profile one of the known ICC sRGB profiles?  If it is, just set
    * the sRGB information.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_compare_ICC_profile_with_sRGB</font><font face='Lucida Console'>(</font>png_ptr, profile, adler<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_colorspace_set_sRGB</font><font face='Lucida Console'>(</font>png_ptr, colorspace,
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#009900'>/*already checked*/</font><font color='#BB00BB'>png_get_uint_32</font><font face='Lucida Console'>(</font>profile<font color='#5555FF'>+</font><font color='#979000'>64</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_sRGB_SUPPORTED */</font>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_set_ICC</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_colorspacerp colorspace,
   png_const_charp name, png_uint_32 profile_length, png_const_bytep profile,
   <font color='#0000FF'><u>int</u></font> color_type<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>colorspace<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_icc_check_length</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, profile_length<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#BB00BB'>png_icc_check_header</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, profile_length, profile,
         color_type<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#BB00BB'>png_icc_check_tag_table</font><font face='Lucida Console'>(</font>png_ptr, colorspace, name, profile_length,
         profile<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
#     ifdef PNG_sRGB_SUPPORTED
         <font color='#009900'>/* If no sRGB support, don't try storing sRGB information */</font>
         <font color='#BB00BB'>png_icc_set_sRGB</font><font face='Lucida Console'>(</font>png_ptr, colorspace, profile, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
#     endif
      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#009900'>/* Failure case */</font>
   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* iCCP */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_colorspace_set_rgb_coefficients</font><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Set the rgb_to_gray coefficients from the colorspace. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_coefficients_set <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_ENDPOINTS<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* png_set_background has not been called, get the coefficients from the Y
       * values of the colorspace colorants.
       */</font>
      png_fixed_point r <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.end_points_XYZ.red_Y;
      png_fixed_point g <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.end_points_XYZ.green_Y;
      png_fixed_point b <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.end_points_XYZ.blue_Y;
      png_fixed_point total <font color='#5555FF'>=</font> r<font color='#5555FF'>+</font>g<font color='#5555FF'>+</font>b;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>total <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>r, r, <font color='#979000'>32768</font>, total<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>32768</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         g <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>g, g, <font color='#979000'>32768</font>, total<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> g <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> g <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>32768</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         b <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>b, b, <font color='#979000'>32768</font>, total<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> b <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> b <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>32768</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         r<font color='#5555FF'>+</font>g<font color='#5555FF'>+</font>b <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>32769</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* We allow 0 coefficients here.  r+g+b may be 32769 if two or
          * all of the coefficients were rounded up.  Handle this by
          * reducing the *largest* coefficient by 1; this matches the
          * approach used for the default coefficients in pngrtran.c
          */</font>
         <font color='#0000FF'><u>int</u></font> add <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r<font color='#5555FF'>+</font>g<font color='#5555FF'>+</font>b <font color='#5555FF'>&gt;</font> <font color='#979000'>32768</font><font face='Lucida Console'>)</font>
            add <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;
         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r<font color='#5555FF'>+</font>g<font color='#5555FF'>+</font>b <font color='#5555FF'>&lt;</font> <font color='#979000'>32768</font><font face='Lucida Console'>)</font>
            add <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>add <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>g <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> r <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> g <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> b<font face='Lucida Console'>)</font>
               g <font color='#5555FF'>+</font><font color='#5555FF'>=</font> add;
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> g <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> b<font face='Lucida Console'>)</font>
               r <font color='#5555FF'>+</font><font color='#5555FF'>=</font> add;
            <font color='#0000FF'>else</font>
               b <font color='#5555FF'>+</font><font color='#5555FF'>=</font> add;
         <b>}</b>

         <font color='#009900'>/* Check for an internal error. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r<font color='#5555FF'>+</font>g<font color='#5555FF'>+</font>b <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>32768</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr,
               "<font color='#CC0000'>internal error handling cHRM coefficients</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_red_coeff   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>r;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_green_coeff <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>g;
         <b>}</b>
      <b>}</b>

      <font color='#009900'>/* This is a png_error at present even though it could be ignored -
       * it should never happen, but it is important that if it does, the
       * bug is fixed.
       */</font>
      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal error handling cHRM-&gt;XYZ</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* COLORSPACE */</font>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_check_IHDR</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr,
   png_uint_32 width, png_uint_32 height, <font color='#0000FF'><u>int</u></font> bit_depth,
   <font color='#0000FF'><u>int</u></font> color_type, <font color='#0000FF'><u>int</u></font> interlace_type, <font color='#0000FF'><u>int</u></font> compression_type,
   <font color='#0000FF'><u>int</u></font> filter_type<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> error <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* Check for width and height valid values */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>width <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Image width is zero in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>height <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Image height is zero in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

#  ifdef PNG_SET_USER_LIMITS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>width <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_width_max<font face='Lucida Console'>)</font>

#  <font color='#0000FF'>else</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>width <font color='#5555FF'>&gt;</font> PNG_USER_WIDTH_MAX<font face='Lucida Console'>)</font>
#  endif
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Image width exceeds user limit in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

#  ifdef PNG_SET_USER_LIMITS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>height <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_height_max<font face='Lucida Console'>)</font>
#  <font color='#0000FF'>else</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>height <font color='#5555FF'>&gt;</font> PNG_USER_HEIGHT_MAX<font face='Lucida Console'>)</font>
#  endif
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Image height exceeds user limit in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>width <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid image width in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>height <font color='#5555FF'>&gt;</font> PNG_UINT_31_MAX<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid image height in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>width <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font>PNG_UINT_32_MAX
                 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>      <font color='#009900'>/* 8-byte RGBA pixels */</font>
                 <font color='#5555FF'>-</font> <font color='#979000'>48</font>       <font color='#009900'>/* bigrowbuf hack */</font>
                 <font color='#5555FF'>-</font> <font color='#979000'>1</font>        <font color='#009900'>/* filter byte */</font>
                 <font color='#5555FF'>-</font> <font color='#979000'>7</font><font color='#5555FF'>*</font><font color='#979000'>8</font>      <font color='#009900'>/* rounding of width to multiple of 8 pixels */</font>
                 <font color='#5555FF'>-</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>       <font color='#009900'>/* extra max_pixel_depth pad */</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Width is too large for libpng to process pixels</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Check other values */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid bit depth in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>5</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> color_type <font color='#5555FF'>&gt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid color type in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid color type/bit depth combination in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>interlace_type <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_INTERLACE_LAST<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unknown interlace method in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compression_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COMPRESSION_TYPE_BASE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unknown compression method in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>

#  ifdef PNG_MNG_FEATURES_SUPPORTED
   <font color='#009900'>/* Accept filter_method 64 (intrapixel differencing) only if
    * 1. Libpng was compiled with PNG_MNG_FEATURES_SUPPORTED and
    * 2. Libpng did not read a PNG signature (this filter_method is only
    *    used in PNG datastreams that are embedded in MNG datastreams) and
    * 3. The application called png_permit_mng_features with a mask that
    *    included PNG_FLAG_MNG_FILTER_64 and
    * 4. The filter_method is 64 and
    * 5. The color_type is RGB or RGBA
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PNG_SIGNATURE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mng_features_permitted<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>MNG features are not allowed in a PNG datastream</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_FILTER_TYPE_BASE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mng_features_permitted <font color='#5555FF'>&amp;</font> PNG_FLAG_MNG_FILTER_64<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
          <font face='Lucida Console'>(</font>filter_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTRAPIXEL_DIFFERENCING<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
          <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PNG_SIGNATURE<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
          <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unknown filter method in IHDR</font>"<font face='Lucida Console'>)</font>;
         error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PNG_SIGNATURE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid filter method in IHDR</font>"<font face='Lucida Console'>)</font>;
         error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      <b>}</b>
   <b>}</b>

#  <font color='#0000FF'>else</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>filter_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_FILTER_TYPE_BASE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Unknown filter method in IHDR</font>"<font face='Lucida Console'>)</font>;
      error <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
   <b>}</b>
#  endif

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>error <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid IHDR data</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_sCAL_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_pCAL_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* ASCII to fp functions */</font>
<font color='#009900'>/* Check an ASCII formated floating point value, see the more detailed
 * comments in pngpriv.h
 */</font>
<font color='#009900'>/* The following is used internally to preserve the sticky flags */</font>
<font color='#0000FF'>#define</font> png_fp_add<font face='Lucida Console'>(</font>state, flags<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>state<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>flags<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#define</font> png_fp_set<font face='Lucida Console'>(</font>state, value<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>state<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>state<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> PNG_FP_STICKY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_check_fp_number</font><font face='Lucida Console'>(</font>png_const_charp string, png_size_t size, <font color='#0000FF'><u>int</u></font> <font color='#5555FF'>*</font>statep,
   png_size_tp whereami<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> state <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>statep;
   png_size_t i <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>whereami;

   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>&lt;</font> size<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> type;
      <font color='#009900'>/* First find the type of the next character */</font>
      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>string[i]<font face='Lucida Console'>)</font>
      <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>43</font>:  type <font color='#5555FF'>=</font> PNG_FP_SAW_SIGN;                   <font color='#0000FF'>break</font>;
      <font color='#0000FF'>case</font> <font color='#979000'>45</font>:  type <font color='#5555FF'>=</font> PNG_FP_SAW_SIGN <font color='#5555FF'>+</font> PNG_FP_NEGATIVE; <font color='#0000FF'>break</font>;
      <font color='#0000FF'>case</font> <font color='#979000'>46</font>:  type <font color='#5555FF'>=</font> PNG_FP_SAW_DOT;                    <font color='#0000FF'>break</font>;
      <font color='#0000FF'>case</font> <font color='#979000'>48</font>:  type <font color='#5555FF'>=</font> PNG_FP_SAW_DIGIT;                  <font color='#0000FF'>break</font>;
      <font color='#0000FF'>case</font> <font color='#979000'>49</font>: <font color='#0000FF'>case</font> <font color='#979000'>50</font>: <font color='#0000FF'>case</font> <font color='#979000'>51</font>: <font color='#0000FF'>case</font> <font color='#979000'>52</font>:
      <font color='#0000FF'>case</font> <font color='#979000'>53</font>: <font color='#0000FF'>case</font> <font color='#979000'>54</font>: <font color='#0000FF'>case</font> <font color='#979000'>55</font>: <font color='#0000FF'>case</font> <font color='#979000'>56</font>:
      <font color='#0000FF'>case</font> <font color='#979000'>57</font>:  type <font color='#5555FF'>=</font> PNG_FP_SAW_DIGIT <font color='#5555FF'>+</font> PNG_FP_NONZERO; <font color='#0000FF'>break</font>;
      <font color='#0000FF'>case</font> <font color='#979000'>69</font>:
      <font color='#0000FF'>case</font> <font color='#979000'>101</font>: type <font color='#5555FF'>=</font> PNG_FP_SAW_E;                      <font color='#0000FF'>break</font>;
      <font color='#0000FF'>default</font>:  <font color='#0000FF'>goto</font> PNG_FP_End;
      <b>}</b>

      <font color='#009900'>/* Now deal with this type according to the current
       * state, the type is arranged to not overlap the
       * bits of the PNG_FP_STATE.
       */</font>
      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_STATE<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>type <font color='#5555FF'>&amp;</font> PNG_FP_SAW_ANY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
      <font color='#0000FF'>case</font> PNG_FP_INTEGER <font color='#5555FF'>+</font> PNG_FP_SAW_SIGN:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_ANY<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> PNG_FP_End; <font color='#009900'>/* not a part of the number */</font>

         <font color='#BB00BB'>png_fp_add</font><font face='Lucida Console'>(</font>state, type<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_FP_INTEGER <font color='#5555FF'>+</font> PNG_FP_SAW_DOT:
         <font color='#009900'>/* Ok as trailer, ok as lead of fraction. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_DOT<font face='Lucida Console'>)</font> <font color='#009900'>/* two dots */</font>
            <font color='#0000FF'>goto</font> PNG_FP_End;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_DIGIT<font face='Lucida Console'>)</font> <font color='#009900'>/* trailing dot? */</font>
            <font color='#BB00BB'>png_fp_add</font><font face='Lucida Console'>(</font>state, type<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font>
            <font color='#BB00BB'>png_fp_set</font><font face='Lucida Console'>(</font>state, PNG_FP_FRACTION <font color='#5555FF'>|</font> type<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_FP_INTEGER <font color='#5555FF'>+</font> PNG_FP_SAW_DIGIT:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_DOT<font face='Lucida Console'>)</font> <font color='#009900'>/* delayed fraction */</font>
            <font color='#BB00BB'>png_fp_set</font><font face='Lucida Console'>(</font>state, PNG_FP_FRACTION <font color='#5555FF'>|</font> PNG_FP_SAW_DOT<font face='Lucida Console'>)</font>;

         <font color='#BB00BB'>png_fp_add</font><font face='Lucida Console'>(</font>state, type <font color='#5555FF'>|</font> PNG_FP_WAS_VALID<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_FP_INTEGER <font color='#5555FF'>+</font> PNG_FP_SAW_E:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_DIGIT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> PNG_FP_End;

         <font color='#BB00BB'>png_fp_set</font><font face='Lucida Console'>(</font>state, PNG_FP_EXPONENT<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>break</font>;

   <font color='#009900'>/* case PNG_FP_FRACTION + PNG_FP_SAW_SIGN:
         goto PNG_FP_End; ** no sign in fraction */</font>

   <font color='#009900'>/* case PNG_FP_FRACTION + PNG_FP_SAW_DOT:
         goto PNG_FP_End; ** Because SAW_DOT is always set */</font>

      <font color='#0000FF'>case</font> PNG_FP_FRACTION <font color='#5555FF'>+</font> PNG_FP_SAW_DIGIT:
         <font color='#BB00BB'>png_fp_add</font><font face='Lucida Console'>(</font>state, type <font color='#5555FF'>|</font> PNG_FP_WAS_VALID<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_FP_FRACTION <font color='#5555FF'>+</font> PNG_FP_SAW_E:
         <font color='#009900'>/* This is correct because the trailing '.' on an
          * integer is handled above - so we can only get here
          * with the sequence ".E" (with no preceding digits).
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_DIGIT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> PNG_FP_End;

         <font color='#BB00BB'>png_fp_set</font><font face='Lucida Console'>(</font>state, PNG_FP_EXPONENT<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_FP_EXPONENT <font color='#5555FF'>+</font> PNG_FP_SAW_SIGN:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_ANY<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> PNG_FP_End; <font color='#009900'>/* not a part of the number */</font>

         <font color='#BB00BB'>png_fp_add</font><font face='Lucida Console'>(</font>state, PNG_FP_SAW_SIGN<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>break</font>;

   <font color='#009900'>/* case PNG_FP_EXPONENT + PNG_FP_SAW_DOT:
         goto PNG_FP_End; */</font>

      <font color='#0000FF'>case</font> PNG_FP_EXPONENT <font color='#5555FF'>+</font> PNG_FP_SAW_DIGIT:
         <font color='#BB00BB'>png_fp_add</font><font face='Lucida Console'>(</font>state, PNG_FP_SAW_DIGIT <font color='#5555FF'>|</font> PNG_FP_WAS_VALID<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>break</font>;

   <font color='#009900'>/* case PNG_FP_EXPONEXT + PNG_FP_SAW_E:
         goto PNG_FP_End; */</font>

      <font color='#0000FF'>default</font>: <font color='#0000FF'>goto</font> PNG_FP_End; <font color='#009900'>/* I.e. break 2 */</font>
      <b>}</b>

      <font color='#009900'>/* The character seems ok, continue. */</font>
      <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i;
   <b>}</b>

PNG_FP_End:
   <font color='#009900'>/* Here at the end, update the state and return the correct
    * return code.
    */</font>
   <font color='#5555FF'>*</font>statep <font color='#5555FF'>=</font> state;
   <font color='#5555FF'>*</font>whereami <font color='#5555FF'>=</font> i;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>state <font color='#5555FF'>&amp;</font> PNG_FP_SAW_DIGIT<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
<b>}</b>


<font color='#009900'>/* The same but for a complete string. */</font>
<font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_check_fp_string</font><font face='Lucida Console'>(</font>png_const_charp string, png_size_t size<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font>        state<font color='#5555FF'>=</font><font color='#979000'>0</font>;
   png_size_t char_index<font color='#5555FF'>=</font><font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_check_fp_number</font><font face='Lucida Console'>(</font>string, size, <font color='#5555FF'>&amp;</font>state, <font color='#5555FF'>&amp;</font>char_index<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>char_index <font color='#5555FF'>=</font><font color='#5555FF'>=</font> size <font color='#5555FF'>|</font><font color='#5555FF'>|</font> string[char_index] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> state <font color='#009900'>/* must be non-zero - see above */</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* i.e. fail */</font>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* pCAL or sCAL */</font>

<font color='#0000FF'>#ifdef</font> PNG_sCAL_SUPPORTED
#  ifdef PNG_FLOATING_POINT_SUPPORTED
<font color='#009900'>/* Utility used below - a simple accurate power of ten from an integral
 * exponent.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>double</u></font>
<font color='#BB00BB'>png_pow10</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font> power<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> recip <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>double</u></font> d <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* Handle negative exponent with a reciprocal at the end because
    * 10 is exact whereas .1 is inexact in base 2
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>power <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>power <font color='#5555FF'>&lt;</font> DBL_MIN_10_EXP<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
      recip <font color='#5555FF'>=</font> <font color='#979000'>1</font>, power <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>power;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>power <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Decompose power bitwise. */</font>
      <font color='#0000FF'><u>double</u></font> mult <font color='#5555FF'>=</font> <font color='#979000'>10</font>;
      <font color='#0000FF'>do</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>power <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> d <font color='#5555FF'>*</font><font color='#5555FF'>=</font> mult;
         mult <font color='#5555FF'>*</font><font color='#5555FF'>=</font> mult;
         power <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      <b>}</b>
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>power <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>recip<font face='Lucida Console'>)</font> d <font color='#5555FF'>=</font> <font color='#979000'>1</font><font color='#5555FF'>/</font>d;
   <b>}</b>
   <font color='#009900'>/* else power is 0 and d is 1 */</font>

   <font color='#0000FF'>return</font> d;
<b>}</b>

<font color='#009900'>/* Function to format a floating point value in ASCII with a given
 * precision.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_ascii_from_fp</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_charp ascii, png_size_t size,
    <font color='#0000FF'><u>double</u></font> fp, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> precision<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* We use standard functions from math.h, but not printf because
    * that would require stdio.  The caller must supply a buffer of
    * sufficient size or we will png_error.  The tests on size and
    * the space in ascii[] consumed are indicated below.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>precision <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
      precision <font color='#5555FF'>=</font> DBL_DIG;

   <font color='#009900'>/* Enforce the limit of the implementation precision too. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>precision <font color='#5555FF'>&gt;</font> DBL_DIG<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>
      precision <font color='#5555FF'>=</font> DBL_DIG<font color='#5555FF'>+</font><font color='#979000'>1</font>;

   <font color='#009900'>/* Basic sanity checks */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> precision<font color='#5555FF'>+</font><font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#009900'>/* See the requirements below. */</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>fp <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         fp <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>fp;
         <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>45</font>; <font color='#009900'>/* '-'  PLUS 1 TOTAL 1 */</font>
         <font color='#5555FF'>-</font><font color='#5555FF'>-</font>size;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>fp <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> DBL_MIN <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> fp <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> DBL_MAX<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> exp_b10;       <font color='#009900'>/* A base 10 exponent */</font>
         <font color='#0000FF'><u>double</u></font> base;   <font color='#009900'>/* 10^exp_b10 */</font>

         <font color='#009900'>/* First extract a base 10 exponent of the number,
          * the calculation below rounds down when converting
          * from base 2 to base 10 (multiply by log10(2) -
          * 0.3010, but 77/256 is 0.3008, so exp_b10 needs to
          * be increased.  Note that the arithmetic shift
          * performs a floor() unlike C arithmetic - using a
          * C multiply would break the following for negative
          * exponents.
          */</font>
         <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>frexp</font><font face='Lucida Console'>(</font>fp, <font color='#5555FF'>&amp;</font>exp_b10<font face='Lucida Console'>)</font>; <font color='#009900'>/* exponent to base 2 */</font>

         exp_b10 <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>*</font> <font color='#979000'>77</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>; <font color='#009900'>/* &lt;= exponent to base 10 */</font>

         <font color='#009900'>/* Avoid underflow here. */</font>
         base <font color='#5555FF'>=</font> <font color='#BB00BB'>png_pow10</font><font face='Lucida Console'>(</font>exp_b10<font face='Lucida Console'>)</font>; <font color='#009900'>/* May underflow */</font>

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>base <font color='#5555FF'>&lt;</font> DBL_MIN <font color='#5555FF'>|</font><font color='#5555FF'>|</font> base <font color='#5555FF'>&lt;</font> fp<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* And this may overflow. */</font>
            <font color='#0000FF'><u>double</u></font> test <font color='#5555FF'>=</font> <font color='#BB00BB'>png_pow10</font><font face='Lucida Console'>(</font>exp_b10<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>test <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> DBL_MAX<font face='Lucida Console'>)</font>
               <font color='#5555FF'>+</font><font color='#5555FF'>+</font>exp_b10, base <font color='#5555FF'>=</font> test;

            <font color='#0000FF'>else</font>
               <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#009900'>/* Normalize fp and correct exp_b10, after this fp is in the
          * range [.1,1) and exp_b10 is both the exponent and the digit
          * *before* which the decimal point should be inserted
          * (starting with 0 for the first digit).  Note that this
          * works even if 10^exp_b10 is out of range because of the
          * test on DBL_MAX above.
          */</font>
         fp <font color='#5555FF'>/</font><font color='#5555FF'>=</font> base;
         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>fp <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> fp <font color='#5555FF'>/</font><font color='#5555FF'>=</font> <font color='#979000'>10</font>, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>exp_b10;

         <font color='#009900'>/* Because of the code above fp may, at this point, be
          * less than .1, this is ok because the code below can
          * handle the leading zeros this generates, so no attempt
          * is made to correct that here.
          */</font>

         <b>{</b>
            <font color='#0000FF'><u>int</u></font> czero, clead, cdigits;
            <font color='#0000FF'><u>char</u></font> exponent[<font color='#979000'>10</font>];

            <font color='#009900'>/* Allow up to two leading zeros - this will not lengthen
             * the number compared to using E-n.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> exp_b10 <font color='#5555FF'>&gt;</font> <font color='#5555FF'>-</font><font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#009900'>/* PLUS 3 TOTAL 4 */</font>
            <b>{</b>
               czero <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>exp_b10; <font color='#009900'>/* PLUS 2 digits: TOTAL 3 */</font>
               exp_b10 <font color='#5555FF'>=</font> <font color='#979000'>0</font>;      <font color='#009900'>/* Dot added below before first output. */</font>
            <b>}</b>
            <font color='#0000FF'>else</font>
               czero <font color='#5555FF'>=</font> <font color='#979000'>0</font>;    <font color='#009900'>/* No zeros to add */</font>

            <font color='#009900'>/* Generate the digit list, stripping trailing zeros and
             * inserting a '.' before a digit if the exponent is 0.
             */</font>
            clead <font color='#5555FF'>=</font> czero; <font color='#009900'>/* Count of leading zeros */</font>
            cdigits <font color='#5555FF'>=</font> <font color='#979000'>0</font>;   <font color='#009900'>/* Count of digits in list. */</font>

            <font color='#0000FF'>do</font>
            <b>{</b>
               <font color='#0000FF'><u>double</u></font> d;

               fp <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>10</font>;
               <font color='#009900'>/* Use modf here, not floor and subtract, so that
                * the separation is done in one step.  At the end
                * of the loop don't break the number into parts so
                * that the final digit is rounded.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cdigits<font color='#5555FF'>+</font>czero<font color='#5555FF'>-</font>clead<font color='#5555FF'>+</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>precision<font face='Lucida Console'>)</font>
                  fp <font color='#5555FF'>=</font> <font color='#BB00BB'>modf</font><font face='Lucida Console'>(</font>fp, <font color='#5555FF'>&amp;</font>d<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>else</font>
               <b>{</b>
                  d <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font>fp <font color='#5555FF'>+</font> .<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>d <font color='#5555FF'>&gt;</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* Rounding up to 10, handle that here. */</font>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>czero <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>-</font><font color='#5555FF'>-</font>czero, d <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cdigits <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>-</font>clead;
                     <b>}</b>
                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>cdigits <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> d <font color='#5555FF'>&gt;</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#0000FF'><u>int</u></font> ch <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>ascii;

                           <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                              <font color='#5555FF'>+</font><font color='#5555FF'>+</font>exp_b10;

                           <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>46</font><font face='Lucida Console'>)</font>
                           <b>{</b>
                              ch <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>ascii, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>size;
                              <font color='#009900'>/* Advance exp_b10 to '1', so that the
                               * decimal point happens after the
                               * previous digit.
                               */</font>
                              exp_b10 <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                           <b>}</b>

                           <font color='#5555FF'>-</font><font color='#5555FF'>-</font>cdigits;
                           d <font color='#5555FF'>=</font> ch <font color='#5555FF'>-</font> <font color='#979000'>47</font>;  <font color='#009900'>/* I.e. 1+(ch-48) */</font>
                        <b>}</b>

                        <font color='#009900'>/* Did we reach the beginning? If so adjust the
                         * exponent but take into account the leading
                         * decimal point.
                         */</font>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>d <font color='#5555FF'>&gt;</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font>  <font color='#009900'>/* cdigits == 0 */</font>
                        <b>{</b>
                           <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                           <b>{</b>
                              <font color='#009900'>/* Leading decimal point (plus zeros?), if
                               * we lose the decimal point here it must
                               * be reentered below.
                               */</font>
                              <font color='#0000FF'><u>int</u></font> ch <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>ascii;

                              <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>46</font><font face='Lucida Console'>)</font>
                                 <font color='#5555FF'>+</font><font color='#5555FF'>+</font>size, exp_b10 <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

                              <font color='#009900'>/* Else lost a leading zero, so 'exp_b10' is
                               * still ok at (-1)
                               */</font>
                           <b>}</b>
                           <font color='#0000FF'>else</font>
                              <font color='#5555FF'>+</font><font color='#5555FF'>+</font>exp_b10;

                           <font color='#009900'>/* In all cases we output a '1' */</font>
                           d <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                        <b>}</b>
                     <b>}</b>
                  <b>}</b>
                  fp <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* Guarantees termination below. */</font>
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>d <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>+</font><font color='#5555FF'>+</font>czero;
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cdigits <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font><font color='#5555FF'>+</font>clead;
               <b>}</b>
               <font color='#0000FF'>else</font>
               <b>{</b>
                  <font color='#009900'>/* Included embedded zeros in the digit count. */</font>
                  cdigits <font color='#5555FF'>+</font><font color='#5555FF'>=</font> czero <font color='#5555FF'>-</font> clead;
                  clead <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>czero <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* exp_b10 == (-1) means we just output the decimal
                      * place - after the DP don't adjust 'exp_b10' any
                      * more!
                      */</font>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>46</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>size;
                        <font color='#009900'>/* PLUS 1: TOTAL 4 */</font>
                        <font color='#5555FF'>-</font><font color='#5555FF'>-</font>exp_b10;
                     <b>}</b>
                     <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>48</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>czero;
                  <b>}</b>

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>46</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>size; <font color='#009900'>/* counted
                                                                 above */</font>
                     <font color='#5555FF'>-</font><font color='#5555FF'>-</font>exp_b10;
                  <b>}</b>
                  <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>48</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>d<font face='Lucida Console'>)</font>, <font color='#5555FF'>+</font><font color='#5555FF'>+</font>cdigits;
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>cdigits<font color='#5555FF'>+</font>czero<font color='#5555FF'>-</font>clead <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>precision <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> fp <font color='#5555FF'>&gt;</font> DBL_MIN<font face='Lucida Console'>)</font>;

            <font color='#009900'>/* The total output count (max) is now 4+precision */</font>

            <font color='#009900'>/* Check for an exponent, if we don't need one we are
             * done and just need to terminate the string.  At
             * this point exp_b10==(-1) is effectively if flag - it got
             * to '-1' because of the decrement after outputing
             * the decimal point above (the exponent required is
             * *not* -1!)
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> exp_b10 <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* The following only happens if we didn't output the
                * leading zeros above for negative exponent, so this
                * doest add to the digit requirement.  Note that the
                * two zeros here can only be output if the two leading
                * zeros were *not* output, so this doesn't increase
                * the output count.
                */</font>
               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>exp_b10 <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>48</font>;

               <font color='#5555FF'>*</font>ascii <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

               <font color='#009900'>/* Total buffer requirement (including the '\0') is
                * 5+precision - see check at the start.
                */</font>
               <font color='#0000FF'>return</font>;
            <b>}</b>

            <font color='#009900'>/* Here if an exponent is required, adjust size for
             * the digits we output but did not count.  The total
             * digit output here so far is at most 1+precision - no
             * decimal point and no leading or trailing zeros have
             * been output.
             */</font>
            size <font color='#5555FF'>-</font><font color='#5555FF'>=</font> cdigits;

            <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>69</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>size;    <font color='#009900'>/* 'E': PLUS 1 TOTAL 2+precision */</font>

            <font color='#009900'>/* The following use of an unsigned temporary avoids ambiguities in
             * the signed arithmetic on exp_b10 and permits GCC at least to do
             * better optimization.
             */</font>
            <b>{</b>
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> uexp_b10;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>exp_b10 <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>45</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>size; <font color='#009900'>/* '-': PLUS 1 TOTAL 3+precision */</font>
                  uexp_b10 <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>exp_b10;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  uexp_b10 <font color='#5555FF'>=</font> exp_b10;

               cdigits <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>uexp_b10 <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  exponent[cdigits<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>48</font> <font color='#5555FF'>+</font> uexp_b10 <font color='#5555FF'>%</font> <font color='#979000'>10</font><font face='Lucida Console'>)</font>;
                  uexp_b10 <font color='#5555FF'>/</font><font color='#5555FF'>=</font> <font color='#979000'>10</font>;
               <b>}</b>
            <b>}</b>

            <font color='#009900'>/* Need another size check here for the exponent digits, so
             * this need not be considered above.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>size <font color='#5555FF'>&gt;</font> cdigits<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>cdigits <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> exponent[<font color='#5555FF'>-</font><font color='#5555FF'>-</font>cdigits];

               <font color='#5555FF'>*</font>ascii <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

               <font color='#0000FF'>return</font>;
            <b>}</b>
         <b>}</b>
      <b>}</b>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>fp <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> DBL_MIN<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>48</font>; <font color='#009900'>/* '0' */</font>
         <font color='#5555FF'>*</font>ascii <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>105</font>; <font color='#009900'>/* 'i' */</font>
         <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>110</font>; <font color='#009900'>/* 'n' */</font>
         <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>102</font>; <font color='#009900'>/* 'f' */</font>
         <font color='#5555FF'>*</font>ascii <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Here on buffer too small. */</font>
   <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>ASCII conversion buffer too small</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

#  endif <font color='#009900'>/* FLOATING_POINT */</font>

#  ifdef PNG_FIXED_POINT_SUPPORTED
<font color='#009900'>/* Function to format a fixed point value in ASCII.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_ascii_from_fixed</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_charp ascii,
    png_size_t size, png_fixed_point fp<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Require space for 10 decimal digits, a decimal point, a minus sign and a
    * trailing \0, 13 characters:
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>size <font color='#5555FF'>&gt;</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 num;

      <font color='#009900'>/* Avoid overflow here on the minimum integer. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>fp <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>45</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>size, num <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>fp;
      <font color='#0000FF'>else</font>
         num <font color='#5555FF'>=</font> fp;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0x80000000</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else overflowed */</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> ndigits <font color='#5555FF'>=</font> <font color='#979000'>0</font>, first <font color='#5555FF'>=</font> <font color='#979000'>16</font> <font color='#009900'>/* flag value */</font>;
         <font color='#0000FF'><u>char</u></font> digits[<font color='#979000'>10</font>];

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>num<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Split the low digit off num: */</font>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> num<font color='#5555FF'>/</font><font color='#979000'>10</font>;
            num <font color='#5555FF'>-</font><font color='#5555FF'>=</font> tmp<font color='#5555FF'>*</font><font color='#979000'>10</font>;
            digits[ndigits<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>48</font> <font color='#5555FF'>+</font> num<font face='Lucida Console'>)</font>;
            <font color='#009900'>/* Record the first non-zero digit, note that this is a number
             * starting at 1, it's not actually the array index.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>first <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> num <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               first <font color='#5555FF'>=</font> ndigits;
            num <font color='#5555FF'>=</font> tmp;
         <b>}</b>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ndigits <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>ndigits <font color='#5555FF'>&gt;</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> digits[<font color='#5555FF'>-</font><font color='#5555FF'>-</font>ndigits];
            <font color='#009900'>/* The remaining digits are fractional digits, ndigits is '5' or
             * smaller at this point.  It is certainly not zero.  Check for a
             * non-zero fractional digit:
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>first <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;
               <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>46</font>; <font color='#009900'>/* decimal point */</font>
               <font color='#009900'>/* ndigits may be &lt;5 for small numbers, output leading zeros
                * then ndigits digits to first:
                */</font>
               i <font color='#5555FF'>=</font> <font color='#979000'>5</font>;
               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>ndigits <font color='#5555FF'>&lt;</font> i<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>48</font>, <font color='#5555FF'>-</font><font color='#5555FF'>-</font>i;
               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>ndigits <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> first<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> digits[<font color='#5555FF'>-</font><font color='#5555FF'>-</font>ndigits];
               <font color='#009900'>/* Don't output the trailing zeros! */</font>
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>else</font>
            <font color='#5555FF'>*</font>ascii<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#979000'>48</font>;

         <font color='#009900'>/* And null terminate the string: */</font>
         <font color='#5555FF'>*</font>ascii <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#0000FF'>return</font>;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Here on buffer too small. */</font>
   <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>ASCII conversion buffer too small</font>"<font face='Lucida Console'>)</font>;
<b>}</b>
#   endif <font color='#009900'>/* FIXED_POINT */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_SCAL */</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_FLOATING_POINT_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
   <font color='#5555FF'>!</font><font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_FIXED_POINT_MACRO_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
   <font face='Lucida Console'>(</font><font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_gAMA_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_cHRM_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_sCAL_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_RGB_TO_GRAY_SUPPORTED<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font face='Lucida Console'>(</font><font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_sCAL_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_FLOATING_ARITHMETIC_SUPPORTED<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
png_fixed_point
<font color='#BB00BB'>png_fixed</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, <font color='#0000FF'><u>double</u></font> fp, png_const_charp text<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font><font color='#979000'>100000</font> <font color='#5555FF'>*</font> fp <font color='#5555FF'>+</font> .<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&gt;</font> <font color='#979000'>2147483647.</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> r <font color='#5555FF'>&lt;</font> <font color='#5555FF'>-</font><font color='#979000'>2147483648.</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_fixed_error</font><font face='Lucida Console'>(</font>png_ptr, text<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>r;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_GAMMA_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
    <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_INCH_CONVERSIONS_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_pHYs_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* muldiv functions */</font>
<font color='#009900'>/* This API takes signed arguments and rounds the result to the nearest
 * integer (or, for a fixed point number - the standard argument - to
 * the nearest .00001).  Overflow and divide by zero are signalled in
 * the result, a boolean - true on success, false on overflow.
 */</font>
<font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font>png_fixed_point_p res, png_fixed_point a, png_int_32 times,
    png_int_32 divisor<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Return a * times / divisor, rounded. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>divisor <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> times <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>res <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
      <b>}</b>
      <font color='#0000FF'>else</font>
      <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_FLOATING_ARITHMETIC_SUPPORTED
         <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> a;
         r <font color='#5555FF'>*</font><font color='#5555FF'>=</font> times;
         r <font color='#5555FF'>/</font><font color='#5555FF'>=</font> divisor;
         r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font>r<font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

         <font color='#009900'>/* A png_fixed_point is a 32-bit integer. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2147483647.</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>2147483648.</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font>res <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>r;
            <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
         <b>}</b>
<font color='#0000FF'>#else</font>
         <font color='#0000FF'><u>int</u></font> negative <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         png_uint_32 A, T, D;
         png_uint_32 s16, s32, s00;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            negative <font color='#5555FF'>=</font> <font color='#979000'>1</font>, A <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>a;
         <font color='#0000FF'>else</font>
            A <font color='#5555FF'>=</font> a;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>times <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            negative <font color='#5555FF'>=</font> <font color='#5555FF'>!</font>negative, T <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>times;
         <font color='#0000FF'>else</font>
            T <font color='#5555FF'>=</font> times;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>divisor <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            negative <font color='#5555FF'>=</font> <font color='#5555FF'>!</font>negative, D <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>divisor;
         <font color='#0000FF'>else</font>
            D <font color='#5555FF'>=</font> divisor;

         <font color='#009900'>/* Following can't overflow because the arguments only
          * have 31 bits each, however the result may be 32 bits.
          */</font>
         s16 <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>A <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                           <font face='Lucida Console'>(</font>A <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font>T <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
         <font color='#009900'>/* Can't overflow because the a*times bit is only 30
          * bits at most.
          */</font>
         s32 <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>A <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font>T <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>s16 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
         s00 <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>A <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font>T <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font>;

         s16 <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>s16 <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>16</font>;
         s00 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s16;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s00 <font color='#5555FF'>&lt;</font> s16<font face='Lucida Console'>)</font>
            <font color='#5555FF'>+</font><font color='#5555FF'>+</font>s32; <font color='#009900'>/* carry */</font>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s32 <font color='#5555FF'>&lt;</font> D<font face='Lucida Console'>)</font> <font color='#009900'>/* else overflow */</font>
         <b>{</b>
            <font color='#009900'>/* s32.s00 is now the 64-bit product, do a standard
             * division, we know that s32 &lt; D, so the maximum
             * required shift is 31.
             */</font>
            <font color='#0000FF'><u>int</u></font> bitshift <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
            png_fixed_point result <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* NOTE: signed */</font>

            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>bitshift <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_uint_32 d32, d00;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bitshift <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  d32 <font color='#5555FF'>=</font> D <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>32</font><font color='#5555FF'>-</font>bitshift<font face='Lucida Console'>)</font>, d00 <font color='#5555FF'>=</font> D <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> bitshift;

               <font color='#0000FF'>else</font>
                  d32 <font color='#5555FF'>=</font> <font color='#979000'>0</font>, d00 <font color='#5555FF'>=</font> D;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s32 <font color='#5555FF'>&gt;</font> d32<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s00 <font color='#5555FF'>&lt;</font> d00<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font><font color='#5555FF'>-</font>s32; <font color='#009900'>/* carry */</font>
                  s32 <font color='#5555FF'>-</font><font color='#5555FF'>=</font> d32, s00 <font color='#5555FF'>-</font><font color='#5555FF'>=</font> d00, result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>bitshift;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s32 <font color='#5555FF'>=</font><font color='#5555FF'>=</font> d32 <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s00 <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> d00<font face='Lucida Console'>)</font>
                     s32 <font color='#5555FF'>=</font> <font color='#979000'>0</font>, s00 <font color='#5555FF'>-</font><font color='#5555FF'>=</font> d00, result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>bitshift;
            <b>}</b>

            <font color='#009900'>/* Handle the rounding. */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s00 <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>D <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <font color='#5555FF'>+</font><font color='#5555FF'>+</font>result;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>negative<font face='Lucida Console'>)</font>
               result <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>result;

            <font color='#009900'>/* Check for overflow. */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>negative <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> result <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>negative <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> result <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font>res <font color='#5555FF'>=</font> result;
               <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
            <b>}</b>
         <b>}</b>
<font color='#0000FF'>#endif</font>
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_GAMMA || INCH_CONVERSIONS */</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_GAMMA_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_INCH_CONVERSIONS_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* The following is for when the caller doesn't much care about the
 * result.
 */</font>
png_fixed_point
<font color='#BB00BB'>png_muldiv_warn</font><font face='Lucida Console'>(</font>png_const_structrp png_ptr, png_fixed_point a, png_int_32 times,
    png_int_32 divisor<font face='Lucida Console'>)</font>
<b>{</b>
   png_fixed_point result;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>result, a, times, divisor<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> result;

   <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>fixed point overflow ignored</font>"<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_GAMMA_SUPPORTED <font color='#009900'>/* more fixed point functions for gamma */</font>
<font color='#009900'>/* Calculate a reciprocal, return 0 on div-by-zero or overflow. */</font>
png_fixed_point
<font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_fixed_point a<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_FLOATING_ARITHMETIC_SUPPORTED
   <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font><font color='#979000'>1E10</font><font color='#5555FF'>/</font>a<font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2147483647.</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>2147483648.</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>r;
<font color='#0000FF'>#else</font>
   png_fixed_point res;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>res, <font color='#979000'>100000</font>, <font color='#979000'>100000</font>, a<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> res;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* error/overflow */</font>
<b>}</b>

<font color='#009900'>/* This is the shared test on whether a gamma value is 'significant' - whether
 * it is worth doing gamma correction.
 */</font>
<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>return</font> gamma_val <font color='#5555FF'>&lt;</font> PNG_FP_1 <font color='#5555FF'>-</font> PNG_GAMMA_THRESHOLD_FIXED <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       gamma_val <font color='#5555FF'>&gt;</font> PNG_FP_1 <font color='#5555FF'>+</font> PNG_GAMMA_THRESHOLD_FIXED;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
<font color='#009900'>/* A local convenience routine. */</font>
<font color='#0000FF'>static</font> png_fixed_point
<font color='#BB00BB'>png_product2</font><font face='Lucida Console'>(</font>png_fixed_point a, png_fixed_point b<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The required result is 1/a * 1/b; the following preserves accuracy. */</font>
<font color='#0000FF'>#ifdef</font> PNG_FLOATING_ARITHMETIC_SUPPORTED
   <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> a <font color='#5555FF'>*</font> <font color='#979000'>1E</font><font color='#5555FF'>-</font><font color='#979000'>5</font>;
   r <font color='#5555FF'>*</font><font color='#5555FF'>=</font> b;
   r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font>r<font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2147483647.</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>2147483648.</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>r;
<font color='#0000FF'>#else</font>
   png_fixed_point res;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>res, a, b, <font color='#979000'>100000</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> res;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* overflow */</font>
<b>}</b>

<font color='#009900'>/* The inverse of the above. */</font>
png_fixed_point
<font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_fixed_point a, png_fixed_point b<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The required result is 1/a * 1/b; the following preserves accuracy. */</font>
<font color='#0000FF'>#ifdef</font> PNG_FLOATING_ARITHMETIC_SUPPORTED
   <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> <font color='#979000'>1E15</font><font color='#5555FF'>/</font>a;
   r <font color='#5555FF'>/</font><font color='#5555FF'>=</font> b;
   r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font>r<font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2147483647.</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> r <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>2147483648.</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>r;
<font color='#0000FF'>#else</font>
   <font color='#009900'>/* This may overflow because the range of png_fixed_point isn't symmetric,
    * but this API is only used for the product of file and screen gamma so it
    * doesn't matter that the smallest number it can produce is 1/21474, not
    * 1/100000
    */</font>
   png_fixed_point res <font color='#5555FF'>=</font> <font color='#BB00BB'>png_product2</font><font face='Lucida Console'>(</font>a, b<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>res <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>res<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* overflow */</font>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_GAMMA */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED <font color='#009900'>/* gamma table code */</font>
<font color='#0000FF'>#ifndef</font> PNG_FLOATING_ARITHMETIC_SUPPORTED
<font color='#009900'>/* Fixed point gamma.
 *
 * The code to calculate the tables used below can be found in the shell script
 * contrib/tools/intgamma.sh
 *
 * To calculate gamma this code implements fast log() and exp() calls using only
 * fixed point arithmetic.  This code has sufficient precision for either 8-bit
 * or 16-bit sample values.
 *
 * The tables used here were calculated using simple 'bc' programs, but C double
 * precision floating point arithmetic would work fine.
 *
 * 8-bit log table
 *   This is a table of -log(value/255)/log(2) for 'value' in the range 128 to
 *   255, so it's the base 2 logarithm of a normalized 8-bit floating point
 *   mantissa.  The numbers are 32-bit fractions.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'>const</font> png_uint_32
png_8bit_l2[<font color='#979000'>128</font>] <font color='#5555FF'>=</font>
<b>{</b>
   <font color='#979000'>4270715492</font>U, <font color='#979000'>4222494797</font>U, <font color='#979000'>4174646467</font>U, <font color='#979000'>4127164793</font>U, <font color='#979000'>4080044201</font>U, <font color='#979000'>4033279239</font>U,
   <font color='#979000'>3986864580</font>U, <font color='#979000'>3940795015</font>U, <font color='#979000'>3895065449</font>U, <font color='#979000'>3849670902</font>U, <font color='#979000'>3804606499</font>U, <font color='#979000'>3759867474</font>U,
   <font color='#979000'>3715449162</font>U, <font color='#979000'>3671346997</font>U, <font color='#979000'>3627556511</font>U, <font color='#979000'>3584073329</font>U, <font color='#979000'>3540893168</font>U, <font color='#979000'>3498011834</font>U,
   <font color='#979000'>3455425220</font>U, <font color='#979000'>3413129301</font>U, <font color='#979000'>3371120137</font>U, <font color='#979000'>3329393864</font>U, <font color='#979000'>3287946700</font>U, <font color='#979000'>3246774933</font>U,
   <font color='#979000'>3205874930</font>U, <font color='#979000'>3165243125</font>U, <font color='#979000'>3124876025</font>U, <font color='#979000'>3084770202</font>U, <font color='#979000'>3044922296</font>U, <font color='#979000'>3005329011</font>U,
   <font color='#979000'>2965987113</font>U, <font color='#979000'>2926893432</font>U, <font color='#979000'>2888044853</font>U, <font color='#979000'>2849438323</font>U, <font color='#979000'>2811070844</font>U, <font color='#979000'>2772939474</font>U,
   <font color='#979000'>2735041326</font>U, <font color='#979000'>2697373562</font>U, <font color='#979000'>2659933400</font>U, <font color='#979000'>2622718104</font>U, <font color='#979000'>2585724991</font>U, <font color='#979000'>2548951424</font>U,
   <font color='#979000'>2512394810</font>U, <font color='#979000'>2476052606</font>U, <font color='#979000'>2439922311</font>U, <font color='#979000'>2404001468</font>U, <font color='#979000'>2368287663</font>U, <font color='#979000'>2332778523</font>U,
   <font color='#979000'>2297471715</font>U, <font color='#979000'>2262364947</font>U, <font color='#979000'>2227455964</font>U, <font color='#979000'>2192742551</font>U, <font color='#979000'>2158222529</font>U, <font color='#979000'>2123893754</font>U,
   <font color='#979000'>2089754119</font>U, <font color='#979000'>2055801552</font>U, <font color='#979000'>2022034013</font>U, <font color='#979000'>1988449497</font>U, <font color='#979000'>1955046031</font>U, <font color='#979000'>1921821672</font>U,
   <font color='#979000'>1888774511</font>U, <font color='#979000'>1855902668</font>U, <font color='#979000'>1823204291</font>U, <font color='#979000'>1790677560</font>U, <font color='#979000'>1758320682</font>U, <font color='#979000'>1726131893</font>U,
   <font color='#979000'>1694109454</font>U, <font color='#979000'>1662251657</font>U, <font color='#979000'>1630556815</font>U, <font color='#979000'>1599023271</font>U, <font color='#979000'>1567649391</font>U, <font color='#979000'>1536433567</font>U,
   <font color='#979000'>1505374214</font>U, <font color='#979000'>1474469770</font>U, <font color='#979000'>1443718700</font>U, <font color='#979000'>1413119487</font>U, <font color='#979000'>1382670639</font>U, <font color='#979000'>1352370686</font>U,
   <font color='#979000'>1322218179</font>U, <font color='#979000'>1292211689</font>U, <font color='#979000'>1262349810</font>U, <font color='#979000'>1232631153</font>U, <font color='#979000'>1203054352</font>U, <font color='#979000'>1173618059</font>U,
   <font color='#979000'>1144320946</font>U, <font color='#979000'>1115161701</font>U, <font color='#979000'>1086139034</font>U, <font color='#979000'>1057251672</font>U, <font color='#979000'>1028498358</font>U, <font color='#979000'>999877854</font>U,
   <font color='#979000'>971388940</font>U, <font color='#979000'>943030410</font>U, <font color='#979000'>914801076</font>U, <font color='#979000'>886699767</font>U, <font color='#979000'>858725327</font>U, <font color='#979000'>830876614</font>U,
   <font color='#979000'>803152505</font>U, <font color='#979000'>775551890</font>U, <font color='#979000'>748073672</font>U, <font color='#979000'>720716771</font>U, <font color='#979000'>693480120</font>U, <font color='#979000'>666362667</font>U,
   <font color='#979000'>639363374</font>U, <font color='#979000'>612481215</font>U, <font color='#979000'>585715177</font>U, <font color='#979000'>559064263</font>U, <font color='#979000'>532527486</font>U, <font color='#979000'>506103872</font>U,
   <font color='#979000'>479792461</font>U, <font color='#979000'>453592303</font>U, <font color='#979000'>427502463</font>U, <font color='#979000'>401522014</font>U, <font color='#979000'>375650043</font>U, <font color='#979000'>349885648</font>U,
   <font color='#979000'>324227938</font>U, <font color='#979000'>298676034</font>U, <font color='#979000'>273229066</font>U, <font color='#979000'>247886176</font>U, <font color='#979000'>222646516</font>U, <font color='#979000'>197509248</font>U,
   <font color='#979000'>172473545</font>U, <font color='#979000'>147538590</font>U, <font color='#979000'>122703574</font>U, <font color='#979000'>97967701</font>U, <font color='#979000'>73330182</font>U, <font color='#979000'>48790236</font>U,
   <font color='#979000'>24347096</font>U, <font color='#979000'>0</font>U

<font color='#0000FF'>#if</font> <font color='#979000'>0</font>
   <font color='#009900'>/* The following are the values for 16-bit tables - these work fine for the
    * 8-bit conversions but produce very slightly larger errors in the 16-bit
    * log (about 1.2 as opposed to 0.7 absolute error in the final value).  To
    * use these all the shifts below must be adjusted appropriately.
    */</font>
   <font color='#979000'>65166</font>, <font color='#979000'>64430</font>, <font color='#979000'>63700</font>, <font color='#979000'>62976</font>, <font color='#979000'>62257</font>, <font color='#979000'>61543</font>, <font color='#979000'>60835</font>, <font color='#979000'>60132</font>, <font color='#979000'>59434</font>, <font color='#979000'>58741</font>, <font color='#979000'>58054</font>,
   <font color='#979000'>57371</font>, <font color='#979000'>56693</font>, <font color='#979000'>56020</font>, <font color='#979000'>55352</font>, <font color='#979000'>54689</font>, <font color='#979000'>54030</font>, <font color='#979000'>53375</font>, <font color='#979000'>52726</font>, <font color='#979000'>52080</font>, <font color='#979000'>51439</font>, <font color='#979000'>50803</font>,
   <font color='#979000'>50170</font>, <font color='#979000'>49542</font>, <font color='#979000'>48918</font>, <font color='#979000'>48298</font>, <font color='#979000'>47682</font>, <font color='#979000'>47070</font>, <font color='#979000'>46462</font>, <font color='#979000'>45858</font>, <font color='#979000'>45257</font>, <font color='#979000'>44661</font>, <font color='#979000'>44068</font>,
   <font color='#979000'>43479</font>, <font color='#979000'>42894</font>, <font color='#979000'>42312</font>, <font color='#979000'>41733</font>, <font color='#979000'>41159</font>, <font color='#979000'>40587</font>, <font color='#979000'>40020</font>, <font color='#979000'>39455</font>, <font color='#979000'>38894</font>, <font color='#979000'>38336</font>, <font color='#979000'>37782</font>,
   <font color='#979000'>37230</font>, <font color='#979000'>36682</font>, <font color='#979000'>36137</font>, <font color='#979000'>35595</font>, <font color='#979000'>35057</font>, <font color='#979000'>34521</font>, <font color='#979000'>33988</font>, <font color='#979000'>33459</font>, <font color='#979000'>32932</font>, <font color='#979000'>32408</font>, <font color='#979000'>31887</font>,
   <font color='#979000'>31369</font>, <font color='#979000'>30854</font>, <font color='#979000'>30341</font>, <font color='#979000'>29832</font>, <font color='#979000'>29325</font>, <font color='#979000'>28820</font>, <font color='#979000'>28319</font>, <font color='#979000'>27820</font>, <font color='#979000'>27324</font>, <font color='#979000'>26830</font>, <font color='#979000'>26339</font>,
   <font color='#979000'>25850</font>, <font color='#979000'>25364</font>, <font color='#979000'>24880</font>, <font color='#979000'>24399</font>, <font color='#979000'>23920</font>, <font color='#979000'>23444</font>, <font color='#979000'>22970</font>, <font color='#979000'>22499</font>, <font color='#979000'>22029</font>, <font color='#979000'>21562</font>, <font color='#979000'>21098</font>,
   <font color='#979000'>20636</font>, <font color='#979000'>20175</font>, <font color='#979000'>19718</font>, <font color='#979000'>19262</font>, <font color='#979000'>18808</font>, <font color='#979000'>18357</font>, <font color='#979000'>17908</font>, <font color='#979000'>17461</font>, <font color='#979000'>17016</font>, <font color='#979000'>16573</font>, <font color='#979000'>16132</font>,
   <font color='#979000'>15694</font>, <font color='#979000'>15257</font>, <font color='#979000'>14822</font>, <font color='#979000'>14390</font>, <font color='#979000'>13959</font>, <font color='#979000'>13530</font>, <font color='#979000'>13103</font>, <font color='#979000'>12678</font>, <font color='#979000'>12255</font>, <font color='#979000'>11834</font>, <font color='#979000'>11415</font>,
   <font color='#979000'>10997</font>, <font color='#979000'>10582</font>, <font color='#979000'>10168</font>, <font color='#979000'>9756</font>, <font color='#979000'>9346</font>, <font color='#979000'>8937</font>, <font color='#979000'>8531</font>, <font color='#979000'>8126</font>, <font color='#979000'>7723</font>, <font color='#979000'>7321</font>, <font color='#979000'>6921</font>, <font color='#979000'>6523</font>,
   <font color='#979000'>6127</font>, <font color='#979000'>5732</font>, <font color='#979000'>5339</font>, <font color='#979000'>4947</font>, <font color='#979000'>4557</font>, <font color='#979000'>4169</font>, <font color='#979000'>3782</font>, <font color='#979000'>3397</font>, <font color='#979000'>3014</font>, <font color='#979000'>2632</font>, <font color='#979000'>2251</font>, <font color='#979000'>1872</font>, <font color='#979000'>1495</font>,
   <font color='#979000'>1119</font>, <font color='#979000'>744</font>, <font color='#979000'>372</font>
<font color='#0000FF'>#endif</font>
<b>}</b>;

<font color='#0000FF'>static</font> png_int_32
<font color='#BB00BB'>png_log8bit</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> x<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> lg2 <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#009900'>/* Each time 'x' is multiplied by 2, 1 must be subtracted off the final log,
    * because the log is actually negate that means adding 1.  The final
    * returned value thus has the range 0 (for 255 input) to 7.994 (for 1
    * input), return -1 for the overflow (log 0) case, - so the result is
    * always at most 19 bits.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0xf0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2  <font color='#5555FF'>=</font> <font color='#979000'>4</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0xc0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x80</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* result is at most 19 bits, so this cast is safe: */</font>
   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_int_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>lg2 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_8bit_l2[x<font color='#5555FF'>-</font><font color='#979000'>128</font>]<font color='#5555FF'>+</font><font color='#979000'>32768</font><font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>16</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* The above gives exact (to 16 binary places) log2 values for 8-bit images,
 * for 16-bit images we use the most significant 8 bits of the 16-bit value to
 * get an approximation then multiply the approximation by a correction factor
 * determined by the remaining up to 8 bits.  This requires an additional step
 * in the 16-bit case.
 *
 * We want log2(value/65535), we have log2(v'/255), where:
 *
 *    value = v' * 256 + v''
 *          = v' * f
 *
 * So f is value/v', which is equal to (256+v''/v') since v' is in the range 128
 * to 255 and v'' is in the range 0 to 255 f will be in the range 256 to less
 * than 258.  The final factor also needs to correct for the fact that our 8-bit
 * value is scaled by 255, whereas the 16-bit values must be scaled by 65535.
 *
 * This gives a final formula using a calculated value 'x' which is value/v' and
 * scaling by 65536 to match the above table:
 *
 *   log2(x/257) * 65536
 *
 * Since these numbers are so close to '1' we can use simple linear
 * interpolation between the two end values 256/257 (result -368.61) and 258/257
 * (result 367.179).  The values used below are scaled by a further 64 to give
 * 16-bit precision in the interpolation:
 *
 * Start (256): -23591
 * Zero  (257):      0
 * End   (258):  23499
 */</font>
<font color='#0000FF'>static</font> png_int_32
<font color='#BB00BB'>png_log16bit</font><font face='Lucida Console'>(</font>png_uint_32 x<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> lg2 <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* As above, but now the input has 16 bits. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff00</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2  <font color='#5555FF'>=</font> <font color='#979000'>8</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0xf000</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0xc000</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x8000</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>, x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#009900'>/* Calculate the base logarithm from the top 8 bits as a 28-bit fractional
    * value.
    */</font>
   lg2 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>28</font>;
   lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_8bit_l2[<font face='Lucida Console'>(</font>x<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>128</font>]<font color='#5555FF'>+</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>4</font>;

   <font color='#009900'>/* Now we need to interpolate the factor, this requires a division by the top
    * 8 bits.  Do this with maximum precision.
    */</font>
   x <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>9</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Since we divided by the top 8 bits of 'x' there will be a '1' at 1&lt;&lt;24,
    * the value at 1&lt;&lt;16 (ignoring this) will be 0 or 1; this gives us exactly
    * 16 bits to interpolate to get the low bits of the result.  Round the
    * answer.  Note that the end point values are scaled by 64 to retain overall
    * precision and that 'lg2' is current scaled by an extra 12 bits, so adjust
    * the overall scaling by 6-12.  Round at every step.
    */</font>
   x <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>24</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>65536</font>U<font face='Lucida Console'>)</font> <font color='#009900'>/* &lt;= '257' */</font>
      lg2 <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>23591</font>U <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#979000'>65536</font>U<font color='#5555FF'>-</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font><font color='#5555FF'>+</font><font color='#979000'>6</font><font color='#5555FF'>-</font><font color='#979000'>12</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font><font color='#5555FF'>+</font><font color='#979000'>6</font><font color='#5555FF'>-</font><font color='#979000'>12</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font>
      lg2 <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>23499</font>U <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font>x<font color='#5555FF'>-</font><font color='#979000'>65536</font>U<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font><font color='#5555FF'>+</font><font color='#979000'>6</font><font color='#5555FF'>-</font><font color='#979000'>12</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font><font color='#5555FF'>+</font><font color='#979000'>6</font><font color='#5555FF'>-</font><font color='#979000'>12</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Safe, because the result can't have more than 20 bits: */</font>
   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_int_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>lg2 <font color='#5555FF'>+</font> <font color='#979000'>2048</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* The 'exp()' case must invert the above, taking a 20-bit fixed point
 * logarithmic value and returning a 16 or 8-bit number as appropriate.  In
 * each case only the low 16 bits are relevant - the fraction - since the
 * integer bits (the top 4) simply determine a shift.
 *
 * The worst case is the 16-bit distinction between 65535 and 65534, this
 * requires perhaps spurious accuracty in the decoding of the logarithm to
 * distinguish log2(65535/65534.5) - 10^-5 or 17 bits.  There is little chance
 * of getting this accuracy in practice.
 *
 * To deal with this the following exp() function works out the exponent of the
 * frational part of the logarithm by using an accurate 32-bit value from the
 * top four fractional bits then multiplying in the remaining bits.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'>const</font> png_uint_32
png_32bit_exp[<font color='#979000'>16</font>] <font color='#5555FF'>=</font>
<b>{</b>
   <font color='#009900'>/* NOTE: the first entry is deliberately set to the maximum 32-bit value. */</font>
   <font color='#979000'>4294967295</font>U, <font color='#979000'>4112874773</font>U, <font color='#979000'>3938502376</font>U, <font color='#979000'>3771522796</font>U, <font color='#979000'>3611622603</font>U, <font color='#979000'>3458501653</font>U,
   <font color='#979000'>3311872529</font>U, <font color='#979000'>3171459999</font>U, <font color='#979000'>3037000500</font>U, <font color='#979000'>2908241642</font>U, <font color='#979000'>2784941738</font>U, <font color='#979000'>2666869345</font>U,
   <font color='#979000'>2553802834</font>U, <font color='#979000'>2445529972</font>U, <font color='#979000'>2341847524</font>U, <font color='#979000'>2242560872</font>U
<b>}</b>;

<font color='#009900'>/* Adjustment table; provided to explain the numbers in the code below. */</font>
<font color='#0000FF'>#if</font> <font color='#979000'>0</font>
<font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>11</font>;i<font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font><font color='#979000'>0</font>;<font color='#5555FF'>-</font><font color='#5555FF'>-</font>i<font face='Lucida Console'>)</font><b>{</b> print i, "<font color='#CC0000'> </font>", <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> <font color='#BB00BB'>e</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font face='Lucida Console'>(</font><font color='#979000'>2</font>^i<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>65536</font><font color='#5555FF'>*</font><font color='#BB00BB'>l</font><font face='Lucida Console'>(</font><font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>2</font>^<font face='Lucida Console'>(</font><font color='#979000'>32</font><font color='#5555FF'>-</font>i<font face='Lucida Console'>)</font>, "<font color='#CC0000'>\n</font>"<b>}</b>
   <font color='#979000'>11</font> <font color='#979000'>44937.64284865548751208448</font>
   <font color='#979000'>10</font> <font color='#979000'>45180.98734845585101160448</font>
    <font color='#979000'>9</font> <font color='#979000'>45303.31936980687359311872</font>
    <font color='#979000'>8</font> <font color='#979000'>45364.65110595323018870784</font>
    <font color='#979000'>7</font> <font color='#979000'>45395.35850361789624614912</font>
    <font color='#979000'>6</font> <font color='#979000'>45410.72259715102037508096</font>
    <font color='#979000'>5</font> <font color='#979000'>45418.40724413220722311168</font>
    <font color='#979000'>4</font> <font color='#979000'>45422.25021786898173001728</font>
    <font color='#979000'>3</font> <font color='#979000'>45424.17186732298419044352</font>
    <font color='#979000'>2</font> <font color='#979000'>45425.13273269940811464704</font>
    <font color='#979000'>1</font> <font color='#979000'>45425.61317555035558641664</font>
    <font color='#979000'>0</font> <font color='#979000'>45425.85339951654943850496</font>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>static</font> png_uint_32
<font color='#BB00BB'>png_exp</font><font face='Lucida Console'>(</font>png_fixed_point x<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> x <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0xfffff</font><font face='Lucida Console'>)</font> <font color='#009900'>/* Else overflow or zero (underflow) */</font>
   <b>{</b>
      <font color='#009900'>/* Obtain a 4-bit approximation */</font>
      png_uint_32 e <font color='#5555FF'>=</font> png_32bit_exp[<font face='Lucida Console'>(</font>x <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xf</font>];

      <font color='#009900'>/* Incorporate the low 12 bits - these decrease the returned value by
       * multiplying by a number less than 1 if the bit is set.  The multiplier
       * is determined by the above table and the shift. Notice that the values
       * converge on 45426 and this is used to allow linear interpolation of the
       * low bits.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x800</font><font face='Lucida Console'>)</font>
         e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>44938</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>  <font color='#979000'>16</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>5</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x400</font><font face='Lucida Console'>)</font>
         e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>45181</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>  <font color='#979000'>32</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>6</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x200</font><font face='Lucida Console'>)</font>
         e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>45303</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>  <font color='#979000'>64</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>7</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x100</font><font face='Lucida Console'>)</font>
         e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>45365</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>128</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x080</font><font face='Lucida Console'>)</font>
         e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>45395</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>256</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>9</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x040</font><font face='Lucida Console'>)</font>
         e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>45410</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>512</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>10</font>;

      <font color='#009900'>/* And handle the low 6 bits in a single block. */</font>
      e <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>355</font>U <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&amp;</font> <font color='#979000'>0x3fU</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>256</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>9</font>;

      <font color='#009900'>/* Handle the upper bits of x. */</font>
      e <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> x <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font>;
      <font color='#0000FF'>return</font> e;
   <b>}</b>

   <font color='#009900'>/* Check for overflow */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>x <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> png_32bit_exp[<font color='#979000'>0</font>];

   <font color='#009900'>/* Else underflow */</font>
   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#0000FF'>static</font> png_byte
<font color='#BB00BB'>png_exp8bit</font><font face='Lucida Console'>(</font>png_fixed_point lg2<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Get a 32-bit value: */</font>
   png_uint_32 x <font color='#5555FF'>=</font> <font color='#BB00BB'>png_exp</font><font face='Lucida Console'>(</font>lg2<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Convert the 32-bit value to 0..255 by multiplying by 256-1, note that the
    * second, rounding, step can't overflow because of the first, subtraction,
    * step.
    */</font>
   x <font color='#5555FF'>-</font><font color='#5555FF'>=</font> x <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>;
   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>+</font> <font color='#979000'>0x7fffffU</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>static</font> png_uint_16
<font color='#BB00BB'>png_exp16bit</font><font face='Lucida Console'>(</font>png_fixed_point lg2<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Get a 32-bit value: */</font>
   png_uint_32 x <font color='#5555FF'>=</font> <font color='#BB00BB'>png_exp</font><font face='Lucida Console'>(</font>lg2<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Convert the 32-bit value to 0..65535 by multiplying by 65536-1: */</font>
   x <font color='#5555FF'>-</font><font color='#5555FF'>=</font> x <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font>;
   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>x <font color='#5555FF'>+</font> <font color='#979000'>32767</font>U<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* FLOATING_ARITHMETIC */</font>

png_byte
<font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> value, png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> value <font color='#5555FF'>&lt;</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>
   <b>{</b>
#     ifdef PNG_FLOATING_ARITHMETIC_SUPPORTED
         <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>*</font><font color='#BB00BB'>pow</font><font face='Lucida Console'>(</font>value<font color='#5555FF'>/</font><font color='#979000'>255.</font>,gamma_val<font color='#5555FF'>*</font>.<font color='#979000'>00001</font><font face='Lucida Console'>)</font><font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>r;
#     <font color='#0000FF'>else</font>
         png_int_32 lg2 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_log8bit</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>;
         png_fixed_point res;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>res, gamma_val, lg2, PNG_FP_1<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_exp8bit</font><font face='Lucida Console'>(</font>res<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Overflow. */</font>
         value <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#     endif
   <b>}</b>

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>value;
<b>}</b>

png_uint_16
<font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> value, png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> value <font color='#5555FF'>&lt;</font> <font color='#979000'>65535</font><font face='Lucida Console'>)</font>
   <b>{</b>
#     ifdef PNG_FLOATING_ARITHMETIC_SUPPORTED
         <font color='#0000FF'><u>double</u></font> r <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font><font color='#979000'>65535</font><font color='#5555FF'>*</font><font color='#BB00BB'>pow</font><font face='Lucida Console'>(</font>value<font color='#5555FF'>/</font><font color='#979000'>65535.</font>,gamma_val<font color='#5555FF'>*</font>.<font color='#979000'>00001</font><font face='Lucida Console'>)</font><font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;
         <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>r;
#     <font color='#0000FF'>else</font>
         png_int_32 lg2 <font color='#5555FF'>=</font> <font color='#BB00BB'>png_log16bit</font><font face='Lucida Console'>(</font>value<font face='Lucida Console'>)</font>;
         png_fixed_point res;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>res, gamma_val, lg2, PNG_FP_1<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_exp16bit</font><font face='Lucida Console'>(</font>res<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Overflow. */</font>
         value <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#     endif
   <b>}</b>

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>value;
<b>}</b>

<font color='#009900'>/* This does the right thing based on the bit_depth field of the
 * png_struct, interpreting values as 8-bit or 16-bit.  While the result
 * is nominally a 16-bit value if bit depth is 8 then the result is
 * 8-bit (as are the arguments.)
 */</font>
png_uint_16 <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> value,
    png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>value, gamma_val<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>value, gamma_val<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Internal function to build a single 16-bit table - the table consists of
 * 'num' 256 entry subtables, where 'num' is determined by 'shift' - the amount
 * to shift the input values right (or 16-number_of_signifiant_bits).
 *
 * The caller is responsible for ensuring that the table gets cleaned up on
 * png_error (i.e. if one of the mallocs below fails) - i.e. the *table argument
 * should be somewhere that will be cleaned.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<font color='#BB00BB'>png_build_16bit_table</font><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_16pp <font color='#5555FF'>*</font>ptable,
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> shift, PNG_CONST png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Various values derived from 'shift': */</font>
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> num <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font>U <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font>;
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> max <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font>U <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font>U;
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> max_by_2 <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>15</font>U<font color='#5555FF'>-</font>shift<font face='Lucida Console'>)</font>;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;

   png_uint_16pp table <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>ptable <font color='#5555FF'>=</font>
       <font face='Lucida Console'>(</font>png_uint_16pp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_calloc</font><font face='Lucida Console'>(</font>png_ptr, num <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16p<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_16p sub_table <font color='#5555FF'>=</font> table[i] <font color='#5555FF'>=</font>
          <font face='Lucida Console'>(</font>png_uint_16p<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>256</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      <font color='#009900'>/* The 'threshold' test is repeated here because it can arise for one of
       * the 16-bit tables even if the others don't hit it.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gamma_val<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* The old code would overflow at the end and this would cause the
          * 'pow' function to return a result &gt;1, resulting in an
          * arithmetic error.  This code follows the spec exactly; ig is
          * the recovered input sample, it always has 8-16 bits.
          *
          * We want input * 65535/max, rounded, the arithmetic fits in 32
          * bits (unsigned) so long as max &lt;= 32767.
          */</font>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> j;
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> <font color='#979000'>256</font>; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_uint_32 ig <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font><font color='#5555FF'>-</font>shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> i;
#           ifdef PNG_FLOATING_ARITHMETIC_SUPPORTED
               <font color='#009900'>/* Inline the 'max' scaling operation: */</font>
               <font color='#0000FF'><u>double</u></font> d <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font><font color='#979000'>65535</font><font color='#5555FF'>*</font><font color='#BB00BB'>pow</font><font face='Lucida Console'>(</font>ig<font color='#5555FF'>/</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>double</u></font><font face='Lucida Console'>)</font>max, gamma_val<font color='#5555FF'>*</font>.<font color='#979000'>00001</font><font face='Lucida Console'>)</font><font color='#5555FF'>+</font>.<font color='#979000'>5</font><font face='Lucida Console'>)</font>;
               sub_table[j] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>d;
#           <font color='#0000FF'>else</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift<font face='Lucida Console'>)</font>
                  ig <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ig <font color='#5555FF'>*</font> <font color='#979000'>65535</font>U <font color='#5555FF'>+</font> max_by_2<font face='Lucida Console'>)</font><font color='#5555FF'>/</font>max;

               sub_table[j] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>ig, gamma_val<font face='Lucida Console'>)</font>;
#           endif
         <b>}</b>
      <b>}</b>
      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* We must still build a table, but do it the fast way. */</font>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> j;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> <font color='#979000'>256</font>; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_uint_32 ig <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font><font color='#5555FF'>-</font>shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> i;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift<font face='Lucida Console'>)</font>
               ig <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ig <font color='#5555FF'>*</font> <font color='#979000'>65535</font>U <font color='#5555FF'>+</font> max_by_2<font face='Lucida Console'>)</font><font color='#5555FF'>/</font>max;

            sub_table[j] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>ig;
         <b>}</b>
      <b>}</b>
   <b>}</b>
<b>}</b>

<font color='#009900'>/* NOTE: this function expects the *inverse* of the overall gamma transformation
 * required.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<font color='#BB00BB'>png_build_16to8_table</font><font face='Lucida Console'>(</font>png_structrp png_ptr, png_uint_16pp <font color='#5555FF'>*</font>ptable,
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> shift, PNG_CONST png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> num <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font>U <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font>;
   PNG_CONST <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> max <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font>U <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font>U;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;
   png_uint_32 last;

   png_uint_16pp table <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>ptable <font color='#5555FF'>=</font>
       <font face='Lucida Console'>(</font>png_uint_16pp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_calloc</font><font face='Lucida Console'>(</font>png_ptr, num <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16p<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* 'num' is the number of tables and also the number of low bits of low
    * bits of the input 16-bit value used to select a table.  Each table is
    * itself index by the high 8 bits of the value.
    */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      table[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16p<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
          <font color='#979000'>256</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* 'gamma_val' is set to the reciprocal of the value calculated above, so
    * pow(out,g) is an *input* value.  'last' is the last input value set.
    *
    * In the loop 'i' is used to find output values.  Since the output is
    * 8-bit there are only 256 possible values.  The tables are set up to
    * select the closest possible output value for each input by finding
    * the input value at the boundary between each pair of output values
    * and filling the table up to that boundary with the lower output
    * value.
    *
    * The boundary values are 0.5,1.5..253.5,254.5.  Since these are 9-bit
    * values the code below uses a 16-bit value in i; the values start at
    * 128.5 (for 0.5) and step by 257, for a total of 254 values (the last
    * entries are filled with 255).  Start i at 128 and fill all 'last'
    * table entries &lt;= 'max'
    */</font>
   last <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> <font color='#979000'>255</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font> <font color='#009900'>/* 8-bit output value */</font>
   <b>{</b>
      <font color='#009900'>/* Find the corresponding maximum input value */</font>
      png_uint_16 out <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>i <font color='#5555FF'>*</font> <font color='#979000'>257</font>U<font face='Lucida Console'>)</font>; <font color='#009900'>/* 16-bit output value */</font>

      <font color='#009900'>/* Find the boundary value in 16 bits: */</font>
      png_uint_32 bound <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>out<font color='#5555FF'>+</font><font color='#979000'>128</font>U, gamma_val<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Adjust (round) to (16-shift) bits: */</font>
      bound <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bound <font color='#5555FF'>*</font> max <font color='#5555FF'>+</font> <font color='#979000'>32768</font>U<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>65535</font>U <font color='#5555FF'>+</font> <font color='#979000'>1</font>U;

      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>last <font color='#5555FF'>&lt;</font> bound<font face='Lucida Console'>)</font>
      <b>{</b>
         table[last <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0xffU</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font>][last <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font>U <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> out;
         last<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* And fill in the final entries. */</font>
   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>last <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>num <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      table[last <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0xff</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font>][last <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font>U <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> <font color='#979000'>65535</font>U;
      last<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Build a single 8-bit table: same as the 16-bit case but much simpler (and
 * typically much faster).  Note that libpng currently does no sBIT processing
 * (apparently contrary to the spec) so a 256 entry table is always generated.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<font color='#BB00BB'>png_build_8bit_table</font><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytepp ptable,
   PNG_CONST png_fixed_point gamma_val<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;
   png_bytep table <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>ptable <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>256</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gamma_val<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      table[i] <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>i, gamma_val<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
      table[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
<b>}</b>

<font color='#009900'>/* Used from png_read_destroy and below to release the memory used by the gamma
 * tables.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_destroy_gamma_table</font><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table <font color='#5555FF'>=</font> NULL;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;
      <font color='#0000FF'><u>int</u></font> istop <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table[i]<font face='Lucida Console'>)</font>;
      <b>}</b>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table <font color='#5555FF'>=</font> NULL;
   <b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_RGB_TO_GRAY_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1 <font color='#5555FF'>=</font> NULL;
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1 <font color='#5555FF'>=</font> NULL;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;
      <font color='#0000FF'><u>int</u></font> istop <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1[i]<font face='Lucida Console'>)</font>;
      <b>}</b>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1 <font color='#5555FF'>=</font> NULL;
   <b>}</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;
      <font color='#0000FF'><u>int</u></font> istop <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1[i]<font face='Lucida Console'>)</font>;
      <b>}</b>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1 <font color='#5555FF'>=</font> NULL;
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_BACKGROUND || READ_ALPHA_MODE || RGB_TO_GRAY */</font>
<b>}</b>

<font color='#009900'>/* We build the 8- or 16-bit gamma tables here.  Note that for 16-bit
 * tables, we don't make a full table if we are reducing to 8-bit in
 * the future.  Note also how the gamma_16 tables are segmented so that
 * we don't need to allocate &gt; 64K chunks for a full 16-bit table.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_build_gamma_table</font><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> bit_depth<font face='Lucida Console'>)</font>
<b>{</b>
  <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_build_gamma_table</font>"<font face='Lucida Console'>)</font>;

  <font color='#009900'>/* Remove any existing table; this copes with multiple calls to
   * png_read_update_info.  The warning is because building the gamma tables
   * multiple times is a performance hit - it's harmless but the ability to call
   * png_read_update_info() multiple times is new in 1.5.6 so it seems sensible
   * to warn if the app introduces such a hit.
   */</font>
  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
  <b>{</b>
    <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gamma table being rebuilt</font>"<font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>png_destroy_gamma_table</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
  <b>}</b>

  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bit_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
  <b>{</b>
     <font color='#BB00BB'>png_build_8bit_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table,
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ?  <font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font> : PNG_FP_1<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_RGB_TO_GRAY_SUPPORTED<font face='Lucida Console'>)</font>
     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_COMPOSE <font color='#5555FF'>|</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
     <b>{</b>
        <font color='#BB00BB'>png_build_8bit_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1,
            <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>png_build_8bit_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1,
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ?  <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font> :
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font color='#009900'>/* Probably doing rgb_to_gray */</font><font face='Lucida Console'>)</font>;
     <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_BACKGROUND || READ_ALPHA_MODE || RGB_TO_GRAY */</font>
  <b>}</b>
  <font color='#0000FF'>else</font>
  <b>{</b>
     png_byte shift, sig_bit;

     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
     <b>{</b>
        sig_bit <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.red;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.green <font color='#5555FF'>&gt;</font> sig_bit<font face='Lucida Console'>)</font>
           sig_bit <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.green;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.blue <font color='#5555FF'>&gt;</font> sig_bit<font face='Lucida Console'>)</font>
           sig_bit <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.blue;
     <b>}</b>
     <font color='#0000FF'>else</font>
        sig_bit <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.gray;

     <font color='#009900'>/* 16-bit gamma code uses this equation:
      *
      *   ov = table[(iv &amp; 0xff) &gt;&gt; gamma_shift][iv &gt;&gt; 8]
      *
      * Where 'iv' is the input color value and 'ov' is the output value -
      * pow(iv, gamma).
      *
      * Thus the gamma table consists of up to 256 256 entry tables.  The table
      * is selected by the (8-gamma_shift) most significant of the low 8 bits of
      * the color value then indexed by the upper 8 bits:
      *
      *   table[low bits][high 8 bits]
      *
      * So the table 'n' corresponds to all those 'iv' of:
      *
      *   &lt;all high 8-bit values&gt;&lt;n &lt;&lt; gamma_shift&gt;..&lt;(n+1 &lt;&lt; gamma_shift)-1&gt;
      *
      */</font>
     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>sig_bit <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> sig_bit <font color='#5555FF'>&lt;</font> <font color='#979000'>16</font>U<font face='Lucida Console'>)</font>
        shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>16</font>U <font color='#5555FF'>-</font> sig_bit<font face='Lucida Console'>)</font>; <font color='#009900'>/* shift == insignificant bits */</font>

     <font color='#0000FF'>else</font>
        shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* keep all 16 bits */</font>

     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_16_TO_8 <font color='#5555FF'>|</font> PNG_SCALE_16_TO_8<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
     <b>{</b>
        <font color='#009900'>/* PNG_MAX_GAMMA_8 is the number of bits to keep - effectively
         * the significant bits in the *input* when the output will
         * eventually be 8 bits.  By default it is 11.
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font>U <font color='#5555FF'>-</font> PNG_MAX_GAMMA_8<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
           shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>16</font>U <font color='#5555FF'>-</font> PNG_MAX_GAMMA_8<font face='Lucida Console'>)</font>;
     <b>}</b>

     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>U<font face='Lucida Console'>)</font>
        shift <font color='#5555FF'>=</font> <font color='#979000'>8</font>U; <font color='#009900'>/* Guarantees at least one table! */</font>

     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift <font color='#5555FF'>=</font> shift;

<font color='#0000FF'>#ifdef</font> PNG_16BIT_SUPPORTED
     <font color='#009900'>/* NOTE: prior to 1.5.4 this test used to include PNG_BACKGROUND (now
      * PNG_COMPOSE).  This effectively smashed the background calculation for
      * 16-bit output because the 8-bit table assumes the result will be reduced
      * to 8 bits.
      */</font>
     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_16_TO_8 <font color='#5555FF'>|</font> PNG_SCALE_16_TO_8<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
         <font color='#BB00BB'>png_build_16to8_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table, shift,
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? <font color='#BB00BB'>png_product2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font> : PNG_FP_1<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_16BIT_SUPPORTED
     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_build_16bit_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table, shift,
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? <font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font> : PNG_FP_1<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_RGB_TO_GRAY_SUPPORTED<font face='Lucida Console'>)</font>
     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_COMPOSE <font color='#5555FF'>|</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
     <b>{</b>
        <font color='#BB00BB'>png_build_16bit_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1, shift,
            <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        <font color='#009900'>/* Notice that the '16 from 1' table should be full precision, however
         * the lookup on this table still uses gamma_shift, so it can't be.
         * TODO: fix this.
         */</font>
        <font color='#BB00BB'>png_build_16bit_table</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1, shift,
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font> :
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font color='#009900'>/* Probably doing rgb_to_gray */</font><font face='Lucida Console'>)</font>;
     <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_BACKGROUND || READ_ALPHA_MODE || RGB_TO_GRAY */</font>
  <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_GAMMA */</font>

<font color='#009900'>/* HARDWARE OPTION SUPPORT */</font>
<font color='#0000FF'>#ifdef</font> PNG_SET_OPTION_SUPPORTED
<font color='#0000FF'><u>int</u></font> PNGAPI
<font color='#BB00BB'>png_set_option</font><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> option, <font color='#0000FF'><u>int</u></font> onoff<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> option <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> option <font color='#5555FF'>&lt;</font> PNG_OPTION_NEXT <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>option <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> mask <font color='#5555FF'>=</font> <font color='#979000'>3</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> option;
      <font color='#0000FF'><u>int</u></font> setting <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>2</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>onoff <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> option;
      <font color='#0000FF'><u>int</u></font> current <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>options;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>options <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>current <font color='#5555FF'>&amp;</font> ~mask<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> setting<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>current <font color='#5555FF'>&amp;</font> mask<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> option;
   <b>}</b>

   <font color='#0000FF'>return</font> PNG_OPTION_INVALID;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* sRGB support */</font>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_SIMPLIFIED_READ_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_SIMPLIFIED_WRITE_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* sRGB conversion tables; these are machine generated with the code in
 * contrib/tools/makesRGB.c.  The actual sRGB transfer curve defined in the
 * specification (see the article at http://en.wikipedia.org/wiki/SRGB)
 * is used, not the gamma=1/2.2 approximation use elsewhere in libpng.
 * The sRGB to linear table is exact (to the nearest 16 bit linear fraction).
 * The inverse (linear to sRGB) table has accuracies as follows:
 *
 * For all possible (255*65535+1) input values:
 *
 *    error: -0.515566 - 0.625971, 79441 (0.475369%) of readings inexact
 *
 * For the input values corresponding to the 65536 16-bit values:
 *
 *    error: -0.513727 - 0.607759, 308 (0.469978%) of readings inexact
 *
 * In all cases the inexact readings are off by one.
 */</font>

<font color='#0000FF'>#ifdef</font> PNG_SIMPLIFIED_READ_SUPPORTED
<font color='#009900'>/* The convert-to-sRGB table is only currently required for read. */</font>
<font color='#0000FF'>const</font> png_uint_16 png_sRGB_table[<font color='#979000'>256</font>] <font color='#5555FF'>=</font>
<b>{</b>
   <font color='#979000'>0</font>,<font color='#979000'>20</font>,<font color='#979000'>40</font>,<font color='#979000'>60</font>,<font color='#979000'>80</font>,<font color='#979000'>99</font>,<font color='#979000'>119</font>,<font color='#979000'>139</font>,
   <font color='#979000'>159</font>,<font color='#979000'>179</font>,<font color='#979000'>199</font>,<font color='#979000'>219</font>,<font color='#979000'>241</font>,<font color='#979000'>264</font>,<font color='#979000'>288</font>,<font color='#979000'>313</font>,
   <font color='#979000'>340</font>,<font color='#979000'>367</font>,<font color='#979000'>396</font>,<font color='#979000'>427</font>,<font color='#979000'>458</font>,<font color='#979000'>491</font>,<font color='#979000'>526</font>,<font color='#979000'>562</font>,
   <font color='#979000'>599</font>,<font color='#979000'>637</font>,<font color='#979000'>677</font>,<font color='#979000'>718</font>,<font color='#979000'>761</font>,<font color='#979000'>805</font>,<font color='#979000'>851</font>,<font color='#979000'>898</font>,
   <font color='#979000'>947</font>,<font color='#979000'>997</font>,<font color='#979000'>1048</font>,<font color='#979000'>1101</font>,<font color='#979000'>1156</font>,<font color='#979000'>1212</font>,<font color='#979000'>1270</font>,<font color='#979000'>1330</font>,
   <font color='#979000'>1391</font>,<font color='#979000'>1453</font>,<font color='#979000'>1517</font>,<font color='#979000'>1583</font>,<font color='#979000'>1651</font>,<font color='#979000'>1720</font>,<font color='#979000'>1790</font>,<font color='#979000'>1863</font>,
   <font color='#979000'>1937</font>,<font color='#979000'>2013</font>,<font color='#979000'>2090</font>,<font color='#979000'>2170</font>,<font color='#979000'>2250</font>,<font color='#979000'>2333</font>,<font color='#979000'>2418</font>,<font color='#979000'>2504</font>,
   <font color='#979000'>2592</font>,<font color='#979000'>2681</font>,<font color='#979000'>2773</font>,<font color='#979000'>2866</font>,<font color='#979000'>2961</font>,<font color='#979000'>3058</font>,<font color='#979000'>3157</font>,<font color='#979000'>3258</font>,
   <font color='#979000'>3360</font>,<font color='#979000'>3464</font>,<font color='#979000'>3570</font>,<font color='#979000'>3678</font>,<font color='#979000'>3788</font>,<font color='#979000'>3900</font>,<font color='#979000'>4014</font>,<font color='#979000'>4129</font>,
   <font color='#979000'>4247</font>,<font color='#979000'>4366</font>,<font color='#979000'>4488</font>,<font color='#979000'>4611</font>,<font color='#979000'>4736</font>,<font color='#979000'>4864</font>,<font color='#979000'>4993</font>,<font color='#979000'>5124</font>,
   <font color='#979000'>5257</font>,<font color='#979000'>5392</font>,<font color='#979000'>5530</font>,<font color='#979000'>5669</font>,<font color='#979000'>5810</font>,<font color='#979000'>5953</font>,<font color='#979000'>6099</font>,<font color='#979000'>6246</font>,
   <font color='#979000'>6395</font>,<font color='#979000'>6547</font>,<font color='#979000'>6700</font>,<font color='#979000'>6856</font>,<font color='#979000'>7014</font>,<font color='#979000'>7174</font>,<font color='#979000'>7335</font>,<font color='#979000'>7500</font>,
   <font color='#979000'>7666</font>,<font color='#979000'>7834</font>,<font color='#979000'>8004</font>,<font color='#979000'>8177</font>,<font color='#979000'>8352</font>,<font color='#979000'>8528</font>,<font color='#979000'>8708</font>,<font color='#979000'>8889</font>,
   <font color='#979000'>9072</font>,<font color='#979000'>9258</font>,<font color='#979000'>9445</font>,<font color='#979000'>9635</font>,<font color='#979000'>9828</font>,<font color='#979000'>10022</font>,<font color='#979000'>10219</font>,<font color='#979000'>10417</font>,
   <font color='#979000'>10619</font>,<font color='#979000'>10822</font>,<font color='#979000'>11028</font>,<font color='#979000'>11235</font>,<font color='#979000'>11446</font>,<font color='#979000'>11658</font>,<font color='#979000'>11873</font>,<font color='#979000'>12090</font>,
   <font color='#979000'>12309</font>,<font color='#979000'>12530</font>,<font color='#979000'>12754</font>,<font color='#979000'>12980</font>,<font color='#979000'>13209</font>,<font color='#979000'>13440</font>,<font color='#979000'>13673</font>,<font color='#979000'>13909</font>,
   <font color='#979000'>14146</font>,<font color='#979000'>14387</font>,<font color='#979000'>14629</font>,<font color='#979000'>14874</font>,<font color='#979000'>15122</font>,<font color='#979000'>15371</font>,<font color='#979000'>15623</font>,<font color='#979000'>15878</font>,
   <font color='#979000'>16135</font>,<font color='#979000'>16394</font>,<font color='#979000'>16656</font>,<font color='#979000'>16920</font>,<font color='#979000'>17187</font>,<font color='#979000'>17456</font>,<font color='#979000'>17727</font>,<font color='#979000'>18001</font>,
   <font color='#979000'>18277</font>,<font color='#979000'>18556</font>,<font color='#979000'>18837</font>,<font color='#979000'>19121</font>,<font color='#979000'>19407</font>,<font color='#979000'>19696</font>,<font color='#979000'>19987</font>,<font color='#979000'>20281</font>,
   <font color='#979000'>20577</font>,<font color='#979000'>20876</font>,<font color='#979000'>21177</font>,<font color='#979000'>21481</font>,<font color='#979000'>21787</font>,<font color='#979000'>22096</font>,<font color='#979000'>22407</font>,<font color='#979000'>22721</font>,
   <font color='#979000'>23038</font>,<font color='#979000'>23357</font>,<font color='#979000'>23678</font>,<font color='#979000'>24002</font>,<font color='#979000'>24329</font>,<font color='#979000'>24658</font>,<font color='#979000'>24990</font>,<font color='#979000'>25325</font>,
   <font color='#979000'>25662</font>,<font color='#979000'>26001</font>,<font color='#979000'>26344</font>,<font color='#979000'>26688</font>,<font color='#979000'>27036</font>,<font color='#979000'>27386</font>,<font color='#979000'>27739</font>,<font color='#979000'>28094</font>,
   <font color='#979000'>28452</font>,<font color='#979000'>28813</font>,<font color='#979000'>29176</font>,<font color='#979000'>29542</font>,<font color='#979000'>29911</font>,<font color='#979000'>30282</font>,<font color='#979000'>30656</font>,<font color='#979000'>31033</font>,
   <font color='#979000'>31412</font>,<font color='#979000'>31794</font>,<font color='#979000'>32179</font>,<font color='#979000'>32567</font>,<font color='#979000'>32957</font>,<font color='#979000'>33350</font>,<font color='#979000'>33745</font>,<font color='#979000'>34143</font>,
   <font color='#979000'>34544</font>,<font color='#979000'>34948</font>,<font color='#979000'>35355</font>,<font color='#979000'>35764</font>,<font color='#979000'>36176</font>,<font color='#979000'>36591</font>,<font color='#979000'>37008</font>,<font color='#979000'>37429</font>,
   <font color='#979000'>37852</font>,<font color='#979000'>38278</font>,<font color='#979000'>38706</font>,<font color='#979000'>39138</font>,<font color='#979000'>39572</font>,<font color='#979000'>40009</font>,<font color='#979000'>40449</font>,<font color='#979000'>40891</font>,
   <font color='#979000'>41337</font>,<font color='#979000'>41785</font>,<font color='#979000'>42236</font>,<font color='#979000'>42690</font>,<font color='#979000'>43147</font>,<font color='#979000'>43606</font>,<font color='#979000'>44069</font>,<font color='#979000'>44534</font>,
   <font color='#979000'>45002</font>,<font color='#979000'>45473</font>,<font color='#979000'>45947</font>,<font color='#979000'>46423</font>,<font color='#979000'>46903</font>,<font color='#979000'>47385</font>,<font color='#979000'>47871</font>,<font color='#979000'>48359</font>,
   <font color='#979000'>48850</font>,<font color='#979000'>49344</font>,<font color='#979000'>49841</font>,<font color='#979000'>50341</font>,<font color='#979000'>50844</font>,<font color='#979000'>51349</font>,<font color='#979000'>51858</font>,<font color='#979000'>52369</font>,
   <font color='#979000'>52884</font>,<font color='#979000'>53401</font>,<font color='#979000'>53921</font>,<font color='#979000'>54445</font>,<font color='#979000'>54971</font>,<font color='#979000'>55500</font>,<font color='#979000'>56032</font>,<font color='#979000'>56567</font>,
   <font color='#979000'>57105</font>,<font color='#979000'>57646</font>,<font color='#979000'>58190</font>,<font color='#979000'>58737</font>,<font color='#979000'>59287</font>,<font color='#979000'>59840</font>,<font color='#979000'>60396</font>,<font color='#979000'>60955</font>,
   <font color='#979000'>61517</font>,<font color='#979000'>62082</font>,<font color='#979000'>62650</font>,<font color='#979000'>63221</font>,<font color='#979000'>63795</font>,<font color='#979000'>64372</font>,<font color='#979000'>64952</font>,<font color='#979000'>65535</font>
<b>}</b>;

<font color='#0000FF'>#endif</font> <font color='#009900'>/* simplified read only */</font>

<font color='#009900'>/* The base/delta tables are required for both read and write (but currently
 * only the simplified versions.)
 */</font>
<font color='#0000FF'>const</font> png_uint_16 png_sRGB_base[<font color='#979000'>512</font>] <font color='#5555FF'>=</font>
<b>{</b>
   <font color='#979000'>128</font>,<font color='#979000'>1782</font>,<font color='#979000'>3383</font>,<font color='#979000'>4644</font>,<font color='#979000'>5675</font>,<font color='#979000'>6564</font>,<font color='#979000'>7357</font>,<font color='#979000'>8074</font>,
   <font color='#979000'>8732</font>,<font color='#979000'>9346</font>,<font color='#979000'>9921</font>,<font color='#979000'>10463</font>,<font color='#979000'>10977</font>,<font color='#979000'>11466</font>,<font color='#979000'>11935</font>,<font color='#979000'>12384</font>,
   <font color='#979000'>12816</font>,<font color='#979000'>13233</font>,<font color='#979000'>13634</font>,<font color='#979000'>14024</font>,<font color='#979000'>14402</font>,<font color='#979000'>14769</font>,<font color='#979000'>15125</font>,<font color='#979000'>15473</font>,
   <font color='#979000'>15812</font>,<font color='#979000'>16142</font>,<font color='#979000'>16466</font>,<font color='#979000'>16781</font>,<font color='#979000'>17090</font>,<font color='#979000'>17393</font>,<font color='#979000'>17690</font>,<font color='#979000'>17981</font>,
   <font color='#979000'>18266</font>,<font color='#979000'>18546</font>,<font color='#979000'>18822</font>,<font color='#979000'>19093</font>,<font color='#979000'>19359</font>,<font color='#979000'>19621</font>,<font color='#979000'>19879</font>,<font color='#979000'>20133</font>,
   <font color='#979000'>20383</font>,<font color='#979000'>20630</font>,<font color='#979000'>20873</font>,<font color='#979000'>21113</font>,<font color='#979000'>21349</font>,<font color='#979000'>21583</font>,<font color='#979000'>21813</font>,<font color='#979000'>22041</font>,
   <font color='#979000'>22265</font>,<font color='#979000'>22487</font>,<font color='#979000'>22707</font>,<font color='#979000'>22923</font>,<font color='#979000'>23138</font>,<font color='#979000'>23350</font>,<font color='#979000'>23559</font>,<font color='#979000'>23767</font>,
   <font color='#979000'>23972</font>,<font color='#979000'>24175</font>,<font color='#979000'>24376</font>,<font color='#979000'>24575</font>,<font color='#979000'>24772</font>,<font color='#979000'>24967</font>,<font color='#979000'>25160</font>,<font color='#979000'>25352</font>,
   <font color='#979000'>25542</font>,<font color='#979000'>25730</font>,<font color='#979000'>25916</font>,<font color='#979000'>26101</font>,<font color='#979000'>26284</font>,<font color='#979000'>26465</font>,<font color='#979000'>26645</font>,<font color='#979000'>26823</font>,
   <font color='#979000'>27000</font>,<font color='#979000'>27176</font>,<font color='#979000'>27350</font>,<font color='#979000'>27523</font>,<font color='#979000'>27695</font>,<font color='#979000'>27865</font>,<font color='#979000'>28034</font>,<font color='#979000'>28201</font>,
   <font color='#979000'>28368</font>,<font color='#979000'>28533</font>,<font color='#979000'>28697</font>,<font color='#979000'>28860</font>,<font color='#979000'>29021</font>,<font color='#979000'>29182</font>,<font color='#979000'>29341</font>,<font color='#979000'>29500</font>,
   <font color='#979000'>29657</font>,<font color='#979000'>29813</font>,<font color='#979000'>29969</font>,<font color='#979000'>30123</font>,<font color='#979000'>30276</font>,<font color='#979000'>30429</font>,<font color='#979000'>30580</font>,<font color='#979000'>30730</font>,
   <font color='#979000'>30880</font>,<font color='#979000'>31028</font>,<font color='#979000'>31176</font>,<font color='#979000'>31323</font>,<font color='#979000'>31469</font>,<font color='#979000'>31614</font>,<font color='#979000'>31758</font>,<font color='#979000'>31902</font>,
   <font color='#979000'>32045</font>,<font color='#979000'>32186</font>,<font color='#979000'>32327</font>,<font color='#979000'>32468</font>,<font color='#979000'>32607</font>,<font color='#979000'>32746</font>,<font color='#979000'>32884</font>,<font color='#979000'>33021</font>,
   <font color='#979000'>33158</font>,<font color='#979000'>33294</font>,<font color='#979000'>33429</font>,<font color='#979000'>33564</font>,<font color='#979000'>33697</font>,<font color='#979000'>33831</font>,<font color='#979000'>33963</font>,<font color='#979000'>34095</font>,
   <font color='#979000'>34226</font>,<font color='#979000'>34357</font>,<font color='#979000'>34486</font>,<font color='#979000'>34616</font>,<font color='#979000'>34744</font>,<font color='#979000'>34873</font>,<font color='#979000'>35000</font>,<font color='#979000'>35127</font>,
   <font color='#979000'>35253</font>,<font color='#979000'>35379</font>,<font color='#979000'>35504</font>,<font color='#979000'>35629</font>,<font color='#979000'>35753</font>,<font color='#979000'>35876</font>,<font color='#979000'>35999</font>,<font color='#979000'>36122</font>,
   <font color='#979000'>36244</font>,<font color='#979000'>36365</font>,<font color='#979000'>36486</font>,<font color='#979000'>36606</font>,<font color='#979000'>36726</font>,<font color='#979000'>36845</font>,<font color='#979000'>36964</font>,<font color='#979000'>37083</font>,
   <font color='#979000'>37201</font>,<font color='#979000'>37318</font>,<font color='#979000'>37435</font>,<font color='#979000'>37551</font>,<font color='#979000'>37668</font>,<font color='#979000'>37783</font>,<font color='#979000'>37898</font>,<font color='#979000'>38013</font>,
   <font color='#979000'>38127</font>,<font color='#979000'>38241</font>,<font color='#979000'>38354</font>,<font color='#979000'>38467</font>,<font color='#979000'>38580</font>,<font color='#979000'>38692</font>,<font color='#979000'>38803</font>,<font color='#979000'>38915</font>,
   <font color='#979000'>39026</font>,<font color='#979000'>39136</font>,<font color='#979000'>39246</font>,<font color='#979000'>39356</font>,<font color='#979000'>39465</font>,<font color='#979000'>39574</font>,<font color='#979000'>39682</font>,<font color='#979000'>39790</font>,
   <font color='#979000'>39898</font>,<font color='#979000'>40005</font>,<font color='#979000'>40112</font>,<font color='#979000'>40219</font>,<font color='#979000'>40325</font>,<font color='#979000'>40431</font>,<font color='#979000'>40537</font>,<font color='#979000'>40642</font>,
   <font color='#979000'>40747</font>,<font color='#979000'>40851</font>,<font color='#979000'>40955</font>,<font color='#979000'>41059</font>,<font color='#979000'>41163</font>,<font color='#979000'>41266</font>,<font color='#979000'>41369</font>,<font color='#979000'>41471</font>,
   <font color='#979000'>41573</font>,<font color='#979000'>41675</font>,<font color='#979000'>41777</font>,<font color='#979000'>41878</font>,<font color='#979000'>41979</font>,<font color='#979000'>42079</font>,<font color='#979000'>42179</font>,<font color='#979000'>42279</font>,
   <font color='#979000'>42379</font>,<font color='#979000'>42478</font>,<font color='#979000'>42577</font>,<font color='#979000'>42676</font>,<font color='#979000'>42775</font>,<font color='#979000'>42873</font>,<font color='#979000'>42971</font>,<font color='#979000'>43068</font>,
   <font color='#979000'>43165</font>,<font color='#979000'>43262</font>,<font color='#979000'>43359</font>,<font color='#979000'>43456</font>,<font color='#979000'>43552</font>,<font color='#979000'>43648</font>,<font color='#979000'>43743</font>,<font color='#979000'>43839</font>,
   <font color='#979000'>43934</font>,<font color='#979000'>44028</font>,<font color='#979000'>44123</font>,<font color='#979000'>44217</font>,<font color='#979000'>44311</font>,<font color='#979000'>44405</font>,<font color='#979000'>44499</font>,<font color='#979000'>44592</font>,
   <font color='#979000'>44685</font>,<font color='#979000'>44778</font>,<font color='#979000'>44870</font>,<font color='#979000'>44962</font>,<font color='#979000'>45054</font>,<font color='#979000'>45146</font>,<font color='#979000'>45238</font>,<font color='#979000'>45329</font>,
   <font color='#979000'>45420</font>,<font color='#979000'>45511</font>,<font color='#979000'>45601</font>,<font color='#979000'>45692</font>,<font color='#979000'>45782</font>,<font color='#979000'>45872</font>,<font color='#979000'>45961</font>,<font color='#979000'>46051</font>,
   <font color='#979000'>46140</font>,<font color='#979000'>46229</font>,<font color='#979000'>46318</font>,<font color='#979000'>46406</font>,<font color='#979000'>46494</font>,<font color='#979000'>46583</font>,<font color='#979000'>46670</font>,<font color='#979000'>46758</font>,
   <font color='#979000'>46846</font>,<font color='#979000'>46933</font>,<font color='#979000'>47020</font>,<font color='#979000'>47107</font>,<font color='#979000'>47193</font>,<font color='#979000'>47280</font>,<font color='#979000'>47366</font>,<font color='#979000'>47452</font>,
   <font color='#979000'>47538</font>,<font color='#979000'>47623</font>,<font color='#979000'>47709</font>,<font color='#979000'>47794</font>,<font color='#979000'>47879</font>,<font color='#979000'>47964</font>,<font color='#979000'>48048</font>,<font color='#979000'>48133</font>,
   <font color='#979000'>48217</font>,<font color='#979000'>48301</font>,<font color='#979000'>48385</font>,<font color='#979000'>48468</font>,<font color='#979000'>48552</font>,<font color='#979000'>48635</font>,<font color='#979000'>48718</font>,<font color='#979000'>48801</font>,
   <font color='#979000'>48884</font>,<font color='#979000'>48966</font>,<font color='#979000'>49048</font>,<font color='#979000'>49131</font>,<font color='#979000'>49213</font>,<font color='#979000'>49294</font>,<font color='#979000'>49376</font>,<font color='#979000'>49458</font>,
   <font color='#979000'>49539</font>,<font color='#979000'>49620</font>,<font color='#979000'>49701</font>,<font color='#979000'>49782</font>,<font color='#979000'>49862</font>,<font color='#979000'>49943</font>,<font color='#979000'>50023</font>,<font color='#979000'>50103</font>,
   <font color='#979000'>50183</font>,<font color='#979000'>50263</font>,<font color='#979000'>50342</font>,<font color='#979000'>50422</font>,<font color='#979000'>50501</font>,<font color='#979000'>50580</font>,<font color='#979000'>50659</font>,<font color='#979000'>50738</font>,
   <font color='#979000'>50816</font>,<font color='#979000'>50895</font>,<font color='#979000'>50973</font>,<font color='#979000'>51051</font>,<font color='#979000'>51129</font>,<font color='#979000'>51207</font>,<font color='#979000'>51285</font>,<font color='#979000'>51362</font>,
   <font color='#979000'>51439</font>,<font color='#979000'>51517</font>,<font color='#979000'>51594</font>,<font color='#979000'>51671</font>,<font color='#979000'>51747</font>,<font color='#979000'>51824</font>,<font color='#979000'>51900</font>,<font color='#979000'>51977</font>,
   <font color='#979000'>52053</font>,<font color='#979000'>52129</font>,<font color='#979000'>52205</font>,<font color='#979000'>52280</font>,<font color='#979000'>52356</font>,<font color='#979000'>52432</font>,<font color='#979000'>52507</font>,<font color='#979000'>52582</font>,
   <font color='#979000'>52657</font>,<font color='#979000'>52732</font>,<font color='#979000'>52807</font>,<font color='#979000'>52881</font>,<font color='#979000'>52956</font>,<font color='#979000'>53030</font>,<font color='#979000'>53104</font>,<font color='#979000'>53178</font>,
   <font color='#979000'>53252</font>,<font color='#979000'>53326</font>,<font color='#979000'>53400</font>,<font color='#979000'>53473</font>,<font color='#979000'>53546</font>,<font color='#979000'>53620</font>,<font color='#979000'>53693</font>,<font color='#979000'>53766</font>,
   <font color='#979000'>53839</font>,<font color='#979000'>53911</font>,<font color='#979000'>53984</font>,<font color='#979000'>54056</font>,<font color='#979000'>54129</font>,<font color='#979000'>54201</font>,<font color='#979000'>54273</font>,<font color='#979000'>54345</font>,
   <font color='#979000'>54417</font>,<font color='#979000'>54489</font>,<font color='#979000'>54560</font>,<font color='#979000'>54632</font>,<font color='#979000'>54703</font>,<font color='#979000'>54774</font>,<font color='#979000'>54845</font>,<font color='#979000'>54916</font>,
   <font color='#979000'>54987</font>,<font color='#979000'>55058</font>,<font color='#979000'>55129</font>,<font color='#979000'>55199</font>,<font color='#979000'>55269</font>,<font color='#979000'>55340</font>,<font color='#979000'>55410</font>,<font color='#979000'>55480</font>,
   <font color='#979000'>55550</font>,<font color='#979000'>55620</font>,<font color='#979000'>55689</font>,<font color='#979000'>55759</font>,<font color='#979000'>55828</font>,<font color='#979000'>55898</font>,<font color='#979000'>55967</font>,<font color='#979000'>56036</font>,
   <font color='#979000'>56105</font>,<font color='#979000'>56174</font>,<font color='#979000'>56243</font>,<font color='#979000'>56311</font>,<font color='#979000'>56380</font>,<font color='#979000'>56448</font>,<font color='#979000'>56517</font>,<font color='#979000'>56585</font>,
   <font color='#979000'>56653</font>,<font color='#979000'>56721</font>,<font color='#979000'>56789</font>,<font color='#979000'>56857</font>,<font color='#979000'>56924</font>,<font color='#979000'>56992</font>,<font color='#979000'>57059</font>,<font color='#979000'>57127</font>,
   <font color='#979000'>57194</font>,<font color='#979000'>57261</font>,<font color='#979000'>57328</font>,<font color='#979000'>57395</font>,<font color='#979000'>57462</font>,<font color='#979000'>57529</font>,<font color='#979000'>57595</font>,<font color='#979000'>57662</font>,
   <font color='#979000'>57728</font>,<font color='#979000'>57795</font>,<font color='#979000'>57861</font>,<font color='#979000'>57927</font>,<font color='#979000'>57993</font>,<font color='#979000'>58059</font>,<font color='#979000'>58125</font>,<font color='#979000'>58191</font>,
   <font color='#979000'>58256</font>,<font color='#979000'>58322</font>,<font color='#979000'>58387</font>,<font color='#979000'>58453</font>,<font color='#979000'>58518</font>,<font color='#979000'>58583</font>,<font color='#979000'>58648</font>,<font color='#979000'>58713</font>,
   <font color='#979000'>58778</font>,<font color='#979000'>58843</font>,<font color='#979000'>58908</font>,<font color='#979000'>58972</font>,<font color='#979000'>59037</font>,<font color='#979000'>59101</font>,<font color='#979000'>59165</font>,<font color='#979000'>59230</font>,
   <font color='#979000'>59294</font>,<font color='#979000'>59358</font>,<font color='#979000'>59422</font>,<font color='#979000'>59486</font>,<font color='#979000'>59549</font>,<font color='#979000'>59613</font>,<font color='#979000'>59677</font>,<font color='#979000'>59740</font>,
   <font color='#979000'>59804</font>,<font color='#979000'>59867</font>,<font color='#979000'>59930</font>,<font color='#979000'>59993</font>,<font color='#979000'>60056</font>,<font color='#979000'>60119</font>,<font color='#979000'>60182</font>,<font color='#979000'>60245</font>,
   <font color='#979000'>60308</font>,<font color='#979000'>60370</font>,<font color='#979000'>60433</font>,<font color='#979000'>60495</font>,<font color='#979000'>60558</font>,<font color='#979000'>60620</font>,<font color='#979000'>60682</font>,<font color='#979000'>60744</font>,
   <font color='#979000'>60806</font>,<font color='#979000'>60868</font>,<font color='#979000'>60930</font>,<font color='#979000'>60992</font>,<font color='#979000'>61054</font>,<font color='#979000'>61115</font>,<font color='#979000'>61177</font>,<font color='#979000'>61238</font>,
   <font color='#979000'>61300</font>,<font color='#979000'>61361</font>,<font color='#979000'>61422</font>,<font color='#979000'>61483</font>,<font color='#979000'>61544</font>,<font color='#979000'>61605</font>,<font color='#979000'>61666</font>,<font color='#979000'>61727</font>,
   <font color='#979000'>61788</font>,<font color='#979000'>61848</font>,<font color='#979000'>61909</font>,<font color='#979000'>61969</font>,<font color='#979000'>62030</font>,<font color='#979000'>62090</font>,<font color='#979000'>62150</font>,<font color='#979000'>62211</font>,
   <font color='#979000'>62271</font>,<font color='#979000'>62331</font>,<font color='#979000'>62391</font>,<font color='#979000'>62450</font>,<font color='#979000'>62510</font>,<font color='#979000'>62570</font>,<font color='#979000'>62630</font>,<font color='#979000'>62689</font>,
   <font color='#979000'>62749</font>,<font color='#979000'>62808</font>,<font color='#979000'>62867</font>,<font color='#979000'>62927</font>,<font color='#979000'>62986</font>,<font color='#979000'>63045</font>,<font color='#979000'>63104</font>,<font color='#979000'>63163</font>,
   <font color='#979000'>63222</font>,<font color='#979000'>63281</font>,<font color='#979000'>63340</font>,<font color='#979000'>63398</font>,<font color='#979000'>63457</font>,<font color='#979000'>63515</font>,<font color='#979000'>63574</font>,<font color='#979000'>63632</font>,
   <font color='#979000'>63691</font>,<font color='#979000'>63749</font>,<font color='#979000'>63807</font>,<font color='#979000'>63865</font>,<font color='#979000'>63923</font>,<font color='#979000'>63981</font>,<font color='#979000'>64039</font>,<font color='#979000'>64097</font>,
   <font color='#979000'>64155</font>,<font color='#979000'>64212</font>,<font color='#979000'>64270</font>,<font color='#979000'>64328</font>,<font color='#979000'>64385</font>,<font color='#979000'>64443</font>,<font color='#979000'>64500</font>,<font color='#979000'>64557</font>,
   <font color='#979000'>64614</font>,<font color='#979000'>64672</font>,<font color='#979000'>64729</font>,<font color='#979000'>64786</font>,<font color='#979000'>64843</font>,<font color='#979000'>64900</font>,<font color='#979000'>64956</font>,<font color='#979000'>65013</font>,
   <font color='#979000'>65070</font>,<font color='#979000'>65126</font>,<font color='#979000'>65183</font>,<font color='#979000'>65239</font>,<font color='#979000'>65296</font>,<font color='#979000'>65352</font>,<font color='#979000'>65409</font>,<font color='#979000'>65465</font>
<b>}</b>;

<font color='#0000FF'>const</font> png_byte png_sRGB_delta[<font color='#979000'>512</font>] <font color='#5555FF'>=</font>
<b>{</b>
   <font color='#979000'>207</font>,<font color='#979000'>201</font>,<font color='#979000'>158</font>,<font color='#979000'>129</font>,<font color='#979000'>113</font>,<font color='#979000'>100</font>,<font color='#979000'>90</font>,<font color='#979000'>82</font>,<font color='#979000'>77</font>,<font color='#979000'>72</font>,<font color='#979000'>68</font>,<font color='#979000'>64</font>,<font color='#979000'>61</font>,<font color='#979000'>59</font>,<font color='#979000'>56</font>,<font color='#979000'>54</font>,
   <font color='#979000'>52</font>,<font color='#979000'>50</font>,<font color='#979000'>49</font>,<font color='#979000'>47</font>,<font color='#979000'>46</font>,<font color='#979000'>45</font>,<font color='#979000'>43</font>,<font color='#979000'>42</font>,<font color='#979000'>41</font>,<font color='#979000'>40</font>,<font color='#979000'>39</font>,<font color='#979000'>39</font>,<font color='#979000'>38</font>,<font color='#979000'>37</font>,<font color='#979000'>36</font>,<font color='#979000'>36</font>,
   <font color='#979000'>35</font>,<font color='#979000'>34</font>,<font color='#979000'>34</font>,<font color='#979000'>33</font>,<font color='#979000'>33</font>,<font color='#979000'>32</font>,<font color='#979000'>32</font>,<font color='#979000'>31</font>,<font color='#979000'>31</font>,<font color='#979000'>30</font>,<font color='#979000'>30</font>,<font color='#979000'>30</font>,<font color='#979000'>29</font>,<font color='#979000'>29</font>,<font color='#979000'>28</font>,<font color='#979000'>28</font>,
   <font color='#979000'>28</font>,<font color='#979000'>27</font>,<font color='#979000'>27</font>,<font color='#979000'>27</font>,<font color='#979000'>27</font>,<font color='#979000'>26</font>,<font color='#979000'>26</font>,<font color='#979000'>26</font>,<font color='#979000'>25</font>,<font color='#979000'>25</font>,<font color='#979000'>25</font>,<font color='#979000'>25</font>,<font color='#979000'>24</font>,<font color='#979000'>24</font>,<font color='#979000'>24</font>,<font color='#979000'>24</font>,
   <font color='#979000'>23</font>,<font color='#979000'>23</font>,<font color='#979000'>23</font>,<font color='#979000'>23</font>,<font color='#979000'>23</font>,<font color='#979000'>22</font>,<font color='#979000'>22</font>,<font color='#979000'>22</font>,<font color='#979000'>22</font>,<font color='#979000'>22</font>,<font color='#979000'>22</font>,<font color='#979000'>21</font>,<font color='#979000'>21</font>,<font color='#979000'>21</font>,<font color='#979000'>21</font>,<font color='#979000'>21</font>,
   <font color='#979000'>21</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>20</font>,<font color='#979000'>19</font>,<font color='#979000'>19</font>,<font color='#979000'>19</font>,<font color='#979000'>19</font>,<font color='#979000'>19</font>,<font color='#979000'>19</font>,<font color='#979000'>19</font>,
   <font color='#979000'>19</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>18</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,
   <font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>17</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,
   <font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>16</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,
   <font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>15</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,
   <font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>14</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,
   <font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>13</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,
   <font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,
   <font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>12</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,
   <font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,
   <font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,<font color='#979000'>11</font>,
   <font color='#979000'>11</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,
   <font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,
   <font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,<font color='#979000'>10</font>,
   <font color='#979000'>10</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,
   <font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,
   <font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,
   <font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,<font color='#979000'>9</font>,
   <font color='#979000'>9</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,
   <font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,
   <font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,
   <font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,
   <font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,
   <font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>8</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,
   <font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,
   <font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,
   <font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>,<font color='#979000'>7</font>
<b>}</b>;
<font color='#0000FF'>#endif</font> <font color='#009900'>/* SIMPLIFIED READ/WRITE sRGB support */</font>

<font color='#009900'>/* SIMPLIFIED READ/WRITE SUPPORT */</font>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_SIMPLIFIED_READ_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_SIMPLIFIED_WRITE_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<font color='#BB00BB'>png_image_free_function</font><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_imagep image <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_imagep, argument<font face='Lucida Console'>)</font>;
   png_controlp cp <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque;
   png_control c;

   <font color='#009900'>/* Double check that we have a png_ptr - it should be impossible to get here
    * without one.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* First free any data held in the control structure. */</font>
#  ifdef PNG_STDIO_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned_file<font face='Lucida Console'>)</font>
      <b>{</b>
         FILE <font color='#5555FF'>*</font>fp <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>FILE<font color='#5555FF'>*</font>, cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr<font face='Lucida Console'>)</font>;
         cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned_file <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

         <font color='#009900'>/* Ignore errors here. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>fp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr <font color='#5555FF'>=</font> NULL;
            <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>fclose</font><font face='Lucida Console'>(</font>fp<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>
#  endif

   <font color='#009900'>/* Copy the control structure so that the original, allocated, version can be
    * safely freed.  Notice that a png_error here stops the remainder of the
    * cleanup, but this is probably fine because that would indicate bad memory
    * problems anyway.
    */</font>
   c <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>cp;
   image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>c;
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>c.png_ptr, cp<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Then the structures, calling the correct API. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>c.for_write<font face='Lucida Console'>)</font>
   <b>{</b>
#     ifdef PNG_SIMPLIFIED_WRITE_SUPPORTED
         <font color='#BB00BB'>png_destroy_write_struct</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>c.png_ptr, <font color='#5555FF'>&amp;</font>c.info_ptr<font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>c.png_ptr, "<font color='#CC0000'>simplified write not supported</font>"<font face='Lucida Console'>)</font>;
#     endif
   <b>}</b>
   <font color='#0000FF'>else</font>
   <b>{</b>
#     ifdef PNG_SIMPLIFIED_READ_SUPPORTED
         <font color='#BB00BB'>png_destroy_read_struct</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>c.png_ptr, <font color='#5555FF'>&amp;</font>c.info_ptr, NULL<font face='Lucida Console'>)</font>;
#     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>c.png_ptr, "<font color='#CC0000'>simplified read not supported</font>"<font face='Lucida Console'>)</font>;
#     endif
   <b>}</b>

   <font color='#009900'>/* Success. */</font>
   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#0000FF'><u>void</u></font> PNGAPI
<font color='#BB00BB'>png_image_free</font><font face='Lucida Console'>(</font>png_imagep image<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Safely call the real function, but only if doing so is safe at this point
    * (if not inside an error handling context).  Otherwise assume
    * png_safe_execute will call this API after the return.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>error_buf <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Ignore errors here: */</font>
      <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_free_function, image<font face='Lucida Console'>)</font>;
      image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>=</font> NULL;
   <b>}</b>
<b>}</b>

<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>png_imagep image, png_const_charp error_message<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Utility to log an error. */</font>
   <font color='#BB00BB'>png_safecat</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>message, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>message<font face='Lucida Console'>)</font>, <font color='#979000'>0</font>, error_message<font face='Lucida Console'>)</font>;
   image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>warning_or_error <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_IMAGE_ERROR;
   <font color='#BB00BB'>png_image_free</font><font face='Lucida Console'>(</font>image<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* SIMPLIFIED READ/WRITE */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* defined(PNG_READ_SUPPORTED) || defined(PNG_WRITE_SUPPORTED) */</font>

</pre></body></html>