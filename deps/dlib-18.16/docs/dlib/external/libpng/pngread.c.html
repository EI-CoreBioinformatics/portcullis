<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - pngread.c</title></head><body bgcolor='white'><pre>

<font color='#009900'>/* pngread.c - read a PNG file
 *
 * Last changed in libpng 1.6.1 [March 28, 2013]
 * Copyright (c) 1998-2013 Glenn Randers-Pehrson
 * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
 * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
 *
 * This code is released under the libpng license.
 * For conditions of distribution and use, see the disclaimer
 * and license in png.h
 *
 * This file contains routines that an application calls directly to
 * read a PNG file or stream.
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pngpriv.h.html'>pngpriv.h</a>"
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_SIMPLIFIED_READ_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> defined<font face='Lucida Console'>(</font>PNG_STDIO_SUPPORTED<font face='Lucida Console'>)</font>
#  include <font color='#5555FF'>&lt;</font>errno.h<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SUPPORTED

<font color='#009900'>/* Create a PNG structure for reading, and allocate any memory needed. */</font>
<b><a name='PNG_FUNCTION'></a>PNG_FUNCTION</b><font face='Lucida Console'>(</font>png_structp,PNGAPI
png_create_read_struct,<font face='Lucida Console'>(</font>png_const_charp user_png_ver, png_voidp error_ptr,
    png_error_ptr error_fn, png_error_ptr warn_fn<font face='Lucida Console'>)</font>,PNG_ALLOCATED<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifndef</font> PNG_USER_MEM_SUPPORTED
   png_structp png_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_create_png_struct</font><font face='Lucida Console'>(</font>user_png_ver, error_ptr,
      error_fn, warn_fn, NULL, NULL, NULL<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
   <font color='#0000FF'>return</font> <font color='#BB00BB'>png_create_read_struct_2</font><font face='Lucida Console'>(</font>user_png_ver, error_ptr, error_fn,
       warn_fn, NULL, NULL, NULL<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Alternate create PNG structure for reading, and allocate any memory
 * needed.
 */</font>
<b><a name='PNG_FUNCTION'></a>PNG_FUNCTION</b><font face='Lucida Console'>(</font>png_structp,PNGAPI
png_create_read_struct_2,<font face='Lucida Console'>(</font>png_const_charp user_png_ver, png_voidp error_ptr,
    png_error_ptr error_fn, png_error_ptr warn_fn, png_voidp mem_ptr,
    png_malloc_ptr malloc_fn, png_free_ptr free_fn<font face='Lucida Console'>)</font>,PNG_ALLOCATED<font face='Lucida Console'>)</font>
<b>{</b>
   png_structp png_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_create_png_struct</font><font face='Lucida Console'>(</font>user_png_ver, error_ptr,
      error_fn, warn_fn, mem_ptr, malloc_fn, free_fn<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_USER_MEM_SUPPORTED */</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>=</font> PNG_IS_READ_STRUCT;

      <font color='#009900'>/* Added in libpng-1.6.0; this can be used to detect a read structure if
       * required (it will be zero in a write structure.)
       */</font>
#     ifdef PNG_SEQUENTIAL_READ_SUPPORTED
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>IDAT_read_size <font color='#5555FF'>=</font> PNG_IDAT_READ_SIZE;
#     endif

#     ifdef PNG_BENIGN_READ_ERRORS_SUPPORTED
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_BENIGN_ERRORS_WARN;

         <font color='#009900'>/* In stable builds only warn if an application error can be completely
          * handled.
          */</font>
#        <font color='#0000FF'>if</font> PNG_LIBPNG_BUILD_BASE_TYPE <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> PNG_LIBPNG_BUILD_RC
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_APP_WARNINGS_WARN;
#        endif
#     endif

      <font color='#009900'>/* TODO: delay this, it can be done in png_init_io (if the app doesn't
       * do it itself) avoiding setting the default function if it is not
       * required.
       */</font>
      <font color='#BB00BB'>png_set_read_fn</font><font face='Lucida Console'>(</font>png_ptr, NULL, NULL<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> png_ptr;
<b>}</b>


<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#009900'>/* Read the information before the actual image data.  This has been
 * changed in v0.90 to allow reading a file that already has the magic
 * bytes read from the stream.  You can tell libpng how many bytes have
 * been read from the beginning of the stream (up to the maximum of 8)
 * via png_set_sig_bytes(), and we will only check the remaining bytes
 * here.  The application can then have access to the signature bytes we
 * read if it is determined that this isn't a valid PNG file.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_info'></a>png_read_info</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_HANDLE_AS_UNKNOWN_SUPPORTED
   <font color='#0000FF'><u>int</u></font> keep;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_info</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> info_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* Read and check the PNG file signature. */</font>
   <font color='#BB00BB'>png_read_sig</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 length <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_chunk_header</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
      png_uint_32 chunk_name <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name;

      <font color='#009900'>/* IDAT logic needs to happen here to simplify getting the two flags
       * right.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Missing IHDR before IDAT</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_PLTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_chunk_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Missing PLTE before IDAT</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_AFTER_IDAT<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_chunk_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Too many IDATs found</font>"<font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_IDAT;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_AFTER_IDAT;

      <font color='#009900'>/* This should be a binary subdivision search or a hash for
       * matching the chunk name rather than a linear search.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IHDR<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_IHDR</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IEND<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_IEND</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_HANDLE_AS_UNKNOWN_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font> <font color='#BB00BB'>png_chunk_unknown_handling</font><font face='Lucida Console'>(</font>png_ptr, chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_handle_unknown</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length, keep<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_PLTE<font face='Lucida Console'>)</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_PLTE;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* It has been consumed */</font>
            <font color='#0000FF'>break</font>;
         <b>}</b>
      <b>}</b>
<font color='#0000FF'>#endif</font>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_PLTE<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_PLTE</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>idat_size <font color='#5555FF'>=</font> length;
         <font color='#0000FF'>break</font>;
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_bKGD_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_bKGD<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_bKGD</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_cHRM_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_cHRM<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_cHRM</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_gAMA_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_gAMA<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_gAMA</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_hIST_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_hIST<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_hIST</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_oFFs_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_oFFs<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_oFFs</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_pCAL_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_pCAL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_pCAL</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sCAL_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sCAL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sCAL</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_pHYs_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_pHYs<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_pHYs</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sBIT_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sBIT<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sBIT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sRGB_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sRGB</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iCCP_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_iCCP<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_iCCP</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sPLT_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sPLT<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sPLT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tEXt_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_tEXt<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_tEXt</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tIME_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_tIME<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_tIME</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tRNS_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_tRNS<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_tRNS</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_zTXt_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_zTXt<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_zTXt</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iTXt_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_iTXt<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_iTXt</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_handle_unknown</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length,
            PNG_HANDLE_CHUNK_AS_DEFAULT<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#009900'>/* Optional call to update the users info_ptr structure */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_update_info'></a>png_read_update_info</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_update_info</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ROW_INIT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_read_start_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

#        ifdef PNG_READ_TRANSFORMS_SUPPORTED
            <font color='#BB00BB'>png_read_transform_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
#        <font color='#0000FF'>else</font>
            <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>info_ptr<font face='Lucida Console'>)</font>
#        endif
      <b>}</b>

      <font color='#009900'>/* New in 1.6.0 this avoids the bug of doing the initializations twice */</font>
      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_app_error</font><font face='Lucida Console'>(</font>png_ptr,
            "<font color='#CC0000'>png_read_update_info/png_start_read_image: duplicate call</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#009900'>/* Initialize palette, background, etc, after transformations
 * are set, but before any reading takes place.  This allows
 * the user to obtain a gamma-corrected palette, for example.
 * If the user doesn't call this, we will do it ourselves.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_start_read_image'></a>png_start_read_image</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_start_read_image</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ROW_INIT<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_read_start_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* New in 1.6.0 this avoids the bug of doing the initializations twice */</font>
      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_app_error</font><font face='Lucida Console'>(</font>png_ptr,
            "<font color='#CC0000'>png_start_read_image/png_read_update_info: duplicate call</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_row'></a>png_read_row</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytep row, png_bytep dsp_row<font face='Lucida Console'>)</font>
<b>{</b>
   png_row_info row_info;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#BB00BB'>png_debug2</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_row (row %lu, pass %d)</font>",
       <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* png_read_start_row sets the information (in particular iwidth) for this
    * interlace pass.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ROW_INIT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_read_start_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* 1.5.6: row_info moved out of png_struct to a local here. */</font>
   row_info.width <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>iwidth; <font color='#009900'>/* NOTE: width of current interlaced row */</font>
   row_info.color_type <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type;
   row_info.bit_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;
   row_info.channels <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels;
   row_info.pixel_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth;
   row_info.rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info.pixel_depth, row_info.width<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
   <font color='#009900'>/* Check for transforms that have been set but were defined out */</font>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_INVERT_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_INVERT_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INVERT_MONO<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_INVERT_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_FILLER_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_FILLER_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_FILLER<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_FILLER_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_PACKSWAP_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
    <font color='#5555FF'>!</font><font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_PACKSWAP_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_PACKSWAP_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_PACK_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_PACK_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACK<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_PACK_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_SHIFT_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_SHIFT_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SHIFT<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_SHIFT_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_BGR_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_BGR_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BGR<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_BGR_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_WRITE_SWAP_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_SWAP_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SWAP_BYTES<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>PNG_READ_SWAP_SUPPORTED is not defined</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#009900'>/* If interlaced and we do not need a new row, combine row and return.
    * Notice that the pixels we have from previous rows have been transformed
    * already; we can only combine like with like (transformed or
    * untransformed) and, because of the libpng API for interlaced images, this
    * means we must transform before de-interlacing.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> <font color='#979000'>0</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;
               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>&lt;</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;

               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;

               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> <font color='#979000'>3</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>&lt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;

               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;

               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> <font color='#979000'>5</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;

               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>default</font>:
         <font color='#0000FF'>case</font> <font color='#979000'>6</font>:
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number <font color='#5555FF'>&amp;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
               <font color='#0000FF'>return</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IDAT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Invalid attempt to read row data</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Fill the row with IDAT data: */</font>
   <font color='#BB00BB'>png_read_IDAT_data</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf, row_info.rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf[<font color='#979000'>0</font>] <font color='#5555FF'>&gt;</font> PNG_FILTER_VALUE_NONE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf[<font color='#979000'>0</font>] <font color='#5555FF'>&lt;</font> PNG_FILTER_VALUE_LAST<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_read_filter_row</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row <font color='#5555FF'>+</font> <font color='#979000'>1</font>, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad adaptive filter value</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* libpng 1.5.6: the following line was copying png_ptr-&gt;rowbytes before
    * 1.5.6, while the buffer really is this big in current versions of libpng
    * it may not be in the future, so this was changed just to copy the
    * interlaced count:
    */</font>
   <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_row, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf, row_info.rowbytes <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_MNG_FEATURES_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mng_features_permitted <font color='#5555FF'>&amp;</font> PNG_FLAG_MNG_FILTER_64<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filter_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTRAPIXEL_DIFFERENCING<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Intrapixel differencing */</font>
      <font color='#BB00BB'>png_do_read_intrapixel</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>


<font color='#0000FF'>#ifdef</font> PNG_READ_TRANSFORMS_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_read_transformations</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>row_info<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* The transformed pixel depth should match the depth now in row_info. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformed_pixel_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformed_pixel_depth <font color='#5555FF'>=</font> row_info.pixel_depth;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info.pixel_depth <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>maximum_pixel_depth<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>sequential row overflow</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformed_pixel_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> row_info.pixel_depth<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>internal sequential row size calculation error</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#009900'>/* Blow up interlaced rows to full size */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass <font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_do_read_interlace</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass,
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#979000'>1</font><font color='#009900'>/*display*/</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, row, <font color='#979000'>0</font><font color='#009900'>/*row*/</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, row, <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#009900'>/*ignored*/</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dsp_row <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_combine_row</font><font face='Lucida Console'>(</font>png_ptr, dsp_row, <font color='#5555FF'>-</font><font color='#979000'>1</font><font color='#009900'>/*ignored*/</font><font face='Lucida Console'>)</font>;
   <b>}</b>
   <font color='#BB00BB'>png_read_finish_row</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_row_fn <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_row_fn<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_number, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pass<font face='Lucida Console'>)</font>;

<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#009900'>/* Read one or more rows of image data.  If the image is interlaced,
 * and png_set_interlace_handling() has been called, the rows need to
 * contain the contents of the rows from the previous pass.  If the
 * image has alpha or transparency, and png_handle_alpha()[*] has been
 * called, the rows contents must be initialized to the contents of the
 * screen.
 *
 * "row" holds the actual image, and pixels are placed in it
 * as they arrive.  If the image is displayed after each pass, it will
 * appear to "sparkle" in.  "display_row" can be used to display a
 * "chunky" progressive image, with finer detail added as it becomes
 * available.  If you do not want this "chunky" display, you may pass
 * NULL for display_row.  If you do not want the sparkle display, and
 * you have not called png_handle_alpha(), you may pass NULL for rows.
 * If you have called png_handle_alpha(), and the image has either an
 * alpha channel or a transparency chunk, you must provide a buffer for
 * rows.  In this case, you do not have to provide a display_row buffer
 * also, but you may.  If the image is not interlaced, or if you have
 * not called png_set_interlace_handling(), the display_row buffer will
 * be ignored, so pass NULL to it.
 *
 * [*] png_handle_alpha() does not exist yet, as of this version of libpng
 */</font>

<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_rows'></a>png_read_rows</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytepp row,
    png_bytepp display_row, png_uint_32 num_rows<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 i;
   png_bytepp rp;
   png_bytepp dp;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_rows</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   rp <font color='#5555FF'>=</font> row;
   dp <font color='#5555FF'>=</font> display_row;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>rp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> dp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_rows; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_bytep rptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
         png_bytep dptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

         <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, rptr, dptr<font face='Lucida Console'>)</font>;
      <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>rp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_rows; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_bytep rptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>rp;
         <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, rptr, NULL<font face='Lucida Console'>)</font>;
         rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_rows; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_bytep dptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>dp;
         <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, NULL, dptr<font face='Lucida Console'>)</font>;
         dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#009900'>/* Read the entire image.  If the image has an alpha channel or a tRNS
 * chunk, and you have called png_handle_alpha()[*], you will need to
 * initialize the image to the current image that PNG will be overlaying.
 * We set the num_rows again here, in case it was incorrectly set in
 * png_read_start_row() by a call to png_read_update_info() or
 * png_start_read_image() if png_set_interlace_handling() wasn't called
 * prior to either of these functions like it should have been.  You can
 * only call this function once.  If you desire to have an image for
 * each pass of a interlaced image, use png_read_rows() instead.
 *
 * [*] png_handle_alpha() does not exist yet, as of this version of libpng
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_image'></a>png_read_image</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_bytepp image<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 i, image_height;
   <font color='#0000FF'><u>int</u></font> pass, j;
   png_bytepp rp;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_image</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_INTERLACING_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ROW_INIT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      pass <font color='#5555FF'>=</font> <font color='#BB00BB'>png_set_interlace_handling</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
      <font color='#009900'>/* And make sure transforms are initialized. */</font>
      <font color='#BB00BB'>png_start_read_image</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   <b>}</b>
   <font color='#0000FF'>else</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INTERLACE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Caller called png_start_read_image or png_read_update_info without
          * first turning on the PNG_INTERLACE transform.  We can fix this here,
          * but the caller should do it!
          */</font>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Interlace handling should be turned on when </font>"
            "<font color='#CC0000'>using png_read_image</font>"<font face='Lucida Console'>)</font>;
         <font color='#009900'>/* Make sure this is set correctly */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_rows <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
      <b>}</b>

      <font color='#009900'>/* Obtain the pass number, which also turns on the PNG_INTERLACE flag in
       * the above error case.
       */</font>
      pass <font color='#5555FF'>=</font> <font color='#BB00BB'>png_set_interlace_handling</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#else</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr,
          "<font color='#CC0000'>Cannot read interlaced image -- interlace handler disabled</font>"<font face='Lucida Console'>)</font>;

   pass <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
<font color='#0000FF'>#endif</font>

   image_height<font color='#5555FF'>=</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> pass; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
   <b>{</b>
      rp <font color='#5555FF'>=</font> image;
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> image_height; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>*</font>rp, NULL<font face='Lucida Console'>)</font>;
         rp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#009900'>/* Read the end of the PNG file.  Will not read past the end of the
 * file, will verify the end is accurate, and will read any comments
 * or time information at the end of the file, if info is not NULL.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_end'></a>png_read_end</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_HANDLE_AS_UNKNOWN_SUPPORTED
   <font color='#0000FF'><u>int</u></font> keep;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_end</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* If png_read_end is called in the middle of reading the rows there may
    * still be pending IDAT data and an owned zstream.  Deal with this here.
    */</font>
<font color='#0000FF'>#ifdef</font> PNG_HANDLE_AS_UNKNOWN_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_chunk_unknown_handling</font><font face='Lucida Console'>(</font>png_ptr, png_IDAT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
      <font color='#BB00BB'>png_read_finish_IDAT</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_CHECK_FOR_INVALID_INDEX_SUPPORTED
   <font color='#009900'>/* Report invalid palette index; added at libng-1.5.10 */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette_max <font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette<font face='Lucida Console'>)</font>
     <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Read palette index exceeding num_palette</font>"<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>do</font>
   <b>{</b>
      png_uint_32 length <font color='#5555FF'>=</font> <font color='#BB00BB'>png_read_chunk_header</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
      png_uint_32 chunk_name <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_name;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IHDR<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_IHDR</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IEND<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_IEND</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_HANDLE_AS_UNKNOWN_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>keep <font color='#5555FF'>=</font> <font color='#BB00BB'>png_chunk_unknown_handling</font><font face='Lucida Console'>(</font>png_ptr, chunk_name<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_CHUNK_AFTER_IDAT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Too many IDATs found</font>"<font face='Lucida Console'>)</font>;
         <b>}</b>
         <font color='#BB00BB'>png_handle_unknown</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length, keep<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_PLTE<font face='Lucida Console'>)</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_HAVE_PLTE;
      <b>}</b>
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_IDAT<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Zero length IDATs are legal after the last IDAT has been
          * read, but not after other chunks have been read.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_CHUNK_AFTER_IDAT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_benign_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Too many IDATs found</font>"<font face='Lucida Console'>)</font>;

         <font color='#BB00BB'>png_crc_finish</font><font face='Lucida Console'>(</font>png_ptr, length<font face='Lucida Console'>)</font>;
      <b>}</b>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_PLTE<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_PLTE</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_bKGD_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_bKGD<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_bKGD</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_cHRM_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_cHRM<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_cHRM</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_gAMA_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_gAMA<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_gAMA</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_hIST_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_hIST<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_hIST</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_oFFs_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_oFFs<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_oFFs</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_pCAL_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_pCAL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_pCAL</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sCAL_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sCAL<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sCAL</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_pHYs_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_pHYs<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_pHYs</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sBIT_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sBIT<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sBIT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sRGB_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sRGB<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sRGB</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iCCP_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_iCCP<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_iCCP</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_sPLT_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_sPLT<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_sPLT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tEXt_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_tEXt<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_tEXt</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tIME_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_tIME<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_tIME</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_tRNS_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_tRNS<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_tRNS</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_zTXt_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_zTXt<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_zTXt</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_iTXt_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>chunk_name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_iTXt<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_handle_iTXt</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

      <font color='#0000FF'>else</font>
         <font color='#BB00BB'>png_handle_unknown</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, length,
            PNG_HANDLE_CHUNK_AS_DEFAULT<font face='Lucida Console'>)</font>;
   <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IEND<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#009900'>/* Free all memory used in the read struct */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_read_destroy'></a>png_read_destroy</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_destroy</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
   <font color='#BB00BB'>png_destroy_gamma_table</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_row_buf<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>big_prev_row<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_buffer<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_QUANTIZE_SUPPORTED
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_lookup<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>&amp;</font> PNG_FREE_PLTE<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_zfree</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FREE_PLTE;

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_tRNS_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
    <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_EXPAND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>&amp;</font> PNG_FREE_TRNS<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FREE_TRNS;
<font color='#0000FF'>#endif</font>

   <font color='#BB00BB'>inflateEnd</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zstream<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_PROGRESSIVE_READ_SUPPORTED
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>save_buffer<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_STORE_UNKNOWN_CHUNKS_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_UNKNOWN_CHUNKS_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>unknown_chunk.data<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_SET_UNKNOWN_CHUNKS_SUPPORTED
   <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>chunk_list<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* NOTE: the 'setjmp' buffer may still be allocated and the memory and error
    * callbacks are still set at this point.  They are required to complete the
    * destruction of the png_struct itself.
    */</font>
<b>}</b>

<font color='#009900'>/* Free all memory used by the read */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_destroy_read_struct'></a>png_destroy_read_struct</b><font face='Lucida Console'>(</font>png_structpp png_ptr_ptr, png_infopp info_ptr_ptr,
    png_infopp end_info_ptr_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_structrp png_ptr <font color='#5555FF'>=</font> NULL;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_destroy_read_struct</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      png_ptr <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>png_ptr_ptr;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* libpng 1.6.0: use the API to destroy info structs to ensure consistent
    * behavior.  Prior to 1.6.0 libpng did extra 'info' destruction in this API.
    * The extra was, apparently, unnecessary yet this hides memory leak bugs.
    */</font>
   <font color='#BB00BB'>png_destroy_info_struct</font><font face='Lucida Console'>(</font>png_ptr, end_info_ptr_ptr<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_destroy_info_struct</font><font face='Lucida Console'>(</font>png_ptr, info_ptr_ptr<font face='Lucida Console'>)</font>;

   <font color='#5555FF'>*</font>png_ptr_ptr <font color='#5555FF'>=</font> NULL;
   <font color='#BB00BB'>png_read_destroy</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_destroy_png_struct</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_read_status_fn'></a>png_set_read_status_fn</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_read_status_ptr read_row_fn<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_row_fn <font color='#5555FF'>=</font> read_row_fn;
<b>}</b>


<font color='#0000FF'>#ifdef</font> PNG_SEQUENTIAL_READ_SUPPORTED
<font color='#0000FF'>#ifdef</font> PNG_INFO_IMAGE_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_read_png'></a>png_read_png</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr,
                           <font color='#0000FF'><u>int</u></font> transforms,
                           voidp params<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> row;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> info_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* png_read_info() gives us all of the information from the
    * PNG file before the first IDAT (image data chunk).
    */</font>
   <font color='#BB00BB'>png_read_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>&gt;</font> PNG_UINT_32_MAX<font color='#5555FF'>/</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Image is too high to process with png_read_png()</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* -------------- image transformations start here ------------------- */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SCALE_16_TO_8_SUPPORTED
   <font color='#009900'>/* Tell libpng to strip 16-bit/color files down to 8 bits per color.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_SCALE_16<font face='Lucida Console'>)</font>
   <b>{</b>
     <font color='#009900'>/* Added at libpng-1.5.4. "strip_16" produces the same result that it
      * did in earlier versions, while "scale_16" is now more accurate.
      */</font>
      <font color='#BB00BB'>png_set_scale_16</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_16_TO_8_SUPPORTED
   <font color='#009900'>/* If both SCALE and STRIP are required pngrtran will effectively cancel the
    * latter by doing SCALE first.  This is ok and allows apps not to check for
    * which is supported to get the right answer.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_STRIP_16<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_strip_16</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_ALPHA_SUPPORTED
   <font color='#009900'>/* Strip alpha bytes from the input data without combining with
    * the background (not recommended).
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_STRIP_ALPHA<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_strip_alpha</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_PACK_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font>defined<font face='Lucida Console'>(</font>PNG_READ_EXPAND_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#009900'>/* Extract multiple pixels with bit depths of 1, 2, or 4 from a single
    * byte into separate bytes (useful for paletted and grayscale images).
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_PACKING<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_packing</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_PACKSWAP_SUPPORTED
   <font color='#009900'>/* Change the order of packed pixels to least significant bit first
    * (not useful if you are using png_set_packing).
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_PACKSWAP<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_packswap</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
   <font color='#009900'>/* Expand paletted colors into true RGB triplets
    * Expand grayscale images to full 8 bits from 1, 2, or 4 bits/pixel
    * Expand paletted or RGB images with transparency to full alpha
    * channels so the data will be available as RGBA quartets.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_EXPAND<font face='Lucida Console'>)</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          <font face='Lucida Console'>(</font><font color='#BB00BB'>png_get_valid</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_INFO_tRNS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_set_expand</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* We don't handle background color or gamma transformation or quantizing.
    */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_INVERT_SUPPORTED
   <font color='#009900'>/* Invert monochrome files to have 0 as white and 1 as black
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_INVERT_MONO<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_invert_mono</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SHIFT_SUPPORTED
   <font color='#009900'>/* If you want to shift the pixel values from the range [0,255] or
    * [0,65535] to the original [0,7] or [0,31], or whatever range the
    * colors were originally in:
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_SHIFT<font face='Lucida Console'>)</font>
       <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>png_get_valid</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_INFO_sBIT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_color_8p sig_bit;

      <font color='#BB00BB'>png_get_sBIT</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, <font color='#5555FF'>&amp;</font>sig_bit<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>png_set_shift</font><font face='Lucida Console'>(</font>png_ptr, sig_bit<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_BGR_SUPPORTED
   <font color='#009900'>/* Flip the RGB pixels to BGR (or RGBA to BGRA) */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_BGR<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_bgr</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SWAP_ALPHA_SUPPORTED
   <font color='#009900'>/* Swap the RGBA or GA data to ARGB or AG (or BGRA to ABGR) */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_SWAP_ALPHA<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_swap_alpha</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SWAP_SUPPORTED
   <font color='#009900'>/* Swap bytes of 16-bit files to least significant byte first */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_SWAP_ENDIAN<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_swap</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Added at libpng-1.2.41 */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_INVERT_ALPHA_SUPPORTED
   <font color='#009900'>/* Invert the alpha channel from opacity to transparency */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_INVERT_ALPHA<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_invert_alpha</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Added at libpng-1.2.41 */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
   <font color='#009900'>/* Expand grayscale image to RGB */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_GRAY_TO_RGB<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_gray_to_rgb</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Added at libpng-1.5.4 */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_16_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>transforms <font color='#5555FF'>&amp;</font> PNG_TRANSFORM_EXPAND_16<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_expand_16</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* We don't handle adding filler bytes */</font>

   <font color='#009900'>/* We use png_read_image and rely on that for interlace handling, but we also
    * call png_read_update_info therefore must turn on interlace handling now:
    */</font>
   <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>png_set_interlace_handling</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Optional call to gamma correct and add the background to the palette
    * and update info structure.  REQUIRED if you are expecting libpng to
    * update the palette for you (i.e., you selected such a transform above).
    */</font>
   <font color='#BB00BB'>png_read_update_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* -------------- image transformations end here ------------------- */</font>

   <font color='#BB00BB'>png_free_data</font><font face='Lucida Console'>(</font>png_ptr, info_ptr, PNG_FREE_ROWS, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 iptr;

      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytepp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
          info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>iptr<font color='#5555FF'>=</font><font color='#979000'>0</font>; iptr<font color='#5555FF'>&lt;</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height; iptr<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers[iptr] <font color='#5555FF'>=</font> NULL;

      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>free_me <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FREE_ROWS;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>row <font color='#5555FF'>=</font> <font color='#979000'>0</font>; row <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height; row<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers[row] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
            <font color='#BB00BB'>png_get_rowbytes</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#BB00BB'>png_read_image</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_pointers<font face='Lucida Console'>)</font>;
   info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>valid <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_INFO_IDAT;

   <font color='#009900'>/* Read rest of file, and get additional chunks in info_ptr - REQUIRED */</font>
   <font color='#BB00BB'>png_read_end</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>transforms<font face='Lucida Console'>)</font>   <font color='#009900'>/* Quiet compiler warnings */</font>
   <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>params<font face='Lucida Console'>)</font>

<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_INFO_IMAGE_SUPPORTED */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SEQUENTIAL_READ_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_SIMPLIFIED_READ_SUPPORTED
<font color='#009900'>/* SIMPLIFIED READ
 *
 * This code currently relies on the sequential reader, though it could easily
 * be made to work with the progressive one.
 */</font>
<font color='#009900'>/* Arguments to png_image_finish_read: */</font>

<font color='#009900'>/* Encoding of PNG data (used by the color-map code) */</font>
<font color='#009900'>/* TODO: change these, dang, ANSI-C reserves the 'E' namespace. */</font>
#  define E_NOTSET  <font color='#979000'>0</font> <font color='#009900'>/* File encoding not yet known */</font>
#  define E_sRGB    <font color='#979000'>1</font> <font color='#009900'>/* 8-bit encoded to sRGB gamma */</font>
#  define E_LINEAR  <font color='#979000'>2</font> <font color='#009900'>/* 16-bit linear: not encoded, NOT pre-multiplied! */</font>
#  define E_FILE    <font color='#979000'>3</font> <font color='#009900'>/* 8-bit encoded to file gamma, not sRGB or linear */</font>
#  define E_LINEAR8 <font color='#979000'>4</font> <font color='#009900'>/* 8-bit linear: only from a file value */</font>

<font color='#009900'>/* Color-map processing: after libpng has run on the PNG image further
 * processing may be needed to conver the data to color-map indicies.
 */</font>
<font color='#0000FF'>#define</font> PNG_CMAP_NONE      <font color='#979000'>0</font>
<font color='#0000FF'>#define</font> PNG_CMAP_GA        <font color='#979000'>1</font> <font color='#009900'>/* Process GA data to a color-map with alpha */</font>
<font color='#0000FF'>#define</font> PNG_CMAP_TRANS     <font color='#979000'>2</font> <font color='#009900'>/* Process GA data to a background index */</font>
<font color='#0000FF'>#define</font> PNG_CMAP_RGB       <font color='#979000'>3</font> <font color='#009900'>/* Process RGB data */</font>
<font color='#0000FF'>#define</font> PNG_CMAP_RGB_ALPHA <font color='#979000'>4</font> <font color='#009900'>/* Process RGBA data */</font>

<font color='#009900'>/* The following document where the background is for each processing case. */</font>
<font color='#0000FF'>#define</font> PNG_CMAP_NONE_BACKGROUND      <font color='#979000'>256</font>
<font color='#0000FF'>#define</font> PNG_CMAP_GA_BACKGROUND        <font color='#979000'>231</font>
<font color='#0000FF'>#define</font> PNG_CMAP_TRANS_BACKGROUND     <font color='#979000'>254</font>
<font color='#0000FF'>#define</font> PNG_CMAP_RGB_BACKGROUND       <font color='#979000'>256</font>
<font color='#0000FF'>#define</font> PNG_CMAP_RGB_ALPHA_BACKGROUND <font color='#979000'>216</font>

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font>
<b>{</b>
   <font color='#009900'>/* Arguments: */</font>
   png_imagep image;
   png_voidp  buffer;
   png_int_32 row_stride;
   png_voidp  colormap;
   png_const_colorp background;
   <font color='#009900'>/* Local variables: */</font>
   png_voidp       local_row;
   png_voidp       first_row;
   ptrdiff_t       row_bytes;           <font color='#009900'>/* step between rows */</font>
   <font color='#0000FF'><u>int</u></font>             file_encoding;       <font color='#009900'>/* E_ values above */</font>
   png_fixed_point gamma_to_linear;     <font color='#009900'>/* For E_FILE, reciprocal of gamma */</font>
   <font color='#0000FF'><u>int</u></font>             colormap_processing; <font color='#009900'>/* PNG_CMAP_ values above */</font>
<b>}</b> png_image_read_control;

<font color='#009900'>/* Do all the *safe* initialization - 'safe' means that png_error won't be
 * called, so setting up the jmp_buf is not required.  This means that anything
 * called from here must *not* call png_malloc - it has to call png_malloc_warn
 * instead so that control is returned safely back to this routine.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_init'></a>png_image_read_init</b><font face='Lucida Console'>(</font>png_imagep image<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_structp png_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_create_read_struct</font><font face='Lucida Console'>(</font>PNG_LIBPNG_VER_STRING, image,
          png_safe_error, png_safe_warning<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* And set the rest of the structure to NULL to ensure that the various
       * fields are consistent.
       */</font>
      <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>image, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>image<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>version <font color='#5555FF'>=</font> PNG_IMAGE_VERSION;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         png_infop info_ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_create_info_struct</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            png_controlp control <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_controlp,
               <font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>control<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>control <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>control, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font color='#5555FF'>*</font>control<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

               control<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr <font color='#5555FF'>=</font> png_ptr;
               control<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_ptr <font color='#5555FF'>=</font> info_ptr;
               control<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>for_write <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

               image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>=</font> control;
               <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
            <b>}</b>

            <font color='#009900'>/* Error clean up */</font>
            <font color='#BB00BB'>png_destroy_info_struct</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>info_ptr<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#BB00BB'>png_destroy_read_struct</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr, NULL, NULL<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image, "<font color='#CC0000'>png_image_read: out of memory</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image, "<font color='#CC0000'>png_image_read: opaque pointer not NULL</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Utility to find the base format of a PNG file from a png_struct. */</font>
<font color='#0000FF'>static</font> png_uint_32
<b><a name='png_image_format'></a>png_image_format</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 format <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
      format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_COLOR;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>
      format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_ALPHA;

   <font color='#009900'>/* Use png_ptr here, not info_ptr, because by examination png_handle_tRNS
    * sets the png_struct fields; that's all we are interested in here.  The
    * precise interaction with an app call to png_set_tRNS and PNG file reading
    * is unclear.
    */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_ALPHA;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
      format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_LINEAR;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_PALETTE<font face='Lucida Console'>)</font>
      format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_COLORMAP;

   <font color='#0000FF'>return</font> format;
<b>}</b>

<font color='#009900'>/* Is the given gamma significantly different from sRGB?  The test is the same
 * one used in pngrtran.c when deciding whether to do gamma correction.  The
 * arithmetic optimizes the division by using the fact that the inverse of the
 * file sRGB gamma is 2.2
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_gamma_not_sRGB'></a>png_gamma_not_sRGB</b><font face='Lucida Console'>(</font>png_fixed_point g<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>g <font color='#5555FF'>&lt;</font> PNG_FP_1<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* An uninitialized gamma is assumed to be sRGB for the simplified API. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>g <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>g <font color='#5555FF'>*</font> <font color='#979000'>11</font> <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>5</font> <font color='#009900'>/* i.e. *2.2, rounded */</font><font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>/* Do the main body of a 'png_image_begin_read' function; read the PNG file
 * header and fill in all the information.  This is executed in a safe context,
 * unlike the init routine above.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_header'></a>png_image_read_header</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_imagep image <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_imagep, argument<font face='Lucida Console'>)</font>;
   png_structrp png_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   png_inforp info_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_ptr;

   <font color='#BB00BB'>png_set_benign_errors</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>1</font><font color='#009900'>/*warn*/</font><font face='Lucida Console'>)</font>;
   <font color='#BB00BB'>png_read_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Do this the fast way; just read directly out of png_struct. */</font>
   image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;

   <b>{</b>
      png_uint_32 format <font color='#5555FF'>=</font> <font color='#BB00BB'>png_image_format</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

      image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>=</font> format;

<font color='#0000FF'>#ifdef</font> PNG_COLORSPACE_SUPPORTED
      <font color='#009900'>/* Does the colorspace match sRGB?  If there is no color endpoint
       * (colorant) information assume yes, otherwise require the
       * 'ENDPOINTS_MATCHE_sRGB' colorspace flag to have been set.  If the
       * colorspace has been determined to be invalid ignore it.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags
         <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_COLORSPACE_HAVE_ENDPOINTS<font color='#5555FF'>|</font>PNG_COLORSPACE_ENDPOINTS_MATCH_sRGB<font color='#5555FF'>|</font>
            PNG_COLORSPACE_INVALID<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_ENDPOINTS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_IMAGE_FLAG_COLORSPACE_NOT_sRGB;
<font color='#0000FF'>#endif</font>
   <b>}</b>

   <font color='#009900'>/* We need the maximum number of entries regardless of the format the
    * application sets here.
    */</font>
   <b>{</b>
      png_uint_32 cmap_entries;

      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY:
            cmap_entries <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_PALETTE:
            cmap_entries <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette;
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>default</font>:
            cmap_entries <font color='#5555FF'>=</font> <font color='#979000'>256</font>;
            <font color='#0000FF'>break</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cmap_entries <font color='#5555FF'>&gt;</font> <font color='#979000'>256</font><font face='Lucida Console'>)</font>
         cmap_entries <font color='#5555FF'>=</font> <font color='#979000'>256</font>;

      image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries <font color='#5555FF'>=</font> cmap_entries;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_STDIO_SUPPORTED
<font color='#0000FF'><u>int</u></font> PNGAPI
<b><a name='png_image_begin_read_from_stdio'></a>png_image_begin_read_from_stdio</b><font face='Lucida Console'>(</font>png_imagep image, FILE<font color='#5555FF'>*</font> file<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>version <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_IMAGE_VERSION<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>file <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_image_read_init</font><font face='Lucida Console'>(</font>image<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This is slightly evil, but png_init_io doesn't do anything other
             * than this and we haven't changed the standard IO functions so
             * this saves a 'safe' function.
             */</font>
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr <font color='#5555FF'>=</font> file;
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_header, image<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
            "<font color='#CC0000'>png_image_begin_read_from_stdio: invalid argument</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
         "<font color='#CC0000'>png_image_begin_read_from_stdio: incorrect PNG_IMAGE_VERSION</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#0000FF'><u>int</u></font> PNGAPI
<b><a name='png_image_begin_read_from_file'></a>png_image_begin_read_from_file</b><font face='Lucida Console'>(</font>png_imagep image, <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>file_name<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>version <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_IMAGE_VERSION<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>file_name <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         FILE <font color='#5555FF'>*</font>fp <font color='#5555FF'>=</font> <font color='#BB00BB'>fopen</font><font face='Lucida Console'>(</font>file_name, "<font color='#CC0000'>rb</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>fp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_image_read_init</font><font face='Lucida Console'>(</font>image<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <b>{</b>
               image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr <font color='#5555FF'>=</font> fp;
               image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>owned_file <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <font color='#0000FF'>return</font> <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_header, image<font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#009900'>/* Clean up: just the opened file. */</font>
            <font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#BB00BB'>fclose</font><font face='Lucida Console'>(</font>fp<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image, <font color='#BB00BB'>strerror</font><font face='Lucida Console'>(</font>errno<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
            "<font color='#CC0000'>png_image_begin_read_from_file: invalid argument</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
         "<font color='#CC0000'>png_image_begin_read_from_file: incorrect PNG_IMAGE_VERSION</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_STDIO_SUPPORTED */</font>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> PNGCBAPI
<b><a name='png_image_memory_read'></a>png_image_memory_read</b><font face='Lucida Console'>(</font>png_structp png_ptr, png_bytep out, png_size_t need<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_imagep image <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_imagep, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         png_controlp cp <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque;
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cp <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            png_const_bytep memory <font color='#5555FF'>=</font> cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>memory;
            png_size_t size <font color='#5555FF'>=</font> cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>size;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>memory <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> size <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> need<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#BB00BB'>memcpy</font><font face='Lucida Console'>(</font>out, memory, need<font face='Lucida Console'>)</font>;
               cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>memory <font color='#5555FF'>=</font> memory <font color='#5555FF'>+</font> need;
               cp<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>size <font color='#5555FF'>=</font> size <font color='#5555FF'>-</font> need;
               <font color='#0000FF'>return</font>;
            <b>}</b>

            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>read beyond end of data</font>"<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>

      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid memory read</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'><u>int</u></font> PNGAPI <b><a name='png_image_begin_read_from_memory'></a>png_image_begin_read_from_memory</b><font face='Lucida Console'>(</font>png_imagep image,
   png_const_voidp memory, png_size_t size<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>version <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_IMAGE_VERSION<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>memory <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> size <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_image_read_init</font><font face='Lucida Console'>(</font>image<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Now set the IO functions to read from the memory buffer and
             * store it into io_ptr.  Again do this in-place to avoid calling a
             * libpng function that requires error handling.
             */</font>
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>memory <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_const_bytep, memory<font face='Lucida Console'>)</font>;
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>size <font color='#5555FF'>=</font> size;
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>io_ptr <font color='#5555FF'>=</font> image;
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_data_fn <font color='#5555FF'>=</font> png_image_memory_read;

            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_header, image<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
            "<font color='#CC0000'>png_image_begin_read_from_memory: invalid argument</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
         "<font color='#CC0000'>png_image_begin_read_from_memory: incorrect PNG_IMAGE_VERSION</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#009900'>/* Utility function to skip chunks that are not used by the simplified image
 * read functions and an appropriate macro to call it.
 */</font>
<font color='#0000FF'>#ifdef</font> PNG_HANDLE_AS_UNKNOWN_SUPPORTED
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_image_skip_unused_chunks'></a>png_image_skip_unused_chunks</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Prepare the reader to ignore all recognized chunks whose data will not
    * be used, i.e., all chunks recognized by libpng except for those
    * involved in basic image reading:
    *
    *    IHDR, PLTE, IDAT, IEND
    *
    * Or image data handling:
    *
    *    tRNS, bKGD, gAMA, cHRM, sRGB, iCCP and sBIT.
    *
    * This provides a small performance improvement and eliminates any
    * potential vulnerability to security problems in the unused chunks.
    */</font>
   <b>{</b>
         <font color='#0000FF'>static</font> PNG_CONST png_byte chunks_to_process[] <font color='#5555FF'>=</font> <b>{</b>
            <font color='#979000'>98</font>,  <font color='#979000'>75</font>,  <font color='#979000'>71</font>,  <font color='#979000'>68</font>, '<font color='#FF0000'>\0</font>',  <font color='#009900'>/* bKGD */</font>
            <font color='#979000'>99</font>,  <font color='#979000'>72</font>,  <font color='#979000'>82</font>,  <font color='#979000'>77</font>, '<font color='#FF0000'>\0</font>',  <font color='#009900'>/* cHRM */</font>
           <font color='#979000'>103</font>,  <font color='#979000'>65</font>,  <font color='#979000'>77</font>,  <font color='#979000'>65</font>, '<font color='#FF0000'>\0</font>',  <font color='#009900'>/* gAMA */</font>
           <font color='#979000'>105</font>,  <font color='#979000'>67</font>,  <font color='#979000'>67</font>,  <font color='#979000'>80</font>, '<font color='#FF0000'>\0</font>',  <font color='#009900'>/* iCCP */</font>
           <font color='#979000'>115</font>,  <font color='#979000'>66</font>,  <font color='#979000'>73</font>,  <font color='#979000'>84</font>, '<font color='#FF0000'>\0</font>',  <font color='#009900'>/* sBIT */</font>
           <font color='#979000'>115</font>,  <font color='#979000'>82</font>,  <font color='#979000'>71</font>,  <font color='#979000'>66</font>, '<font color='#FF0000'>\0</font>',  <font color='#009900'>/* sRGB */</font>
           <b>}</b>;

       <font color='#009900'>/* Ignore unknown chunks and all other chunks except for the
        * IHDR, PLTE, tRNS, IDAT, and IEND chunks.
        */</font>
       <font color='#BB00BB'>png_set_keep_unknown_chunks</font><font face='Lucida Console'>(</font>png_ptr, PNG_HANDLE_CHUNK_NEVER,
         NULL, <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

       <font color='#009900'>/* But do not ignore image data handling chunks */</font>
       <font color='#BB00BB'>png_set_keep_unknown_chunks</font><font face='Lucida Console'>(</font>png_ptr, PNG_HANDLE_CHUNK_AS_DEFAULT,
         chunks_to_process, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> chunks_to_process<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>5</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>

#  define <b><a name='PNG_SKIP_CHUNKS'></a>PNG_SKIP_CHUNKS</b><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font> <b><a name='png_image_skip_unused_chunks'></a>png_image_skip_unused_chunks</b><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
#  define <b><a name='PNG_SKIP_CHUNKS'></a>PNG_SKIP_CHUNKS</b><font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_HANDLE_AS_UNKNOWN_SUPPORTED */</font>

<font color='#009900'>/* The following macro gives the exact rounded answer for all values in the
 * range 0..255 (it actually divides by 51.2, but the rounding still generates
 * the correct numbers 0..5
 */</font>
<font color='#0000FF'>#define</font> PNG_DIV51<font face='Lucida Console'>(</font>v8<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v8<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>5</font> <font color='#5555FF'>+</font> <font color='#979000'>130</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>

<font color='#009900'>/* Utility functions to make particular color-maps */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='set_file_encoding'></a>set_file_encoding</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display<font face='Lucida Console'>)</font>
<b>{</b>
   png_fixed_point g <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_not_sRGB</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding <font color='#5555FF'>=</font> E_FILE;
         display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_linear <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
         display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding <font color='#5555FF'>=</font> E_sRGB;
   <b>}</b>

   <font color='#0000FF'>else</font>
      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding <font color='#5555FF'>=</font> E_LINEAR8;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font>
<b><a name='decode_gamma'></a>decode_gamma</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display, png_uint_32 value, <font color='#0000FF'><u>int</u></font> encoding<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_FILE<font face='Lucida Console'>)</font> <font color='#009900'>/* double check */</font>
      encoding <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_NOTSET<font face='Lucida Console'>)</font> <font color='#009900'>/* must be the file encoding */</font>
   <b>{</b>
      <font color='#BB00BB'>set_file_encoding</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;
      encoding <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding;
   <b>}</b>

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>encoding<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> E_FILE:
         value <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>value<font color='#5555FF'>*</font><font color='#979000'>257</font>, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_linear<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> E_sRGB:
         value <font color='#5555FF'>=</font> png_sRGB_table[value];
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> E_LINEAR:
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> E_LINEAR8:
         value <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr,
            "<font color='#CC0000'>unexpected encoding (internal error)</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> value;
<b>}</b>

<font color='#0000FF'>static</font> png_uint_32
<b><a name='png_colormap_compose'></a>png_colormap_compose</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display,
   png_uint_32 foreground, <font color='#0000FF'><u>int</u></font> foreground_encoding, png_uint_32 alpha,
   png_uint_32 background, <font color='#0000FF'><u>int</u></font> encoding<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The file value is composed on the background, the background has the given
    * encoding and so does the result, the file is encoded with E_FILE and the
    * file and alpha are 8-bit values.  The (output) encoding will always be
    * E_LINEAR or E_sRGB.
    */</font>
   png_uint_32 f <font color='#5555FF'>=</font> <font color='#BB00BB'>decode_gamma</font><font face='Lucida Console'>(</font>display, foreground, foreground_encoding<font face='Lucida Console'>)</font>;
   png_uint_32 b <font color='#5555FF'>=</font> <font color='#BB00BB'>decode_gamma</font><font face='Lucida Console'>(</font>display, background, encoding<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The alpha is always an 8-bit value (it comes from the palette), the value
    * scaled by 255 is what PNG_sRGB_FROM_LINEAR requires.
    */</font>
   f <font color='#5555FF'>=</font> f <font color='#5555FF'>*</font> alpha <font color='#5555FF'>+</font> b <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Scale to 65535; divide by 255, approximately (in fact this is extremely
       * accurate, it divides by 255.00000005937181414556, with no overflow.)
       */</font>
      f <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>; <font color='#009900'>/* Now scaled by 65535 */</font>
      f <font color='#5555FF'>+</font><font color='#5555FF'>=</font> f <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font>;
      f <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>f<font color='#5555FF'>+</font><font color='#979000'>32768</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#009900'>/* E_sRGB */</font>
      f <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> f;
<b>}</b>

<font color='#009900'>/* NOTE: E_LINEAR values to this routine must be 16-bit, but E_FILE values must
 * be 8-bit.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font>
<b><a name='png_create_colormap_entry'></a>png_create_colormap_entry</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display,
   png_uint_32 ip, png_uint_32 red, png_uint_32 green, png_uint_32 blue,
   png_uint_32 alpha, <font color='#0000FF'><u>int</u></font> encoding<font face='Lucida Console'>)</font>
<b>{</b>
   png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;
   <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> output_encoding <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_LINEAR<font face='Lucida Console'>)</font> ?
      E_LINEAR : E_sRGB;
   <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> convert_to_Y <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> green <font color='#5555FF'>|</font><font color='#5555FF'>|</font> green <font color='#5555FF'>!</font><font color='#5555FF'>=</font> blue<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ip <font color='#5555FF'>&gt;</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr, "<font color='#CC0000'>color-map index out of range</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Update the cache with whether the file gamma is significantly different
    * from sRGB.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_FILE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_NOTSET<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>set_file_encoding</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Note that the cached value may be E_FILE too, but if it is then the
       * gamma_to_linear member has been set.
       */</font>
      encoding <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>file_encoding;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_FILE<font face='Lucida Console'>)</font>
   <b>{</b>
      png_fixed_point g <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_linear;

      red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>red<font color='#5555FF'>*</font><font color='#979000'>257</font>, g<font face='Lucida Console'>)</font>;
      green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>green<font color='#5555FF'>*</font><font color='#979000'>257</font>, g<font face='Lucida Console'>)</font>;
      blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>blue<font color='#5555FF'>*</font><font color='#979000'>257</font>, g<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>convert_to_Y <font color='#5555FF'>|</font><font color='#5555FF'>|</font> output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
      <b>{</b>
         alpha <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
         encoding <font color='#5555FF'>=</font> E_LINEAR;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         red <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>red <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
         green <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>green <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
         blue <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>blue <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
         encoding <font color='#5555FF'>=</font> E_sRGB;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR8<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* This encoding occurs quite frequently in test cases because PngSuite
       * includes a gAMA 1.0 chunk with most images.
       */</font>
      red <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
      green <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
      blue <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
      alpha <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
      encoding <font color='#5555FF'>=</font> E_LINEAR;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_sRGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>convert_to_Y <font color='#5555FF'>|</font><font color='#5555FF'>|</font> output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* The values are 8-bit sRGB values, but must be converted to 16-bit
       * linear.
       */</font>
      red <font color='#5555FF'>=</font> png_sRGB_table[red];
      green <font color='#5555FF'>=</font> png_sRGB_table[green];
      blue <font color='#5555FF'>=</font> png_sRGB_table[blue];
      alpha <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font>;
      encoding <font color='#5555FF'>=</font> E_LINEAR;
   <b>}</b>

   <font color='#009900'>/* This is set if the color isn't gray but the output is. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>convert_to_Y<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* NOTE: these values are copied from png_do_rgb_to_gray */</font>
         png_uint_32 y <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#979000'>6968</font> <font color='#5555FF'>*</font> red  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#979000'>23434</font> <font color='#5555FF'>*</font> green <font color='#5555FF'>+</font>
            <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font color='#979000'>2366</font> <font color='#5555FF'>*</font> blue;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
            y <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>y <font color='#5555FF'>+</font> <font color='#979000'>16384</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>15</font>;

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* y is scaled by 32768, we need it scaled by 255: */</font>
            y <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>y <font color='#5555FF'>+</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>;
            y <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>255</font>;
            y <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>y <font color='#5555FF'>+</font> <font color='#979000'>64</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>;
            encoding <font color='#5555FF'>=</font> E_sRGB;
         <b>}</b>

         blue <font color='#5555FF'>=</font> red <font color='#5555FF'>=</font> green <font color='#5555FF'>=</font> y;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_sRGB<font face='Lucida Console'>)</font>
      <b>{</b>
         red <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>red <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
         green <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>green <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
         blue <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>blue <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
         alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_DIV257</font><font face='Lucida Console'>(</font>alpha<font face='Lucida Console'>)</font>;
         encoding <font color='#5555FF'>=</font> E_sRGB;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>encoding <font color='#5555FF'>!</font><font color='#5555FF'>=</font> output_encoding<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr, "<font color='#CC0000'>bad encoding (internal error)</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Store the value. */</font>
   <b>{</b>
#     ifdef PNG_FORMAT_BGR_SUPPORTED
         <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> afirst <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_AFIRST<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
#     <font color='#0000FF'>else</font>
#        define afirst <font color='#979000'>0</font>
#     endif
#     ifdef PNG_FORMAT_BGR_SUPPORTED
         <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> bgr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_BGR<font face='Lucida Console'>)</font> ? <font color='#979000'>2</font> : <font color='#979000'>0</font>;
#     <font color='#0000FF'>else</font>
#        define bgr <font color='#979000'>0</font>
#     endif

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_16p entry <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_uint_16p, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap<font face='Lucida Console'>)</font>;

         entry <font color='#5555FF'>+</font><font color='#5555FF'>=</font> ip <font color='#5555FF'>*</font> <font color='#BB00BB'>PNG_IMAGE_SAMPLE_CHANNELS</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* The linear 16-bit values must be pre-multiplied by the alpha channel
          * value, if less than 65535 (this is, effectively, composite on black
          * if the alpha channel is removed.)
          */</font>
         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_IMAGE_SAMPLE_CHANNELS</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
               entry[afirst ? <font color='#979000'>0</font> : <font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>alpha;
               <font color='#009900'>/* FALL THROUGH */</font>

            <font color='#0000FF'>case</font> <font color='#979000'>3</font>:
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>65535</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>blue <font color='#5555FF'>*</font> alpha <font color='#5555FF'>+</font> <font color='#979000'>32767</font>U<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>65535</font>U;
                     green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>green <font color='#5555FF'>*</font> alpha <font color='#5555FF'>+</font> <font color='#979000'>32767</font>U<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>65535</font>U;
                     red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>*</font> alpha <font color='#5555FF'>+</font> <font color='#979000'>32767</font>U<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>65535</font>U;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     red <font color='#5555FF'>=</font> green <font color='#5555FF'>=</font> blue <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>
               entry[afirst <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#979000'>2</font> ^ bgr<font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>blue;
               entry[afirst <font color='#5555FF'>+</font> <font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>green;
               entry[afirst <font color='#5555FF'>+</font> bgr] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>red;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               entry[<font color='#979000'>1</font> ^ afirst] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>alpha;
               <font color='#009900'>/* FALL THROUGH */</font>

            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>65535</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>green <font color='#5555FF'>*</font> alpha <font color='#5555FF'>+</font> <font color='#979000'>32767</font>U<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>65535</font>U;

                  <font color='#0000FF'>else</font>
                     green <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>
               entry[afirst] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>green;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>:
               <font color='#0000FF'>break</font>;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#009900'>/* output encoding is E_sRGB */</font>
      <b>{</b>
         png_bytep entry <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap<font face='Lucida Console'>)</font>;

         entry <font color='#5555FF'>+</font><font color='#5555FF'>=</font> ip <font color='#5555FF'>*</font> <font color='#BB00BB'>PNG_IMAGE_SAMPLE_CHANNELS</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_IMAGE_SAMPLE_CHANNELS</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
               entry[afirst ? <font color='#979000'>0</font> : <font color='#979000'>3</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>alpha;
            <font color='#0000FF'>case</font> <font color='#979000'>3</font>:
               entry[afirst <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#979000'>2</font> ^ bgr<font face='Lucida Console'>)</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>blue;
               entry[afirst <font color='#5555FF'>+</font> <font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>green;
               entry[afirst <font color='#5555FF'>+</font> bgr] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>red;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               entry[<font color='#979000'>1</font> ^ afirst] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>alpha;
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               entry[afirst] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>green;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>:
               <font color='#0000FF'>break</font>;
         <b>}</b>
      <b>}</b>

#     ifdef afirst
#        undef afirst
#     endif
#     ifdef bgr
#        undef bgr
#     endif
   <b>}</b>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='make_gray_file_colormap'></a>make_gray_file_colormap</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i, i, i, i, <font color='#979000'>255</font>, E_FILE<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> i;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='make_gray_colormap'></a>make_gray_colormap</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i, i, i, i, <font color='#979000'>255</font>, E_sRGB<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> i;
<b>}</b>
<font color='#0000FF'>#define</font> PNG_GRAY_COLORMAP_ENTRIES <font color='#979000'>256</font>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='make_ga_colormap'></a>make_ga_colormap</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i, a;

   <font color='#009900'>/* Alpha is retained, the output will be a color-map with entries
    * selected by six levels of alpha.  One transparent entry, 6 gray
    * levels for all the intermediate alpha values, leaving 230 entries
    * for the opaque grays.  The color-map entries are the six values
    * [0..5]*51, the GA processing uses PNG_DIV51(value) to find the
    * relevant entry.
    *
    * if (alpha &gt; 229) // opaque
    * {
    *    // The 231 entries are selected to make the math below work:
    *    base = 0;
    *    entry = (231 * gray + 128) &gt;&gt; 8;
    * }
    * else if (alpha &lt; 26) // transparent
    * {
    *    base = 231;
    *    entry = 0;
    * }
    * else // partially opaque
    * {
    *    base = 226 + 6 * PNG_DIV51(alpha);
    *    entry = PNG_DIV51(gray);
    * }
    */</font>
   i <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>&lt;</font> <font color='#979000'>231</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> gray <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>*</font> <font color='#979000'>256</font> <font color='#5555FF'>+</font> <font color='#979000'>115</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#979000'>231</font>;
      <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, gray, gray, gray, <font color='#979000'>255</font>, E_sRGB<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* 255 is used here for the component values for consistency with the code
    * that undoes premultiplication in pngwrite.c.
    */</font>
   <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, <font color='#979000'>255</font>, <font color='#979000'>255</font>, <font color='#979000'>255</font>, <font color='#979000'>0</font>, E_sRGB<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>a<font color='#5555FF'>=</font><font color='#979000'>1</font>; a<font color='#5555FF'>&lt;</font><font color='#979000'>5</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>a<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> g;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>g<font color='#5555FF'>=</font><font color='#979000'>0</font>; g<font color='#5555FF'>&lt;</font><font color='#979000'>6</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>g<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, g<font color='#5555FF'>*</font><font color='#979000'>51</font>, g<font color='#5555FF'>*</font><font color='#979000'>51</font>, g<font color='#5555FF'>*</font><font color='#979000'>51</font>, a<font color='#5555FF'>*</font><font color='#979000'>51</font>,
            E_sRGB<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> i;
<b>}</b>

<font color='#0000FF'>#define</font> PNG_GA_COLORMAP_ENTRIES <font color='#979000'>256</font>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='make_rgb_colormap'></a>make_rgb_colormap</b><font face='Lucida Console'>(</font>png_image_read_control <font color='#5555FF'>*</font>display<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i, r;

   <font color='#009900'>/* Build a 6x6x6 opaque RGB cube */</font>
   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font>r<font color='#5555FF'>=</font><font color='#979000'>0</font>; r<font color='#5555FF'>&lt;</font><font color='#979000'>6</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>r<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> g;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>g<font color='#5555FF'>=</font><font color='#979000'>0</font>; g<font color='#5555FF'>&lt;</font><font color='#979000'>6</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>g<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> b;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>b<font color='#5555FF'>=</font><font color='#979000'>0</font>; b<font color='#5555FF'>&lt;</font><font color='#979000'>6</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>b<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, r<font color='#5555FF'>*</font><font color='#979000'>51</font>, g<font color='#5555FF'>*</font><font color='#979000'>51</font>, b<font color='#5555FF'>*</font><font color='#979000'>51</font>, <font color='#979000'>255</font>,
               E_sRGB<font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> i;
<b>}</b>

<font color='#0000FF'>#define</font> PNG_RGB_COLORMAP_ENTRIES <font color='#979000'>216</font>

<font color='#009900'>/* Return a palette index to the above palette given three 8-bit sRGB values. */</font>
<font color='#0000FF'>#define</font> PNG_RGB_INDEX<font face='Lucida Console'>(</font>r,g,b<font face='Lucida Console'>)</font> \
   <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>6</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#979000'>6</font> <font color='#5555FF'>*</font> <font color='#BB00BB'>PNG_DIV51</font><font face='Lucida Console'>(</font>r<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>PNG_DIV51</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>PNG_DIV51</font><font face='Lucida Console'>(</font>b<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_colormap'></a>png_image_read_colormap</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_image_read_control <font color='#5555FF'>*</font>display <font color='#5555FF'>=</font>
      <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_image_read_control<font color='#5555FF'>*</font>, argument<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>const</font> png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;

   <font color='#0000FF'>const</font> png_structrp png_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   <font color='#0000FF'>const</font> png_uint_32 output_format <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format;
   <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> output_encoding <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_LINEAR<font face='Lucida Console'>)</font> ?
      E_LINEAR : E_sRGB;

   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> cmap_entries;
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> output_processing;        <font color='#009900'>/* Output processing option */</font>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> data_encoding <font color='#5555FF'>=</font> E_NOTSET; <font color='#009900'>/* Encoding libpng must produce */</font>

   <font color='#009900'>/* Background information; the background color and the index of this color
    * in the color-map if it exists (else 256).
    */</font>
   <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> background_index <font color='#5555FF'>=</font> <font color='#979000'>256</font>;
   png_uint_32 back_r, back_g, back_b;

   <font color='#009900'>/* Flags to accumulate things that need to be done to the input. */</font>
   <font color='#0000FF'><u>int</u></font> expand_tRNS <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* Exclude the NYI feature of compositing onto a color-mapped buffer; it is
    * very difficult to do, the results look awful, and it is difficult to see
    * what possible use it is because the application can't control the
    * color-map.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* alpha in input */</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* no alpha in output */</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font> <font color='#009900'>/* compose on black */</font>
         back_b <font color='#5555FF'>=</font> back_g <font color='#5555FF'>=</font> back_r <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL <font color='#009900'>/* no way to remove it */</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr,
            "<font color='#CC0000'>a background color must be supplied to remove alpha/transparency</font>"<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* Get a copy of the background color (this avoids repeating the checks
       * below.)  The encoding is 8-bit sRGB or 16-bit linear, depending on the
       * output format.
       */</font>
      <font color='#0000FF'>else</font>
      <b>{</b>
         back_g <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font>
         <b>{</b>
            back_r <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red;
            back_b <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue;
         <b>}</b>
         <font color='#0000FF'>else</font>
            back_b <font color='#5555FF'>=</font> back_r <font color='#5555FF'>=</font> back_g;
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
      back_b <font color='#5555FF'>=</font> back_r <font color='#5555FF'>=</font> back_g <font color='#5555FF'>=</font> <font color='#979000'>65535</font>;

   <font color='#0000FF'>else</font>
      back_b <font color='#5555FF'>=</font> back_r <font color='#5555FF'>=</font> back_g <font color='#5555FF'>=</font> <font color='#979000'>255</font>;

   <font color='#009900'>/* Default the input file gamma if required - this is necessary because
    * libpng assumes that if no gamma information is present the data is in the
    * output format, but the simplified API deduces the gamma from the input
    * format.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>&amp;</font> PNG_COLORSPACE_HAVE_GAMMA<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Do this directly, not using the png_colorspace functions, to ensure
       * that it happens even if the colorspace is invalid (though probably if
       * it is the setting will be ignored)  Note that the same thing can be
       * achieved at the application interface with png_set_gAMA.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_IMAGE_FLAG_16BIT_sRGB<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> PNG_GAMMA_LINEAR;

      <font color='#0000FF'>else</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> PNG_GAMMA_sRGB_INVERSE;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_GAMMA;
   <b>}</b>

   <font color='#009900'>/* Decide what to do based on the PNG color type of the input data.  The
    * utility function png_create_colormap_entry deals with most aspects of the
    * output transformations; this code works out how to produce bytes of
    * color-map entries from the original format.
    */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* There at most 256 colors in the output, regardless of
             * transparency.
             */</font>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> step, i, val, trans <font color='#5555FF'>=</font> <font color='#979000'>256</font><font color='#009900'>/*ignore*/</font>, back_alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            cmap_entries <font color='#5555FF'>=</font> <font color='#979000'>1</font>U <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cmap_entries <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gray[8] color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

            step <font color='#5555FF'>=</font> <font color='#979000'>255</font> <font color='#5555FF'>/</font> <font face='Lucida Console'>(</font>cmap_entries <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            output_processing <font color='#5555FF'>=</font> PNG_CMAP_NONE;

            <font color='#009900'>/* If there is a tRNS chunk then this either selects a transparent
             * value or, if the output has no alpha, the background color.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               trans <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  back_alpha <font color='#5555FF'>=</font> output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR ? <font color='#979000'>65535</font> : <font color='#979000'>255</font>;
            <b>}</b>

            <font color='#009900'>/* png_create_colormap_entry just takes an RGBA and writes the
             * corresponding color-map entry using the format from 'image',
             * including the required conversion to sRGB or linear as
             * appropriate.  The input values are always either sRGB (if the
             * gamma correction flag is 0) or 0..255 scaled file encoded values
             * (if the function must gamma correct them).
             */</font>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font>val<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font>cmap_entries; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i, val <font color='#5555FF'>+</font><font color='#5555FF'>=</font> step<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* 'i' is a file value.  While this will result in duplicated
                * entries for 8-bit non-sRGB encoded files it is necessary to
                * have non-gamma corrected values to do tRNS handling.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>!</font><font color='#5555FF'>=</font> trans<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i, val, val, val, <font color='#979000'>255</font>,
                     E_FILE<font color='#009900'>/*8-bit with file gamma*/</font><font face='Lucida Console'>)</font>;

               <font color='#009900'>/* Else this entry is transparent.  The colors don't matter if
                * there is an alpha channel (back_alpha == 0), but it does no
                * harm to pass them in; the values are not set above so this
                * passes in white.
                *
                * NOTE: this preserves the full precision of the application
                * supplied background color when it is used.
                */</font>
               <font color='#0000FF'>else</font>
                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i, back_r, back_g, back_b,
                     back_alpha, output_encoding<font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#009900'>/* We need libpng to preserve the original encoding. */</font>
            data_encoding <font color='#5555FF'>=</font> E_FILE;

            <font color='#009900'>/* The rows from libpng, while technically gray values, are now also
             * color-map indicies; however, they may need to be expanded to 1
             * byte per pixel.  This is what png_set_packing does (i.e., it
             * unpacks the bit values into bytes.)
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_set_packing</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#009900'>/* bit depth is 16 */</font>
         <b>{</b>
            <font color='#009900'>/* The 16-bit input values can be converted directly to 8-bit gamma
             * encoded values; however, if a tRNS chunk is present 257 color-map
             * entries are required.  This means that the extra entry requires
             * special processing; add an alpha channel, sacrifice gray level
             * 254 and convert transparent (alpha==0) entries to that.
             *
             * Use libpng to chop the data to 8 bits.  Convert it to sRGB at the
             * same time to minimize quality loss.  If a tRNS chunk is present
             * this means libpng must handle it too; otherwise it is impossible
             * to do the exact match on the 16-bit value.
             *
             * If the output has no alpha channel *and* the background color is
             * gray then it is possible to let libpng handle the substitution by
             * ensuring that the corresponding gray level matches the background
             * color exactly.
             */</font>
            data_encoding <font color='#5555FF'>=</font> E_sRGB;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_GRAY_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gray[16] color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

            cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_gray_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> back_alpha;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
                  back_alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

               <font color='#0000FF'>else</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>back_r <font color='#5555FF'>=</font><font color='#5555FF'>=</font> back_g <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> back_g <font color='#5555FF'>=</font><font color='#5555FF'>=</font> back_b<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* Background is gray; no special processing will be
                      * required.
                      */</font>
                     png_color_16 c;
                     png_uint_32 gray <font color='#5555FF'>=</font> back_g;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
                     <b>{</b>
                        gray <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>gray <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;

                        <font color='#009900'>/* And make sure the corresponding palette entry
                         * matches.
                         */</font>
                        <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, gray, back_g, back_g,
                           back_g, <font color='#979000'>65535</font>, E_LINEAR<font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#009900'>/* The background passed to libpng, however, must be the
                      * sRGB value.
                      */</font>
                     c.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/*unused*/</font>
                     c.gray <font color='#5555FF'>=</font> c.red <font color='#5555FF'>=</font> c.green <font color='#5555FF'>=</font> c.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>gray;

                     <font color='#009900'>/* NOTE: does this work without expanding tRNS to alpha?
                      * It should be the color-&gt;gray case below apparently
                      * doesn't.
                      */</font>
                     <font color='#BB00BB'>png_set_background_fixed</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>c,
                        PNG_BACKGROUND_GAMMA_SCREEN, <font color='#979000'>0</font><font color='#009900'>/*need_expand*/</font>,
                        <font color='#979000'>0</font><font color='#009900'>/*gamma: not used*/</font><font face='Lucida Console'>)</font>;

                     output_processing <font color='#5555FF'>=</font> PNG_CMAP_NONE;
                     <font color='#0000FF'>break</font>;
                  <b>}</b>

                  back_alpha <font color='#5555FF'>=</font> output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR ? <font color='#979000'>65535</font> : <font color='#979000'>255</font>;
               <b>}</b>

               <font color='#009900'>/* output_processing means that the libpng-processed row will be
                * 8-bit GA and it has to be processing to single byte color-map
                * values.  Entry 254 is replaced by either a completely
                * transparent entry or by the background color at full
                * precision (and the background color is not a simple gray leve
                * in this case.)
                */</font>
               expand_tRNS <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               output_processing <font color='#5555FF'>=</font> PNG_CMAP_TRANS;
               background_index <font color='#5555FF'>=</font> <font color='#979000'>254</font>;

               <font color='#009900'>/* And set (overwrite) color-map entry 254 to the actual
                * background color at full precision.
                */</font>
               <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, <font color='#979000'>254</font>, back_r, back_g, back_b,
                  back_alpha, output_encoding<font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#0000FF'>else</font>
               output_processing <font color='#5555FF'>=</font> PNG_CMAP_NONE;
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY_ALPHA:
         <font color='#009900'>/* 8-bit or 16-bit PNG with two channels - gray and alpha.  A minimum
          * of 65536 combinations.  If, however, the alpha channel is to be
          * removed there are only 256 possibilities if the background is gray.
          * (Otherwise there is a subset of the 65536 possibilities defined by
          * the triangle between black, white and the background color.)
          *
          * Reduce 16-bit files to 8-bit and sRGB encode the result.  No need to
          * worry about tRNS matching - tRNS is ignored if there is an alpha
          * channel.
          */</font>
         data_encoding <font color='#5555FF'>=</font> E_sRGB;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_GA_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gray+alpha color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

            cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_ga_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

            background_index <font color='#5555FF'>=</font> PNG_CMAP_GA_BACKGROUND;
            output_processing <font color='#5555FF'>=</font> PNG_CMAP_GA;
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#009900'>/* alpha is removed */</font>
         <b>{</b>
            <font color='#009900'>/* Alpha must be removed as the PNG data is processed when the
             * background is a color because the G and A channels are
             * independent and the vector addition (non-parallel vectors) is a
             * 2-D problem.
             *
             * This can be reduced to the same algorithm as above by making a
             * colormap containing gray levels (for the opaque grays), a
             * background entry (for a transparent pixel) and a set of four six
             * level color values, one set for each intermediate alpha value.
             * See the comments in make_ga_colormap for how this works in the
             * per-pixel processing.
             *
             * If the background is gray, however, we only need a 256 entry gray
             * level color map.  It is sufficient to make the entry generated
             * for the background color be exactly the color specified.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
               <font face='Lucida Console'>(</font>back_r <font color='#5555FF'>=</font><font color='#5555FF'>=</font> back_g <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> back_g <font color='#5555FF'>=</font><font color='#5555FF'>=</font> back_b<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Background is gray; no special processing will be required. */</font>
               png_color_16 c;
               png_uint_32 gray <font color='#5555FF'>=</font> back_g;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_GRAY_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gray-alpha color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

               cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_gray_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
               <b>{</b>
                  gray <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>gray <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;

                  <font color='#009900'>/* And make sure the corresponding palette entry matches. */</font>
                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, gray, back_g, back_g,
                     back_g, <font color='#979000'>65535</font>, E_LINEAR<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#009900'>/* The background passed to libpng, however, must be the sRGB
                * value.
                */</font>
               c.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/*unused*/</font>
               c.gray <font color='#5555FF'>=</font> c.red <font color='#5555FF'>=</font> c.green <font color='#5555FF'>=</font> c.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>gray;

               <font color='#BB00BB'>png_set_background_fixed</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>c,
                  PNG_BACKGROUND_GAMMA_SCREEN, <font color='#979000'>0</font><font color='#009900'>/*need_expand*/</font>,
                  <font color='#979000'>0</font><font color='#009900'>/*gamma: not used*/</font><font face='Lucida Console'>)</font>;

               output_processing <font color='#5555FF'>=</font> PNG_CMAP_NONE;
            <b>}</b>

            <font color='#0000FF'>else</font>
            <b>{</b>
               png_uint_32 i, a;

               <font color='#009900'>/* This is the same as png_make_ga_colormap, above, except that
                * the entries are all opaque.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_GA_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>ga-alpha color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

               i <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>&lt;</font> <font color='#979000'>231</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  png_uint_32 gray <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>*</font> <font color='#979000'>256</font> <font color='#5555FF'>+</font> <font color='#979000'>115</font><font face='Lucida Console'>)</font> <font color='#5555FF'>/</font> <font color='#979000'>231</font>;
                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, gray, gray, gray,
                     <font color='#979000'>255</font>, E_sRGB<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#009900'>/* NOTE: this preserves the full precision of the application
                * background color.
                */</font>
               background_index <font color='#5555FF'>=</font> i;
               <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, back_r, back_g, back_b,
                  output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR ? <font color='#979000'>65535</font>U : <font color='#979000'>255</font>U, output_encoding<font face='Lucida Console'>)</font>;

               <font color='#009900'>/* For non-opaque input composite on the sRGB background - this
                * requires inverting the encoding for each component.  The input
                * is still converted to the sRGB encoding because this is a
                * reasonable approximate to the logarithmic curve of human
                * visual sensitivity, at least over the narrow range which PNG
                * represents.  Consequently 'G' is always sRGB encoded, while
                * 'A' is linear.  We need the linear background colors.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_sRGB<font face='Lucida Console'>)</font> <font color='#009900'>/* else already linear */</font>
               <b>{</b>
                  <font color='#009900'>/* This may produce a value not exactly matching the
                   * background, but that's ok because these numbers are only
                   * used when alpha != 0
                   */</font>
                  back_r <font color='#5555FF'>=</font> png_sRGB_table[back_r];
                  back_g <font color='#5555FF'>=</font> png_sRGB_table[back_g];
                  back_b <font color='#5555FF'>=</font> png_sRGB_table[back_b];
               <b>}</b>

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>a<font color='#5555FF'>=</font><font color='#979000'>1</font>; a<font color='#5555FF'>&lt;</font><font color='#979000'>5</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>a<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> g;

                  <font color='#009900'>/* PNG_sRGB_FROM_LINEAR expects a 16-bit linear value scaled
                   * by an 8-bit alpha value (0..255).
                   */</font>
                  png_uint_32 alpha <font color='#5555FF'>=</font> <font color='#979000'>51</font> <font color='#5555FF'>*</font> a;
                  png_uint_32 back_rx <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> back_r;
                  png_uint_32 back_gx <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> back_g;
                  png_uint_32 back_bx <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> back_b;

                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>g<font color='#5555FF'>=</font><font color='#979000'>0</font>; g<font color='#5555FF'>&lt;</font><font color='#979000'>6</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>g<font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_32 gray <font color='#5555FF'>=</font> png_sRGB_table[g<font color='#5555FF'>*</font><font color='#979000'>51</font>] <font color='#5555FF'>*</font> alpha;

                     <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>,
                        <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>gray <font color='#5555FF'>+</font> back_rx<font face='Lucida Console'>)</font>,
                        <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>gray <font color='#5555FF'>+</font> back_gx<font face='Lucida Console'>)</font>,
                        <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>gray <font color='#5555FF'>+</font> back_bx<font face='Lucida Console'>)</font>, <font color='#979000'>255</font>, E_sRGB<font face='Lucida Console'>)</font>;
                  <b>}</b>
               <b>}</b>

               cmap_entries <font color='#5555FF'>=</font> i;
               output_processing <font color='#5555FF'>=</font> PNG_CMAP_GA;
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB:
      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB_ALPHA:
         <font color='#009900'>/* Exclude the case where the output is gray; we can always handle this
          * with the cases above.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* The color-map will be grayscale, so we may as well convert the
             * input RGB values to a simple grayscale and use the grayscale
             * code above.
             *
             * NOTE: calling this apparently damages the recognition of the
             * transparent color in background color handling; call
             * png_set_tRNS_to_alpha before png_set_background_fixed.
             */</font>
            <font color='#BB00BB'>png_set_rgb_to_gray_fixed</font><font face='Lucida Console'>(</font>png_ptr, PNG_ERROR_ACTION_NONE, <font color='#5555FF'>-</font><font color='#979000'>1</font>,
               <font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            data_encoding <font color='#5555FF'>=</font> E_sRGB;

            <font color='#009900'>/* The output will now be one or two 8-bit gray or gray+alpha
             * channels.  The more complex case arises when the input has alpha.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
               <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Both input and output have an alpha channel, so no background
                * processing is required; just map the GA bytes to the right
                * color-map entry.
                */</font>
               expand_tRNS <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_GA_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>rgb[ga] color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

               cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_ga_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;
               background_index <font color='#5555FF'>=</font> PNG_CMAP_GA_BACKGROUND;
               output_processing <font color='#5555FF'>=</font> PNG_CMAP_GA;
            <b>}</b>

            <font color='#0000FF'>else</font>
            <b>{</b>
               <font color='#009900'>/* Either the input or the output has no alpha channel, so there
                * will be no non-opaque pixels in the color-map; it will just be
                * grayscale.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_GRAY_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>rgb[gray] color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

               <font color='#009900'>/* Ideally this code would use libpng to do the gamma correction,
                * but if an input alpha channel is to be removed we will hit the
                * libpng bug in gamma+compose+rgb-to-gray (the double gamma
                * correction bug).  Fix this by dropping the gamma correction in
                * this case and doing it in the palette; this will result in
                * duplicate palette entries, but that's better than the
                * alternative of double gamma correction.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                  <font color='#BB00BB'>png_gamma_not_sRGB</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_gray_file_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;
                  data_encoding <font color='#5555FF'>=</font> E_FILE;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_gray_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

               <font color='#009900'>/* But if the input has alpha or transparency it must be removed
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  png_color_16 c;
                  png_uint_32 gray <font color='#5555FF'>=</font> back_g;

                  <font color='#009900'>/* We need to ensure that the application background exists in
                   * the colormap and that completely transparent pixels map to
                   * it.  Achieve this simply by ensuring that the entry
                   * selected for the background really is the background color.
                   */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>data_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_FILE<font face='Lucida Console'>)</font> <font color='#009900'>/* from the fixup above */</font>
                  <b>{</b>
                     <font color='#009900'>/* The app supplied a gray which is in output_encoding, we
                      * need to convert it to a value of the input (E_FILE)
                      * encoding then set this palette entry to the required
                      * output encoding.
                      */</font>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_sRGB<font face='Lucida Console'>)</font>
                        gray <font color='#5555FF'>=</font> png_sRGB_table[gray]; <font color='#009900'>/* now E_LINEAR */</font>

                     gray <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_DIV257</font><font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_16bit_correct</font><font face='Lucida Console'>(</font>gray,
                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* now E_FILE */</font>

                     <font color='#009900'>/* And make sure the corresponding palette entry contains
                      * exactly the required sRGB value.
                      */</font>
                     <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, gray, back_g, back_g,
                        back_g, <font color='#979000'>0</font><font color='#009900'>/*unused*/</font>, output_encoding<font face='Lucida Console'>)</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
                  <b>{</b>
                     gray <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>gray <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;

                     <font color='#009900'>/* And make sure the corresponding palette entry matches.
                      */</font>
                     <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, gray, back_g, back_g,
                        back_g, <font color='#979000'>0</font><font color='#009900'>/*unused*/</font>, E_LINEAR<font face='Lucida Console'>)</font>;
                  <b>}</b>

                  <font color='#009900'>/* The background passed to libpng, however, must be the
                   * output (normally sRGB) value.
                   */</font>
                  c.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/*unused*/</font>
                  c.gray <font color='#5555FF'>=</font> c.red <font color='#5555FF'>=</font> c.green <font color='#5555FF'>=</font> c.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>gray;

                  <font color='#009900'>/* NOTE: the following is apparently a bug in libpng. Without
                   * it the transparent color recognition in
                   * png_set_background_fixed seems to go wrong.
                   */</font>
                  expand_tRNS <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                  <font color='#BB00BB'>png_set_background_fixed</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>c,
                     PNG_BACKGROUND_GAMMA_SCREEN, <font color='#979000'>0</font><font color='#009900'>/*need_expand*/</font>,
                     <font color='#979000'>0</font><font color='#009900'>/*gamma: not used*/</font><font face='Lucida Console'>)</font>;
               <b>}</b>

               output_processing <font color='#5555FF'>=</font> PNG_CMAP_NONE;
            <b>}</b>
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#009900'>/* output is color */</font>
         <b>{</b>
            <font color='#009900'>/* We could use png_quantize here so long as there is no transparent
             * color or alpha; png_quantize ignores alpha.  Easier overall just
             * to do it once and using PNG_DIV51 on the 6x6x6 reduced RGB cube.
             * Consequently we always want libpng to produce sRGB data.
             */</font>
            data_encoding <font color='#5555FF'>=</font> E_sRGB;

            <font color='#009900'>/* Is there any transparency or alpha? */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Is there alpha in the output too?  If so all four channels are
                * processed into a special RGB cube with alpha support.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_uint_32 r;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_RGB_COLORMAP_ENTRIES<font color='#5555FF'>+</font><font color='#979000'>1</font><font color='#5555FF'>+</font><font color='#979000'>27</font> <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                     <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>rgb+alpha color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

                  cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_rgb_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

                  <font color='#009900'>/* Add a transparent entry. */</font>
                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, cmap_entries, <font color='#979000'>255</font>, <font color='#979000'>255</font>,
                     <font color='#979000'>255</font>, <font color='#979000'>0</font>, E_sRGB<font face='Lucida Console'>)</font>;

                  <font color='#009900'>/* This is stored as the background index for the processing
                   * algorithm.
                   */</font>
                  background_index <font color='#5555FF'>=</font> cmap_entries<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                  <font color='#009900'>/* Add 27 r,g,b entries each with alpha 0.5. */</font>
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>r<font color='#5555FF'>=</font><font color='#979000'>0</font>; r<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#979000'>0x7f</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_32 g;

                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>g<font color='#5555FF'>=</font><font color='#979000'>0</font>; g<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>g <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#979000'>0x7f</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_32 b;

                        <font color='#009900'>/* This generates components with the values 0, 127 and
                         * 255
                         */</font>
                        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>b<font color='#5555FF'>=</font><font color='#979000'>0</font>; b<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>b <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#979000'>0x7f</font><font face='Lucida Console'>)</font>
                           <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, cmap_entries<font color='#5555FF'>+</font><font color='#5555FF'>+</font>,
                              r, g, b, <font color='#979000'>128</font>, E_sRGB<font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>

                  expand_tRNS <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                  output_processing <font color='#5555FF'>=</font> PNG_CMAP_RGB_ALPHA;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  <font color='#009900'>/* Alpha/transparency must be removed.  The background must
                   * exist in the color map (achieved by setting adding it after
                   * the 666 color-map).  If the standard processing code will
                   * pick up this entry automatically that's all that is
                   * required; libpng can be called to do the background
                   * processing.
                   */</font>
                  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> sample_size <font color='#5555FF'>=</font>
                     <font color='#BB00BB'>PNG_IMAGE_SAMPLE_SIZE</font><font face='Lucida Console'>(</font>output_format<font face='Lucida Console'>)</font>;
                  png_uint_32 r, g, b; <font color='#009900'>/* sRGB background */</font>

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_RGB_COLORMAP_ENTRIES<font color='#5555FF'>+</font><font color='#979000'>1</font><font color='#5555FF'>+</font><font color='#979000'>27</font> <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                     <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>rgb-alpha color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

                  cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_rgb_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;

                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, cmap_entries, back_r,
                        back_g, back_b, <font color='#979000'>0</font><font color='#009900'>/*unused*/</font>, output_encoding<font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR<font face='Lucida Console'>)</font>
                  <b>{</b>
                     r <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>back_r <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
                     g <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>back_g <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
                     b <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>back_b <font color='#5555FF'>*</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                  <b>{</b>
                     r <font color='#5555FF'>=</font> back_r;
                     g <font color='#5555FF'>=</font> back_g;
                     b <font color='#5555FF'>=</font> back_g;
                  <b>}</b>

                  <font color='#009900'>/* Compare the newly-created color-map entry with the one the
                   * PNG_CMAP_RGB algorithm will use.  If the two entries don't
                   * match, add the new one and set this as the background
                   * index.
                   */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>memcmp</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap <font color='#5555FF'>+</font>
                        sample_size <font color='#5555FF'>*</font> cmap_entries,
                     <font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap <font color='#5555FF'>+</font>
                        sample_size <font color='#5555FF'>*</font> <font color='#BB00BB'>PNG_RGB_INDEX</font><font face='Lucida Console'>(</font>r,g,b<font face='Lucida Console'>)</font>,
                     sample_size<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* The background color must be added. */</font>
                     background_index <font color='#5555FF'>=</font> cmap_entries<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                     <font color='#009900'>/* Add 27 r,g,b entries each with created by composing with
                      * the background at alpha 0.5.
                      */</font>
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>r<font color='#5555FF'>=</font><font color='#979000'>0</font>; r<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#979000'>0x7f</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>g<font color='#5555FF'>=</font><font color='#979000'>0</font>; g<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>g <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#979000'>0x7f</font><font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#009900'>/* This generates components with the values 0, 127
                            * and 255
                            */</font>
                           <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>b<font color='#5555FF'>=</font><font color='#979000'>0</font>; b<font color='#5555FF'>&lt;</font><font color='#979000'>256</font>; b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>b <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#979000'>0x7f</font><font face='Lucida Console'>)</font>
                              <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, cmap_entries<font color='#5555FF'>+</font><font color='#5555FF'>+</font>,
                                 <font color='#BB00BB'>png_colormap_compose</font><font face='Lucida Console'>(</font>display, r, E_sRGB, <font color='#979000'>128</font>,
                                    back_r, output_encoding<font face='Lucida Console'>)</font>,
                                 <font color='#BB00BB'>png_colormap_compose</font><font face='Lucida Console'>(</font>display, g, E_sRGB, <font color='#979000'>128</font>,
                                    back_g, output_encoding<font face='Lucida Console'>)</font>,
                                 <font color='#BB00BB'>png_colormap_compose</font><font face='Lucida Console'>(</font>display, b, E_sRGB, <font color='#979000'>128</font>,
                                    back_b, output_encoding<font face='Lucida Console'>)</font>,
                                 <font color='#979000'>0</font><font color='#009900'>/*unused*/</font>, output_encoding<font face='Lucida Console'>)</font>;
                        <b>}</b>
                     <b>}</b>

                     expand_tRNS <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                     output_processing <font color='#5555FF'>=</font> PNG_CMAP_RGB_ALPHA;
                  <b>}</b>

                  <font color='#0000FF'>else</font> <font color='#009900'>/* background color is in the standard color-map */</font>
                  <b>{</b>
                     png_color_16 c;

                     c.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/*unused*/</font>
                     c.red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>back_r;
                     c.gray <font color='#5555FF'>=</font> c.green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>back_g;
                     c.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>back_b;

                     <font color='#BB00BB'>png_set_background_fixed</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>c,
                        PNG_BACKGROUND_GAMMA_SCREEN, <font color='#979000'>0</font><font color='#009900'>/*need_expand*/</font>,
                        <font color='#979000'>0</font><font color='#009900'>/*gamma: not used*/</font><font face='Lucida Console'>)</font>;

                     output_processing <font color='#5555FF'>=</font> PNG_CMAP_RGB;
                  <b>}</b>
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* no alpha or transparency in the input */</font>
            <b>{</b>
               <font color='#009900'>/* Alpha in the output is irrelevant, simply map the opaque input
                * pixels to the 6x6x6 color-map.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>PNG_RGB_COLORMAP_ENTRIES <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>rgb color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

               cmap_entries <font color='#5555FF'>=</font> <font color='#BB00BB'>make_rgb_colormap</font><font face='Lucida Console'>(</font>display<font face='Lucida Console'>)</font>;
               output_processing <font color='#5555FF'>=</font> PNG_CMAP_RGB;
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_COLOR_TYPE_PALETTE:
         <font color='#009900'>/* It's already got a color-map.  It may be necessary to eliminate the
          * tRNS entries though.
          */</font>
         <b>{</b>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> num_trans <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans;
            png_const_bytep trans <font color='#5555FF'>=</font> num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> ? png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha : NULL;
            png_const_colorp colormap <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette;
            <font color='#0000FF'>const</font> <font color='#0000FF'><u>int</u></font> do_background <font color='#5555FF'>=</font> trans <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
               <font face='Lucida Console'>(</font>output_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> i;

            <font color='#009900'>/* Just in case: */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trans <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            output_processing <font color='#5555FF'>=</font> PNG_CMAP_NONE;
            data_encoding <font color='#5555FF'>=</font> E_FILE; <font color='#009900'>/* Don't change from color-map indicies */</font>
            cmap_entries <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cmap_entries <font color='#5555FF'>&gt;</font> <font color='#979000'>256</font><font face='Lucida Console'>)</font>
               cmap_entries <font color='#5555FF'>=</font> <font color='#979000'>256</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cmap_entries <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>palette color-map: too few entries</font>"<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> cmap_entries; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_background <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> i <font color='#5555FF'>&lt;</font> num_trans <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> trans[i] <font color='#5555FF'>&lt;</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trans[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i, back_r, back_g,
                        back_b, <font color='#979000'>0</font>, output_encoding<font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>else</font>
                  <b>{</b>
                     <font color='#009900'>/* Must compose the PNG file color in the color-map entry
                      * on the sRGB color in 'back'.
                      */</font>
                     <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i,
                        <font color='#BB00BB'>png_colormap_compose</font><font face='Lucida Console'>(</font>display, colormap[i].red, E_FILE,
                           trans[i], back_r, output_encoding<font face='Lucida Console'>)</font>,
                        <font color='#BB00BB'>png_colormap_compose</font><font face='Lucida Console'>(</font>display, colormap[i].green, E_FILE,
                           trans[i], back_g, output_encoding<font face='Lucida Console'>)</font>,
                        <font color='#BB00BB'>png_colormap_compose</font><font face='Lucida Console'>(</font>display, colormap[i].blue, E_FILE,
                           trans[i], back_b, output_encoding<font face='Lucida Console'>)</font>,
                        output_encoding <font color='#5555FF'>=</font><font color='#5555FF'>=</font> E_LINEAR ? trans[i] <font color='#5555FF'>*</font> <font color='#979000'>257</font>U :
                           trans[i],
                        output_encoding<font face='Lucida Console'>)</font>;
                  <b>}</b>
               <b>}</b>

               <font color='#0000FF'>else</font>
                  <font color='#BB00BB'>png_create_colormap_entry</font><font face='Lucida Console'>(</font>display, i, colormap[i].red,
                     colormap[i].green, colormap[i].blue,
                     i <font color='#5555FF'>&lt;</font> num_trans ? trans[i] : <font color='#979000'>255</font>U, E_FILE<font color='#009900'>/*8-bit*/</font><font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#009900'>/* The PNG data may have indicies packed in fewer than 8 bits, it
             * must be expanded if so.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_set_packing</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid PNG color type</font>"<font face='Lucida Console'>)</font>;
         <font color='#009900'>/*NOT REACHED*/</font>
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#009900'>/* Now deal with the output processing */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>expand_tRNS <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_set_tRNS_to_alpha</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>data_encoding<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad data option (internal error)</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> E_sRGB:
         <font color='#009900'>/* Change to 8-bit sRGB */</font>
         <font color='#BB00BB'>png_set_alpha_mode_fixed</font><font face='Lucida Console'>(</font>png_ptr, PNG_ALPHA_PNG, PNG_GAMMA_sRGB<font face='Lucida Console'>)</font>;
         <font color='#009900'>/* FALL THROUGH */</font>

      <font color='#0000FF'>case</font> E_FILE:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_set_scale_16</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cmap_entries <font color='#5555FF'>&gt;</font> <font color='#979000'>256</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> cmap_entries <font color='#5555FF'>&gt;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>color map overflow (BAD internal error)</font>"<font face='Lucida Console'>)</font>;

   image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries <font color='#5555FF'>=</font> cmap_entries;

   <font color='#009900'>/* Double check using the recorded background index */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>output_processing<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_CMAP_NONE:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>background_index <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_CMAP_NONE_BACKGROUND<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> bad_background;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CMAP_GA:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>background_index <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_CMAP_GA_BACKGROUND<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> bad_background;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CMAP_TRANS:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>background_index <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> cmap_entries <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            background_index <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_CMAP_TRANS_BACKGROUND<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> bad_background;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CMAP_RGB:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>background_index <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_CMAP_RGB_BACKGROUND<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> bad_background;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CMAP_RGB_ALPHA:
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>background_index <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_CMAP_RGB_ALPHA_BACKGROUND<font face='Lucida Console'>)</font>
            <font color='#0000FF'>goto</font> bad_background;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad processing option (internal error)</font>"<font face='Lucida Console'>)</font>;

      bad_background:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad background index (internal error)</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_processing <font color='#5555FF'>=</font> output_processing;

   <font color='#0000FF'>return</font> <font color='#979000'>1</font><font color='#009900'>/*ok*/</font>;
<b>}</b>

<font color='#009900'>/* The final part of the color-map read called from png_image_finish_read. */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_and_map'></a>png_image_read_and_map</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_image_read_control <font color='#5555FF'>*</font>display <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_image_read_control<font color='#5555FF'>*</font>,
      argument<font face='Lucida Console'>)</font>;
   png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;
   png_structrp png_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   <font color='#0000FF'><u>int</u></font> passes;

   <font color='#009900'>/* Called when the libpng data must be transformed into the color-mapped
    * form.  There is a local row buffer in display-&gt;local and this routine must
    * do the interlace handling.
    */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_INTERLACE_NONE:
         passes <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_INTERLACE_ADAM7:
         passes <font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7_PASSES;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         passes <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unknown interlace type</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <b>{</b>
      png_uint_32  height <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
      png_uint_32  width <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
      <font color='#0000FF'><u>int</u></font>          proc <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_processing;
      png_bytep    first_row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;
      ptrdiff_t    step_row <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes;
      <font color='#0000FF'><u>int</u></font> pass;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>pass <font color='#5555FF'>=</font> <font color='#979000'>0</font>; pass <font color='#5555FF'>&lt;</font> passes; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pass<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font>     startx, stepx, stepy;
         png_uint_32      y;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* The row may be empty for a short image: */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_PASS_COLS</font><font face='Lucida Console'>(</font>width, pass<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <font color='#0000FF'>continue</font>;

            startx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_COL</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
            stepx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_COL_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
            y <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_ROW</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
            stepy <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_ROW_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            y <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            startx <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            stepx <font color='#5555FF'>=</font> stepy <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <b>}</b>

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; y<font color='#5555FF'>&lt;</font>height; y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepy<font face='Lucida Console'>)</font>
         <b>{</b>
            png_bytep inrow <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row<font face='Lucida Console'>)</font>;
            png_bytep outrow <font color='#5555FF'>=</font> first_row <font color='#5555FF'>+</font> y <font color='#5555FF'>*</font> step_row;
            png_const_bytep end_row <font color='#5555FF'>=</font> outrow <font color='#5555FF'>+</font> width;

            <font color='#009900'>/* Read read the libpng data into the temporary buffer. */</font>
            <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, inrow, NULL<font face='Lucida Console'>)</font>;

            <font color='#009900'>/* Now process the row according to the processing option, note
             * that the caller verifies that the format of the libpng output
             * data is as required.
             */</font>
            outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> startx;
            <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>proc<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>case</font> PNG_CMAP_GA:
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#009900'>/* The data is always in the PNG order */</font>
                     <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> gray <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inrow<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                     <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> alpha <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inrow<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                     <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> entry;

                     <font color='#009900'>/* NOTE: this code is copied as a comment in
                      * make_ga_colormap above.  Please update the
                      * comment if you change this code!
                      */</font>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>229</font><font face='Lucida Console'>)</font> <font color='#009900'>/* opaque */</font>
                     <b>{</b>
                        entry <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>231</font> <font color='#5555FF'>*</font> gray <font color='#5555FF'>+</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>;
                     <b>}</b>
                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>26</font><font face='Lucida Console'>)</font> <font color='#009900'>/* transparent */</font>
                     <b>{</b>
                        entry <font color='#5555FF'>=</font> <font color='#979000'>231</font>;
                     <b>}</b>
                     <font color='#0000FF'>else</font> <font color='#009900'>/* partially opaque */</font>
                     <b>{</b>
                        entry <font color='#5555FF'>=</font> <font color='#979000'>226</font> <font color='#5555FF'>+</font> <font color='#979000'>6</font> <font color='#5555FF'>*</font> <font color='#BB00BB'>PNG_DIV51</font><font face='Lucida Console'>(</font>alpha<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#BB00BB'>PNG_DIV51</font><font face='Lucida Console'>(</font>gray<font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>entry;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>case</font> PNG_CMAP_TRANS:
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_byte gray <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inrow<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                     png_byte alpha <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>inrow<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> PNG_CMAP_TRANS_BACKGROUND;

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gray <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_CMAP_TRANS_BACKGROUND<font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> gray;

                     <font color='#0000FF'>else</font>
                        <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>PNG_CMAP_TRANS_BACKGROUND<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>case</font> PNG_CMAP_RGB:
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_RGB_INDEX</font><font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>], inrow[<font color='#979000'>1</font>], inrow[<font color='#979000'>2</font>]<font face='Lucida Console'>)</font>;
                     inrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>case</font> PNG_CMAP_RGB_ALPHA:
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> alpha <font color='#5555FF'>=</font> inrow[<font color='#979000'>3</font>];

                     <font color='#009900'>/* Because the alpha entries only hold alpha==0.5 values
                      * split the processing at alpha==0.25 (64) and 0.75
                      * (196).
                      */</font>

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>196</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_RGB_INDEX</font><font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>], inrow[<font color='#979000'>1</font>],
                           inrow[<font color='#979000'>2</font>]<font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>64</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> PNG_CMAP_RGB_ALPHA_BACKGROUND;

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        <font color='#009900'>/* Likewise there are three entries for each of r, g
                         * and b.  We could select the entry by popcount on
                         * the top two bits on those architectures that
                         * support it, this is what the code below does,
                         * crudely.
                         */</font>
                        <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> back_i <font color='#5555FF'>=</font> PNG_CMAP_RGB_ALPHA_BACKGROUND<font color='#5555FF'>+</font><font color='#979000'>1</font>;

                        <font color='#009900'>/* Here are how the values map:
                         *
                         * 0x00 .. 0x3f -&gt; 0
                         * 0x40 .. 0xbf -&gt; 1
                         * 0xc0 .. 0xff -&gt; 2
                         *
                         * So, as above with the explicit alpha checks, the
                         * breakpoints are at 64 and 196.
                         */</font>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0x80</font><font face='Lucida Console'>)</font> back_i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>9</font>; <font color='#009900'>/* red */</font>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0x40</font><font face='Lucida Console'>)</font> back_i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>9</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0x80</font><font face='Lucida Console'>)</font> back_i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>; <font color='#009900'>/* green */</font>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0x40</font><font face='Lucida Console'>)</font> back_i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0x80</font><font face='Lucida Console'>)</font> back_i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>; <font color='#009900'>/* blue */</font>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>inrow[<font color='#979000'>0</font>] <font color='#5555FF'>&amp;</font> <font color='#979000'>0x40</font><font face='Lucida Console'>)</font> back_i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;

                        <font color='#5555FF'>*</font>outrow <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>back_i;
                     <b>}</b>

                     inrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>default</font>:
                  <font color='#0000FF'>break</font>;
            <b>}</b>
         <b>}</b>
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_colormapped'></a>png_image_read_colormapped</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_image_read_control <font color='#5555FF'>*</font>display <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_image_read_control<font color='#5555FF'>*</font>,
      argument<font face='Lucida Console'>)</font>;
   png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;
   png_controlp control <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque;
   png_structrp png_ptr <font color='#5555FF'>=</font> control<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   png_inforp info_ptr <font color='#5555FF'>=</font> control<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_ptr;

   <font color='#0000FF'><u>int</u></font> passes <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* As a flag */</font>

   <font color='#BB00BB'>PNG_SKIP_CHUNKS</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Update the 'info' structure and make sure the result is as required; first
    * make sure to turn on the interlace handling if it will be required
    * (because it can't be turned on *after* the call to png_read_update_info!)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_processing <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_CMAP_NONE<font face='Lucida Console'>)</font>
      passes <font color='#5555FF'>=</font> <font color='#BB00BB'>png_set_interlace_handling</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_read_update_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The expected output can be deduced from the colormap_processing option. */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_processing<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_CMAP_NONE:
         <font color='#009900'>/* Output must be one channel and one byte per pixel, the output
          * encoding can be anything.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>goto</font> bad_output;

      <font color='#0000FF'>case</font> PNG_CMAP_TRANS:
      <font color='#0000FF'>case</font> PNG_CMAP_GA:
         <font color='#009900'>/* Output must be two channels and the 'G' one must be sRGB, the latter
          * can be checked with an exact number because it should have been set
          * to this number above!
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_GAMMA_sRGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>256</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>goto</font> bad_output;

      <font color='#0000FF'>case</font> PNG_CMAP_RGB:
         <font color='#009900'>/* Output must be 8-bit sRGB encoded RGB */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_GAMMA_sRGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>216</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>goto</font> bad_output;

      <font color='#0000FF'>case</font> PNG_CMAP_RGB_ALPHA:
         <font color='#009900'>/* Output must be 8-bit sRGB encoded RGBA */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_GAMMA_sRGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>244</font> <font color='#009900'>/* 216 + 1 + 27 */</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>break</font>;

         <font color='#009900'>/* goto bad_output; */</font>
         <font color='#009900'>/* FALL THROUGH */</font>

      <font color='#0000FF'>default</font>:
      bad_output:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>bad color-map processing (internal error)</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* Now read the rows.  Do this here if it is possible to read directly into
    * the output buffer, otherwise allocate a local row buffer of the maximum
    * size libpng requires and call the relevant processing routine safely.
    */</font>
   <b>{</b>
      png_voidp first_row <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>buffer;
      ptrdiff_t row_bytes <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_stride;

      <font color='#009900'>/* The following expression is designed to work correctly whether it gives
       * a signed or an unsigned result.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_bytes <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font color='#5555FF'>*</font>, first_row<font face='Lucida Console'>)</font>;
         ptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font>row_bytes<font face='Lucida Console'>)</font>;
         first_row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_voidp, ptr<font face='Lucida Console'>)</font>;
      <b>}</b>

      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row <font color='#5555FF'>=</font> first_row;
      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes <font color='#5555FF'>=</font> row_bytes;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>passes <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> result;
      png_voidp row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>png_get_rowbytes</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row <font color='#5555FF'>=</font> row;
      result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_and_map, display<font face='Lucida Console'>)</font>;
      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row <font color='#5555FF'>=</font> NULL;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, row<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font> result;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      png_alloc_size_t row_bytes <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes;

      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>passes <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_32      y <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
         png_bytep        row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>y<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, row, NULL<font face='Lucida Console'>)</font>;
            row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> row_bytes;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <b>}</b>
<b>}</b>

<font color='#009900'>/* Just the row reading part of png_image_read. */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_composite'></a>png_image_read_composite</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_image_read_control <font color='#5555FF'>*</font>display <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_image_read_control<font color='#5555FF'>*</font>,
      argument<font face='Lucida Console'>)</font>;
   png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;
   png_structrp png_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   <font color='#0000FF'><u>int</u></font> passes;

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_INTERLACE_NONE:
         passes <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_INTERLACE_ADAM7:
         passes <font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7_PASSES;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         passes <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unknown interlace type</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <b>{</b>
      png_uint_32  height <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
      png_uint_32  width <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
      ptrdiff_t    step_row <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes;
      <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> channels <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font> ? <font color='#979000'>3</font> : <font color='#979000'>1</font>;
      <font color='#0000FF'><u>int</u></font> pass;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>pass <font color='#5555FF'>=</font> <font color='#979000'>0</font>; pass <font color='#5555FF'>&lt;</font> passes; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pass<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font>     startx, stepx, stepy;
         png_uint_32      y;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* The row may be empty for a short image: */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_PASS_COLS</font><font face='Lucida Console'>(</font>width, pass<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               <font color='#0000FF'>continue</font>;

            startx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_COL</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> channels;
            stepx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_COL_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> channels;
            y <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_ROW</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
            stepy <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_ROW_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            y <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            startx <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            stepx <font color='#5555FF'>=</font> channels;
            stepy <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <b>}</b>

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; y<font color='#5555FF'>&lt;</font>height; y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepy<font face='Lucida Console'>)</font>
         <b>{</b>
            png_bytep inrow <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row<font face='Lucida Console'>)</font>;
            png_bytep outrow;
            png_const_bytep end_row;

            <font color='#009900'>/* Read the row, which is packed: */</font>
            <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, inrow, NULL<font face='Lucida Console'>)</font>;

            outrow <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;
            outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> y <font color='#5555FF'>*</font> step_row;
            end_row <font color='#5555FF'>=</font> outrow <font color='#5555FF'>+</font> width <font color='#5555FF'>*</font> channels;

            <font color='#009900'>/* Now do the composition on each pixel in this row. */</font>
            outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> startx;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
            <b>{</b>
               png_byte alpha <font color='#5555FF'>=</font> inrow[channels];

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else no change to the output */</font>
               <b>{</b>
                  <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> c;

                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>c<font color='#5555FF'>=</font><font color='#979000'>0</font>; c<font color='#5555FF'>&lt;</font>channels; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>c<font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_32 component <font color='#5555FF'>=</font> inrow[c];

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else just use component */</font>
                     <b>{</b>
                        <font color='#009900'>/* This is PNG_OPTIMIZED_ALPHA, the component value
                         * is a linear 8-bit value.  Combine this with the
                         * current outrow[c] value which is sRGB encoded.
                         * Arithmetic here is 16-bits to preserve the output
                         * values correctly.
                         */</font>
                        component <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>257</font><font color='#5555FF'>*</font><font color='#979000'>255</font>; <font color='#009900'>/* =65535 */</font>
                        component <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>png_sRGB_table[outrow[c]];

                        <font color='#009900'>/* So 'component' is scaled by 255*65535 and is
                         * therefore appropriate for the sRGB to linear
                         * conversion table.
                         */</font>
                        component <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>component<font face='Lucida Console'>)</font>;
                     <b>}</b>

                     outrow[c] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>component;
                  <b>}</b>
               <b>}</b>

               inrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> channels<font color='#5555FF'>+</font><font color='#979000'>1</font>; <font color='#009900'>/* components and alpha channel */</font>
            <b>}</b>
         <b>}</b>
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>/* The do_local_background case; called when all the following transforms are to
 * be done:
 *
 * PNG_RGB_TO_GRAY
 * PNG_COMPOSITE
 * PNG_GAMMA
 *
 * This is a work-round for the fact that both the PNG_RGB_TO_GRAY and
 * PNG_COMPOSITE code performs gamma correction, so we get double gamma
 * correction.  The fix-up is to prevent the PNG_COMPOSITE operation happening
 * inside libpng, so this routine sees an 8 or 16-bit gray+alpha row and handles
 * the removal or pre-multiplication of the alpha channel.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_background'></a>png_image_read_background</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_image_read_control <font color='#5555FF'>*</font>display <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_image_read_control<font color='#5555FF'>*</font>,
      argument<font face='Lucida Console'>)</font>;
   png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;
   png_structrp png_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   png_inforp info_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_ptr;
   png_uint_32 height <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
   png_uint_32 width <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   <font color='#0000FF'><u>int</u></font> pass, passes;

   <font color='#009900'>/* Double check the convoluted logic below.  We expect to get here with
    * libpng doing rgb to gray and gamma correction but background processing
    * left to the png_image_read_background function.  The rows libpng produce
    * might be 8 or 16-bit but should always have two channels; gray plus alpha.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>lost rgb to gray</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unexpected compose</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_get_channels</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>lost/gained channels</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Expect the 8-bit case to always remove the alpha channel */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_LINEAR<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unexpected 8-bit transformation</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_INTERLACE_NONE:
         passes <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_INTERLACE_ADAM7:
         passes <font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7_PASSES;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         passes <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unknown interlace type</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_get_bit_depth</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unexpected bit depth</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
         <font color='#009900'>/* 8-bit sRGB gray values with an alpha channel; the alpha channel is
          * to be removed by composing on a background: either the row if
          * display-&gt;background is NULL or display-&gt;background-&gt;green if not.
          * Unlike the code above ALPHA_OPTIMIZED has *not* been done.
          */</font>
         <b>{</b>
            png_bytep first_row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;
            ptrdiff_t step_row <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>pass <font color='#5555FF'>=</font> <font color='#979000'>0</font>; pass <font color='#5555FF'>&lt;</font> passes; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pass<font face='Lucida Console'>)</font>
            <b>{</b>
               png_bytep        row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep,
                                                   display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font>     startx, stepx, stepy;
               png_uint_32      y;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#009900'>/* The row may be empty for a short image: */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_PASS_COLS</font><font face='Lucida Console'>(</font>width, pass<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <font color='#0000FF'>continue</font>;

                  startx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_COL</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
                  stepx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_COL_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
                  y <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_ROW</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
                  stepy <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_ROW_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  y <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  startx <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  stepx <font color='#5555FF'>=</font> stepy <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; y<font color='#5555FF'>&lt;</font>height; y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepy<font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_bytep inrow <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep,
                        display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row<font face='Lucida Console'>)</font>;
                     png_bytep outrow <font color='#5555FF'>=</font> first_row <font color='#5555FF'>+</font> y <font color='#5555FF'>*</font> step_row;
                     png_const_bytep end_row <font color='#5555FF'>=</font> outrow <font color='#5555FF'>+</font> width;

                     <font color='#009900'>/* Read the row, which is packed: */</font>
                     <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, inrow, NULL<font face='Lucida Console'>)</font>;

                     <font color='#009900'>/* Now do the composition on each pixel in this row. */</font>
                     outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> startx;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_byte alpha <font color='#5555FF'>=</font> inrow[<font color='#979000'>1</font>];

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else no change to the output */</font>
                        <b>{</b>
                           png_uint_32 component <font color='#5555FF'>=</font> inrow[<font color='#979000'>0</font>];

                           <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else just use component */</font>
                           <b>{</b>
                              <font color='#009900'>/* Since PNG_OPTIMIZED_ALPHA was not set it is
                               * necessary to invert the sRGB transfer
                               * function and multiply the alpha out.
                               */</font>
                              component <font color='#5555FF'>=</font> png_sRGB_table[component] <font color='#5555FF'>*</font> alpha;
                              component <font color='#5555FF'>+</font><font color='#5555FF'>=</font> png_sRGB_table[outrow[<font color='#979000'>0</font>]] <font color='#5555FF'>*</font>
                                 <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font>;
                              component <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>component<font face='Lucida Console'>)</font>;
                           <b>}</b>

                           outrow[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>component;
                        <b>}</b>

                        inrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>; <font color='#009900'>/* gray and alpha channel */</font>
                     <b>}</b>
                  <b>}</b>
               <b>}</b>

               <font color='#0000FF'>else</font> <font color='#009900'>/* constant background value */</font>
               <b>{</b>
                  png_byte background8 <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
                  png_uint_16 background <font color='#5555FF'>=</font> png_sRGB_table[background8];

                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; y<font color='#5555FF'>&lt;</font>height; y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepy<font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_bytep inrow <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep,
                        display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row<font face='Lucida Console'>)</font>;
                     png_bytep outrow <font color='#5555FF'>=</font> first_row <font color='#5555FF'>+</font> y <font color='#5555FF'>*</font> step_row;
                     png_const_bytep end_row <font color='#5555FF'>=</font> outrow <font color='#5555FF'>+</font> width;

                     <font color='#009900'>/* Read the row, which is packed: */</font>
                     <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, inrow, NULL<font face='Lucida Console'>)</font>;

                     <font color='#009900'>/* Now do the composition on each pixel in this row. */</font>
                     outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> startx;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_byte alpha <font color='#5555FF'>=</font> inrow[<font color='#979000'>1</font>];

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else use background */</font>
                        <b>{</b>
                           png_uint_32 component <font color='#5555FF'>=</font> inrow[<font color='#979000'>0</font>];

                           <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else just use component */</font>
                           <b>{</b>
                              component <font color='#5555FF'>=</font> png_sRGB_table[component] <font color='#5555FF'>*</font> alpha;
                              component <font color='#5555FF'>+</font><font color='#5555FF'>=</font> background <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#979000'>255</font><font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font>;
                              component <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_sRGB_FROM_LINEAR</font><font face='Lucida Console'>(</font>component<font face='Lucida Console'>)</font>;
                           <b>}</b>

                           outrow[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>component;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                           outrow[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> background8;

                        inrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>; <font color='#009900'>/* gray and alpha channel */</font>
                     <b>}</b>

                     row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes;
                  <b>}</b>
               <b>}</b>
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>16</font>:
         <font color='#009900'>/* 16-bit linear with pre-multiplied alpha; the pre-multiplication must
          * still be done and, maybe, the alpha channel removed.  This code also
          * handles the alpha-first option.
          */</font>
         <b>{</b>
            png_uint_16p first_row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_uint_16p,
               display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;
            <font color='#009900'>/* The division by two is safe because the caller passed in a
             * stride which was multiplied by 2 (below) to get row_bytes.
             */</font>
            ptrdiff_t    step_row <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes <font color='#5555FF'>/</font> <font color='#979000'>2</font>;
            <font color='#0000FF'><u>int</u></font> preserve_alpha <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> outchannels <font color='#5555FF'>=</font> <font color='#979000'>1</font><font color='#5555FF'>+</font>preserve_alpha;
            <font color='#0000FF'><u>int</u></font> swap_alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>preserve_alpha <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_AFIRST<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               swap_alpha <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>pass <font color='#5555FF'>=</font> <font color='#979000'>0</font>; pass <font color='#5555FF'>&lt;</font> passes; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pass<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font>     startx, stepx, stepy;
               png_uint_32      y;

               <font color='#009900'>/* The 'x' start and step are adjusted to output components here.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>interlaced <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_INTERLACE_ADAM7<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#009900'>/* The row may be empty for a short image: */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>PNG_PASS_COLS</font><font face='Lucida Console'>(</font>width, pass<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <font color='#0000FF'>continue</font>;

                  startx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_COL</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> outchannels;
                  stepx <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_COL_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> outchannels;
                  y <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_START_ROW</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
                  stepy <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_PASS_ROW_OFFSET</font><font face='Lucida Console'>(</font>pass<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  y <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  startx <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  stepx <font color='#5555FF'>=</font> outchannels;
                  stepy <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <b>}</b>

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; y<font color='#5555FF'>&lt;</font>height; y <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepy<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_const_uint_16p inrow;
                  png_uint_16p outrow <font color='#5555FF'>=</font> first_row <font color='#5555FF'>+</font> y<font color='#5555FF'>*</font>step_row;
                  png_uint_16p end_row <font color='#5555FF'>=</font> outrow <font color='#5555FF'>+</font> width <font color='#5555FF'>*</font> outchannels;

                  <font color='#009900'>/* Read the row, which is packed: */</font>
                  <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep,
                     display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row<font face='Lucida Console'>)</font>, NULL<font face='Lucida Console'>)</font>;
                  inrow <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_const_uint_16p, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row<font face='Lucida Console'>)</font>;

                  <font color='#009900'>/* Now do the pre-multiplication on each pixel in this row.
                   */</font>
                  outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> startx;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; outrow <font color='#5555FF'>&lt;</font> end_row; outrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> stepx<font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_32 component <font color='#5555FF'>=</font> inrow[<font color='#979000'>0</font>];
                     png_uint_16 alpha <font color='#5555FF'>=</font> inrow[<font color='#979000'>1</font>];

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else 0 */</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> <font color='#979000'>65535</font><font face='Lucida Console'>)</font> <font color='#009900'>/* else just use component */</font>
                        <b>{</b>
                           component <font color='#5555FF'>*</font><font color='#5555FF'>=</font> alpha;
                           component <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>32767</font>;
                           component <font color='#5555FF'>/</font><font color='#5555FF'>=</font> <font color='#979000'>65535</font>;
                        <b>}</b>
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                        component <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                     outrow[swap_alpha] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>component;
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>preserve_alpha<font face='Lucida Console'>)</font>
                        outrow[<font color='#979000'>1</font> ^ swap_alpha] <font color='#5555FF'>=</font> alpha;

                     inrow <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>; <font color='#009900'>/* components and alpha channel */</font>
                  <b>}</b>
               <b>}</b>
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
<b>}</b>

<font color='#009900'>/* The guts of png_image_finish_read as a png_safe_execute callback. */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_image_read_direct'></a>png_image_read_direct</b><font face='Lucida Console'>(</font>png_voidp argument<font face='Lucida Console'>)</font>
<b>{</b>
   png_image_read_control <font color='#5555FF'>*</font>display <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_image_read_control<font color='#5555FF'>*</font>,
      argument<font face='Lucida Console'>)</font>;
   png_imagep image <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>image;
   png_structrp png_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>png_ptr;
   png_inforp info_ptr <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_ptr;

   png_uint_32 format <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format;
   <font color='#0000FF'><u>int</u></font> linear <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_LINEAR<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>int</u></font> do_local_compose <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>int</u></font> do_local_background <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/* to avoid double gamma correction bug */</font>
   <font color='#0000FF'><u>int</u></font> passes <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* Add transforms to ensure the correct output format is produced then check
    * that the required implementation support is there.  Always expand; always
    * need 8 bits minimum, no palette and expanded tRNS.
    */</font>
   <font color='#BB00BB'>png_set_expand</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Now check the format to see if it was modified. */</font>
   <b>{</b>
      png_uint_32 base_format <font color='#5555FF'>=</font> <font color='#BB00BB'>png_image_format</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
         ~PNG_FORMAT_FLAG_COLORMAP <font color='#009900'>/* removed by png_set_expand */</font>;
      png_uint_32 change <font color='#5555FF'>=</font> format ^ base_format;
      png_fixed_point output_gamma;
      <font color='#0000FF'><u>int</u></font> mode; <font color='#009900'>/* alpha mode */</font>

      <font color='#009900'>/* Do this first so that we have a record if rgb to gray is happening. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>change <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* gray&lt;-&gt;color transformation required. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_set_gray_to_rgb</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* libpng can't do both rgb to gray and
             * background/pre-multiplication if there is also significant gamma
             * correction, because both operations require linear colors and
             * the code only supports one transform doing the gamma correction.
             * Handle this by doing the pre-multiplication or background
             * operation in this code, if necessary.
             *
             * TODO: fix this by rewriting pngrtran.c (!)
             *
             * For the moment (given that fixing this in pngrtran.c is an
             * enormous change) 'do_local_background' is used to indicate that
             * the problem exists.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>base_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
               do_local_background <font color='#5555FF'>=</font> <font color='#979000'>1</font><font color='#009900'>/*maybe*/</font>;

            <font color='#BB00BB'>png_set_rgb_to_gray_fixed</font><font face='Lucida Console'>(</font>png_ptr, PNG_ERROR_ACTION_NONE,
               PNG_RGB_TO_GRAY_DEFAULT, PNG_RGB_TO_GRAY_DEFAULT<font face='Lucida Console'>)</font>;
         <b>}</b>

         change <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_COLOR;
      <b>}</b>

      <font color='#009900'>/* Set the gamma appropriately, linear for 16-bit input, sRGB otherwise.
       */</font>
      <b>{</b>
         png_fixed_point input_gamma_default;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>base_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_LINEAR<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_IMAGE_FLAG_16BIT_sRGB<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            input_gamma_default <font color='#5555FF'>=</font> PNG_GAMMA_LINEAR;
         <font color='#0000FF'>else</font>
            input_gamma_default <font color='#5555FF'>=</font> PNG_DEFAULT_sRGB;

         <font color='#009900'>/* Call png_set_alpha_mode to set the default for the input gamma; the
          * output gamma is set by a second call below.
          */</font>
         <font color='#BB00BB'>png_set_alpha_mode_fixed</font><font face='Lucida Console'>(</font>png_ptr, PNG_ALPHA_PNG, input_gamma_default<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>linear<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* If there *is* an alpha channel in the input it must be multiplied
          * out; use PNG_ALPHA_STANDARD, otherwise just use PNG_ALPHA_PNG.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>base_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
            mode <font color='#5555FF'>=</font> PNG_ALPHA_STANDARD; <font color='#009900'>/* associated alpha */</font>

         <font color='#0000FF'>else</font>
            mode <font color='#5555FF'>=</font> PNG_ALPHA_PNG;

         output_gamma <font color='#5555FF'>=</font> PNG_GAMMA_LINEAR;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         mode <font color='#5555FF'>=</font> PNG_ALPHA_PNG;
         output_gamma <font color='#5555FF'>=</font> PNG_DEFAULT_sRGB;
      <b>}</b>

      <font color='#009900'>/* If 'do_local_background' is set check for the presence of gamma
       * correction; this is part of the work-round for the libpng bug
       * described above.
       *
       * TODO: fix libpng and remove this.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background<font face='Lucida Console'>)</font>
      <b>{</b>
         png_fixed_point gtest;

         <font color='#009900'>/* This is 'png_gamma_threshold' from pngrtran.c; the test used for
          * gamma correction, the screen gamma hasn't been set on png_struct
          * yet; it's set below.  png_struct::gamma, however, is set to the
          * final value.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>gtest, output_gamma, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
               PNG_FP_1<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>!</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gtest<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            do_local_background <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>mode <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_ALPHA_STANDARD<font face='Lucida Console'>)</font>
         <b>{</b>
            do_local_background <font color='#5555FF'>=</font> <font color='#979000'>2</font><font color='#009900'>/*required*/</font>;
            mode <font color='#5555FF'>=</font> PNG_ALPHA_PNG; <font color='#009900'>/* prevent libpng doing it */</font>
         <b>}</b>

         <font color='#009900'>/* else leave as 1 for the checks below */</font>
      <b>}</b>

      <font color='#009900'>/* If the bit-depth changes then handle that here. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>change <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_LINEAR<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>linear <font color='#009900'>/*16-bit output*/</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_set_expand_16</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font> <font color='#009900'>/* 8-bit output */</font>
            <font color='#BB00BB'>png_set_scale_16</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

         change <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_LINEAR;
      <b>}</b>

      <font color='#009900'>/* Now the background/alpha channel changes. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>change <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Removing an alpha channel requires composition for the 8-bit
          * formats; for the 16-bit it is already done, above, by the
          * pre-multiplication and the channel just needs to be stripped.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>base_format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* If RGB-&gt;gray is happening the alpha channel must be left and the
             * operation completed locally.
             *
             * TODO: fix libpng and remove this.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background<font face='Lucida Console'>)</font>
               do_local_background <font color='#5555FF'>=</font> <font color='#979000'>2</font><font color='#009900'>/*required*/</font>;

            <font color='#009900'>/* 16-bit output: just remove the channel */</font>
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>linear<font face='Lucida Console'>)</font> <font color='#009900'>/* compose on black (well, pre-multiply) */</font>
               <font color='#BB00BB'>png_set_strip_alpha</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

            <font color='#009900'>/* 8-bit output: do an appropriate compose */</font>
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <b>{</b>
               png_color_16 c;

               c.index <font color='#5555FF'>=</font> <font color='#979000'>0</font>; <font color='#009900'>/*unused*/</font>
               c.red <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red;
               c.green <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
               c.blue <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue;
               c.gray <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;

               <font color='#009900'>/* This is always an 8-bit sRGB value, using the 'green' channel
                * for gray is much better than calculating the luminance here;
                * we can get off-by-one errors in that calculation relative to
                * the app expectations and that will show up in transparent
                * pixels.
                */</font>
               <font color='#BB00BB'>png_set_background_fixed</font><font face='Lucida Console'>(</font>png_ptr, <font color='#5555FF'>&amp;</font>c,
                  PNG_BACKGROUND_GAMMA_SCREEN, <font color='#979000'>0</font><font color='#009900'>/*need_expand*/</font>,
                  <font color='#979000'>0</font><font color='#009900'>/*gamma: not used*/</font><font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* compose on row: implemented below. */</font>
            <b>{</b>
               do_local_compose <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <font color='#009900'>/* This leaves the alpha channel in the output, so it has to be
                * removed by the code below.  Set the encoding to the 'OPTIMIZE'
                * one so the code only has to hack on the pixels that require
                * composition.
                */</font>
               mode <font color='#5555FF'>=</font> PNG_ALPHA_OPTIMIZED;
            <b>}</b>
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#009900'>/* output needs an alpha channel */</font>
         <b>{</b>
            <font color='#009900'>/* This is tricky because it happens before the swap operation has
             * been accomplished; however, the swap does *not* swap the added
             * alpha channel (weird API), so it must be added in the correct
             * place.
             */</font>
            png_uint_32 filler; <font color='#009900'>/* opaque filler */</font>
            <font color='#0000FF'><u>int</u></font> where;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>linear<font face='Lucida Console'>)</font>
               filler <font color='#5555FF'>=</font> <font color='#979000'>65535</font>;

            <font color='#0000FF'>else</font>
               filler <font color='#5555FF'>=</font> <font color='#979000'>255</font>;

#           ifdef PNG_FORMAT_AFIRST_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_AFIRST<font face='Lucida Console'>)</font>
               <b>{</b>
                  where <font color='#5555FF'>=</font> PNG_FILLER_BEFORE;
                  change <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_AFIRST;
               <b>}</b>

               <font color='#0000FF'>else</font>
#           endif
               where <font color='#5555FF'>=</font> PNG_FILLER_AFTER;

            <font color='#BB00BB'>png_set_add_alpha</font><font face='Lucida Console'>(</font>png_ptr, filler, where<font face='Lucida Console'>)</font>;
         <b>}</b>

         <font color='#009900'>/* This stops the (irrelevant) call to swap_alpha below. */</font>
         change <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_ALPHA;
      <b>}</b>

      <font color='#009900'>/* Now set the alpha mode correctly; this is always done, even if there is
       * no alpha channel in either the input or the output because it correctly
       * sets the output gamma.
       */</font>
      <font color='#BB00BB'>png_set_alpha_mode_fixed</font><font face='Lucida Console'>(</font>png_ptr, mode, output_gamma<font face='Lucida Console'>)</font>;

#     ifdef PNG_FORMAT_BGR_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>change <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_BGR<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Check only the output format; PNG is never BGR; don't do this if
             * the output is gray, but fix up the 'format' value in that case.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLOR<font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_set_bgr</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>else</font>
               format <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_BGR;

            change <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_BGR;
         <b>}</b>
#     endif

#     ifdef PNG_FORMAT_AFIRST_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>change <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_AFIRST<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* Only relevant if there is an alpha channel - it's particularly
             * important to handle this correctly because do_local_compose may
             * be set above and then libpng will keep the alpha channel for this
             * code to remove.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Disable this if doing a local background,
                * TODO: remove this when local background is no longer required.
                */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                  <font color='#BB00BB'>png_set_swap_alpha</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#0000FF'>else</font>
               format <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_AFIRST;

            change <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FORMAT_FLAG_AFIRST;
         <b>}</b>
#     endif

      <font color='#009900'>/* If the *output* is 16-bit then we need to check for a byte-swap on this
       * architecture.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>linear<font face='Lucida Console'>)</font>
      <b>{</b>
         PNG_CONST png_uint_16 le <font color='#5555FF'>=</font> <font color='#979000'>0x0001</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>png_const_bytep<font face='Lucida Console'>)</font><font color='#5555FF'>&amp;</font>le<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_set_swap</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#009900'>/* If change is not now 0 some transformation is missing - error out. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>change<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_read_image: unsupported transformation</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#BB00BB'>PNG_SKIP_CHUNKS</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Update the 'info' structure and make sure the result is as required; first
    * make sure to turn on the interlace handling if it will be required
    * (because it can't be turned on *after* the call to png_read_update_info!)
    *
    * TODO: remove the do_local_background fixup below.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>do_local_compose <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> do_local_background <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
      passes <font color='#5555FF'>=</font> <font color='#BB00BB'>png_set_interlace_handling</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_read_update_info</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font>;

   <b>{</b>
      png_uint_32 info_format <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
         info_format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_COLOR;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* do_local_compose removes this channel below. */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>do_local_compose<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* do_local_background does the same if required. */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
               <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
               info_format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_ALPHA;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_compose<font face='Lucida Console'>)</font> <font color='#009900'>/* internal error */</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_image_read: alpha channel lost</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
         info_format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_LINEAR;

#     ifdef PNG_FORMAT_BGR_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BGR<font face='Lucida Console'>)</font>
            info_format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_BGR;
#     endif

#     ifdef PNG_FORMAT_AFIRST_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_AFIRST<font face='Lucida Console'>)</font>
               info_format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_AFIRST;
         <b>}</b>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SWAP_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_ADD_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_FILLER_AFTER<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
               <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>unexpected alpha swap transformation</font>"<font face='Lucida Console'>)</font>;

            info_format <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FORMAT_FLAG_AFIRST;
         <b>}</b>
#     endif

      <font color='#009900'>/* This is actually an internal error. */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_format <font color='#5555FF'>!</font><font color='#5555FF'>=</font> format<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_read_image: invalid transformations</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* Now read the rows.  If do_local_compose is set then it is necessary to use
    * a local row buffer.  The output will be GA, RGBA or BGRA and must be
    * converted to G, RGB or BGR as appropriate.  The 'local_row' member of the
    * display acts as a flag.
    */</font>
   <b>{</b>
      png_voidp first_row <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>buffer;
      ptrdiff_t row_bytes <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_stride;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>linear<font face='Lucida Console'>)</font>
         row_bytes <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

      <font color='#009900'>/* The following expression is designed to work correctly whether it gives
       * a signed or an unsigned result.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_bytes <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>ptr <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font color='#5555FF'>*</font>, first_row<font face='Lucida Console'>)</font>;
         ptr <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font>row_bytes<font face='Lucida Console'>)</font>;
         first_row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_voidp, ptr<font face='Lucida Console'>)</font>;
      <b>}</b>

      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row <font color='#5555FF'>=</font> first_row;
      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes <font color='#5555FF'>=</font> row_bytes;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_compose<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> result;
      png_voidp row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>png_get_rowbytes</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row <font color='#5555FF'>=</font> row;
      result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_composite, display<font face='Lucida Console'>)</font>;
      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row <font color='#5555FF'>=</font> NULL;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, row<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font> result;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>do_local_background <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> result;
      png_voidp row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>png_get_rowbytes</font><font face='Lucida Console'>(</font>png_ptr, info_ptr<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row <font color='#5555FF'>=</font> row;
      result <font color='#5555FF'>=</font> <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_background, display<font face='Lucida Console'>)</font>;
      display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>local_row <font color='#5555FF'>=</font> NULL;
      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, row<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>return</font> result;
   <b>}</b>

   <font color='#0000FF'>else</font>
   <b>{</b>
      png_alloc_size_t row_bytes <font color='#5555FF'>=</font> display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_bytes;

      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>passes <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_32      y <font color='#5555FF'>=</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>height;
         png_bytep        row <font color='#5555FF'>=</font> <font color='#BB00BB'>png_voidcast</font><font face='Lucida Console'>(</font>png_bytep, display<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>first_row<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>y<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#BB00BB'>png_read_row</font><font face='Lucida Console'>(</font>png_ptr, row, NULL<font face='Lucida Console'>)</font>;
            row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> row_bytes;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>return</font> <font color='#979000'>1</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'><u>int</u></font> PNGAPI
<b><a name='png_image_finish_read'></a>png_image_finish_read</b><font face='Lucida Console'>(</font>png_imagep image, png_const_colorp background,
   <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>buffer, png_int_32 row_stride, <font color='#0000FF'><u>void</u></font> <font color='#5555FF'>*</font>colormap<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>version <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_IMAGE_VERSION<font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 check;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_stride <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         row_stride <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_IMAGE_ROW_STRIDE</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>image<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_stride <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         check <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>row_stride;

      <font color='#0000FF'>else</font>
         check <font color='#5555FF'>=</font> row_stride;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> buffer <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         check <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_IMAGE_ROW_STRIDE</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>image<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLORMAP<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colormap_entries <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> colormap <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> result;
            png_image_read_control display;

            <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>display, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> display<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            display.image <font color='#5555FF'>=</font> image;
            display.buffer <font color='#5555FF'>=</font> buffer;
            display.row_stride <font color='#5555FF'>=</font> row_stride;
            display.colormap <font color='#5555FF'>=</font> colormap;
            display.background <font color='#5555FF'>=</font> background;
            display.local_row <font color='#5555FF'>=</font> NULL;

            <font color='#009900'>/* Choose the correct 'end' routine; for the color-map case all the
             * setup has already been done.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>format <font color='#5555FF'>&amp;</font> PNG_FORMAT_FLAG_COLORMAP<font face='Lucida Console'>)</font>
               result <font color='#5555FF'>=</font>
                  <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_colormap, <font color='#5555FF'>&amp;</font>display<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                  <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_colormapped, <font color='#5555FF'>&amp;</font>display<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>else</font>
               result <font color='#5555FF'>=</font>
                  <font color='#BB00BB'>png_safe_execute</font><font face='Lucida Console'>(</font>image, png_image_read_direct, <font color='#5555FF'>&amp;</font>display<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>png_image_free</font><font face='Lucida Console'>(</font>image<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>return</font> result;
         <b>}</b>

         <font color='#0000FF'>else</font>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
               "<font color='#CC0000'>png_image_finish_read[color-map]: no color-map</font>"<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
         <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
            "<font color='#CC0000'>png_image_finish_read: invalid argument</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>image <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font> <font color='#BB00BB'>png_image_error</font><font face='Lucida Console'>(</font>image,
         "<font color='#CC0000'>png_image_finish_read: damaged PNG_IMAGE_VERSION</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_SIMPLIFIED_READ_SUPPORTED */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_SUPPORTED */</font>

</pre></body></html>