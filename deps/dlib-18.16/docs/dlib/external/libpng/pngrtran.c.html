<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - pngrtran.c</title></head><body bgcolor='white'><pre>

<font color='#009900'>/* pngrtran.c - transforms the data in a row for PNG readers
 *
 * Last changed in libpng 1.6.4 [August 21, 2013]
 * Copyright (c) 1998-2013 Glenn Randers-Pehrson
 * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
 * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
 *
 * This code is released under the libpng license.
 * For conditions of distribution and use, see the disclaimer
 * and license in png.h
 *
 * This file contains functions optionally called by an application
 * in order to tell libpng how to handle data when reading a PNG.
 * Transformations that are used in both reading and writing are
 * in pngtrans.c.
 */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='pngpriv.h.html'>pngpriv.h</a>"

<font color='#0000FF'>#ifdef</font> PNG_READ_SUPPORTED

<font color='#009900'>/* Set the action on getting a CRC error for an ancillary or critical chunk. */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_crc_action'></a>png_set_crc_action</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> crit_action, <font color='#0000FF'><u>int</u></font> ancil_action<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_crc_action</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* Tell libpng how we react to CRC errors in critical chunks */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>crit_action<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_CRC_NO_CHANGE:                        <font color='#009900'>/* Leave setting as is */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_WARN_USE:                               <font color='#009900'>/* Warn/use data */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_CRITICAL_MASK;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_CRC_CRITICAL_USE;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_QUIET_USE:                             <font color='#009900'>/* Quiet/use data */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_CRITICAL_MASK;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_CRC_CRITICAL_USE <font color='#5555FF'>|</font>
                           PNG_FLAG_CRC_CRITICAL_IGNORE;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_WARN_DISCARD:    <font color='#009900'>/* Not a valid action for critical data */</font>
         <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr,
            "<font color='#CC0000'>Can't discard critical data on CRC error</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>case</font> PNG_CRC_ERROR_QUIT:                                <font color='#009900'>/* Error/quit */</font>

      <font color='#0000FF'>case</font> PNG_CRC_DEFAULT:
      <font color='#0000FF'>default</font>:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_CRITICAL_MASK;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#009900'>/* Tell libpng how we react to CRC errors in ancillary chunks */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>ancil_action<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_CRC_NO_CHANGE:                       <font color='#009900'>/* Leave setting as is */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_WARN_USE:                              <font color='#009900'>/* Warn/use data */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_ANCILLARY_MASK;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_CRC_ANCILLARY_USE;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_QUIET_USE:                            <font color='#009900'>/* Quiet/use data */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_ANCILLARY_MASK;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_CRC_ANCILLARY_USE <font color='#5555FF'>|</font>
                           PNG_FLAG_CRC_ANCILLARY_NOWARN;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_ERROR_QUIT:                               <font color='#009900'>/* Error/quit */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_ANCILLARY_MASK;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_CRC_ANCILLARY_NOWARN;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_CRC_WARN_DISCARD:                      <font color='#009900'>/* Warn/discard data */</font>

      <font color='#0000FF'>case</font> PNG_CRC_DEFAULT:
      <font color='#0000FF'>default</font>:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_CRC_ANCILLARY_MASK;
         <font color='#0000FF'>break</font>;
   <b>}</b>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_TRANSFORMS_SUPPORTED
<font color='#009900'>/* Is it OK to set a transformation now?  Only if png_start_read_image or
 * png_read_update_info have not been called.  It is not necessary for the IHDR
 * to have been read in all cases, the parameter allows for this check too.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font>
<b><a name='png_rtran_ok'></a>png_rtran_ok</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> need_IHDR<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ROW_INIT<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_app_error</font><font face='Lucida Console'>(</font>png_ptr,
            "<font color='#CC0000'>invalid after png_start_read_image or png_read_update_info</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>need_IHDR <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_HAVE_IHDR<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_app_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid before the PNG header has been read</font>"<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* Turn on failure to initialize correctly for all transforms. */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_DETECT_UNINITIALIZED;

         <font color='#0000FF'>return</font> <font color='#979000'>1</font>; <font color='#009900'>/* Ok */</font>
      <b>}</b>
   <b>}</b>

   <font color='#0000FF'>return</font> <font color='#979000'>0</font>; <font color='#009900'>/* no png_error possible! */</font>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_BACKGROUND_SUPPORTED
<font color='#009900'>/* Handle alpha and tRNS via a background color */</font>
<font color='#0000FF'><u>void</u></font> PNGFAPI
<b><a name='png_set_background_fixed'></a>png_set_background_fixed</b><font face='Lucida Console'>(</font>png_structrp png_ptr,
    png_const_color_16p background_color, <font color='#0000FF'><u>int</u></font> background_gamma_code,
    <font color='#0000FF'><u>int</u></font> need_expand, png_fixed_point background_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_background_fixed</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> background_color <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>background_gamma_code <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_BACKGROUND_GAMMA_UNKNOWN<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Application must supply a known background gamma</font>"<font face='Lucida Console'>)</font>;
      <font color='#0000FF'>return</font>;
   <b>}</b>

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COMPOSE <font color='#5555FF'>|</font> PNG_STRIP_ALPHA;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>background_color;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma <font color='#5555FF'>=</font> background_gamma;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>background_gamma_code<font face='Lucida Console'>)</font>;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>need_expand<font face='Lucida Console'>)</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_BACKGROUND_EXPAND;
   <font color='#0000FF'>else</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_BACKGROUND_EXPAND;
<b>}</b>

#  ifdef PNG_FLOATING_POINT_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_background'></a>png_set_background</b><font face='Lucida Console'>(</font>png_structrp png_ptr,
    png_const_color_16p background_color, <font color='#0000FF'><u>int</u></font> background_gamma_code,
    <font color='#0000FF'><u>int</u></font> need_expand, <font color='#0000FF'><u>double</u></font> background_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_set_background_fixed</font><font face='Lucida Console'>(</font>png_ptr, background_color, background_gamma_code,
      need_expand, <font color='#BB00BB'>png_fixed</font><font face='Lucida Console'>(</font>png_ptr, background_gamma, "<font color='#CC0000'>png_set_background</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
#  endif  <font color='#009900'>/* FLOATING_POINT */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_BACKGROUND */</font>

<font color='#009900'>/* Scale 16-bit depth files to 8-bit depth.  If both of these are set then the
 * one that pngrtran does first (scale) happens.  This is necessary to allow the
 * TRANSFORM and API behavior to be somewhat consistent, and it's simpler.
 */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_SCALE_16_TO_8_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_scale_16'></a>png_set_scale_16</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_scale_16</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_SCALE_16_TO_8;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_16_TO_8_SUPPORTED
<font color='#009900'>/* Chop 16-bit depth files to 8-bit depth */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_strip_16'></a>png_set_strip_16</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_strip_16</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_16_TO_8;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_ALPHA_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_strip_alpha'></a>png_set_strip_alpha</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_strip_alpha</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_STRIP_ALPHA;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> defined<font face='Lucida Console'>(</font>PNG_READ_GAMMA_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#0000FF'>static</font> png_fixed_point
<b><a name='translate_gamma_flags'></a>translate_gamma_flags</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_fixed_point output_gamma,
   <font color='#0000FF'><u>int</u></font> is_screen<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Check for flag values.  The main reason for having the old Mac value as a
    * flag is that it is pretty near impossible to work out what the correct
    * value is from Apple documentation - a working Mac system is needed to
    * discover the value!
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_DEFAULT_sRGB <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      output_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FP_1 <font color='#5555FF'>/</font> PNG_DEFAULT_sRGB<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* If there is no sRGB support this just sets the gamma to the standard
       * sRGB value.  (This is a side effect of using this function!)
       */</font>
#     ifdef PNG_READ_sRGB_SUPPORTED
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_ASSUME_sRGB;
#     <font color='#0000FF'>else</font>
         <font color='#BB00BB'>PNG_UNUSED</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>
#     endif
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>is_screen<font face='Lucida Console'>)</font>
         output_gamma <font color='#5555FF'>=</font> PNG_GAMMA_sRGB;
      <font color='#0000FF'>else</font>
         output_gamma <font color='#5555FF'>=</font> PNG_GAMMA_sRGB_INVERSE;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_GAMMA_MAC_18 <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      output_gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_FP_1 <font color='#5555FF'>/</font> PNG_GAMMA_MAC_18<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>is_screen<font face='Lucida Console'>)</font>
         output_gamma <font color='#5555FF'>=</font> PNG_GAMMA_MAC_OLD;
      <font color='#0000FF'>else</font>
         output_gamma <font color='#5555FF'>=</font> PNG_GAMMA_MAC_INVERSE;
   <b>}</b>

   <font color='#0000FF'>return</font> output_gamma;
<b>}</b>

#  ifdef PNG_FLOATING_POINT_SUPPORTED
<font color='#0000FF'>static</font> png_fixed_point
<b><a name='convert_gamma_value'></a>convert_gamma_value</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>double</u></font> output_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* The following silently ignores cases where fixed point (times 100,000)
    * gamma values are passed to the floating point API.  This is safe and it
    * means the fixed point constants work just fine with the floating point
    * API.  The alternative would just lead to undetected errors and spurious
    * bug reports.  Negative values fail inside the _fixed API unless they
    * correspond to the flag values.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> output_gamma <font color='#5555FF'>&lt;</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font>
      output_gamma <font color='#5555FF'>*</font><font color='#5555FF'>=</font> PNG_FP_1;

   <font color='#009900'>/* This preserves -1 and -2 exactly: */</font>
   output_gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>floor</font><font face='Lucida Console'>(</font>output_gamma <font color='#5555FF'>+</font> .<font color='#979000'>5</font><font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_gamma <font color='#5555FF'>&gt;</font> PNG_FP_MAX <font color='#5555FF'>|</font><font color='#5555FF'>|</font> output_gamma <font color='#5555FF'>&lt;</font> PNG_FP_MIN<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_fixed_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>gamma value</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>png_fixed_point<font face='Lucida Console'>)</font>output_gamma;
<b>}</b>
#  endif
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_ALPHA_MODE || READ_GAMMA */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_ALPHA_MODE_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGFAPI
<b><a name='png_set_alpha_mode_fixed'></a>png_set_alpha_mode_fixed</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> mode,
   png_fixed_point output_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> compose <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   png_fixed_point file_gamma;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_alpha_mode</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   output_gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>translate_gamma_flags</font><font face='Lucida Console'>(</font>png_ptr, output_gamma, <font color='#979000'>1</font><font color='#009900'>/*screen*/</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Validate the value to ensure it is in a reasonable range. The value
    * is expected to be 1 or greater, but this range test allows for some
    * viewing correction values.  The intent is to weed out users of this API
    * who use the inverse of the gamma value accidentally!  Since some of these
    * values are reasonable this may have to be changed.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>output_gamma <font color='#5555FF'>&lt;</font> <font color='#979000'>70000</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> output_gamma <font color='#5555FF'>&gt;</font> <font color='#979000'>300000</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>output gamma out of expected range</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The default file gamma is the inverse of the output gamma; the output
    * gamma may be changed below so get the file value first:
    */</font>
   file_gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>output_gamma<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* There are really 8 possibilities here, composed of any combination
    * of:
    *
    *    premultiply the color channels
    *    do not encode non-opaque pixels
    *    encode the alpha as well as the color channels
    *
    * The differences disappear if the input/output ('screen') gamma is 1.0,
    * because then the encoding is a no-op and there is only the choice of
    * premultiplying the color channels or not.
    *
    * png_set_alpha_mode and png_set_background interact because both use
    * png_compose to do the work.  Calling both is only useful when
    * png_set_alpha_mode is used to set the default mode - PNG_ALPHA_PNG - along
    * with a default gamma value.  Otherwise PNG_COMPOSE must not be set.
    */</font>
   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>mode<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_ALPHA_PNG:        <font color='#009900'>/* default: png standard */</font>
         <font color='#009900'>/* No compose, but it may be set by png_set_background! */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_ALPHA_ASSOCIATED: <font color='#009900'>/* color channels premultiplied */</font>
         compose <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;
         <font color='#009900'>/* The output is linear: */</font>
         output_gamma <font color='#5555FF'>=</font> PNG_FP_1;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_ALPHA_OPTIMIZED:  <font color='#009900'>/* associated, non-opaque pixels linear */</font>
         compose <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_FLAG_OPTIMIZE_ALPHA;
         <font color='#009900'>/* output_gamma records the encoding of opaque pixels! */</font>
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_ALPHA_BROKEN:     <font color='#009900'>/* associated, non-linear, alpha encoded */</font>
         compose <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_ENCODE_ALPHA;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid alpha mode</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* Only set the default gamma if the file gamma has not been set (this has
    * the side effect that the gamma in a second call to png_set_alpha_mode will
    * be ignored.)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> file_gamma;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_GAMMA;
   <b>}</b>

   <font color='#009900'>/* But always set the output gamma: */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font> output_gamma;

   <font color='#009900'>/* Finally, if pre-multiplying, set the background fields to achieve the
    * desired result.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>compose<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* And obtain alpha pre-multiplication by composing on black: */</font>
      <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background, <font color='#979000'>0</font>, <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma; <font color='#009900'>/* just in case */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type <font color='#5555FF'>=</font> PNG_BACKGROUND_GAMMA_FILE;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_BACKGROUND_EXPAND;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr,
            "<font color='#CC0000'>conflicting calls to set alpha mode and background</font>"<font face='Lucida Console'>)</font>;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COMPOSE;
   <b>}</b>
<b>}</b>

#  ifdef PNG_FLOATING_POINT_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_alpha_mode'></a>png_set_alpha_mode</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> mode, <font color='#0000FF'><u>double</u></font> output_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_set_alpha_mode_fixed</font><font face='Lucida Console'>(</font>png_ptr, mode, <font color='#BB00BB'>convert_gamma_value</font><font face='Lucida Console'>(</font>png_ptr,
      output_gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
#  endif
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_QUANTIZE_SUPPORTED
<font color='#009900'>/* Dither file to 8-bit.  Supply a palette, the current number
 * of elements in the palette, the maximum number of elements
 * allowed, and a histogram if possible.  If the current number
 * of colors is greater then the maximum number, the palette will be
 * modified to fit in the maximum number.  "full_quantize" indicates
 * whether we need a quantizing cube set up for RGB images, or if we
 * simply are reducing the number of colors in a paletted image.
 */</font>

<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> <b><a name='png_dsort_struct'></a>png_dsort_struct</b>
<b>{</b>
   <font color='#0000FF'>struct</font> png_dsort_struct <font color='#5555FF'>*</font> next;
   png_byte left;
   png_byte right;
<b>}</b> png_dsort;
<font color='#0000FF'>typedef</font> png_dsort <font color='#5555FF'>*</font>   png_dsortp;
<font color='#0000FF'>typedef</font> png_dsort <font color='#5555FF'>*</font> <font color='#5555FF'>*</font> png_dsortpp;

<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_quantize'></a>png_set_quantize</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_colorp palette,
    <font color='#0000FF'><u>int</u></font> num_palette, <font color='#0000FF'><u>int</u></font> maximum_colors, png_const_uint_16p histogram,
    <font color='#0000FF'><u>int</u></font> full_quantize<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_quantize</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_QUANTIZE;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>full_quantize<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
          <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_palette <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_palette <font color='#5555FF'>&gt;</font> maximum_colors<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>histogram <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This is easy enough, just throw out the least used colors.
          * Perhaps not the best solution, but good enough.
          */</font>

         <font color='#0000FF'><u>int</u></font> i;

         <font color='#009900'>/* Initialize an array to sort colors */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
             <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_palette <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Initialize the quantize_sort array */</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;

         <font color='#009900'>/* Find the least used palette entries by starting a
          * bubble sort, and running it until we have sorted
          * out enough colors.  Note that we don't care about
          * sorting all the colors, just finding which are
          * least used.
          */</font>

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> num_palette <font color='#5555FF'>-</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> maximum_colors; i<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> done; <font color='#009900'>/* To stop early if the list is pre-sorted */</font>
            <font color='#0000FF'><u>int</u></font> j;

            done <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> <font color='#979000'>0</font>; j <font color='#5555FF'>&lt;</font> i; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>histogram[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j]]
                   <font color='#5555FF'>&lt;</font> histogram[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j <font color='#5555FF'>+</font> <font color='#979000'>1</font>]]<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_byte t;

                  t <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j];
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j] <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j <font color='#5555FF'>+</font> <font color='#979000'>1</font>];
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j <font color='#5555FF'>+</font> <font color='#979000'>1</font>] <font color='#5555FF'>=</font> t;
                  done <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>done<font face='Lucida Console'>)</font>
               <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#009900'>/* Swap the palette around, and set up a table, if necessary */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>full_quantize<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> j <font color='#5555FF'>=</font> num_palette;

            <font color='#009900'>/* Put all the useful colors within the max, but don't
             * move the others.
             */</font>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> maximum_colors; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[i] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>do</font>
                     j<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>;

                  palette[i] <font color='#5555FF'>=</font> palette[j];
               <b>}</b>
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> j <font color='#5555FF'>=</font> num_palette;

            <font color='#009900'>/* Move all the used colors inside the max limit, and
             * develop a translation table.
             */</font>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> maximum_colors; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* Only move the colors we need to */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[i] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_color tmp_color;

                  <font color='#0000FF'>do</font>
                     j<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort[j] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>;

                  tmp_color <font color='#5555FF'>=</font> palette[j];
                  palette[j] <font color='#5555FF'>=</font> palette[i];
                  palette[i] <font color='#5555FF'>=</font> tmp_color;
                  <font color='#009900'>/* Indicate where the color went */</font>
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[j] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>j;
               <b>}</b>
            <b>}</b>

            <font color='#009900'>/* Find closest color for those colors we are not using */</font>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[i] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>int</u></font> min_d, k, min_k, d_index;

                  <font color='#009900'>/* Find the closest color to one we threw out */</font>
                  d_index <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[i];
                  min_d <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_COLOR_DIST</font><font face='Lucida Console'>(</font>palette[d_index], palette[<font color='#979000'>0</font>]<font face='Lucida Console'>)</font>;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>k <font color='#5555FF'>=</font> <font color='#979000'>1</font>, min_k <font color='#5555FF'>=</font> <font color='#979000'>0</font>; k <font color='#5555FF'>&lt;</font> maximum_colors; k<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'><u>int</u></font> d;

                     d <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_COLOR_DIST</font><font face='Lucida Console'>(</font>palette[d_index], palette[k]<font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>d <font color='#5555FF'>&lt;</font> min_d<font face='Lucida Console'>)</font>
                     <b>{</b>
                        min_d <font color='#5555FF'>=</font> d;
                        min_k <font color='#5555FF'>=</font> k;
                     <b>}</b>
                  <b>}</b>
                  <font color='#009900'>/* Point to closest color */</font>
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>min_k;
               <b>}</b>
            <b>}</b>
         <b>}</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort<font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_sort <font color='#5555FF'>=</font> NULL;
      <b>}</b>
      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* This is much harder to do simply (and quickly).  Perhaps
          * we need to go through a median cut routine, but those
          * don't always behave themselves with only a few colors
          * as input.  So we will just find the closest two colors,
          * and throw out one of them (chosen somewhat randomly).
          * [We don't understand this at all, so if someone wants to
          *  work on improving it, be our guest - AED, GRP]
          */</font>
         <font color='#0000FF'><u>int</u></font> i;
         <font color='#0000FF'><u>int</u></font> max_d;
         <font color='#0000FF'><u>int</u></font> num_new_palette;
         png_dsortp t;
         png_dsortpp hash;

         t <font color='#5555FF'>=</font> NULL;

         <font color='#009900'>/* Initialize palette index arrays */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
             <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_palette <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr,
             <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_palette <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Initialize the sort array */</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
         <b>}</b>

         hash <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_dsortpp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_calloc</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>769</font> <font color='#5555FF'>*</font>
             <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_dsortp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

         num_new_palette <font color='#5555FF'>=</font> num_palette;

         <font color='#009900'>/* Initial wild guess at how far apart the farthest pixel
          * pair we will be eliminating will be.  Larger
          * numbers mean more areas will be allocated, Smaller
          * numbers run the risk of not saving enough data, and
          * having to do this all over again.
          *
          * I have not done extensive checking on this number.
          */</font>
         max_d <font color='#5555FF'>=</font> <font color='#979000'>96</font>;

         <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>num_new_palette <font color='#5555FF'>&gt;</font> maximum_colors<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_new_palette <font color='#5555FF'>-</font> <font color='#979000'>1</font>; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>int</u></font> j;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>j <font color='#5555FF'>=</font> i <font color='#5555FF'>+</font> <font color='#979000'>1</font>; j <font color='#5555FF'>&lt;</font> num_new_palette; j<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>int</u></font> d;

                  d <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_COLOR_DIST</font><font face='Lucida Console'>(</font>palette[i], palette[j]<font face='Lucida Console'>)</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>d <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> max_d<font face='Lucida Console'>)</font>
                  <b>{</b>

                     t <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_dsortp<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc_warn</font><font face='Lucida Console'>(</font>png_ptr,
                         <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_dsort<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>t <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                         <font color='#0000FF'>break</font>;

                     t<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next <font color='#5555FF'>=</font> hash[d];
                     t<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>left <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
                     t<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>right <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>j;
                     hash[d] <font color='#5555FF'>=</font> t;
                  <b>}</b>
               <b>}</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>t <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>t <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> max_d; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>hash[i] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_dsortp p;

                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>=</font> hash[i]; p; p <font color='#5555FF'>=</font> p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>left]
                         <font color='#5555FF'>&lt;</font> num_new_palette <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>right]
                         <font color='#5555FF'>&lt;</font> num_new_palette<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'><u>int</u></font> j, next_j;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_new_palette <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font>
                        <b>{</b>
                           j <font color='#5555FF'>=</font> p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>left;
                           next_j <font color='#5555FF'>=</font> p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>right;
                        <b>}</b>
                        <font color='#0000FF'>else</font>
                        <b>{</b>
                           j <font color='#5555FF'>=</font> p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>right;
                           next_j <font color='#5555FF'>=</font> p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>left;
                        <b>}</b>

                        num_new_palette<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                        palette[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[j]]
                            <font color='#5555FF'>=</font> palette[num_new_palette];
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>full_quantize<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#0000FF'><u>int</u></font> k;

                           <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>k <font color='#5555FF'>=</font> <font color='#979000'>0</font>; k <font color='#5555FF'>&lt;</font> num_palette; k<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                           <b>{</b>
                              <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[k] <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
                                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[j]<font face='Lucida Console'>)</font>
                                 png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[k] <font color='#5555FF'>=</font>
                                     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[next_j];

                              <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[k] <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
                                  num_new_palette<font face='Lucida Console'>)</font>
                                 png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index[k] <font color='#5555FF'>=</font>
                                     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[j];
                           <b>}</b>
                        <b>}</b>

                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index
                            [num_new_palette]] <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[j];

                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[j]]
                            <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index[num_new_palette];

                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette[j] <font color='#5555FF'>=</font>
                            <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>num_new_palette;

                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index[num_new_palette] <font color='#5555FF'>=</font>
                            <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>j;
                     <b>}</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_new_palette <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>
                        <font color='#0000FF'>break</font>;
                  <b>}</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_new_palette <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> maximum_colors<font face='Lucida Console'>)</font>
                     <font color='#0000FF'>break</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> <font color='#979000'>769</font>; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>hash[i] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_dsortp p <font color='#5555FF'>=</font> hash[i];
                  <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>p<font face='Lucida Console'>)</font>
                  <b>{</b>
                     t <font color='#5555FF'>=</font> p<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next;
                     <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, p<font face='Lucida Console'>)</font>;
                     p <font color='#5555FF'>=</font> t;
                  <b>}</b>
               <b>}</b>
               hash[i] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <b>}</b>
            max_d <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>96</font>;
         <b>}</b>
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, hash<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index<font face='Lucida Console'>)</font>;
         <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette<font face='Lucida Console'>)</font>;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_to_index <font color='#5555FF'>=</font> NULL;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>index_to_palette <font color='#5555FF'>=</font> NULL;
      <b>}</b>
      num_palette <font color='#5555FF'>=</font> maximum_colors;
   <b>}</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette <font color='#5555FF'>=</font> palette;
   <b>}</b>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>num_palette;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>full_quantize<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;
      png_bytep distance;
      <font color='#0000FF'><u>int</u></font> total_bits <font color='#5555FF'>=</font> PNG_QUANTIZE_RED_BITS <font color='#5555FF'>+</font> PNG_QUANTIZE_GREEN_BITS <font color='#5555FF'>+</font>
          PNG_QUANTIZE_BLUE_BITS;
      <font color='#0000FF'><u>int</u></font> num_red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_RED_BITS<font face='Lucida Console'>)</font>;
      <font color='#0000FF'><u>int</u></font> num_green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font>;
      <font color='#0000FF'><u>int</u></font> num_blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font>;
      png_size_t num_entries <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> total_bits<font face='Lucida Console'>)</font>;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_lookup <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_calloc</font><font face='Lucida Console'>(</font>png_ptr,
          <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_entries <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      distance <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_bytep<font face='Lucida Console'>)</font><font color='#BB00BB'>png_malloc</font><font face='Lucida Console'>(</font>png_ptr, <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>num_entries <font color='#5555FF'>*</font>
          <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      <font color='#BB00BB'>memset</font><font face='Lucida Console'>(</font>distance, <font color='#979000'>0xff</font>, num_entries <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> ir, ig, ib;
         <font color='#0000FF'><u>int</u></font> r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>palette[i].red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_RED_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
         <font color='#0000FF'><u>int</u></font> g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>palette[i].green <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
         <font color='#0000FF'><u>int</u></font> b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>palette[i].blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>ir <font color='#5555FF'>=</font> <font color='#979000'>0</font>; ir <font color='#5555FF'>&lt;</font> num_red; ir<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* int dr = abs(ir - r); */</font>
            <font color='#0000FF'><u>int</u></font> dr <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ir <font color='#5555FF'>&gt;</font> r<font face='Lucida Console'>)</font> ? ir <font color='#5555FF'>-</font> r : r <font color='#5555FF'>-</font> ir<font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>int</u></font> index_r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ir <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>PNG_QUANTIZE_BLUE_BITS <font color='#5555FF'>+</font>
                PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>ig <font color='#5555FF'>=</font> <font color='#979000'>0</font>; ig <font color='#5555FF'>&lt;</font> num_green; ig<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* int dg = abs(ig - g); */</font>
               <font color='#0000FF'><u>int</u></font> dg <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ig <font color='#5555FF'>&gt;</font> g<font face='Lucida Console'>)</font> ? ig <font color='#5555FF'>-</font> g : g <font color='#5555FF'>-</font> ig<font face='Lucida Console'>)</font>;
               <font color='#0000FF'><u>int</u></font> dt <font color='#5555FF'>=</font> dr <font color='#5555FF'>+</font> dg;
               <font color='#0000FF'><u>int</u></font> dm <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>dr <font color='#5555FF'>&gt;</font> dg<font face='Lucida Console'>)</font> ? dr : dg<font face='Lucida Console'>)</font>;
               <font color='#0000FF'><u>int</u></font> index_g <font color='#5555FF'>=</font> index_r <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>ig <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font>;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>ib <font color='#5555FF'>=</font> <font color='#979000'>0</font>; ib <font color='#5555FF'>&lt;</font> num_blue; ib<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>int</u></font> d_index <font color='#5555FF'>=</font> index_g <font color='#5555FF'>|</font> ib;
                  <font color='#009900'>/* int db = abs(ib - b); */</font>
                  <font color='#0000FF'><u>int</u></font> db <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ib <font color='#5555FF'>&gt;</font> b<font face='Lucida Console'>)</font> ? ib <font color='#5555FF'>-</font> b : b <font color='#5555FF'>-</font> ib<font face='Lucida Console'>)</font>;
                  <font color='#0000FF'><u>int</u></font> dmax <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>dm <font color='#5555FF'>&gt;</font> db<font face='Lucida Console'>)</font> ? dm : db<font face='Lucida Console'>)</font>;
                  <font color='#0000FF'><u>int</u></font> d <font color='#5555FF'>=</font> dmax <font color='#5555FF'>+</font> dt <font color='#5555FF'>+</font> db;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>d <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>distance[d_index]<font face='Lucida Console'>)</font>
                  <b>{</b>
                     distance[d_index] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>d;
                     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_lookup[d_index] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>i;
                  <b>}</b>
               <b>}</b>
            <b>}</b>
         <b>}</b>
      <b>}</b>

      <font color='#BB00BB'>png_free</font><font face='Lucida Console'>(</font>png_ptr, distance<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_QUANTIZE_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGFAPI
<b><a name='png_set_gamma_fixed'></a>png_set_gamma_fixed</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_fixed_point scrn_gamma,
   png_fixed_point file_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_gamma_fixed</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* New in libpng-1.5.4 - reserve particular negative values as flags. */</font>
   scrn_gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>translate_gamma_flags</font><font face='Lucida Console'>(</font>png_ptr, scrn_gamma, <font color='#979000'>1</font><font color='#009900'>/*screen*/</font><font face='Lucida Console'>)</font>;
   file_gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>translate_gamma_flags</font><font face='Lucida Console'>(</font>png_ptr, file_gamma, <font color='#979000'>0</font><font color='#009900'>/*file*/</font><font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Checking the gamma values for being &gt;0 was added in 1.5.4 along with the
    * premultiplied alpha support; this actually hides an undocumented feature
    * of the previous implementation which allowed gamma processing to be
    * disabled in background handling.  There is no evidence (so far) that this
    * was being used; however, png_set_background itself accepted and must still
    * accept '0' for the gamma value it takes, because it isn't always used.
    *
    * Since this is an API change (albeit a very minor one that removes an
    * undocumented API feature) the following checks were only enabled in
    * libpng-1.6.0.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>file_gamma <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid file gamma in png_set_gamma</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>scrn_gamma <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid screen gamma in png_set_gamma</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Set the gamma values unconditionally - this overrides the value in the PNG
    * file if a gAMA chunk was present.  png_set_alpha_mode provides a
    * different, easier, way to default the file gamma.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> file_gamma;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_GAMMA;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font> scrn_gamma;
<b>}</b>

#  ifdef PNG_FLOATING_POINT_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_gamma'></a>png_set_gamma</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>double</u></font> scrn_gamma, <font color='#0000FF'><u>double</u></font> file_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_set_gamma_fixed</font><font face='Lucida Console'>(</font>png_ptr, <font color='#BB00BB'>convert_gamma_value</font><font face='Lucida Console'>(</font>png_ptr, scrn_gamma<font face='Lucida Console'>)</font>,
      <font color='#BB00BB'>convert_gamma_value</font><font face='Lucida Console'>(</font>png_ptr, file_gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
#  endif <font color='#009900'>/* FLOATING_POINT_SUPPORTED */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* READ_GAMMA */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
<font color='#009900'>/* Expand paletted images to RGB, expand grayscale images of
 * less than 8-bit depth to 8-bit depth, and expand tRNS chunks
 * to alpha channels.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_expand'></a>png_set_expand</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_expand</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>PNG_EXPAND <font color='#5555FF'>|</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* GRR 19990627:  the following three functions currently are identical
 *  to png_set_expand().  However, it is entirely reasonable that someone
 *  might wish to expand an indexed image to RGB but *not* expand a single,
 *  fully transparent palette entry to a full alpha channel--perhaps instead
 *  convert tRNS to the grayscale/RGB format (16-bit RGB value), or replace
 *  the transparent color with a particular RGB value, or drop tRNS entirely.
 *  IOW, a future version of the library may make the transformations flag
 *  a bit more fine-grained, with separate bits for each of these three
 *  functions.
 *
 *  More to the point, these functions make it obvious what libpng will be
 *  doing, whereas "expand" can (and does) mean any number of things.
 *
 *  GRP 20060307: In libpng-1.2.9, png_set_gray_1_2_4_to_8() was modified
 *  to expand only the sample depth but not to expand the tRNS to alpha
 *  and its name was changed to png_set_expand_gray_1_2_4_to_8().
 */</font>

<font color='#009900'>/* Expand paletted images to RGB. */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_palette_to_rgb'></a>png_set_palette_to_rgb</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_palette_to_rgb</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>PNG_EXPAND <font color='#5555FF'>|</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* Expand grayscale images of less than 8-bit depth to 8 bits. */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_expand_gray_1_2_4_to_8'></a>png_set_expand_gray_1_2_4_to_8</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_expand_gray_1_2_4_to_8</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_EXPAND;
<b>}</b>

<font color='#009900'>/* Expand tRNS chunks to alpha channels. */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_tRNS_to_alpha'></a>png_set_tRNS_to_alpha</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_tRNS_to_alpha</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>PNG_EXPAND <font color='#5555FF'>|</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* defined(PNG_READ_EXPAND_SUPPORTED) */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_16_SUPPORTED
<font color='#009900'>/* Expand to 16-bit channels, expand the tRNS chunk too (because otherwise
 * it may not work correctly.)
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_expand_16'></a>png_set_expand_16</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_expand_16</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>PNG_EXPAND_16 <font color='#5555FF'>|</font> PNG_EXPAND <font color='#5555FF'>|</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_gray_to_rgb'></a>png_set_gray_to_rgb</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_gray_to_rgb</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#009900'>/* Because rgb must be 8 bits or more: */</font>
   <font color='#BB00BB'>png_set_expand_gray_1_2_4_to_8</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_GRAY_TO_RGB;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
<font color='#0000FF'><u>void</u></font> PNGFAPI
<b><a name='png_set_rgb_to_gray_fixed'></a>png_set_rgb_to_gray_fixed</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> error_action,
    png_fixed_point red, png_fixed_point green<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_rgb_to_gray</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Need the IHDR here because of the check on color_type below. */</font>
   <font color='#009900'>/* TODO: fix this */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_rtran_ok</font><font face='Lucida Console'>(</font>png_ptr, <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>switch</font><font face='Lucida Console'>(</font>error_action<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> PNG_ERROR_ACTION_NONE:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_RGB_TO_GRAY;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_ERROR_ACTION_WARN:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_RGB_TO_GRAY_WARN;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> PNG_ERROR_ACTION_ERROR:
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_RGB_TO_GRAY_ERR;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid error action to rgb_to_gray</font>"<font face='Lucida Console'>)</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_EXPAND;
<font color='#0000FF'>#else</font>
   <b>{</b>
      <font color='#009900'>/* Make this an error in 1.6 because otherwise the application may assume
       * that it just worked and get a memory overwrite.
       */</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr,
        "<font color='#CC0000'>Cannot do RGB_TO_GRAY without EXPAND_SUPPORTED</font>"<font face='Lucida Console'>)</font>;

      <font color='#009900'>/* png_ptr-&gt;transformations &amp;= ~PNG_RGB_TO_GRAY; */</font>
   <b>}</b>
<font color='#0000FF'>#endif</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> green <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> red <font color='#5555FF'>+</font> green <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> PNG_FP_1<font face='Lucida Console'>)</font>
      <b>{</b>
         png_uint_16 red_int, green_int;

         <font color='#009900'>/* NOTE: this calculation does not round, but this behavior is retained
          * for consistency, the inaccuracy is very small.  The code here always
          * overwrites the coefficients, regardless of whether they have been
          * defaulted or set already.
          */</font>
         red_int <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>red<font color='#5555FF'>*</font><font color='#979000'>32768</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>100000</font><font face='Lucida Console'>)</font>;
         green_int <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>green<font color='#5555FF'>*</font><font color='#979000'>32768</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font color='#979000'>100000</font><font face='Lucida Console'>)</font>;

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_red_coeff   <font color='#5555FF'>=</font> red_int;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_green_coeff <font color='#5555FF'>=</font> green_int;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_coefficients_set <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> green <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_app_warning</font><font face='Lucida Console'>(</font>png_ptr,
               "<font color='#CC0000'>ignoring out of range rgb_to_gray coefficients</font>"<font face='Lucida Console'>)</font>;

         <font color='#009900'>/* Use the defaults, from the cHRM chunk if set, else the historical
          * values which are close to the sRGB/HDTV/ITU-Rec 709 values.  See
          * png_do_rgb_to_gray for more discussion of the values.  In this case
          * the coefficients are not marked as 'set' and are not overwritten if
          * something has already provided a default.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_red_coeff <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_green_coeff <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_red_coeff   <font color='#5555FF'>=</font> <font color='#979000'>6968</font>;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_green_coeff <font color='#5555FF'>=</font> <font color='#979000'>23434</font>;
            <font color='#009900'>/* png_ptr-&gt;rgb_to_gray_blue_coeff  = 2366; */</font>
         <b>}</b>
      <b>}</b>
   <b>}</b>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_FLOATING_POINT_SUPPORTED
<font color='#009900'>/* Convert a RGB image to a grayscale of the same width.  This allows us,
 * for example, to convert a 24 bpp RGB image into an 8 bpp grayscale image.
 */</font>

<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_rgb_to_gray'></a>png_set_rgb_to_gray</b><font face='Lucida Console'>(</font>png_structrp png_ptr, <font color='#0000FF'><u>int</u></font> error_action, <font color='#0000FF'><u>double</u></font> red,
   <font color='#0000FF'><u>double</u></font> green<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_set_rgb_to_gray_fixed</font><font face='Lucida Console'>(</font>png_ptr, error_action,
      <font color='#BB00BB'>png_fixed</font><font face='Lucida Console'>(</font>png_ptr, red, "<font color='#CC0000'>rgb to gray red coefficient</font>"<font face='Lucida Console'>)</font>,
      <font color='#BB00BB'>png_fixed</font><font face='Lucida Console'>(</font>png_ptr, green, "<font color='#CC0000'>rgb to gray green coefficient</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* FLOATING POINT */</font>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* RGB_TO_GRAY */</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_USER_TRANSFORM_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
    <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>PNG_WRITE_USER_TRANSFORM_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_set_read_user_transform_fn'></a>png_set_read_user_transform_fn</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_user_transform_ptr
    read_user_transform_fn<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_set_read_user_transform_fn</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_USER_TRANSFORM_SUPPORTED
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_USER_TRANSFORM;
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_user_transform_fn <font color='#5555FF'>=</font> read_user_transform_fn;
<font color='#0000FF'>#endif</font>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_TRANSFORMS_SUPPORTED
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
<font color='#009900'>/* In the case of gamma transformations only do transformations on images where
 * the [file] gamma and screen_gamma are not close reciprocals, otherwise it
 * slows things down slightly, and also needlessly introduces small errors.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_gamma_threshold'></a>png_gamma_threshold</b><font face='Lucida Console'>(</font>png_fixed_point screen_gamma, png_fixed_point file_gamma<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* PNG_GAMMA_THRESHOLD is the threshold for performing gamma
    * correction as a difference of the overall transform from 1.0
    *
    * We want to compare the threshold with s*f - 1, if we get
    * overflow here it is because of wacky gamma values so we
    * turn on processing anyway.
    */</font>
   png_fixed_point gtest;
   <font color='#0000FF'>return</font> <font color='#5555FF'>!</font><font color='#BB00BB'>png_muldiv</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>gtest, screen_gamma, file_gamma, PNG_FP_1<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gtest<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Initialize everything needed for the read.  This includes modifying
 * the palette.
 */</font>

<font color='#009900'>/*For the moment 'png_init_palette_transformations' and
 * 'png_init_rgb_transformations' only do some flag canceling optimizations.
 * The intent is that these two routines should have palette or rgb operations
 * extracted from 'png_init_read_transformations'.
 */</font>
<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_init_palette_transformations'></a>png_init_palette_transformations</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Called to handle the (input) palette case.  In png_do_read_transformations
    * the first step is to expand the palette if requested, so this code must
    * take care to only make changes that are invariant with respect to the
    * palette expansion, or only do them if there is no expansion.
    *
    * STRIP_ALPHA has already been handled in the caller (by setting num_trans
    * to 0.)
    */</font>
   <font color='#0000FF'><u>int</u></font> input_has_alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>int</u></font> input_has_transparency <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;

      <font color='#009900'>/* Ignore if all the entries are opaque (unlikely!) */</font>
      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>255</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>continue</font>;
         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            input_has_transparency <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <font color='#0000FF'>else</font>
         <b>{</b>
            input_has_transparency <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            input_has_alpha <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>break</font>;
         <b>}</b>
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* If no alpha we can optimize. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>input_has_alpha<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Any alpha means background and associative alpha processing is
       * required, however if the alpha is 0 or 1 throughout OPTIIMIZE_ALPHA
       * and ENCODE_ALPHA are irrelevant.
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>input_has_transparency<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~<font face='Lucida Console'>(</font>PNG_COMPOSE <font color='#5555FF'>|</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font>;
   <b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_EXPAND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#009900'>/* png_set_background handling - deals with the complexity of whether the
    * background color is in the file format or the screen format in the case
    * where an 'expand' will happen.
    */</font>

   <font color='#009900'>/* The following code cannot be entered in the alpha pre-multiplication case
    * because PNG_BACKGROUND_EXPAND is cancelled below.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red   <font color='#5555FF'>=</font>
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.index].red;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>=</font>
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.index].green;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue  <font color='#5555FF'>=</font>
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.index].blue;

<font color='#0000FF'>#ifdef</font> PNG_READ_INVERT_ALPHA_SUPPORTED
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INVERT_ALPHA<font face='Lucida Console'>)</font>
        <b>{</b>
           <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
           <b>{</b>
              <font color='#009900'>/* Invert the alpha channel (in tRNS) unless the pixels are
               * going to be expanded, in which case leave it for later
               */</font>
              <font color='#0000FF'><u>int</u></font> i, istop <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans;

              <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font>istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                 png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font>
                    png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i]<font face='Lucida Console'>)</font>;
           <b>}</b>
        <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_INVERT_ALPHA_SUPPORTED */</font>
      <b>}</b>
   <b>}</b> <font color='#009900'>/* background expand and (therefore) no alpha association. */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_EXPAND_SUPPORTED &amp;&amp; PNG_READ_BACKGROUND_SUPPORTED */</font>
<b>}</b>

<font color='#0000FF'>static</font> <font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_init_rgb_transformations'></a>png_init_rgb_transformations</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#009900'>/* Added to libpng-1.5.4: check the color type to determine whether there
    * is any alpha or transparency in the image and simply cancel the
    * background and alpha mode stuff if there isn't.
    */</font>
   <font color='#0000FF'><u>int</u></font> input_has_alpha <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <font color='#0000FF'><u>int</u></font> input_has_transparency <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>;

   <font color='#009900'>/* If no alpha we can optimize. */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>input_has_alpha<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Any alpha means background and associative alpha processing is
       * required, however if the alpha is 0 or 1 throughout OPTIIMIZE_ALPHA
       * and ENCODE_ALPHA are irrelevant.
       */</font>
#     ifdef PNG_READ_ALPHA_MODE_SUPPORTED
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;
#     endif

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>input_has_transparency<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~<font face='Lucida Console'>(</font>PNG_COMPOSE <font color='#5555FF'>|</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font>;
   <b>}</b>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_EXPAND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#009900'>/* png_set_background handling - deals with the complexity of whether the
    * background color is in the file format or the screen format in the case
    * where an 'expand' will happen.
    */</font>

   <font color='#009900'>/* The following code cannot be entered in the alpha pre-multiplication case
    * because PNG_BACKGROUND_EXPAND is cancelled below.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
       <font color='#009900'>/* i.e., GRAY or GRAY_ALPHA */</font>
   <b>{</b>
      <b>{</b>
         <font color='#009900'>/* Expand background and tRNS chunks */</font>
         <font color='#0000FF'><u>int</u></font> gray <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray;
         <font color='#0000FF'><u>int</u></font> trans_gray <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray;

         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               gray <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
               trans_gray <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               gray <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>0x55</font>;
               trans_gray <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>0x55</font>;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
               gray <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>0x11</font>;
               trans_gray <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>0x11</font>;
               <font color='#0000FF'>break</font>;

            <font color='#0000FF'>default</font>:

            <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
               <font color='#009900'>/* FALL THROUGH (Already 8 bits) */</font>

            <font color='#0000FF'>case</font> <font color='#979000'>16</font>:
               <font color='#009900'>/* Already a full 16 bits */</font>
               <font color='#0000FF'>break</font>;
         <b>}</b>

         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>=</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>gray;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.green <font color='#5555FF'>=</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font>trans_gray;
         <b>}</b>
      <b>}</b>
   <b>}</b> <font color='#009900'>/* background expand and (therefore) no alpha association. */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_EXPAND_SUPPORTED &amp;&amp; PNG_READ_BACKGROUND_SUPPORTED */</font>
<b>}</b>

<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_init_read_transformations'></a>png_init_read_transformations</b><font face='Lucida Console'>(</font>png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_init_read_transformations</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* This internal function is called from png_read_start_row in pngrutil.c
    * and it is called before the 'rowbytes' calculation is done, so the code
    * in here can change or update the transformations flags.
    *
    * First do updates that do not depend on the details of the PNG image data
    * being processed.
    */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
   <font color='#009900'>/* Prior to 1.5.4 these tests were performed from png_set_gamma, 1.5.4 adds
    * png_set_alpha_mode and this is another source for a default file gamma so
    * the test needs to be performed later - here.  In addition prior to 1.5.4
    * the tests were repeated for the PALETTE color type here - this is no
    * longer necessary (and doesn't seem to have been necessary before.)
    */</font>
   <b>{</b>
      <font color='#009900'>/* The following temporary indicates if overall gamma correction is
       * required.
       */</font>
      <font color='#0000FF'><u>int</u></font> gamma_correction <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* has been set */</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#009900'>/* screen set too */</font>
            gamma_correction <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_threshold</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font>
            <font color='#009900'>/* Assume the output matches the input; a long time default behavior
             * of libpng, although the standard has nothing to say about this.
             */</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#009900'>/* The converse - assume the file matches the screen, note that this
          * perhaps undesireable default can (from 1.5.4) be changed by calling
          * png_set_alpha_mode (even if the alpha handling mode isn't required
          * or isn't changed from the default.)
          */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>else</font> <font color='#009900'>/* neither are set */</font>
         <font color='#009900'>/* Just in case the following prevents any processing - file and screen
          * are both assumed to be linear and there is no way to introduce a
          * third gamma value other than png_set_background with 'UNIQUE', and,
          * prior to 1.5.4
          */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> PNG_FP_1;

      <font color='#009900'>/* We have a gamma value now. */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.flags <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLORSPACE_HAVE_GAMMA;

      <font color='#009900'>/* Now turn the gamma transformation on or off as appropriate.  Notice
       * that PNG_GAMMA just refers to the file-&gt;screen correction.  Alpha
       * composition may independently cause gamma correction because it needs
       * linear data (e.g. if the file has a gAMA chunk but the screen gamma
       * hasn't been specified.)  In any case this flag may get turned off in
       * the code immediately below if the transform can be handled outside the
       * row loop.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_correction<font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_GAMMA;

      <font color='#0000FF'>else</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_GAMMA;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* Certain transformations have the effect of preventing other
    * transformations that happen afterward in png_do_read_transformations,
    * resolve the interdependencies here.  From the code of
    * png_do_read_transformations the order is:
    *
    *  1) PNG_EXPAND (including PNG_EXPAND_tRNS)
    *  2) PNG_STRIP_ALPHA (if no compose)
    *  3) PNG_RGB_TO_GRAY
    *  4) PNG_GRAY_TO_RGB iff !PNG_BACKGROUND_IS_GRAY
    *  5) PNG_COMPOSE
    *  6) PNG_GAMMA
    *  7) PNG_STRIP_ALPHA (if compose)
    *  8) PNG_ENCODE_ALPHA
    *  9) PNG_SCALE_16_TO_8
    * 10) PNG_16_TO_8
    * 11) PNG_QUANTIZE (converts to palette)
    * 12) PNG_EXPAND_16
    * 13) PNG_GRAY_TO_RGB iff PNG_BACKGROUND_IS_GRAY
    * 14) PNG_INVERT_MONO
    * 15) PNG_SHIFT
    * 16) PNG_PACK
    * 17) PNG_BGR
    * 18) PNG_PACKSWAP
    * 19) PNG_FILLER (includes PNG_ADD_ALPHA)
    * 20) PNG_INVERT_ALPHA
    * 21) PNG_SWAP_ALPHA
    * 22) PNG_SWAP_BYTES
    * 23) PNG_USER_TRANSFORM [must be last]
    */</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_ALPHA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_STRIP_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Stripping the alpha channel happens immediately after the 'expand'
       * transformations, before all other transformation, so it cancels out
       * the alpha handling.  It has the side effect negating the effect of
       * PNG_EXPAND_tRNS too:
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~<font face='Lucida Console'>(</font>PNG_BACKGROUND_EXPAND <font color='#5555FF'>|</font> PNG_ENCODE_ALPHA <font color='#5555FF'>|</font>
         PNG_EXPAND_tRNS<font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;

      <font color='#009900'>/* Kill the tRNS chunk itself too.  Prior to 1.5.4 this did not happen
       * so transparency information would remain just so long as it wasn't
       * expanded.  This produces unexpected API changes if the set of things
       * that do PNG_EXPAND_tRNS changes (perfectly possible given the
       * documentation - which says ask for what you want, accept what you
       * get.)  This makes the behavior consistent from 1.5.4:
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* STRIP_ALPHA supported, no COMPOSE */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_ALPHA_MODE_SUPPORTED
   <font color='#009900'>/* If the screen gamma is about 1.0 then the OPTIMIZE_ALPHA and ENCODE_ALPHA
    * settings will have no effect.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_ENCODE_ALPHA;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_FLAG_OPTIMIZE_ALPHA;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
   <font color='#009900'>/* Make sure the coefficients for the rgb to gray conversion are set
    * appropriately.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_colorspace_set_rgb_coefficients</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_EXPAND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#009900'>/* Detect gray background and attempt to enable optimization for
    * gray --&gt; RGB case.
    *
    * Note:  if PNG_BACKGROUND_EXPAND is set and color_type is either RGB or
    * RGB_ALPHA (in which case need_expand is superfluous anyway), the
    * background color might actually be gray yet not be flagged as such.
    * This is not a problem for the current code, which uses
    * PNG_BACKGROUND_IS_GRAY only to decide when to do the
    * png_do_gray_to_rgb() transformation.
    *
    * TODO: this code needs to be revised to avoid the complexity and
    * interdependencies.  The color type of the background should be recorded in
    * png_set_background, along with the bit depth, then the code has a record
    * of exactly what color space the background is currently in.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* PNG_BACKGROUND_EXPAND: the background is in the file color space, so if
       * the file was grayscale the background value is gray.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_BACKGROUND_IS_GRAY;
   <b>}</b>

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* PNG_COMPOSE: png_set_background was called with need_expand false,
       * so the color is in the color space of the output or png_set_alpha_mode
       * was called and the color is black.  Ignore RGB_TO_GRAY because that
       * happens before GRAY_TO_RGB.
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GRAY_TO_RGB<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue<font face='Lucida Console'>)</font>
         <b>{</b>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_BACKGROUND_IS_GRAY;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
         <b>}</b>
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_EXPAND_SUPPORTED &amp;&amp; PNG_READ_BACKGROUND_SUPPORTED */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_GRAY_TO_RGB_SUPPORTED */</font>

   <font color='#009900'>/* For indexed PNG data (PNG_COLOR_TYPE_PALETTE) many of the transformations
    * can be performed directly on the palette, and some (such as rgb to gray)
    * can be optimized inside the palette.  This is particularly true of the
    * composite (background and alpha) stuff, which can be pretty much all done
    * in the palette even if the result is expanded to RGB or gray afterward.
    *
    * NOTE: this is Not Yet Implemented, the code behaves as in 1.5.1 and
    * earlier and the palette stuff is actually handled on the first row.  This
    * leads to the reported bug that the palette returned by png_get_PLTE is not
    * updated.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_init_palette_transformations</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>else</font>
      <font color='#BB00BB'>png_init_rgb_transformations</font><font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_EXPAND_16_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_16<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* TODO: fix this.  Because the expand_16 operation is after the compose
       * handling the background color must be 8, not 16, bits deep, but the
       * application will supply a 16-bit value so reduce it here.
       *
       * The PNG_BACKGROUND_EXPAND code above does not expand to 16 bits at
       * present, so that case is ok (until do_expand_16 is moved.)
       *
       * NOTE: this discards the low 16 bits of the user supplied background
       * color, but until expand_16 works properly there is no choice!
       */</font>
#     define <font color='#BB00BB'>CHOP</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font color='#5555FF'>=</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font color='#BB00BB'>PNG_DIV257</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>CHOP</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>CHOP</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>CHOP</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue<font face='Lucida Console'>)</font>;
      <font color='#BB00BB'>CHOP</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray<font face='Lucida Console'>)</font>;
#     undef CHOP
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_BACKGROUND_SUPPORTED &amp;&amp; PNG_READ_EXPAND_16_SUPPORTED */</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
   <font face='Lucida Console'>(</font><font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_SCALE_16_TO_8_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> \
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_STRIP_16_TO_8_SUPPORTED<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>PNG_16_TO_8<font color='#5555FF'>|</font>PNG_SCALE_16_TO_8<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* On the other hand, if a 16-bit file is to be reduced to 8-bits per
       * component this will also happen after PNG_COMPOSE and so the background
       * color must be pre-expanded here.
       *
       * TODO: fix this too.
       */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>*</font> <font color='#979000'>257</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>=</font>
         <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>*</font> <font color='#979000'>257</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>*</font> <font color='#979000'>257</font><font face='Lucida Console'>)</font>;
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>*</font> <font color='#979000'>257</font><font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#009900'>/* NOTE: below 'PNG_READ_ALPHA_MODE_SUPPORTED' is presumed to also enable the
    * background support (see the comments in scripts/pnglibconf.dfa), this
    * allows pre-multiplication of the alpha channel to be implemented as
    * compositing on black.  This is probably sub-optimal and has been done in
    * 1.5.4 betas simply to enable external critique and testing (i.e. to
    * implement the new API quickly, without lots of internal changes.)
    */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
#  ifdef PNG_READ_BACKGROUND_SUPPORTED
      <font color='#009900'>/* Includes ALPHA_MODE */</font>
      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1 <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background;
#  endif

   <font color='#009900'>/* This needs to change - in the palette image case a whole set of tables are
    * built when it would be quicker to just calculate the correct value for
    * each palette entry directly.  Also, the test is too tricky - why check
    * PNG_RGB_TO_GRAY if PNG_GAMMA is not set?  The answer seems to be that
    * PNG_GAMMA is cancelled even if the gamma is known?  The test excludes the
    * PNG_COMPOSE case, so apparently if there is no *overall* gamma correction
    * the gamma tables will not be built even if composition is required on a
    * gamma encoded value.
    *
    * In 1.5.4 this is addressed below by an additional check on the individual
    * file gamma - if it is not 1.0 both RGB_TO_GRAY and COMPOSE need the
    * tables.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GAMMA<font face='Lucida Console'>)</font>
      <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font>
         <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font>
         <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font>
            <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>
#  ifdef PNG_READ_BACKGROUND_SUPPORTED
            <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_BACKGROUND_GAMMA_UNIQUE
               <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
#  endif
      <font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_ENCODE_ALPHA<font face='Lucida Console'>)</font>
         <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_build_gamma_table</font><font face='Lucida Console'>(</font>png_ptr, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_BACKGROUND_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* Issue a warning about this combination: because RGB_TO_GRAY is
          * optimized to do the gamma transform if present yet do_background has
          * to do the same thing if both options are set a
          * double-gamma-correction happens.  This is true in all versions of
          * libpng to date.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr,
               "<font color='#CC0000'>libpng does not support gamma+background+rgb_to_gray</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* We don't get to here unless there is a tRNS chunk with non-opaque
             * entries - see the checking code at the start of this function.
             */</font>
            png_color back, back_1;
            png_colorp palette <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette;
            <font color='#0000FF'><u>int</u></font> num_palette <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette;
            <font color='#0000FF'><u>int</u></font> i;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_BACKGROUND_GAMMA_FILE<font face='Lucida Console'>)</font>
            <b>{</b>

               back.red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red];
               back.green <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green];
               back.blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue];

               back_1.red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red];
               back_1.green <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green];
               back_1.blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue];
            <b>}</b>
            <font color='#0000FF'>else</font>
            <b>{</b>
               png_fixed_point g, gs;

               <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>case</font> PNG_BACKGROUND_GAMMA_SCREEN:
                     g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;
                     gs <font color='#5555FF'>=</font> PNG_FP_1;
                     <font color='#0000FF'>break</font>;

                  <font color='#0000FF'>case</font> PNG_BACKGROUND_GAMMA_FILE:
                     g <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font>;
                     gs <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;
                     <font color='#0000FF'>break</font>;

                  <font color='#0000FF'>case</font> PNG_BACKGROUND_GAMMA_UNIQUE:
                     g <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma<font face='Lucida Console'>)</font>;
                     gs <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma,
                        png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;
                     <font color='#0000FF'>break</font>;
                  <font color='#0000FF'>default</font>:
                     g <font color='#5555FF'>=</font> PNG_FP_1;    <font color='#009900'>/* back_1 */</font>
                     gs <font color='#5555FF'>=</font> PNG_FP_1;   <font color='#009900'>/* back */</font>
                     <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gs<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  back.red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red,
                      gs<font face='Lucida Console'>)</font>;
                  back.green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green,
                      gs<font face='Lucida Console'>)</font>;
                  back.blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue,
                      gs<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  back.red   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
                  back.green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
                  back.blue  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  back_1.red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red,
                     g<font face='Lucida Console'>)</font>;
                  back_1.green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>
                     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green, g<font face='Lucida Console'>)</font>;
                  back_1.blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_8bit_correct</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue,
                     g<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  back_1.red   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
                  back_1.green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
                  back_1.blue  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     palette[i] <font color='#5555FF'>=</font> back;
                  <b>}</b>
                  <font color='#0000FF'>else</font> <font color='#009900'>/* if (png_ptr-&gt;trans_alpha[i] != 0xff) */</font>
                  <b>{</b>
                     png_byte v, w;

                     v <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[palette[i].red];
                     <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i], back_1.red<font face='Lucida Console'>)</font>;
                     palette[i].red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1[w];

                     v <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[palette[i].green];
                     <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i], back_1.green<font face='Lucida Console'>)</font>;
                     palette[i].green <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1[w];

                     v <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[palette[i].blue];
                     <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i], back_1.blue<font face='Lucida Console'>)</font>;
                     palette[i].blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1[w];
                  <b>}</b>
               <b>}</b>
               <font color='#0000FF'>else</font>
               <b>{</b>
                  palette[i].red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[palette[i].red];
                  palette[i].green <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[palette[i].green];
                  palette[i].blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[palette[i].blue];
               <b>}</b>
            <b>}</b>

            <font color='#009900'>/* Prevent the transformations being done again.
             *
             * NOTE: this is highly dubious; it removes the transformations in
             * place.  This seems inconsistent with the general treatment of the
             * transformations elsewhere.
             */</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~<font face='Lucida Console'>(</font>PNG_COMPOSE <font color='#5555FF'>|</font> PNG_GAMMA<font face='Lucida Console'>)</font>;
         <b>}</b> <font color='#009900'>/* color_type == PNG_COLOR_TYPE_PALETTE */</font>

         <font color='#009900'>/* if (png_ptr-&gt;background_gamma_type!=PNG_BACKGROUND_GAMMA_UNKNOWN) */</font>
         <font color='#0000FF'>else</font> <font color='#009900'>/* color_type != PNG_COLOR_TYPE_PALETTE */</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> gs_sig, g_sig;
            png_fixed_point g <font color='#5555FF'>=</font> PNG_FP_1;  <font color='#009900'>/* Correction to linear */</font>
            png_fixed_point gs <font color='#5555FF'>=</font> PNG_FP_1; <font color='#009900'>/* Correction to screen */</font>

            <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>case</font> PNG_BACKGROUND_GAMMA_SCREEN:
                  g <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma;
                  <font color='#009900'>/* gs = PNG_FP_1; */</font>
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>case</font> PNG_BACKGROUND_GAMMA_FILE:
                  g <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma<font face='Lucida Console'>)</font>;
                  gs <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma,
                     png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>case</font> PNG_BACKGROUND_GAMMA_UNIQUE:
                  g <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma<font face='Lucida Console'>)</font>;
                  gs <font color='#5555FF'>=</font> <font color='#BB00BB'>png_reciprocal2</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>screen_gamma<font face='Lucida Console'>)</font>;
                  <font color='#0000FF'>break</font>;

               <font color='#0000FF'>default</font>:
                  <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>invalid background gamma type</font>"<font face='Lucida Console'>)</font>;
            <b>}</b>

            g_sig <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font>;
            gs_sig <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_significant</font><font face='Lucida Console'>(</font>gs<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>g_sig<font face='Lucida Console'>)</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.gray <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray, g<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gs_sig<font face='Lucida Console'>)</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray, gs<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#009900'>/* RGB or RGBA with color background */</font>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>g_sig<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red, g<font face='Lucida Console'>)</font>;

                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green, g<font face='Lucida Console'>)</font>;

                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue, g<font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gs_sig<font face='Lucida Console'>)</font>
               <b>{</b>
                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red, gs<font face='Lucida Console'>)</font>;

                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green, gs<font face='Lucida Console'>)</font>;

                  png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>=</font> <font color='#BB00BB'>png_gamma_correct</font><font face='Lucida Console'>(</font>png_ptr,
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue, gs<font face='Lucida Console'>)</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font>
            <b>{</b>
               <font color='#009900'>/* GRAY, GRAY ALPHA, RGB, or RGBA with gray background */</font>
               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.green
                   <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.gray;

               png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green
                   <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray;
            <b>}</b>

            <font color='#009900'>/* The background is now in screen gamma: */</font>
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_gamma_type <font color='#5555FF'>=</font> PNG_BACKGROUND_GAMMA_SCREEN;
         <b>}</b> <font color='#009900'>/* color_type != PNG_COLOR_TYPE_PALETTE */</font>
      <b>}</b><font color='#009900'>/* png_ptr-&gt;transformations &amp; PNG_BACKGROUND */</font>

      <font color='#0000FF'>else</font>
      <font color='#009900'>/* Transformation does not include PNG_BACKGROUND */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_BACKGROUND_SUPPORTED */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE
<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
         <font color='#009900'>/* RGB_TO_GRAY needs to have non-gamma-corrected values! */</font>
         <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
         <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
         <font face='Lucida Console'>)</font>
      <b>{</b>
         png_colorp palette <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette;
         <font color='#0000FF'><u>int</u></font> num_palette <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette;
         <font color='#0000FF'><u>int</u></font> i;

         <font color='#009900'>/* NOTE: there are other transformations that should probably be in
          * here too.
          */</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            palette[i].red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[palette[i].red];
            palette[i].green <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[palette[i].green];
            palette[i].blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[palette[i].blue];
         <b>}</b>

         <font color='#009900'>/* Done the gamma correction. */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_GAMMA;
      <b>}</b> <font color='#009900'>/* color_type == PALETTE &amp;&amp; !PNG_BACKGROUND transformation */</font>
   <b>}</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_BACKGROUND_SUPPORTED
   <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_GAMMA_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_BACKGROUND_SUPPORTED
   <font color='#009900'>/* No GAMMA transformation (see the hanging else 4 lines above) */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;
      <font color='#0000FF'><u>int</u></font> istop <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans;
      png_color back;
      png_colorp palette <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette;

      back.red   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
      back.green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
      back.blue  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;

      <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> istop; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <b>{</b>
            palette[i] <font color='#5555FF'>=</font> back;
         <b>}</b>

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* The png_composite() macro is defined in png.h */</font>
            <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>palette[i].red, palette[i].red,
                png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i], back.red<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>palette[i].green, palette[i].green,
                png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i], back.green<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>palette[i].blue, palette[i].blue,
                png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha[i], back.blue<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_COMPOSE;
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_BACKGROUND_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SHIFT_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SHIFT<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> i;
      <font color='#0000FF'><u>int</u></font> istop <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette;
      <font color='#0000FF'><u>int</u></font> shift <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.red;

      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font><font color='#5555FF'>=</font> ~PNG_SHIFT;

      <font color='#009900'>/* significant bits can be in the range 1 to 7 for a meaninful result, if
       * the number of significant bits is 0 then no shift is done (this is an
       * error condition which is silently ignored.)
       */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> shift <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font>istop; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> component <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[i].red;

            component <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> shift;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[i].red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>component;
         <b>}</b>

      shift <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.green;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> shift <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font>istop; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> component <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[i].green;

            component <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> shift;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[i].green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>component;
         <b>}</b>

      shift <font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>-</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>sig_bit.blue;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> shift <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i<font color='#5555FF'>=</font><font color='#979000'>0</font>; i<font color='#5555FF'>&lt;</font>istop; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'><u>int</u></font> component <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[i].blue;

            component <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> shift;
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette[i].blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>component;
         <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>  <font color='#009900'>/* PNG_READ_SHIFT_SUPPORTED */</font>
<b>}</b>

<font color='#009900'>/* Modify the info structure to reflect the transformations.  The
 * info should be updated so a PNG file could be written with it,
 * assuming the transformations result in valid PNG data.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_read_transform_info'></a>png_read_transform_info</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_inforp info_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_read_transform_info</font>"<font face='Lucida Console'>)</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This check must match what actually happens in
          * png_do_expand_palette; if it ever checks the tRNS chunk to see if
          * it is all opaque we must do the same (at present it does not.)
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA;

         <font color='#0000FF'>else</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB;

         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <b>}</b>
      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font>
               info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLOR_MASK_ALPHA;
         <b>}</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;

         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#009900'>/* The following is almost certainly wrong unless the background value is in
    * the screen space!
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
   <font color='#009900'>/* The following used to be conditional on PNG_GAMMA (prior to 1.5.4),
    * however it seems that the code in png_init_read_transformations, which has
    * been called before this from png_read_update_info-&gt;png_read_start_row
    * sometimes does the gamma transform and cancels the flag.
    *
    * TODO: this looks wrong; the info_ptr should end up with a gamma equal to
    * the screen_gamma value.  The following probably results in weirdness if
    * the info_ptr is used by the app after the rows have been read.
    */</font>
   info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>colorspace.gamma;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
   <b>{</b>
#  ifdef PNG_READ_16BIT_SUPPORTED
#     ifdef PNG_READ_SCALE_16_TO_8_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SCALE_16_TO_8<font face='Lucida Console'>)</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
#     endif

#     ifdef PNG_READ_STRIP_16_TO_8_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_16_TO_8<font face='Lucida Console'>)</font>
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
#     endif

#  <font color='#0000FF'>else</font>
      <font color='#009900'>/* No 16 bit support: force chopping 16-bit input down to 8, in this case
       * the app program can chose if both APIs are available by setting the
       * correct scaling to use.
       */</font>
#     ifdef PNG_READ_STRIP_16_TO_8_SUPPORTED
         <font color='#009900'>/* For compatibility with previous versions use the strip method by
          * default.  This code works because if PNG_SCALE_16_TO_8 is already
          * set the code below will do that in preference to the chop.
          */</font>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_16_TO_8;
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
#     <font color='#0000FF'>else</font>

#        ifdef PNG_READ_SCALE_16_TO_8_SUPPORTED
            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_SCALE_16_TO_8;
            info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
#        <font color='#0000FF'>else</font>

            CONFIGURATION ERROR: you must enable at least one <font color='#979000'>16</font> to <font color='#979000'>8</font> method
#        endif
#    endif
<font color='#0000FF'>#endif</font> <font color='#009900'>/* !READ_16BIT_SUPPORTED */</font>
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GRAY_TO_RGB<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>|</font>
         PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font>
         ~PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_QUANTIZE_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_QUANTIZE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
          <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_lookup <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_16_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_16 <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>16</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_PACK_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACK<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>3</font>;

   <font color='#0000FF'>else</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_ALPHA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_STRIP_ALPHA<font face='Lucida Console'>)</font>
   <b>{</b>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font>
         ~PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>;
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

<font color='#0000FF'>#ifdef</font> PNG_READ_FILLER_SUPPORTED
   <font color='#009900'>/* STRIP_ALPHA and FILLER allowed:  MASK_ALPHA bit stripped above */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_FILLER<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
      <font color='#009900'>/* If adding a true alpha channel not just filler */</font>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_ADD_ALPHA<font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLOR_MASK_ALPHA;
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_USER_TRANSFORM_PTR_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> \
<font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_USER_TRANSFORM_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_USER_TRANSFORM<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_depth<font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_depth;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>&lt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_channels<font face='Lucida Console'>)</font>
         info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_channels;
   <b>}</b>
<font color='#0000FF'>#endif</font>

   info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>*</font>
       info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>;

   info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* Adding in 1.5.4: cache the above value in png_struct so that we can later
    * check in png_rowbytes that the user buffer won't get overwritten.  Note
    * that the field is not always set - if png_read_update_info isn't called
    * the application has to either not do any transforms or get the calculation
    * right itself.
    */</font>
   png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>info_rowbytes <font color='#5555FF'>=</font> info_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;

<font color='#0000FF'>#ifndef</font> PNG_READ_EXPAND_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#009900'>/* Transform the row.  The order of transformations is significant,
 * and is very touchy.  If you add a transformation, take care to
 * decide how it fits in with the other transformations here.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_read_transformations'></a>png_do_read_transformations</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_row_infop row_info<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_read_transformations</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Prior to 1.5.4 this output row/pass where the NULL pointer is, but this
       * error is incredibly rare and incredibly easy to debug without this
       * information.
       */</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>NULL row buffer</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

   <font color='#009900'>/* The following is debugging; prior to 1.5.4 the code was never compiled in;
    * in 1.5.4 PNG_FLAG_DETECT_UNINITIALIZED was added and the macro
    * PNG_WARN_UNINITIALIZED_ROW removed.  In 1.6 the new flag is set only for
    * all transformations, however in practice the ROW_INIT always gets done on
    * demand, if necessary.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_DETECT_UNINITIALIZED<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_ROW_INIT<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* Application has failed to call either png_read_start_image() or
       * png_read_update_info() after setting transforms that expand pixels.
       * This check added to libpng-1.2.19 (but not enabled until 1.5.4).
       */</font>
      <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>Uninitialized row</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#BB00BB'>png_do_expand_palette</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_alpha, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_tRNS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_do_expand</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
                <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

         <font color='#0000FF'>else</font>
            <font color='#BB00BB'>png_do_expand</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
                NULL<font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_ALPHA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_STRIP_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_strip_channel</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
         <font color='#979000'>0</font> <font color='#009900'>/* at_start == false, because SWAP_ALPHA happens later */</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> rgb_error <font color='#5555FF'>=</font>
          <font color='#BB00BB'>png_do_rgb_to_gray</font><font face='Lucida Console'>(</font>png_ptr, row_info,
              png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>rgb_error<font face='Lucida Console'>)</font>
      <b>{</b>
         png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_status<font color='#5555FF'>=</font><font color='#979000'>1</font>;
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
             PNG_RGB_TO_GRAY_WARN<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_do_rgb_to_gray found nongray pixel</font>"<font face='Lucida Console'>)</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font>
             PNG_RGB_TO_GRAY_ERR<font face='Lucida Console'>)</font>
            <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_do_rgb_to_gray found nongray pixel</font>"<font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* From Andreas Dilger e-mail to png-implement, 26 March 1998:
 *
 *   In most cases, the "simple transparency" should be done prior to doing
 *   gray-to-RGB, or you will have to test 3x as many bytes to check if a
 *   pixel is transparent.  You would also need to make sure that the
 *   transparency information is upgraded to RGB.
 *
 *   To summarize, the current flow is:
 *   - Gray + simple transparency -&gt; compare 1 or 2 gray bytes and composite
 *                                   with background "in place" if transparent,
 *                                   convert to RGB if necessary
 *   - Gray + alpha -&gt; composite with gray background and remove alpha bytes,
 *                                   convert to RGB if necessary
 *
 *   To support RGB backgrounds for gray images we need:
 *   - Gray + simple transparency -&gt; convert to RGB + simple transparency,
 *                                   compare 3 or 6 bytes and composite with
 *                                   background "in place" if transparent
 *                                   (3x compare/pixel compared to doing
 *                                   composite with gray bkgrnd)
 *   - Gray + alpha -&gt; convert to RGB + alpha, composite with background and
 *                                   remove alpha bytes (3x float
 *                                   operations/pixel compared with composite
 *                                   on gray background)
 *
 *  Greg's change will do this.  The reason it wasn't done before is for
 *  performance, as this increases the per-pixel operations.  If we would check
 *  in advance if the background was gray or RGB, and position the gray-to-RGB
 *  transform appropriately, then it would save a lot of work/time.
 */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
   <font color='#009900'>/* If gray -&gt; RGB, do so now only if background is non-gray; else do later
    * for performance reasons
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GRAY_TO_RGB<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_IS_GRAY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_gray_to_rgb</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_compose</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GAMMA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
      <font color='#009900'>/* Because RGB_TO_GRAY does the gamma transform. */</font>
      <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_RGB_TO_GRAY<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <font color='#BB00BB'>defined</font><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font>
      <font color='#009900'>/* Because PNG_COMPOSE does the gamma transform if there is something to
       * do (if there is an alpha channel or transparency.)
       */</font>
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_trans <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
<font color='#0000FF'>#endif</font>
      <font color='#009900'>/* Because png_init_read_transformations transforms the palette, unless
       * RGB_TO_GRAY will do the transform.
       */</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_gamma</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_ALPHA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_STRIP_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_COMPOSE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_strip_channel</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
         <font color='#979000'>0</font> <font color='#009900'>/* at_start == false, because SWAP_ALPHA happens later */</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_ALPHA_MODE_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_ENCODE_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_encode_alpha</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>, png_ptr<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SCALE_16_TO_8_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SCALE_16_TO_8<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_scale_16_to_8</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_16_TO_8_SUPPORTED
   <font color='#009900'>/* There is no harm in doing both of these because only one has any effect,
    * by putting the 'scale' option first if the app asks for scale (either by
    * calling the API or in a TRANSFORM flag) this is what happens.
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_16_TO_8<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_chop</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_QUANTIZE_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_QUANTIZE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#BB00BB'>png_do_quantize</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>palette_lookup, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>quantize_index<font face='Lucida Console'>)</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
         <font color='#BB00BB'>png_error</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_do_quantize returned rowbytes=0</font>"<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_QUANTIZE_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_16_SUPPORTED
   <font color='#009900'>/* Do the expansion now, after all the arithmetic has been done.  Notice
    * that previous transformations can handle the PNG_EXPAND_16 flag if this
    * is efficient (particularly true in the case of gamma correction, where
    * better accuracy results faster!)
    */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_EXPAND_16<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_expand_16</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
   <font color='#009900'>/* NOTE: moved here in 1.5.4 (from much later in this list.) */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_GRAY_TO_RGB<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>mode <font color='#5555FF'>&amp;</font> PNG_BACKGROUND_IS_GRAY<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_gray_to_rgb</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_INVERT_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INVERT_MONO<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_invert</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SHIFT_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SHIFT<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_unshift</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          <font color='#5555FF'>&amp;</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_PACK_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACK<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_unpack</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_CHECK_FOR_INVALID_INDEX_SUPPORTED
   <font color='#009900'>/* Added at libpng-1.5.10 */</font>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>num_palette_max <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_check_palette_indexes</font><font face='Lucida Console'>(</font>png_ptr, row_info<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_BGR_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_BGR<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_bgr</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_PACKSWAP_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_PACKSWAP<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_packswap</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_FILLER_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_FILLER<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_read_filler</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font>,
          <font face='Lucida Console'>(</font>png_uint_32<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>filler, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_INVERT_ALPHA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_INVERT_ALPHA<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_read_invert_alpha</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SWAP_ALPHA_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SWAP_ALPHA<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_read_swap_alpha</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
<font color='#0000FF'>#ifdef</font> PNG_READ_SWAP_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_SWAP_BYTES<font face='Lucida Console'>)</font>
      <font color='#BB00BB'>png_do_swap</font><font face='Lucida Console'>(</font>row_info, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_USER_TRANSFORM_SUPPORTED
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>transformations <font color='#5555FF'>&amp;</font> PNG_USER_TRANSFORM<font face='Lucida Console'>)</font>
    <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_user_transform_fn <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>read_user_transform_fn<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#009900'>/* User read transform function */</font>
             <font face='Lucida Console'>(</font>png_ptr,     <font color='#009900'>/* png_ptr */</font>
             row_info,     <font color='#009900'>/* row_info: */</font>
                <font color='#009900'>/*  png_uint_32 width;       width of row */</font>
                <font color='#009900'>/*  png_size_t rowbytes;     number of bytes in row */</font>
                <font color='#009900'>/*  png_byte color_type;     color type of pixels */</font>
                <font color='#009900'>/*  png_byte bit_depth;      bit depth of samples */</font>
                <font color='#009900'>/*  png_byte channels;       number of channels (1-4) */</font>
                <font color='#009900'>/*  png_byte pixel_depth;    bits per pixel (depth*channels) */</font>
             png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>row_buf <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;    <font color='#009900'>/* start of pixel data for row */</font>
<font color='#0000FF'>#ifdef</font> PNG_USER_TRANSFORM_PTR_SUPPORTED
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_depth<font face='Lucida Console'>)</font>
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_depth;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_channels<font face='Lucida Console'>)</font>
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>user_transform_channels;
<font color='#0000FF'>#endif</font>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>*</font>
          row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width<font face='Lucida Console'>)</font>;
   <b>}</b>
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_PACK_SUPPORTED
<font color='#009900'>/* Unpack pixels of 1, 2, or 4 bits per pixel into 1 byte per pixel,
 * without changing the actual values.  Thus, if you had a row with
 * a bit depth of 1, you would end up with bytes that only contained
 * the numbers 0 or 1.  If you would rather they contain 0 and 255, use
 * png_do_shift() after this.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_unpack'></a>png_do_unpack</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_unpack</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_uint_32 i;
      png_uint_32 row_width<font color='#5555FF'>=</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_uint_32 shift <font color='#5555FF'>=</font> <font color='#979000'>7</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  shift<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

               dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
         <b>{</b>

            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_uint_32 shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>3</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  shift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

               dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            png_bytep dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_uint_32 shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;

               dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>default</font>:
            <font color='#0000FF'>break</font>;
      <b>}</b>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>*</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SHIFT_SUPPORTED
<font color='#009900'>/* Reverse the effects of png_do_shift.  This routine merely shifts the
 * pixels back to their significant bits values.  Thus, if you have
 * a row of bit depth 8, but only 5 are significant, this will shift
 * the values back to 0 through 31.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_unshift'></a>png_do_unshift</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
    png_const_color_8p sig_bits<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> color_type;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_unshift</font>"<font face='Lucida Console'>)</font>;

   <font color='#009900'>/* The palette case has already been handled in the _init routine. */</font>
   color_type <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> shift[<font color='#979000'>4</font>];
      <font color='#0000FF'><u>int</u></font> channels <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
      <font color='#0000FF'><u>int</u></font> bit_depth <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>
      <b>{</b>
         shift[channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> bit_depth <font color='#5555FF'>-</font> sig_bits<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red;
         shift[channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> bit_depth <font color='#5555FF'>-</font> sig_bits<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green;
         shift[channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> bit_depth <font color='#5555FF'>-</font> sig_bits<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue;
      <b>}</b>

      <font color='#0000FF'>else</font>
      <b>{</b>
         shift[channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> bit_depth <font color='#5555FF'>-</font> sig_bits<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         shift[channels<font color='#5555FF'>+</font><font color='#5555FF'>+</font>] <font color='#5555FF'>=</font> bit_depth <font color='#5555FF'>-</font> sig_bits<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>alpha;
      <b>}</b>

      <b>{</b>
         <font color='#0000FF'><u>int</u></font> c, have_shift;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>c <font color='#5555FF'>=</font> have_shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>; c <font color='#5555FF'>&lt;</font> channels; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>c<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* A shift of more than the bit depth is an error condition but it
             * gets ignored here.
             */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift[c] <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> shift[c] <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> bit_depth<font face='Lucida Console'>)</font>
               shift[c] <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            <font color='#0000FF'>else</font>
               have_shift <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <b>}</b>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>have_shift<font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font>;
      <b>}</b>

      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>bit_depth<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>default</font>:
         <font color='#009900'>/* Must be 1bpp gray: should not be here! */</font>
            <font color='#009900'>/* NOTREACHED */</font>
            <font color='#0000FF'>break</font>;

         <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
         <font color='#009900'>/* Must be 2bpp gray */</font>
         <font color='#009900'>/* assert(channels == 1 &amp;&amp; shift[0] == 1) */</font>
         <b>{</b>
            png_bytep bp <font color='#5555FF'>=</font> row;
            png_bytep bp_end <font color='#5555FF'>=</font> bp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;

            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bp <font color='#5555FF'>&lt;</font> bp_end<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>int</u></font> b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>bp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x55</font>;
               <font color='#5555FF'>*</font>bp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>b;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
         <font color='#009900'>/* Must be 4bpp gray */</font>
         <font color='#009900'>/* assert(channels == 1) */</font>
         <b>{</b>
            png_bytep bp <font color='#5555FF'>=</font> row;
            png_bytep bp_end <font color='#5555FF'>=</font> bp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            <font color='#0000FF'><u>int</u></font> gray_shift <font color='#5555FF'>=</font> shift[<font color='#979000'>0</font>];
            <font color='#0000FF'><u>int</u></font> mask <font color='#5555FF'>=</font>  <font color='#979000'>0xf</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gray_shift;

            mask <font color='#5555FF'>|</font><font color='#5555FF'>=</font> mask <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font>;

            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bp <font color='#5555FF'>&lt;</font> bp_end<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>int</u></font> b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>bp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gray_shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> mask;
               <font color='#5555FF'>*</font>bp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>b;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
         <font color='#009900'>/* Single byte components, G, GA, RGB, RGBA */</font>
         <b>{</b>
            png_bytep bp <font color='#5555FF'>=</font> row;
            png_bytep bp_end <font color='#5555FF'>=</font> bp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            <font color='#0000FF'><u>int</u></font> channel <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bp <font color='#5555FF'>&lt;</font> bp_end<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>int</u></font> b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>bp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift[channel];
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>channel <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> channels<font face='Lucida Console'>)</font>
                  channel <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <font color='#5555FF'>*</font>bp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>b;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
         <font color='#0000FF'>case</font> <font color='#979000'>16</font>:
         <font color='#009900'>/* Double byte components, G, GA, RGB, RGBA */</font>
         <b>{</b>
            png_bytep bp <font color='#5555FF'>=</font> row;
            png_bytep bp_end <font color='#5555FF'>=</font> bp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            <font color='#0000FF'><u>int</u></font> channel <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bp <font color='#5555FF'>&lt;</font> bp_end<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>int</u></font> value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>bp[<font color='#979000'>0</font>] <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> bp[<font color='#979000'>1</font>];

               value <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> shift[channel];
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>channel <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> channels<font face='Lucida Console'>)</font>
                  channel <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <font color='#5555FF'>*</font>bp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>value <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font>bp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>value <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>
<font color='#0000FF'>#endif</font>
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SCALE_16_TO_8_SUPPORTED
<font color='#009900'>/* Scale rows of bit depth 16 down to 8 accurately */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_scale_16_to_8'></a>png_do_scale_16_to_8</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_scale_16_to_8</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep sp <font color='#5555FF'>=</font> row; <font color='#009900'>/* source */</font>
      png_bytep dp <font color='#5555FF'>=</font> row; <font color='#009900'>/* destination */</font>
      png_bytep ep <font color='#5555FF'>=</font> sp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes; <font color='#009900'>/* end+1 */</font>

      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>sp <font color='#5555FF'>&lt;</font> ep<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* The input is an array of 16 bit components, these must be scaled to
          * 8 bits each.  For a 16 bit value V the required value (from the PNG
          * specification) is:
          *
          *    (V * 255) / 65535
          *
          * This reduces to round(V / 257), or floor((V + 128.5)/257)
          *
          * Represent V as the two byte value vhi.vlo.  Make a guess that the
          * result is the top byte of V, vhi, then the correction to this value
          * is:
          *
          *    error = floor(((V-vhi.vhi) + 128.5) / 257)
          *          = floor(((vlo-vhi) + 128.5) / 257)
          *
          * This can be approximated using integer arithmetic (and a signed
          * shift):
          *
          *    error = (vlo-vhi+128) &gt;&gt; 8;
          *
          * The approximate differs from the exact answer only when (vlo-vhi) is
          * 128; it then gives a correction of +1 when the exact correction is
          * 0.  This gives 128 errors.  The exact answer (correct for all 16 bit
          * input values) is:
          *
          *    error = (vlo-vhi+128)*65535 &gt;&gt; 24;
          *
          * An alternative arithmetic calculation which also gives no errors is:
          *
          *    (V * 255 + 32895) &gt;&gt; 16
          */</font>

         png_int_32 tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>; <font color='#009900'>/* must be signed! */</font>
         tmp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>-</font> tmp <font color='#5555FF'>+</font> <font color='#979000'>128</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>65535</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font>;
         <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>tmp;
      <b>}</b>

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>*</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>*</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_STRIP_16_TO_8_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<font color='#009900'>/* Simply discard the low byte.  This was the default behavior prior
 * to libpng-1.5.4.
 */</font>
<b><a name='png_do_chop'></a>png_do_chop</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_chop</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
   <b>{</b>
      png_bytep sp <font color='#5555FF'>=</font> row; <font color='#009900'>/* source */</font>
      png_bytep dp <font color='#5555FF'>=</font> row; <font color='#009900'>/* destination */</font>
      png_bytep ep <font color='#5555FF'>=</font> sp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes; <font color='#009900'>/* end+1 */</font>

      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>sp <font color='#5555FF'>&lt;</font> ep<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
         sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>; <font color='#009900'>/* skip low byte */</font>
      <b>}</b>

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>*</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels<font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width <font color='#5555FF'>*</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_SWAP_ALPHA_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_read_swap_alpha'></a>png_do_read_swap_alpha</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_read_swap_alpha</font>"<font face='Lucida Console'>)</font>;

   <b>{</b>
      png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This converts from RGBA to ARGB */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            png_bytep dp <font color='#5555FF'>=</font> sp;
            png_byte save;
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               save <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> save;
            <b>}</b>
         <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
         <font color='#009900'>/* This converts from RRGGBBAA to AARRGGBB */</font>
         <font color='#0000FF'>else</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            png_bytep dp <font color='#5555FF'>=</font> sp;
            png_byte save[<font color='#979000'>2</font>];
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               save[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               save[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> save[<font color='#979000'>0</font>];
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> save[<font color='#979000'>1</font>];
            <b>}</b>
         <b>}</b>
<font color='#0000FF'>#endif</font>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This converts from GA to AG */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            png_bytep dp <font color='#5555FF'>=</font> sp;
            png_byte save;
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               save <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> save;
            <b>}</b>
         <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
         <font color='#009900'>/* This converts from GGAA to AAGG */</font>
         <font color='#0000FF'>else</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
            png_bytep dp <font color='#5555FF'>=</font> sp;
            png_byte save[<font color='#979000'>2</font>];
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               save[<font color='#979000'>0</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               save[<font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> save[<font color='#979000'>0</font>];
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> save[<font color='#979000'>1</font>];
            <b>}</b>
         <b>}</b>
<font color='#0000FF'>#endif</font>
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_INVERT_ALPHA_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_read_invert_alpha'></a>png_do_read_invert_alpha</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 row_width;
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_read_invert_alpha</font>"<font face='Lucida Console'>)</font>;

   row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This inverts the alpha channel in RGBA */</font>
         png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
         png_bytep dp <font color='#5555FF'>=</font> sp;
         png_uint_32 i;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

<font color='#009900'>/*          This does nothing:
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            We can replace it with:
*/</font>
            sp<font color='#5555FF'>-</font><font color='#5555FF'>=</font><font color='#979000'>3</font>;
            dp<font color='#5555FF'>=</font>sp;
         <b>}</b>
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
      <font color='#009900'>/* This inverts the alpha channel in RRGGBBAA */</font>
      <font color='#0000FF'>else</font>
      <b>{</b>
         png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
         png_bytep dp <font color='#5555FF'>=</font> sp;
         png_uint_32 i;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

<font color='#009900'>/*          This does nothing:
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
            We can replace it with:
*/</font>
            sp<font color='#5555FF'>-</font><font color='#5555FF'>=</font><font color='#979000'>6</font>;
            dp<font color='#5555FF'>=</font>sp;
         <b>}</b>
      <b>}</b>
<font color='#0000FF'>#endif</font>
   <b>}</b>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#009900'>/* This inverts the alpha channel in GA */</font>
         png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
         png_bytep dp <font color='#5555FF'>=</font> sp;
         png_uint_32 i;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
      <font color='#0000FF'>else</font>
      <b>{</b>
         <font color='#009900'>/* This inverts the alpha channel in GGAA */</font>
         png_bytep sp  <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;
         png_bytep dp <font color='#5555FF'>=</font> sp;
         png_uint_32 i;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#979000'>255</font> <font color='#5555FF'>-</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#009900'>/*
            *(--dp) = *(--sp);
            *(--dp) = *(--sp);
*/</font>
            sp<font color='#5555FF'>-</font><font color='#5555FF'>=</font><font color='#979000'>2</font>;
            dp<font color='#5555FF'>=</font>sp;
         <b>}</b>
      <b>}</b>
<font color='#0000FF'>#endif</font>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_FILLER_SUPPORTED
<font color='#009900'>/* Add filler channel if we have RGB color */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_read_filler'></a>png_do_read_filler</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
    png_uint_32 filler, png_uint_32 flags<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 i;
   png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
   png_byte hi_filler <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>filler<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
   png_byte lo_filler <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>filler <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_read_filler</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>
       row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_FILLER_AFTER<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from G to GX */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width;
            png_bytep dp <font color='#5555FF'>=</font>  sp <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>16</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from G to XG */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            <b>}</b>
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>16</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
         <b>}</b>
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_FILLER_AFTER<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from GG to GGXX */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> hi_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> hi_filler;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from GG to XXGG */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> hi_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            <b>}</b>
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
         <b>}</b>
      <b>}</b>
<font color='#0000FF'>#endif</font>
   <b>}</b> <font color='#009900'>/* COLOR_TYPE == GRAY */</font>
   <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_FILLER_AFTER<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from RGB to RGBX */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>3</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from RGB to XRGB */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>3</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            <b>}</b>
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
         <b>}</b>
      <b>}</b>

<font color='#0000FF'>#ifdef</font> PNG_READ_16BIT_SUPPORTED
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_FILLER_AFTER<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from RRGGBB to RRGGBBXX */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>6</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>1</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> hi_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> hi_filler;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>64</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>8</font>;
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* This changes the data from RRGGBB to XXRRGGBB */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>6</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp<font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> hi_filler;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>dp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> lo_filler;
            <b>}</b>

            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>64</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>8</font>;
         <b>}</b>
      <b>}</b>
<font color='#0000FF'>#endif</font>
   <b>}</b> <font color='#009900'>/* COLOR_TYPE == RGB */</font>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GRAY_TO_RGB_SUPPORTED
<font color='#009900'>/* Expand grayscale files to RGB, with or without alpha */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_gray_to_rgb'></a>png_do_gray_to_rgb</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 i;
   png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_gray_to_rgb</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font color='#5555FF'>!</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This changes G to RGB */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
            <b>}</b>
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* This changes GG to RRGGBB */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
            <b>}</b>
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#009900'>/* This changes GA to RGBA */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
            <b>}</b>
         <b>}</b>

         <font color='#0000FF'>else</font>
         <b>{</b>
            <font color='#009900'>/* This changes GGAA to RRGGBBAA */</font>
            png_bytep sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            png_bytep dp <font color='#5555FF'>=</font> sp  <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font><font face='Lucida Console'>)</font>;
            <b>}</b>
         <b>}</b>
      <b>}</b>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PNG_COLOR_MASK_COLOR;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>*</font>
          row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, row_width<font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_RGB_TO_GRAY_SUPPORTED
<font color='#009900'>/* Reduce RGB files to grayscale, with or without alpha
 * using the equation given in Poynton's ColorFAQ of 1998-01-04 at
 * &lt;http://www.inforamp.net/~poynton/&gt;  (THIS LINK IS DEAD June 2008 but
 * versions dated 1998 through November 2002 have been archived at
 * http://web.archive.org/web/20000816232553/http://www.inforamp.net/
 * ~poynton/notes/colour_and_gamma/ColorFAQ.txt )
 * Charles Poynton poynton at poynton.com
 *
 *     Y = 0.212671 * R + 0.715160 * G + 0.072169 * B
 *
 *  which can be expressed with integers as
 *
 *     Y = (6969 * R + 23434 * G + 2365 * B)/32768
 *
 * Poynton's current link (as of January 2003 through July 2011):
 * &lt;http://www.poynton.com/notes/colour_and_gamma/&gt;
 * has changed the numbers slightly:
 *
 *     Y = 0.2126*R + 0.7152*G + 0.0722*B
 *
 *  which can be expressed with integers as
 *
 *     Y = (6966 * R + 23436 * G + 2366 * B)/32768
 *
 *  Historically, however, libpng uses numbers derived from the ITU-R Rec 709
 *  end point chromaticities and the D65 white point.  Depending on the
 *  precision used for the D65 white point this produces a variety of different
 *  numbers, however if the four decimal place value used in ITU-R Rec 709 is
 *  used (0.3127,0.3290) the Y calculation would be:
 *
 *     Y = (6968 * R + 23435 * G + 2366 * B)/32768
 *
 *  While this is correct the rounding results in an overflow for white, because
 *  the sum of the rounded coefficients is 32769, not 32768.  Consequently
 *  libpng uses, instead, the closest non-overflowing approximation:
 *
 *     Y = (6968 * R + 23434 * G + 2366 * B)/32768
 *
 *  Starting with libpng-1.5.5, if the image being converted has a cHRM chunk
 *  (including an sRGB chunk) then the chromaticities are used to calculate the
 *  coefficients.  See the chunk handling in pngrutil.c for more information.
 *
 *  In all cases the calculation is to be done in a linear colorspace.  If no
 *  gamma information is available to correct the encoding of the original RGB
 *  values this results in an implicit assumption that the original PNG RGB
 *  values were linear.
 *
 *  Other integer coefficents can be used via png_set_rgb_to_gray().  Because
 *  the API takes just red and green coefficients the blue coefficient is
 *  calculated to make the sum 32768.  This will result in different rounding
 *  to that used above.
 */</font>
<font color='#0000FF'><u>int</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_rgb_to_gray'></a>png_do_rgb_to_gray</b><font face='Lucida Console'>(</font>png_structrp png_ptr, png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>

<b>{</b>
   <font color='#0000FF'><u>int</u></font> rgb_error <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_rgb_to_gray</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_PALETTE<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
       <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      PNG_CONST png_uint_32 rc <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_red_coeff;
      PNG_CONST png_uint_32 gc <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rgb_to_gray_green_coeff;
      PNG_CONST png_uint_32 bc <font color='#5555FF'>=</font> <font color='#979000'>32768</font> <font color='#5555FF'>-</font> rc <font color='#5555FF'>-</font> gc;
      PNG_CONST png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
      PNG_CONST <font color='#0000FF'><u>int</u></font> have_alpha <font color='#5555FF'>=</font>
         <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
         <font color='#009900'>/* Notice that gamma to/from 1 are not necessarily inverses (if
          * there is an overall gamma correction).  Prior to 1.5.5 this code
          * checked the linearized values for equality; this doesn't match
          * the documentation, the original values must be checked.
          */</font>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row;
            png_bytep dp <font color='#5555FF'>=</font> row;
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_byte red   <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
               png_byte green <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
               png_byte blue  <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> green <font color='#5555FF'>|</font><font color='#5555FF'>|</font> red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> blue<font face='Lucida Console'>)</font>
               <b>{</b>
                  red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[red];
                  green <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[green];
                  blue <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1[blue];

                  rgb_error <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1[
                      <font face='Lucida Console'>(</font>rc<font color='#5555FF'>*</font>red <font color='#5555FF'>+</font> gc<font color='#5555FF'>*</font>green <font color='#5555FF'>+</font> bc<font color='#5555FF'>*</font>blue <font color='#5555FF'>+</font> <font color='#979000'>16384</font><font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>15</font>];
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  <font color='#009900'>/* If there is no overall correction the table will not be
                   * set.
                   */</font>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                     red <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table[red];

                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> red;
               <b>}</b>

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>have_alpha<font face='Lucida Console'>)</font>
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row;
            png_bytep dp <font color='#5555FF'>=</font> row;
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_byte red   <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
               png_byte green <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
               png_byte blue  <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> green <font color='#5555FF'>|</font><font color='#5555FF'>|</font> red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> blue<font face='Lucida Console'>)</font>
               <b>{</b>
                  rgb_error <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                  <font color='#009900'>/* NOTE: this is the historical approach which simply
                   * truncates the results.
                   */</font>
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>rc<font color='#5555FF'>*</font>red <font color='#5555FF'>+</font> gc<font color='#5555FF'>*</font>green <font color='#5555FF'>+</font> bc<font color='#5555FF'>*</font>blue<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>15</font><font face='Lucida Console'>)</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> red;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>have_alpha<font face='Lucida Console'>)</font>
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
            <b>}</b>
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#009900'>/* RGB bit_depth == 16 */</font>
      <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row;
            png_bytep dp <font color='#5555FF'>=</font> row;
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_uint_16 red, green, blue, w;

               red   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               blue  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>=</font><font color='#5555FF'>=</font> green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> red <font color='#5555FF'>=</font><font color='#5555FF'>=</font> blue<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                     w <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table[<font face='Lucida Console'>(</font>red<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift][red<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font>];

                  <font color='#0000FF'>else</font>
                     w <font color='#5555FF'>=</font> red;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  png_uint_16 red_1   <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1[<font face='Lucida Console'>(</font>red<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                      <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift][red<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font>];
                  png_uint_16 green_1 <font color='#5555FF'>=</font>
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1[<font face='Lucida Console'>(</font>green<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift][green<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font>];
                  png_uint_16 blue_1  <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1[<font face='Lucida Console'>(</font>blue<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                      <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift][blue<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font>];
                  png_uint_16 gray16  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>rc<font color='#5555FF'>*</font>red_1 <font color='#5555FF'>+</font> gc<font color='#5555FF'>*</font>green_1
                      <font color='#5555FF'>+</font> bc<font color='#5555FF'>*</font>blue_1 <font color='#5555FF'>+</font> <font color='#979000'>16384</font><font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>15</font><font face='Lucida Console'>)</font>;
                  w <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1[<font face='Lucida Console'>(</font>gray16<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                      png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift][gray16 <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>];
                  rgb_error <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;
               <b>}</b>

               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>have_alpha<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
               <b>}</b>
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
         <b>{</b>
            png_bytep sp <font color='#5555FF'>=</font> row;
            png_bytep dp <font color='#5555FF'>=</font> row;
            png_uint_32 i;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               png_uint_16 red, green, blue, gray16;

               red   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               blue  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> green <font color='#5555FF'>|</font><font color='#5555FF'>|</font> red <font color='#5555FF'>!</font><font color='#5555FF'>=</font> blue<font face='Lucida Console'>)</font>
                  rgb_error <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>;

               <font color='#009900'>/* From 1.5.5 in the 16 bit case do the accurate conversion even
                * in the 'fast' case - this is because this is where the code
                * ends up when handling linear 16 bit data.
                */</font>
               gray16  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>rc<font color='#5555FF'>*</font>red <font color='#5555FF'>+</font> gc<font color='#5555FF'>*</font>green <font color='#5555FF'>+</font> bc<font color='#5555FF'>*</font>blue <font color='#5555FF'>+</font> <font color='#979000'>16384</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                  <font color='#979000'>15</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>gray16<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>gray16 <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>have_alpha<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
               <b>}</b>
            <b>}</b>
         <b>}</b>
      <b>}</b>

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>-</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font>
          ~PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>*</font>
          row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, row_width<font face='Lucida Console'>)</font>;
   <b>}</b>
   <font color='#0000FF'>return</font> rgb_error;
<b>}</b>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_TRANSFORMS_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_BUILD_GRAYSCALE_PALETTE_SUPPORTED
<font color='#009900'>/* Build a grayscale palette.  Palette is assumed to be 1 &lt;&lt; bit_depth
 * large of png_color.  This lets grayscale images be treated as
 * paletted.  Most useful for gamma correction and simplification
 * of code.  This API is not used internally.
 */</font>
<font color='#0000FF'><u>void</u></font> PNGAPI
<b><a name='png_build_grayscale_palette'></a>png_build_grayscale_palette</b><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font> bit_depth, png_colorp palette<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> num_palette;
   <font color='#0000FF'><u>int</u></font> color_inc;
   <font color='#0000FF'><u>int</u></font> i;
   <font color='#0000FF'><u>int</u></font> v;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_build_grayscale_palette</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>palette <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <font color='#0000FF'>return</font>;

   <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>bit_depth<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
         num_palette <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
         color_inc <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
         num_palette <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
         color_inc <font color='#5555FF'>=</font> <font color='#979000'>0x55</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
         num_palette <font color='#5555FF'>=</font> <font color='#979000'>16</font>;
         color_inc <font color='#5555FF'>=</font> <font color='#979000'>0x11</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
         num_palette <font color='#5555FF'>=</font> <font color='#979000'>256</font>;
         color_inc <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         <font color='#0000FF'>break</font>;

      <font color='#0000FF'>default</font>:
         num_palette <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         color_inc <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
         <font color='#0000FF'>break</font>;
   <b>}</b>

   <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, v <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> num_palette; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, v <font color='#5555FF'>+</font><font color='#5555FF'>=</font> color_inc<font face='Lucida Console'>)</font>
   <b>{</b>
      palette[i].red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>v;
      palette[i].green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>v;
      palette[i].blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>v;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>


<font color='#0000FF'>#ifdef</font> PNG_READ_TRANSFORMS_SUPPORTED
<font color='#0000FF'>#if</font> defined<font face='Lucida Console'>(</font>PNG_READ_BACKGROUND_SUPPORTED<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>\
   <b><a name='defined'></a>defined</b><font face='Lucida Console'>(</font>PNG_READ_ALPHA_MODE_SUPPORTED<font face='Lucida Console'>)</font>
<font color='#009900'>/* Replace any alpha or transparency with the supplied background color.
 * "background" is already in the screen gamma, while "background_1" is
 * at a gamma of 1.0.  Paletted files have already been taken care of.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_compose'></a>png_do_compose</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row, png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
   png_const_bytep gamma_table <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table;
   png_const_bytep gamma_from_1 <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1;
   png_const_bytep gamma_to_1 <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_to_1;
   png_const_uint_16pp gamma_16 <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table;
   png_const_uint_16pp gamma_16_from_1 <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1;
   png_const_uint_16pp gamma_16_to_1 <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_to_1;
   <font color='#0000FF'><u>int</u></font> gamma_shift <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift;
   <font color='#0000FF'><u>int</u></font> optimize <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>flags <font color='#5555FF'>&amp;</font> PNG_FLAG_OPTIMIZE_ALPHA<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>;
<font color='#0000FF'>#endif</font>

   png_bytep sp;
   png_uint_32 i;
   png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;
   <font color='#0000FF'><u>int</u></font> shift;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_compose</font>"<font face='Lucida Console'>)</font>;

   <b>{</b>
      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY:
         <b>{</b>
            <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  shift <font color='#5555FF'>=</font> <font color='#979000'>7</font>;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0x7f7f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>7</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>shift<font face='Lucida Console'>)</font>
                     <b>{</b>
                        shift <font color='#5555FF'>=</font> <font color='#979000'>7</font>;
                        sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                        shift<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     shift <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font>
                            <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0x3f3f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>6</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                           tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                        <b>{</b>
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font>;
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>gamma_table [p <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font>
                               <font face='Lucida Console'>(</font>p <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>] <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font>;
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0x3f3f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>6</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                           tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> g <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>shift<font face='Lucida Console'>)</font>
                        <b>{</b>
                           shift <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                           sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                           shift <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
                     <b>}</b>
                  <b>}</b>

                  <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     shift <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font>
                            <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0x3f3f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>6</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                           tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>shift<font face='Lucida Console'>)</font>
                        <b>{</b>
                           shift <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                           sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                           shift <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
                     <b>}</b>
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
               <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font>
                            <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0xf0f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>4</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                           tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                        <b>{</b>
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font>;
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>gamma_table[p <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>p <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>] <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                              <font color='#979000'>0x0f</font>;
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0xf0f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>4</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                           tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> g <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>shift<font face='Lucida Console'>)</font>
                        <b>{</b>
                           shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                           sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                           shift <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                     <b>}</b>
                  <b>}</b>

                  <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font>
                            <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> tmp <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font color='#979000'>0xf0f</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>4</font> <font color='#5555FF'>-</font> shift<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                           tmp <font color='#5555FF'>|</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> shift;
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>tmp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>shift<font face='Lucida Console'>)</font>
                        <b>{</b>
                           shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                           sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                           shift <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
                     <b>}</b>
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>case</font> <font color='#979000'>8</font>:
               <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray;

                        <font color='#0000FF'>else</font>
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                     <b>}</b>
                  <b>}</b>
                  <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray;
                     <b>}</b>
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>case</font> <font color='#979000'>16</font>:
               <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_16 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_16 v;

                        v <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#009900'>/* Background is already in screen gamma */</font>
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                           <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#0000FF'>else</font>
                        <b>{</b>
                           v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                           <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                     <b>}</b>
                  <b>}</b>
                  <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
                  <b>{</b>
                     sp <font color='#5555FF'>=</font> row;
                     <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_16 v;

                        v <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>v <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.gray<font face='Lucida Console'>)</font>
                        <b>{</b>
                           <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                           <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                     <b>}</b>
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>default</font>:
                  <font color='#0000FF'>break</font>;
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.red <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.blue<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>];
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
               <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.red <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.blue<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>else</font> <font color='#009900'>/* if (row_info-&gt;bit_depth == 16) */</font>
            <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_16 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     png_uint_16 g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     png_uint_16 b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.red <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         g <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         b <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.blue<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#009900'>/* Background is already in screen gamma */</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        png_uint_16 v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>

               <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     png_uint_16 g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     png_uint_16 b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>r <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.red <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         g <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         b <font color='#5555FF'>=</font><font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>trans_color.blue<font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY_ALPHA:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> gamma_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#009900'>/* Background is already in screen gamma */</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        png_byte v, w;

                        v <font color='#5555FF'>=</font> gamma_to_1[<font color='#5555FF'>*</font>sp];
                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.gray<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font>
                           w <font color='#5555FF'>=</font> gamma_from_1[w];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> w;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
               <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_byte a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray;

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>&lt;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp, <font color='#5555FF'>*</font>sp, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray<font face='Lucida Console'>)</font>;
                  <b>}</b>
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>else</font> <font color='#009900'>/* if (png_ptr-&gt;bit_depth == 16) */</font>
            <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_16 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> gamma_16_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   gamma_16_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 a <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font color='#979000'>0xffff</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_16 v;

                        v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#009900'>/* Background is already in screen gamma */</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        png_uint_16 g, v, w;

                        g <font color='#5555FF'>=</font> gamma_16_to_1[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>v, g, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.gray<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>optimize<font face='Lucida Console'>)</font>
                           w <font color='#5555FF'>=</font> v;
                        <font color='#0000FF'>else</font>
                           w <font color='#5555FF'>=</font> gamma_16_from_1[<font face='Lucida Console'>(</font>v<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font>];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
               <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 a <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>&lt;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_16 g, v;

                        g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>v, g, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.gray<font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB_ALPHA:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> gamma_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_byte a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>];
                     <b>}</b>

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#009900'>/* Background is already in screen gamma */</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        png_byte v, w;

                        v <font color='#5555FF'>=</font> gamma_to_1[<font color='#5555FF'>*</font>sp];
                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.red<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font> w <font color='#5555FF'>=</font> gamma_from_1[w];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> w;

                        v <font color='#5555FF'>=</font> gamma_to_1[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>];
                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.green<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font> w <font color='#5555FF'>=</font> gamma_from_1[w];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> w;

                        v <font color='#5555FF'>=</font> gamma_to_1[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>];
                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.blue<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font> w <font color='#5555FF'>=</font> gamma_from_1[w];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> w;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
               <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_byte a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue;
                     <b>}</b>

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>&lt;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp, <font color='#5555FF'>*</font>sp, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red<font face='Lucida Console'>)</font>;

                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>, <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>, a,
                            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green<font face='Lucida Console'>)</font>;

                        <font color='#BB00BB'>png_composite</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>, <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>, a,
                            png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue<font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>else</font> <font color='#009900'>/* if (row_info-&gt;bit_depth == 16) */</font>
            <b>{</b>
<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gamma_16 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> gamma_16_from_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   gamma_16_to_1 <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 a <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font color='#979000'>0xffff</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_16 v;

                        v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        v <font color='#5555FF'>=</font> gamma_16[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>];
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#009900'>/* Background is already in screen gamma */</font>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                     <b>{</b>
                        png_uint_16 v, w;

                        v <font color='#5555FF'>=</font> gamma_16_to_1[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.red<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font>
                           w <font color='#5555FF'>=</font> gamma_16_from_1[<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift<font face='Lucida Console'>)</font>][w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                                <font color='#979000'>8</font>];
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        v <font color='#5555FF'>=</font> gamma_16_to_1[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>];
                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.green<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font>
                           w <font color='#5555FF'>=</font> gamma_16_from_1[<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift<font face='Lucida Console'>)</font>][w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                                <font color='#979000'>8</font>];

                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        v <font color='#5555FF'>=</font> gamma_16_to_1[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>];
                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>w, v, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background_1.blue<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>optimize<font face='Lucida Console'>)</font>
                           w <font color='#5555FF'>=</font> gamma_16_from_1[<font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w<font color='#5555FF'>&amp;</font><font color='#979000'>0xff</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift<font face='Lucida Console'>)</font>][w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font>
                                <font color='#979000'>8</font>];

                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>w <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>

               <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
               <b>{</b>
                  sp <font color='#5555FF'>=</font> row;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     png_uint_16 a <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                         <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                                <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>&lt;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        png_uint_16 v;

                        png_uint_16 r <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        png_uint_16 g <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                            <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                        png_uint_16 b <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_uint_16<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
                            <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>v, r, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.red<font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>v, g, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.green<font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;

                        <font color='#BB00BB'>png_composite_16</font><font face='Lucida Console'>(</font>v, b, a, png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>background.blue<font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                        <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                     <b>}</b>
                  <b>}</b>
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>default</font>:
            <font color='#0000FF'>break</font>;
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_BACKGROUND_SUPPORTED || PNG_READ_ALPHA_MODE_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_GAMMA_SUPPORTED
<font color='#009900'>/* Gamma correct the image, avoiding the alpha channel.  Make sure
 * you do this after you deal with the transparency issue on grayscale
 * or RGB images. If your bit depth is 8, use gamma_table, if it
 * is 16, use gamma_16_table and gamma_shift.  Build these with
 * build_gamma_table().
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_gamma'></a>png_do_gamma</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row, png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_const_bytep gamma_table <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_table;
   png_const_uint_16pp gamma_16_table <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_table;
   <font color='#0000FF'><u>int</u></font> gamma_shift <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift;

   png_bytep sp;
   png_uint_32 i;
   png_uint_32 row_width<font color='#5555FF'>=</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_gamma</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> gamma_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
       <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> gamma_16_table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* if (row_info-&gt;bit_depth == 16) */</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  png_uint_16 v;

                  v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

                  v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

                  v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_RGB_ALPHA:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* if (row_info-&gt;bit_depth == 16) */</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  png_uint_16 v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

                  v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

                  v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY_ALPHA:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#009900'>/* if (row_info-&gt;bit_depth == 16) */</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  png_uint_16 v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>case</font> PNG_COLOR_TYPE_GRAY:
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>int</u></font> a <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xc0</font>;
                  <font color='#0000FF'><u>int</u></font> b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font color='#979000'>0x30</font>;
                  <font color='#0000FF'><u>int</u></font> c <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0c</font>;
                  <font color='#0000FF'><u>int</u></font> d <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font>;

                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>
                      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>gamma_table[a<font color='#5555FF'>|</font><font face='Lucida Console'>(</font>a<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>a<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>4</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>a<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>6</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font>   <font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xc0</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font>
                      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>gamma_table[<font face='Lucida Console'>(</font>b<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font>b<font color='#5555FF'>|</font><font face='Lucida Console'>(</font>b<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>b<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>4</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x30</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font>
                      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>gamma_table[<font face='Lucida Console'>(</font>c<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>4</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>c<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font>c<font color='#5555FF'>|</font><font face='Lucida Console'>(</font>c<font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0c</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font>
                      <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>gamma_table[<font face='Lucida Console'>(</font>d<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>6</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>d<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>4</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font><font face='Lucida Console'>(</font>d<font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>2</font><font face='Lucida Console'>)</font><font color='#5555FF'>|</font>d]<font face='Lucida Console'>)</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#979000'>6</font><font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'><u>int</u></font> msb <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font color='#979000'>0xf0</font>;
                  <font color='#0000FF'><u>int</u></font> lsb <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font>;

                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>gamma_table[msb <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>msb <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xf0</font><font face='Lucida Console'>)</font>
                      <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>gamma_table[<font face='Lucida Console'>(</font>lsb <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> lsb]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> gamma_table[<font color='#5555FF'>*</font>sp];
                  sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  png_uint_16 v <font color='#5555FF'>=</font> gamma_16_table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>sp];
                  <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                  sp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               <b>}</b>
            <b>}</b>
            <font color='#0000FF'>break</font>;
         <b>}</b>

         <font color='#0000FF'>default</font>:
            <font color='#0000FF'>break</font>;
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_ALPHA_MODE_SUPPORTED
<font color='#009900'>/* Encode the alpha channel to the output gamma (the input channel is always
 * linear.)  Called only with color types that have an alpha channel.  Needs the
 * from_1 tables.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_encode_alpha'></a>png_do_encode_alpha</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row, png_structrp png_ptr<font face='Lucida Console'>)</font>
<b>{</b>
   png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_encode_alpha</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_ALPHA<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         PNG_CONST png_bytep table <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_from_1;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            PNG_CONST <font color='#0000FF'><u>int</u></font> step <font color='#5555FF'>=</font>
               <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font> ? <font color='#979000'>4</font> : <font color='#979000'>2</font>;

            <font color='#009900'>/* The alpha channel is the last component: */</font>
            row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> step <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; row_width <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; <font color='#5555FF'>-</font><font color='#5555FF'>-</font>row_width, row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> step<font face='Lucida Console'>)</font>
               <font color='#5555FF'>*</font>row <font color='#5555FF'>=</font> table[<font color='#5555FF'>*</font>row];

            <font color='#0000FF'>return</font>;
         <b>}</b>
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
      <b>{</b>
         PNG_CONST png_uint_16pp table <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_16_from_1;
         PNG_CONST <font color='#0000FF'><u>int</u></font> gamma_shift <font color='#5555FF'>=</font> png_ptr<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gamma_shift;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>table <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            PNG_CONST <font color='#0000FF'><u>int</u></font> step <font color='#5555FF'>=</font>
               <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font> ? <font color='#979000'>8</font> : <font color='#979000'>4</font>;

            <font color='#009900'>/* The alpha channel is the last component: */</font>
            row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> step <font color='#5555FF'>-</font> <font color='#979000'>2</font>;

            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>; row_width <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>; <font color='#5555FF'>-</font><font color='#5555FF'>-</font>row_width, row <font color='#5555FF'>+</font><font color='#5555FF'>=</font> step<font face='Lucida Console'>)</font>
            <b>{</b>
               png_uint_16 v;

               v <font color='#5555FF'>=</font> table[<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>row <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> gamma_shift][<font color='#5555FF'>*</font>row];
               <font color='#5555FF'>*</font>row <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
               <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>row <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>v <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            <b>}</b>

            <font color='#0000FF'>return</font>;
         <b>}</b>
      <b>}</b>
   <b>}</b>

   <font color='#009900'>/* Only get to here if called with a weird row_info; no harm has been done,
    * so just issue a warning.
    */</font>
   <font color='#BB00BB'>png_warning</font><font face='Lucida Console'>(</font>png_ptr, "<font color='#CC0000'>png_do_encode_alpha: unexpected call</font>"<font face='Lucida Console'>)</font>;
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_SUPPORTED
<font color='#009900'>/* Expands a palette row to an RGB or RGBA row depending
 * upon whether you supply trans and num_trans.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_expand_palette'></a>png_do_expand_palette</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
   png_const_colorp palette, png_const_bytep trans_alpha, <font color='#0000FF'><u>int</u></font> num_trans<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> shift, value;
   png_bytep sp, dp;
   png_uint_32 i;
   png_uint_32 row_width<font color='#5555FF'>=</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_expand_palette</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               shift <font color='#5555FF'>=</font> <font color='#979000'>7</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font>
                     <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#979000'>1</font>;

                  <font color='#0000FF'>else</font>
                     <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                     sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     shift<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                  dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>
               <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>3</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font>;
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>value;
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                     sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     shift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

                  dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>
               <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font>;
                  <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font>value;
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                     sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                     shift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>4</font>;

                  dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>
               <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#0000FF'>default</font>:
               <font color='#0000FF'>break</font>;
         <b>}</b>
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width;
      <b>}</b>

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>num_trans <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> num_trans<font face='Lucida Console'>)</font>
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;

                  <font color='#0000FF'>else</font>
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> trans_alpha[<font color='#5555FF'>*</font>sp];

                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> palette[<font color='#5555FF'>*</font>sp].blue;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> palette[<font color='#5555FF'>*</font>sp].green;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> palette[<font color='#5555FF'>*</font>sp].red;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>32</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>4</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
            <b>}</b>

            <font color='#0000FF'>else</font>
            <b>{</b>
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>*</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> palette[<font color='#5555FF'>*</font>sp].blue;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> palette[<font color='#5555FF'>*</font>sp].green;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> palette[<font color='#5555FF'>*</font>sp].red;
                  sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>

               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>24</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width <font color='#5555FF'>*</font> <font color='#979000'>3</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
               row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
            <b>}</b>
         <b>}</b>
      <b>}</b>
   <b>}</b>
<b>}</b>

<font color='#009900'>/* If the bit depth &lt; 8, it is expanded to 8.  Also, if the already
 * expanded transparency value is supplied, an alpha channel is built.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_expand'></a>png_do_expand</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
    png_const_color_16p trans_color<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'><u>int</u></font> shift, value;
   png_bytep sp, dp;
   png_uint_32 i;
   png_uint_32 row_width<font color='#5555FF'>=</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_expand</font>"<font face='Lucida Console'>)</font>;

   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> gray <font color='#5555FF'>=</font> trans_color ? trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gray : <font color='#979000'>0</font>;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth<font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>case</font> <font color='#979000'>1</font>:
               <b>{</b>
                  gray <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>0xff</font>;
                  sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
                  dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
                  shift <font color='#5555FF'>=</font> <font color='#979000'>7</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x07</font><font face='Lucida Console'>)</font>;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font>
                        <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;

                     <font color='#0000FF'>else</font>
                        <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                        sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                        shift<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

                     dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>case</font> <font color='#979000'>2</font>:
               <b>{</b>
                  gray <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>0x55</font>;
                  sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
                  dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
                  shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>3</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x03</font>;
                     <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>value <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font>
                        <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                        sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                        shift <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

                     dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>case</font> <font color='#979000'>4</font>:
               <b>{</b>
                  gray <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font><font face='Lucida Console'>)</font> <font color='#5555FF'>*</font> <font color='#979000'>0x11</font>;
                  sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                  dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
                  shift <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x01</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
                  <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
                  <b>{</b>
                     value <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> shift<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0x0f</font>;
                     <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>value <font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>value <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                     <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>shift <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font>
                     <b>{</b>
                        shift <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                        sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                     <b>}</b>

                     <font color='#0000FF'>else</font>
                        shift <font color='#5555FF'>=</font> <font color='#979000'>4</font>;

                     dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <b>}</b>
                  <font color='#0000FF'>break</font>;
               <b>}</b>

               <font color='#0000FF'>default</font>:
                  <font color='#0000FF'>break</font>;
            <b>}</b>

            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font color='#979000'>8</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> row_width;
         <b>}</b>

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>trans_color <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
            <b>{</b>
               gray <font color='#5555FF'>=</font> gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font>;
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_width <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font><font color='#5555FF'>=</font> gray<font face='Lucida Console'>)</font>
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

                  <font color='#0000FF'>else</font>
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;

                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>
            <b>}</b>

            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> gray_high <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>gray <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font>;
               <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>int</u></font> gray_low <font color='#5555FF'>=</font> gray <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font>;
               sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
               <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> gray_high <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> gray_low<font face='Lucida Console'>)</font>
                  <b>{</b>
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  <b>}</b>

                  <font color='#0000FF'>else</font>
                  <b>{</b>
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
                     <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
                  <b>}</b>

                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <b>}</b>
            <b>}</b>

            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_GRAY_ALPHA;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth,
               row_width<font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> trans_color<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_byte red <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte green <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> red <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> green <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> blue<font face='Lucida Console'>)</font>
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

               <font color='#0000FF'>else</font>
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;

               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
         <b>}</b>
         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
         <b>{</b>
            png_byte red_high <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte green_high <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte blue_high <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte red_low <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte green_low <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>green <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            png_byte blue_low <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>trans_color<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            dp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>png_size_t<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_width <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
            <b>{</b>
               <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> red_high <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> red_low <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> green_high <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> green_low <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> blue_high <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                   <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>sp    <font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> blue_low<font face='Lucida Console'>)</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
               <b>}</b>

               <font color='#0000FF'>else</font>
               <b>{</b>
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
                  <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#979000'>0xff</font>;
               <b>}</b>

               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
               <font color='#5555FF'>*</font>dp<font color='#5555FF'>-</font><font color='#5555FF'>-</font> <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
         <b>}</b>
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>4</font>;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, row_width<font face='Lucida Console'>)</font>;
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_EXPAND_16_SUPPORTED
<font color='#009900'>/* If the bit depth is 8 and the color type is not a palette type expand the
 * whole row to 16 bits.  Has no effect otherwise.
 */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_expand_16'></a>png_do_expand_16</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>!</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE<font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#009900'>/* The row have a sequence of bytes containing [0..255] and we need
       * to turn it into another row containing [0..65535], to do this we
       * calculate:
       *
       *  (input / 255) * 65535
       *
       *  Which happens to be exactly input * 257 and this can be achieved
       *  simply by byte replication in place (copying backwards).
       */</font>
      png_byte <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> row <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes; <font color='#009900'>/* source, last byte + 1 */</font>
      png_byte <font color='#5555FF'>*</font>dp <font color='#5555FF'>=</font> sp <font color='#5555FF'>+</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes;  <font color='#009900'>/* destination, end + 1 */</font>
      <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>dp <font color='#5555FF'>&gt;</font> sp<font face='Lucida Console'>)</font>
         dp[<font color='#5555FF'>-</font><font color='#979000'>2</font>] <font color='#5555FF'>=</font> dp[<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>sp, dp <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;

      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>*</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font> <font color='#979000'>16</font>;
      row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>*</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>;
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> PNG_READ_QUANTIZE_SUPPORTED
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_quantize'></a>png_do_quantize</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row,
    png_const_bytep palette_lookup, png_const_bytep quantize_lookup<font face='Lucida Console'>)</font>
<b>{</b>
   png_bytep sp, dp;
   png_uint_32 i;
   png_uint_32 row_width<font color='#5555FF'>=</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_quantize</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> palette_lookup<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> r, g, b, p;
         sp <font color='#5555FF'>=</font> row;
         dp <font color='#5555FF'>=</font> row;
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            r <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            g <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

            <font color='#009900'>/* This looks real messy, but the compiler will reduce
             * it down to a reasonable formula.  For example, with
             * 5 bits per color, we get:
             * p = (((r &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 10) |
             *    (((g &gt;&gt; 3) &amp; 0x1f) &lt;&lt; 5) |
             *    ((b &gt;&gt; 3) &amp; 0x1f);
             */</font>
            p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>r <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_RED_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_RED_BITS<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>
                <font face='Lucida Console'>(</font>PNG_QUANTIZE_GREEN_BITS <font color='#5555FF'>+</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>g <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>
                <font face='Lucida Console'>(</font>PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>b <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

            <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> palette_lookup[p];
         <b>}</b>

         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, row_width<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         palette_lookup <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NULL<font face='Lucida Console'>)</font>
      <b>{</b>
         <font color='#0000FF'><u>int</u></font> r, g, b, p;
         sp <font color='#5555FF'>=</font> row;
         dp <font color='#5555FF'>=</font> row;
         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            r <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            g <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            b <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

            p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>r <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_RED_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_RED_BITS<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>
                <font face='Lucida Console'>(</font>PNG_QUANTIZE_GREEN_BITS <font color='#5555FF'>+</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>g <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_GREEN_BITS<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>
                <font face='Lucida Console'>(</font>PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>b <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font><font color='#979000'>8</font> <font color='#5555FF'>-</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font>
                <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> PNG_QUANTIZE_BLUE_BITS<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

            <font color='#5555FF'>*</font>dp<font color='#5555FF'>+</font><font color='#5555FF'>+</font> <font color='#5555FF'>=</font> palette_lookup[p];
         <b>}</b>

         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>channels <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth;
         row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>rowbytes <font color='#5555FF'>=</font> <font color='#BB00BB'>PNG_ROWBYTES</font><font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pixel_depth, row_width<font face='Lucida Console'>)</font>;
      <b>}</b>

      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_PALETTE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
         quantize_lookup<font face='Lucida Console'>)</font>
      <b>{</b>
         sp <font color='#5555FF'>=</font> row;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, sp<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font>sp <font color='#5555FF'>=</font> quantize_lookup[<font color='#5555FF'>*</font>sp];
         <b>}</b>
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_QUANTIZE_SUPPORTED */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_TRANSFORMS_SUPPORTED */</font>

<font color='#0000FF'>#ifdef</font> PNG_MNG_FEATURES_SUPPORTED
<font color='#009900'>/* Undoes intrapixel differencing  */</font>
<font color='#0000FF'><u>void</u></font> <font color='#009900'>/* PRIVATE */</font>
<b><a name='png_do_read_intrapixel'></a>png_do_read_intrapixel</b><font face='Lucida Console'>(</font>png_row_infop row_info, png_bytep row<font face='Lucida Console'>)</font>
<b>{</b>
   <font color='#BB00BB'>png_debug</font><font face='Lucida Console'>(</font><font color='#979000'>1</font>, "<font color='#CC0000'>in png_do_read_intrapixel</font>"<font face='Lucida Console'>)</font>;

   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>
       <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>&amp;</font> PNG_COLOR_MASK_COLOR<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
   <b>{</b>
      <font color='#0000FF'><u>int</u></font> bytes_per_pixel;
      png_uint_32 row_width <font color='#5555FF'>=</font> row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>width;

      <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_bytep rp;
         png_uint_32 i;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font>
            bytes_per_pixel <font color='#5555FF'>=</font> <font color='#979000'>3</font>;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font>
            bytes_per_pixel <font color='#5555FF'>=</font> <font color='#979000'>4</font>;

         <font color='#0000FF'>else</font>
            <font color='#0000FF'>return</font>;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_per_pixel<font face='Lucida Console'>)</font>
         <b>{</b>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>256</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font>rp <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp<font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>256</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>
      <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bit_depth <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font>
      <b>{</b>
         png_bytep rp;
         png_uint_32 i;

         <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB<font face='Lucida Console'>)</font>
            bytes_per_pixel <font color='#5555FF'>=</font> <font color='#979000'>6</font>;

         <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>row_info<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>color_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> PNG_COLOR_TYPE_RGB_ALPHA<font face='Lucida Console'>)</font>
            bytes_per_pixel <font color='#5555FF'>=</font> <font color='#979000'>8</font>;

         <font color='#0000FF'>else</font>
            <font color='#0000FF'>return</font>;

         <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>, rp <font color='#5555FF'>=</font> row; i <font color='#5555FF'>&lt;</font> row_width; i<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, rp <font color='#5555FF'>+</font><font color='#5555FF'>=</font> bytes_per_pixel<font face='Lucida Console'>)</font>
         <b>{</b>
            png_uint_32 s0   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp    <font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
            png_uint_32 s1   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font>;
            png_uint_32 s2   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font>;
            png_uint_32 red  <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>s0 <font color='#5555FF'>+</font> s1 <font color='#5555FF'>+</font> <font color='#979000'>65536</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font>;
            png_uint_32 blue <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>s2 <font color='#5555FF'>+</font> s1 <font color='#5555FF'>+</font> <font color='#979000'>65536</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp    <font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>red <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>red <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>blue <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>rp <font color='#5555FF'>+</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>png_byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>blue <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
         <b>}</b>
      <b>}</b>
   <b>}</b>
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_MNG_FEATURES_SUPPORTED */</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* PNG_READ_SUPPORTED */</font>

</pre></body></html>