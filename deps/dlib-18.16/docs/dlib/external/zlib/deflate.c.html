<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dlib.net for updates. --><head><title>dlib C++ Library - deflate.c</title></head><body bgcolor='white'><pre>
<font color='#009900'>/* deflate.c -- compress data using the deflation algorithm
 * Copyright (C) 1995-2013 Jean-loup Gailly and Mark Adler
 * For conditions of distribution and use, see copyright notice in zlib.h
 */</font>

<font color='#009900'>/*
 *  ALGORITHM
 *
 *      The "deflation" process depends on being able to identify portions
 *      of the input text which are identical to earlier input (within a
 *      sliding window trailing behind the input currently being processed).
 *
 *      The most straightforward technique turns out to be the fastest for
 *      most input files: try all possible matches and select the longest.
 *      The key feature of this algorithm is that insertions into the string
 *      dictionary are very simple and thus fast, and deletions are avoided
 *      completely. Insertions are performed at each input character, whereas
 *      string matches are performed only when the previous match ends. So it
 *      is preferable to spend more time in matches to allow very fast string
 *      insertions and avoid deletions. The matching algorithm for small
 *      strings is inspired from that of Rabin &amp; Karp. A brute force approach
 *      is used to find longer strings when a small match has been found.
 *      A similar algorithm is used in comic (by Jan-Mark Wams) and freeze
 *      (by Leonid Broukhis).
 *         A previous version of this file used a more sophisticated algorithm
 *      (by Fiala and Greene) which is guaranteed to run in linear amortized
 *      time, but has a larger average cost, uses more memory and is patented.
 *      However the F&amp;G algorithm may be faster for some highly redundant
 *      files if the parameter max_chain_length (described below) is too large.
 *
 *  ACKNOWLEDGEMENTS
 *
 *      The idea of lazy evaluation of matches is due to Jan-Mark Wams, and
 *      I found it in 'freeze' written by Leonid Broukhis.
 *      Thanks to many people for bug reports and testing.
 *
 *  REFERENCES
 *
 *      Deutsch, L.P.,"DEFLATE Compressed Data Format Specification".
 *      Available in http://tools.ietf.org/html/rfc1951
 *
 *      A description of the Rabin and Karp algorithm is given in the book
 *         "Algorithms" by R. Sedgewick, Addison-Wesley, p252.
 *
 *      Fiala,E.R., and Greene,D.H.
 *         Data Compression with Finite Windows, Comm.ACM, 32,4 (1989) 490-595
 *
 */</font>

<font color='#009900'>/* @(#) $Id$ */</font>

<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='deflate.h.html'>deflate.h</a>"

<font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> deflate_copyright[] <font color='#5555FF'>=</font>
   "<font color='#CC0000'> deflate 1.2.8 Copyright 1995-2013 Jean-loup Gailly and Mark Adler </font>";
<font color='#009900'>/*
  If you use the zlib library in a product, an acknowledgment is welcome
  in the documentation of your product. If for some reason you cannot
  include such an acknowledgment, I would appreciate that you keep this
  copyright string in the executable of your product.
 */</font>

<font color='#009900'>/* ===========================================================================
 *  Function prototypes.
 */</font>
<font color='#0000FF'>typedef</font> <font color='#0000FF'>enum</font> <b>{</b>
    need_more,      <font color='#009900'>/* block not completed, need more input or more output */</font>
    block_done,     <font color='#009900'>/* block flush performed */</font>
    finish_started, <font color='#009900'>/* finish started, need only more output at next deflate */</font>
    finish_done     <font color='#009900'>/* finish done, accept no more input or output */</font>
<b>}</b> block_state;

<font color='#0000FF'>typedef</font> <b><a name='block_state'></a>block_state</b> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>compress_func<font face='Lucida Console'>)</font> <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#009900'>/* Compression function. Returns the block state after the call. */</font>

local <font color='#0000FF'><u>void</u></font> fill_window    <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local block_state deflate_stored <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local block_state deflate_fast   <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifndef</font> FASTEST
local block_state deflate_slow   <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
local block_state deflate_rle    <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local block_state deflate_huff   <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, <font color='#0000FF'><u>int</u></font> flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local <font color='#0000FF'><u>void</u></font> lm_init        <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local <font color='#0000FF'><u>void</u></font> putShortMSB    <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, uInt b<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local <font color='#0000FF'><u>void</u></font> flush_pending  <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>z_streamp strm<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
local <font color='#0000FF'><u>int</u></font> read_buf        <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>z_streamp strm, Bytef <font color='#5555FF'>*</font>buf, <font color='#0000FF'><u>unsigned</u></font> size<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifdef</font> ASMV
      <font color='#0000FF'><u>void</u></font> match_init <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>void</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* asm code initialization */</font>
      uInt longest_match  <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, IPos cur_match<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
local uInt longest_match  <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, IPos cur_match<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> DEBUG
local  <font color='#0000FF'><u>void</u></font> check_match <b><a name='OF'></a>OF</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font>s, IPos start, IPos match,
                            <font color='#0000FF'><u>int</u></font> length<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* ===========================================================================
 * Local data
 */</font>

<font color='#0000FF'>#define</font> NIL <font color='#979000'>0</font>
<font color='#009900'>/* Tail of hash chains */</font>

<font color='#0000FF'>#ifndef</font> TOO_FAR
#  define TOO_FAR <font color='#979000'>4096</font>
<font color='#0000FF'>#endif</font>
<font color='#009900'>/* Matches of length 3 are discarded if their distance exceeds TOO_FAR */</font>

<font color='#009900'>/* Values for max_lazy_match, good_match and max_chain_length, depending on
 * the desired pack level (0..9). The values given below have been tuned to
 * exclude worst case performance for pathological files. Better values may be
 * found for specific files.
 */</font>
<font color='#0000FF'>typedef</font> <font color='#0000FF'>struct</font> <b><a name='config_s'></a>config_s</b> <b>{</b>
   ush good_length; <font color='#009900'>/* reduce lazy search above this match length */</font>
   ush max_lazy;    <font color='#009900'>/* do not perform lazy search above this match length */</font>
   ush nice_length; <font color='#009900'>/* quit search above this match length */</font>
   ush max_chain;
   compress_func func;
<b>}</b> config;

<font color='#0000FF'>#ifdef</font> FASTEST
local <font color='#0000FF'>const</font> config configuration_table[<font color='#979000'>2</font>] <font color='#5555FF'>=</font> <b>{</b>
<font color='#009900'>/*      good lazy nice chain */</font>
<font color='#009900'>/* 0 */</font> <b>{</b><font color='#979000'>0</font>,    <font color='#979000'>0</font>,  <font color='#979000'>0</font>,    <font color='#979000'>0</font>, deflate_stored<b>}</b>,  <font color='#009900'>/* store only */</font>
<font color='#009900'>/* 1 */</font> <b>{</b><font color='#979000'>4</font>,    <font color='#979000'>4</font>,  <font color='#979000'>8</font>,    <font color='#979000'>4</font>, deflate_fast<b>}</b><b>}</b>; <font color='#009900'>/* max speed, no lazy matches */</font>
<font color='#0000FF'>#else</font>
local <font color='#0000FF'>const</font> config configuration_table[<font color='#979000'>10</font>] <font color='#5555FF'>=</font> <b>{</b>
<font color='#009900'>/*      good lazy nice chain */</font>
<font color='#009900'>/* 0 */</font> <b>{</b><font color='#979000'>0</font>,    <font color='#979000'>0</font>,  <font color='#979000'>0</font>,    <font color='#979000'>0</font>, deflate_stored<b>}</b>,  <font color='#009900'>/* store only */</font>
<font color='#009900'>/* 1 */</font> <b>{</b><font color='#979000'>4</font>,    <font color='#979000'>4</font>,  <font color='#979000'>8</font>,    <font color='#979000'>4</font>, deflate_fast<b>}</b>, <font color='#009900'>/* max speed, no lazy matches */</font>
<font color='#009900'>/* 2 */</font> <b>{</b><font color='#979000'>4</font>,    <font color='#979000'>5</font>, <font color='#979000'>16</font>,    <font color='#979000'>8</font>, deflate_fast<b>}</b>,
<font color='#009900'>/* 3 */</font> <b>{</b><font color='#979000'>4</font>,    <font color='#979000'>6</font>, <font color='#979000'>32</font>,   <font color='#979000'>32</font>, deflate_fast<b>}</b>,

<font color='#009900'>/* 4 */</font> <b>{</b><font color='#979000'>4</font>,    <font color='#979000'>4</font>, <font color='#979000'>16</font>,   <font color='#979000'>16</font>, deflate_slow<b>}</b>,  <font color='#009900'>/* lazy matches */</font>
<font color='#009900'>/* 5 */</font> <b>{</b><font color='#979000'>8</font>,   <font color='#979000'>16</font>, <font color='#979000'>32</font>,   <font color='#979000'>32</font>, deflate_slow<b>}</b>,
<font color='#009900'>/* 6 */</font> <b>{</b><font color='#979000'>8</font>,   <font color='#979000'>16</font>, <font color='#979000'>128</font>, <font color='#979000'>128</font>, deflate_slow<b>}</b>,
<font color='#009900'>/* 7 */</font> <b>{</b><font color='#979000'>8</font>,   <font color='#979000'>32</font>, <font color='#979000'>128</font>, <font color='#979000'>256</font>, deflate_slow<b>}</b>,
<font color='#009900'>/* 8 */</font> <b>{</b><font color='#979000'>32</font>, <font color='#979000'>128</font>, <font color='#979000'>258</font>, <font color='#979000'>1024</font>, deflate_slow<b>}</b>,
<font color='#009900'>/* 9 */</font> <b>{</b><font color='#979000'>32</font>, <font color='#979000'>258</font>, <font color='#979000'>258</font>, <font color='#979000'>4096</font>, deflate_slow<b>}</b><b>}</b>; <font color='#009900'>/* max compression */</font>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* Note: the deflate() code requires max_lazy &gt;= MIN_MATCH and max_chain &gt;= 4
 * For deflate_fast() (levels &lt;= 3) good is ignored and lazy has a different
 * meaning.
 */</font>

<font color='#0000FF'>#define</font> EQUAL <font color='#979000'>0</font>
<font color='#009900'>/* result of memcmp for equal strings */</font>

<font color='#0000FF'>#ifndef</font> NO_DUMMY_DECL
<font color='#0000FF'>struct</font> <b><a name='static_tree_desc_s'></a>static_tree_desc_s</b> <b>{</b><font color='#0000FF'><u>int</u></font> dummy;<b>}</b>; <font color='#009900'>/* for buggy compilers */</font>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* rank Z_BLOCK between Z_NO_FLUSH and Z_PARTIAL_FLUSH */</font>
<font color='#0000FF'>#define</font> RANK<font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>4</font> ? <font color='#979000'>9</font> : <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>

<font color='#009900'>/* ===========================================================================
 * Update a hash value with the given input byte
 * IN  assertion: all calls to to UPDATE_HASH are made with consecutive
 *    input characters, so that a running hash key can be computed from the
 *    previous key instead of complete recalculation each time.
 */</font>
<font color='#0000FF'>#define</font> UPDATE_HASH<font face='Lucida Console'>(</font>s,h,c<font face='Lucida Console'>)</font> <font face='Lucida Console'>(</font>h <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>h<font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_shift<font face='Lucida Console'>)</font> ^ <font face='Lucida Console'>(</font>c<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_mask<font face='Lucida Console'>)</font>


<font color='#009900'>/* ===========================================================================
 * Insert string str in the dictionary and set match_head to the previous head
 * of the hash chain (the most recent string with same hash key). Return
 * the previous length of the hash chain.
 * If this file is compiled with -DFASTEST, the compression level is forced
 * to 1, and no hash chains are maintained.
 * IN  assertion: all calls to to INSERT_STRING are made with consecutive
 *    input characters and the first MIN_MATCH bytes of str are valid
 *    (except for the last MIN_MATCH-1 bytes of the input file).
 */</font>
<font color='#0000FF'>#ifdef</font> FASTEST
<font color='#0000FF'>#define</font> INSERT_STRING<font face='Lucida Console'>(</font>s, str, match_head<font face='Lucida Console'>)</font> \
   <font face='Lucida Console'>(</font><font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[<font face='Lucida Console'>(</font>str<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font>, \
    match_head <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h], \
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>str<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#else</font>
<font color='#0000FF'>#define</font> INSERT_STRING<font face='Lucida Console'>(</font>s, str, match_head<font face='Lucida Console'>)</font> \
   <font face='Lucida Console'>(</font><font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[<font face='Lucida Console'>(</font>str<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>]<font face='Lucida Console'>)</font>, \
    match_head <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev[<font face='Lucida Console'>(</font>str<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_mask] <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h], \
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>str<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>

<font color='#009900'>/* ===========================================================================
 * Initialize the hash table (avoiding 64K overflow for 16 bit systems).
 * prev[] will be initialized on the fly.
 */</font>
<font color='#0000FF'>#define</font> CLEAR_HASH<font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font> \
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font> NIL; \
    <b><a name='zmemzero'></a>zmemzero</b><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>Bytef <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateInit_'></a>deflateInit_</b><font face='Lucida Console'>(</font>strm, level, version, stream_size<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'><u>int</u></font> level;
    <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>version;
    <font color='#0000FF'><u>int</u></font> stream_size;
<b>{</b>
    <font color='#0000FF'>return</font> <font color='#BB00BB'>deflateInit2_</font><font face='Lucida Console'>(</font>strm, level, Z_DEFLATED, MAX_WBITS, DEF_MEM_LEVEL,
                         Z_DEFAULT_STRATEGY, version, stream_size<font face='Lucida Console'>)</font>;
    <font color='#009900'>/* To do: ignore strm-&gt;next_in if we use it as window */</font>
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateInit2_'></a>deflateInit2_</b><font face='Lucida Console'>(</font>strm, level, method, windowBits, memLevel, strategy,
                  version, stream_size<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'><u>int</u></font>  level;
    <font color='#0000FF'><u>int</u></font>  method;
    <font color='#0000FF'><u>int</u></font>  windowBits;
    <font color='#0000FF'><u>int</u></font>  memLevel;
    <font color='#0000FF'><u>int</u></font>  strategy;
    <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>version;
    <font color='#0000FF'><u>int</u></font> stream_size;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> wrap <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
    <font color='#0000FF'>static</font> <font color='#0000FF'>const</font> <font color='#0000FF'><u>char</u></font> my_version[] <font color='#5555FF'>=</font> ZLIB_VERSION;

    ushf <font color='#5555FF'>*</font>overlay;
    <font color='#009900'>/* We overlay pending_buf and d_buf+l_buf. This works since the average
     * output size for (length,distance) codes is &lt;= 24 bits.
     */</font>

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>version <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> version[<font color='#979000'>0</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> my_version[<font color='#979000'>0</font>] <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        stream_size <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>z_stream<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> Z_VERSION_ERROR;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;

    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>msg <font color='#5555FF'>=</font> Z_NULL;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zalloc <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>alloc_func<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#ifdef</font> Z_SOLO
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
<font color='#0000FF'>#else</font>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zalloc <font color='#5555FF'>=</font> zcalloc;
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>opaque <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font><font color='#979000'>0</font>;
<font color='#0000FF'>#endif</font>
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zfree <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>free_func<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#ifdef</font> Z_SOLO
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
<font color='#0000FF'>#else</font>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zfree <font color='#5555FF'>=</font> zcfree;
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>#ifdef</font> FASTEST
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>level <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> level <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
<font color='#0000FF'>#else</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>level <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_DEFAULT_COMPRESSION<font face='Lucida Console'>)</font> level <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
<font color='#0000FF'>#endif</font>

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>windowBits <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b> <font color='#009900'>/* suppress zlib wrapper */</font>
        wrap <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        windowBits <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>windowBits;
    <b>}</b>
<font color='#0000FF'>#ifdef</font> GZIP
    <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>windowBits <font color='#5555FF'>&gt;</font> <font color='#979000'>15</font><font face='Lucida Console'>)</font> <b>{</b>
        wrap <font color='#5555FF'>=</font> <font color='#979000'>2</font>;       <font color='#009900'>/* write gzip wrapper instead */</font>
        windowBits <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>16</font>;
    <b>}</b>
<font color='#0000FF'>#endif</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>memLevel <font color='#5555FF'>&lt;</font> <font color='#979000'>1</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> memLevel <font color='#5555FF'>&gt;</font> MAX_MEM_LEVEL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> method <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_DEFLATED <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        windowBits <font color='#5555FF'>&lt;</font> <font color='#979000'>8</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> windowBits <font color='#5555FF'>&gt;</font> <font color='#979000'>15</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> level <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> level <font color='#5555FF'>&gt;</font> <font color='#979000'>9</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        strategy <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strategy <font color='#5555FF'>&gt;</font> Z_FIXED<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>windowBits <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> windowBits <font color='#5555FF'>=</font> <font color='#979000'>9</font>;  <font color='#009900'>/* until 256-byte window bug fixed */</font>
    s <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>strm, <font color='#979000'>1</font>, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>deflate_state<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_MEM_ERROR;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>struct</font> internal_state FAR <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>s;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm <font color='#5555FF'>=</font> strm;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font> wrap;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead <font color='#5555FF'>=</font> Z_NULL;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_bits <font color='#5555FF'>=</font> windowBits;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size <font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_bits;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_mask <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_bits <font color='#5555FF'>=</font> memLevel <font color='#5555FF'>+</font> <font color='#979000'>7</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size <font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_bits;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_mask <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_shift <font color='#5555FF'>=</font>  <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_bits<font color='#5555FF'>+</font>MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font>MIN_MATCH<font face='Lucida Console'>)</font>;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Bytef <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>strm, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size, <font color='#979000'>2</font><font color='#5555FF'>*</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Posf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>  <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>strm, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Posf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>  <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>strm, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water <font color='#5555FF'>=</font> <font color='#979000'>0</font>;      <font color='#009900'>/* nothing written to s-&gt;window yet */</font>

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize <font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>memLevel <font color='#5555FF'>+</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* 16K elements by default */</font>

    overlay <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ushf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>strm, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font><font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uchf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> overlay;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize <font color='#5555FF'>*</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font><font color='#5555FF'>+</font><font color='#979000'>2</font>L<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> FINISH_STATE;
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>msg <font color='#5555FF'>=</font> <font color='#BB00BB'>ERR_MSG</font><font face='Lucida Console'>(</font>Z_MEM_ERROR<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>deflateEnd</font> <font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> Z_MEM_ERROR;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>d_buf <font color='#5555FF'>=</font> overlay <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize<font color='#5555FF'>/</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>l_buf <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font><font color='#5555FF'>+</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>=</font> level;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>=</font> strategy;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>method <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font>method;

    <font color='#0000FF'>return</font> <font color='#BB00BB'>deflateReset</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateSetDictionary'></a>deflateSetDictionary</b> <font face='Lucida Console'>(</font>strm, dictionary, dictLength<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'>const</font> Bytef <font color='#5555FF'>*</font>dictionary;
    uInt  dictLength;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;
    uInt str, n;
    <font color='#0000FF'><u>int</u></font> wrap;
    <font color='#0000FF'><u>unsigned</u></font> avail;
    z_const <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <font color='#5555FF'>*</font>next;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> dictionary <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;
    wrap <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> INIT_STATE<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;

    <font color='#009900'>/* when using zlib wrappers, compute Adler-32 for provided dictionary */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>adler32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, dictionary, dictLength<font face='Lucida Console'>)</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font> <font color='#979000'>0</font>;                    <font color='#009900'>/* avoid computing Adler-32 in read_buf */</font>

    <font color='#009900'>/* if dictionary would fill window, just replace the history */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>dictLength <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>            <font color='#009900'>/* already empty otherwise */</font>
            <font color='#BB00BB'>CLEAR_HASH</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>=</font> <font color='#979000'>0</font>L;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <b>}</b>
        dictionary <font color='#5555FF'>+</font><font color='#5555FF'>=</font> dictLength <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size;  <font color='#009900'>/* use the tail */</font>
        dictLength <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size;
    <b>}</b>

    <font color='#009900'>/* insert dictionary into window and hash */</font>
    avail <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in;
    next <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_in;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>=</font> dictLength;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_in <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>z_const Bytef <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>dictionary;
    <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
        str <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart;
        n <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>do</font> <b>{</b>
            <font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[str <font color='#5555FF'>+</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifndef</font> FASTEST
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev[str <font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_mask] <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h];
<font color='#0000FF'>#endif</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font>str;
            str<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>n<font face='Lucida Console'>)</font>;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font> str;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
        <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>=</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_in <font color='#5555FF'>=</font> next;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>=</font> avail;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font> wrap;
    <font color='#0000FF'>return</font> Z_OK;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateResetKeep'></a>deflateResetKeep</b> <font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>
    z_streamp strm;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zalloc <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>alloc_func<font face='Lucida Console'>)</font><font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>zfree <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>free_func<font face='Lucida Console'>)</font><font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <b>}</b>

    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_out <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>msg <font color='#5555FF'>=</font> Z_NULL; <font color='#009900'>/* use zfree if we ever allocate msg dynamically */</font>
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>data_type <font color='#5555FF'>=</font> Z_UNKNOWN;

    s <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap; <font color='#009900'>/* was made negative by deflate(..., Z_FINISH); */</font>
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap ? INIT_STATE : BUSY_STATE;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font>
<font color='#0000FF'>#ifdef</font> GZIP
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> ? <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>L, Z_NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font> :
<font color='#0000FF'>#endif</font>
        <font color='#BB00BB'>adler32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>L, Z_NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_flush <font color='#5555FF'>=</font> Z_NO_FLUSH;

    <font color='#BB00BB'>_tr_init</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>return</font> Z_OK;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateReset'></a>deflateReset</b> <font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>
    z_streamp strm;
<b>{</b>
    <font color='#0000FF'><u>int</u></font> ret;

    ret <font color='#5555FF'>=</font> <font color='#BB00BB'>deflateResetKeep</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ret <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_OK<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>lm_init</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> ret;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateSetHeader'></a>deflateSetHeader</b> <font face='Lucida Console'>(</font>strm, head<font face='Lucida Console'>)</font>
    z_streamp strm;
    gz_headerp head;
<b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead <font color='#5555FF'>=</font> head;
    <font color='#0000FF'>return</font> Z_OK;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflatePending'></a>deflatePending</b> <font face='Lucida Console'>(</font>strm, pending, bits<font face='Lucida Console'>)</font>
    <font color='#0000FF'><u>unsigned</u></font> <font color='#5555FF'>*</font>pending;
    <font color='#0000FF'><u>int</u></font> <font color='#5555FF'>*</font>bits;
    z_streamp strm;
<b>{</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pending <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
        <font color='#5555FF'>*</font>pending <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bits <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
        <font color='#5555FF'>*</font>bits <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bi_valid;
    <font color='#0000FF'>return</font> Z_OK;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflatePrime'></a>deflatePrime</b> <font face='Lucida Console'>(</font>strm, bits, value<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'><u>int</u></font> bits;
    <font color='#0000FF'><u>int</u></font> value;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> put;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>Bytef <font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>d_buf<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>Buf_size <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> Z_BUF_ERROR;
    <font color='#0000FF'>do</font> <b>{</b>
        put <font color='#5555FF'>=</font> Buf_size <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bi_valid;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>put <font color='#5555FF'>&gt;</font> bits<font face='Lucida Console'>)</font>
            put <font color='#5555FF'>=</font> bits;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bi_buf <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>value <font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> put<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bi_valid<font face='Lucida Console'>)</font>;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bi_valid <font color='#5555FF'>+</font><font color='#5555FF'>=</font> put;
        <font color='#BB00BB'>_tr_flush_bits</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
        value <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> put;
        bits <font color='#5555FF'>-</font><font color='#5555FF'>=</font> put;
    <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>bits<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> Z_OK;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateParams'></a>deflateParams</b><font face='Lucida Console'>(</font>strm, level, strategy<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'><u>int</u></font> level;
    <font color='#0000FF'><u>int</u></font> strategy;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;
    compress_func func;
    <font color='#0000FF'><u>int</u></font> err <font color='#5555FF'>=</font> Z_OK;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;

<font color='#0000FF'>#ifdef</font> FASTEST
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>level <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> level <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
<font color='#0000FF'>#else</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>level <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_DEFAULT_COMPRESSION<font face='Lucida Console'>)</font> level <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
<font color='#0000FF'>#endif</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>level <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> level <font color='#5555FF'>&gt;</font> <font color='#979000'>9</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strategy <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strategy <font color='#5555FF'>&gt;</font> Z_FIXED<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <b>}</b>
    func <font color='#5555FF'>=</font> configuration_table[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level].func;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strategy <font color='#5555FF'>!</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>|</font><font color='#5555FF'>|</font> func <font color='#5555FF'>!</font><font color='#5555FF'>=</font> configuration_table[level].func<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>/* Flush the last buffer: */</font>
        err <font color='#5555FF'>=</font> <font color='#BB00BB'>deflate</font><font face='Lucida Console'>(</font>strm, Z_BLOCK<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>err <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_BUF_ERROR <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            err <font color='#5555FF'>=</font> Z_OK;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>!</font><font color='#5555FF'>=</font> level<font face='Lucida Console'>)</font> <b>{</b>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>=</font> level;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_lazy_match   <font color='#5555FF'>=</font> configuration_table[level].max_lazy;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>good_match       <font color='#5555FF'>=</font> configuration_table[level].good_length;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nice_match       <font color='#5555FF'>=</font> configuration_table[level].nice_length;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_chain_length <font color='#5555FF'>=</font> configuration_table[level].max_chain;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>=</font> strategy;
    <font color='#0000FF'>return</font> err;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateTune'></a>deflateTune</b><font face='Lucida Console'>(</font>strm, good_length, max_lazy, nice_length, max_chain<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'><u>int</u></font> good_length;
    <font color='#0000FF'><u>int</u></font> max_lazy;
    <font color='#0000FF'><u>int</u></font> nice_length;
    <font color='#0000FF'><u>int</u></font> max_chain;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>good_match <font color='#5555FF'>=</font> good_length;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_lazy_match <font color='#5555FF'>=</font> max_lazy;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nice_match <font color='#5555FF'>=</font> nice_length;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_chain_length <font color='#5555FF'>=</font> max_chain;
    <font color='#0000FF'>return</font> Z_OK;
<b>}</b>

<font color='#009900'>/* =========================================================================
 * For the default windowBits of 15 and memLevel of 8, this function returns
 * a close to exact, as well as small, upper bound on the compressed size.
 * They are coded as constants here for a reason--if the #define's are
 * changed, then this function needs to be changed as well.  The return
 * value for 15 and 8 only works for those exact settings.
 *
 * For any setting other than those defaults for windowBits and memLevel,
 * the value returned is a conservative worst case for the maximum expansion
 * resulting from using fixed blocks instead of stored blocks, which deflate
 * can emit on compressed data for some combinations of the parameters.
 *
 * This function could be more sophisticated to provide closer upper bounds for
 * every combination of windowBits and memLevel.  But even the conservative
 * upper bound of about 14% expansion does not seem onerous for output buffer
 * allocation.
 */</font>
uLong ZEXPORT <b><a name='deflateBound'></a>deflateBound</b><font face='Lucida Console'>(</font>strm, sourceLen<font face='Lucida Console'>)</font>
    z_streamp strm;
    uLong sourceLen;
<b>{</b>
    deflate_state <font color='#5555FF'>*</font>s;
    uLong complen, wraplen;
    Bytef <font color='#5555FF'>*</font>str;

    <font color='#009900'>/* conservative upper bound for compressed data */</font>
    complen <font color='#5555FF'>=</font> sourceLen <font color='#5555FF'>+</font>
              <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>sourceLen <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>3</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>sourceLen <font color='#5555FF'>+</font> <font color='#979000'>63</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>5</font>;

    <font color='#009900'>/* if can't get parameters, return conservative bound plus zlib wrapper */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> complen <font color='#5555FF'>+</font> <font color='#979000'>6</font>;

    <font color='#009900'>/* compute wrapper length */</font>
    s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;
    <font color='#0000FF'>switch</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap<font face='Lucida Console'>)</font> <b>{</b>
    <font color='#0000FF'>case</font> <font color='#979000'>0</font>:                                 <font color='#009900'>/* raw deflate */</font>
        wraplen <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> <font color='#979000'>1</font>:                                 <font color='#009900'>/* zlib wrapper */</font>
        wraplen <font color='#5555FF'>=</font> <font color='#979000'>6</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart ? <font color='#979000'>4</font> : <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>break</font>;
    <font color='#0000FF'>case</font> <font color='#979000'>2</font>:                                 <font color='#009900'>/* gzip wrapper */</font>
        wraplen <font color='#5555FF'>=</font> <font color='#979000'>18</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>          <font color='#009900'>/* user-supplied gzip header */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
                wraplen <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font> <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra_len;
            str <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>name;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
                <font color='#0000FF'>do</font> <b>{</b>
                    wraplen<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>str<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
            str <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comment;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font>
                <font color='#0000FF'>do</font> <b>{</b>
                    wraplen<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>str<font color='#5555FF'>+</font><font color='#5555FF'>+</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc<font face='Lucida Console'>)</font>
                wraplen <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
        <b>}</b>
        <font color='#0000FF'>break</font>;
    <font color='#0000FF'>default</font>:                                <font color='#009900'>/* for compiler happiness */</font>
        wraplen <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
    <b>}</b>

    <font color='#009900'>/* if not default parameters, return conservative bound */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_bits <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>15</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_bits <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>+</font> <font color='#979000'>7</font><font face='Lucida Console'>)</font>
        <font color='#0000FF'>return</font> complen <font color='#5555FF'>+</font> wraplen;

    <font color='#009900'>/* default settings: return tight bound for that case */</font>
    <font color='#0000FF'>return</font> sourceLen <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>sourceLen <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>12</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>sourceLen <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>14</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
           <font face='Lucida Console'>(</font>sourceLen <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>25</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> <font color='#979000'>13</font> <font color='#5555FF'>-</font> <font color='#979000'>6</font> <font color='#5555FF'>+</font> wraplen;
<b>}</b>

<font color='#009900'>/* =========================================================================
 * Put a short in the pending buffer. The 16-bit value is put in MSB order.
 * IN assertion: the stream state is correct and there is enough room in
 * pending_buf.
 */</font>
local <font color='#0000FF'><u>void</u></font> <b><a name='putShortMSB'></a>putShortMSB</b> <font face='Lucida Console'>(</font>s, b<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    uInt b;
<b>{</b>
    <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>b <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>b <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* =========================================================================
 * Flush as much pending output as possible. All deflate() output goes
 * through this function so some applications may wish to modify it
 * to avoid allocating a large strm-&gt;next_out buffer and copying into it.
 * (See also read_buf()).
 */</font>
local <font color='#0000FF'><u>void</u></font> <b><a name='flush_pending'></a>flush_pending</b><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>
    z_streamp strm;
<b>{</b>
    <font color='#0000FF'><u>unsigned</u></font> len;
    deflate_state <font color='#5555FF'>*</font>s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;

    <font color='#BB00BB'>_tr_flush_bits</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
    len <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>&gt;</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out<font face='Lucida Console'>)</font> len <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font>;

    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_out, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out, len<font face='Lucida Console'>)</font>;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_out  <font color='#5555FF'>+</font><font color='#5555FF'>=</font> len;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out  <font color='#5555FF'>+</font><font color='#5555FF'>=</font> len;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_out <font color='#5555FF'>+</font><font color='#5555FF'>=</font> len;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out  <font color='#5555FF'>-</font><font color='#5555FF'>=</font> len;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font><font color='#5555FF'>=</font> len;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf;
    <b>}</b>
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflate'></a>deflate</b> <font face='Lucida Console'>(</font>strm, flush<font face='Lucida Console'>)</font>
    z_streamp strm;
    <font color='#0000FF'><u>int</u></font> flush;
<b>{</b>
    <font color='#0000FF'><u>int</u></font> old_flush; <font color='#009900'>/* value of flush param for previous deflate call */</font>
    deflate_state <font color='#5555FF'>*</font>s;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        flush <font color='#5555FF'>&gt;</font> Z_BLOCK <font color='#5555FF'>|</font><font color='#5555FF'>|</font> flush <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <b>}</b>
    s <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_in <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> FINISH_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>ERR_RETURN</font><font face='Lucida Console'>(</font>strm, Z_STREAM_ERROR<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ERR_RETURN</font><font face='Lucida Console'>(</font>strm, Z_BUF_ERROR<font face='Lucida Console'>)</font>;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm <font color='#5555FF'>=</font> strm; <font color='#009900'>/* just in case */</font>
    old_flush <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_flush;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_flush <font color='#5555FF'>=</font> flush;

    <font color='#009900'>/* Write the header */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> INIT_STATE<font face='Lucida Console'>)</font> <b>{</b>
<font color='#0000FF'>#ifdef</font> GZIP
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <b>{</b>
            strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>L, Z_NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>31</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>139</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>8</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>9</font> ? <font color='#979000'>2</font> :
                            <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> Z_HUFFMAN_ONLY <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>&lt;</font> <font color='#979000'>2</font> ?
                             <font color='#979000'>4</font> : <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, OS_CODE<font face='Lucida Console'>)</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> BUSY_STATE;
            <b>}</b>
            <font color='#0000FF'>else</font> <b>{</b>
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>text ? <font color='#979000'>1</font> : <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                            <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc ? <font color='#979000'>2</font> : <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                            <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL ? <font color='#979000'>0</font> : <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                            <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>name <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL ? <font color='#979000'>0</font> : <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>+</font>
                            <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comment <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL ? <font color='#979000'>0</font> : <font color='#979000'>16</font><font face='Lucida Console'>)</font>
                        <font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>time <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>time <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>time <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>time <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>9</font> ? <font color='#979000'>2</font> :
                            <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> Z_HUFFMAN_ONLY <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>&lt;</font> <font color='#979000'>2</font> ?
                             <font color='#979000'>4</font> : <font color='#979000'>0</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>os <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra_len <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                    <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra_len <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font>;
                <b>}</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc<font face='Lucida Console'>)</font>
                    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf,
                                        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending<font face='Lucida Console'>)</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> EXTRA_STATE;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
        <b>{</b>
            uInt header <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Z_DEFLATED <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_bits<font color='#5555FF'>-</font><font color='#979000'>8</font><font face='Lucida Console'>)</font><font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font><font color='#979000'>4</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>8</font>;
            uInt level_flags;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> Z_HUFFMAN_ONLY <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>&lt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                level_flags <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
                level_flags <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>
                level_flags <font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>else</font>
                level_flags <font color='#5555FF'>=</font> <font color='#979000'>3</font>;
            header <font color='#5555FF'>|</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>level_flags <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>6</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> header <font color='#5555FF'>|</font><font color='#5555FF'>=</font> PRESET_DICT;
            header <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>31</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>header <font color='#5555FF'>%</font> <font color='#979000'>31</font><font face='Lucida Console'>)</font>;

            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> BUSY_STATE;
            <font color='#BB00BB'>putShortMSB</font><font face='Lucida Console'>(</font>s, header<font face='Lucida Console'>)</font>;

            <font color='#009900'>/* Save the adler32 of the preset dictionary: */</font>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>putShortMSB</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>putShortMSB</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <b>}</b>
            strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>adler32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>L, Z_NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>
<font color='#0000FF'>#ifdef</font> GZIP
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> EXTRA_STATE<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
            uInt beg <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;  <font color='#009900'>/* start of bytes to update crc */</font>

            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra_len <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>&gt;</font> beg<font face='Lucida Console'>)</font>
                        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> beg,
                                            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font> beg<font face='Lucida Console'>)</font>;
                    <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
                    beg <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font>
                        <font color='#0000FF'>break</font>;
                <b>}</b>
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex]<font face='Lucida Console'>)</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>&gt;</font> beg<font face='Lucida Console'>)</font>
                strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> beg,
                                    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font> beg<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>extra_len<font face='Lucida Console'>)</font> <b>{</b>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> NAME_STATE;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>else</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> NAME_STATE;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> NAME_STATE<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>name <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
            uInt beg <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;  <font color='#009900'>/* start of bytes to update crc */</font>
            <font color='#0000FF'><u>int</u></font> val;

            <font color='#0000FF'>do</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>&gt;</font> beg<font face='Lucida Console'>)</font>
                        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> beg,
                                            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font> beg<font face='Lucida Console'>)</font>;
                    <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
                    beg <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font> <b>{</b>
                        val <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                        <font color='#0000FF'>break</font>;
                    <b>}</b>
                <b>}</b>
                val <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>name[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex<font color='#5555FF'>+</font><font color='#5555FF'>+</font>];
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, val<font face='Lucida Console'>)</font>;
            <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>&gt;</font> beg<font face='Lucida Console'>)</font>
                strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> beg,
                                    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font> beg<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> COMMENT_STATE;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>else</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> COMMENT_STATE;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> COMMENT_STATE<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comment <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
            uInt beg <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;  <font color='#009900'>/* start of bytes to update crc */</font>
            <font color='#0000FF'><u>int</u></font> val;

            <font color='#0000FF'>do</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>&gt;</font> beg<font face='Lucida Console'>)</font>
                        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> beg,
                                            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font> beg<font face='Lucida Console'>)</font>;
                    <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
                    beg <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending;
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>=</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font> <b>{</b>
                        val <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                        <font color='#0000FF'>break</font>;
                    <b>}</b>
                <b>}</b>
                val <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>comment[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzindex<font color='#5555FF'>+</font><font color='#5555FF'>+</font>];
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, val<font face='Lucida Console'>)</font>;
            <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>&gt;</font> beg<font face='Lucida Console'>)</font>
                strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> beg,
                                    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>-</font> beg<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> HCRC_STATE;
        <b>}</b>
        <font color='#0000FF'>else</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> HCRC_STATE;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> HCRC_STATE<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>gzhead<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hcrc<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>+</font> <font color='#979000'>2</font> <font color='#5555FF'>&gt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font>
                <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>+</font> <font color='#979000'>2</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>L, Z_NULL, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> BUSY_STATE;
            <b>}</b>
        <b>}</b>
        <font color='#0000FF'>else</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> BUSY_STATE;
    <b>}</b>
<font color='#0000FF'>#endif</font>

    <font color='#009900'>/* Flush as much pending output as possible */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* Since avail_out is 0, deflate will be called again with
             * more output space, but possibly with both pending and
             * avail_in equal to zero. There won't be anything to do,
             * but this is not an error situation so make sure we
             * return OK instead of BUF_ERROR at next call of deflate:
             */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_flush <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>;
            <font color='#0000FF'>return</font> Z_OK;
        <b>}</b>

    <font color='#009900'>/* Make sure there is something to do and avoid duplicate consecutive
     * flushes. For repeated and useless calls with Z_FINISH, we keep
     * returning Z_STREAM_END instead of Z_BUF_ERROR.
     */</font>
    <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#BB00BB'>RANK</font><font face='Lucida Console'>(</font>flush<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>RANK</font><font face='Lucida Console'>(</font>old_flush<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
               flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>ERR_RETURN</font><font face='Lucida Console'>(</font>strm, Z_BUF_ERROR<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/* User must not provide more input after the first FINISH: */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> FINISH_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>ERR_RETURN</font><font face='Lucida Console'>(</font>strm, Z_BUF_ERROR<font face='Lucida Console'>)</font>;
    <b>}</b>

    <font color='#009900'>/* Start a new block or continue the current one.
     */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        <font face='Lucida Console'>(</font>flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NO_FLUSH <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> FINISH_STATE<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
        block_state bstate;

        bstate <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_HUFFMAN_ONLY ? <font color='#BB00BB'>deflate_huff</font><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font> :
                    <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_RLE ? <font color='#BB00BB'>deflate_rle</font><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font> :
                        <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>configuration_table[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level].func<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bstate <font color='#5555FF'>=</font><font color='#5555FF'>=</font> finish_started <font color='#5555FF'>|</font><font color='#5555FF'>|</font> bstate <font color='#5555FF'>=</font><font color='#5555FF'>=</font> finish_done<font face='Lucida Console'>)</font> <b>{</b>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status <font color='#5555FF'>=</font> FINISH_STATE;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bstate <font color='#5555FF'>=</font><font color='#5555FF'>=</font> need_more <font color='#5555FF'>|</font><font color='#5555FF'>|</font> bstate <font color='#5555FF'>=</font><font color='#5555FF'>=</font> finish_started<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_flush <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>; <font color='#009900'>/* avoid BUF_ERROR next call, see above */</font>
            <b>}</b>
            <font color='#0000FF'>return</font> Z_OK;
            <font color='#009900'>/* If flush != Z_NO_FLUSH &amp;&amp; avail_out == 0, the next call
             * of deflate should use the same flush parameter to make sure
             * that the flush is complete. So we don't have to output an
             * empty block here, this will be done at next call. This also
             * ensures that for a very small output buffer, we emit at most
             * one empty block.
             */</font>
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bstate <font color='#5555FF'>=</font><font color='#5555FF'>=</font> block_done<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_PARTIAL_FLUSH<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>_tr_align</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_BLOCK<font face='Lucida Console'>)</font> <b>{</b> <font color='#009900'>/* FULL_FLUSH or SYNC_FLUSH */</font>
                <font color='#BB00BB'>_tr_stored_block</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font><font color='#0000FF'><u>char</u></font><font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font color='#979000'>0</font>, <font color='#979000'>0</font>L, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                <font color='#009900'>/* For a full flush, this empty block will be recognized
                 * as a special marker by inflate_sync().
                 */</font>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FULL_FLUSH<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#BB00BB'>CLEAR_HASH</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;             <font color='#009900'>/* forget history */</font>
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
                        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>=</font> <font color='#979000'>0</font>L;
                        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                    <b>}</b>
                <b>}</b>
            <b>}</b>
            <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
              s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_flush <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font color='#979000'>1</font>; <font color='#009900'>/* avoid BUF_ERROR at next call, see above */</font>
              <font color='#0000FF'>return</font> Z_OK;
            <b>}</b>
        <b>}</b>
    <b>}</b>
    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>, "<font color='#CC0000'>bug2</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_OK;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_END;

    <font color='#009900'>/* Write the trailer */</font>
<font color='#0000FF'>#ifdef</font> GZIP
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>8</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>put_byte</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>24</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font> <font color='#979000'>0xff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
    <b>{</b>
        <font color='#BB00BB'>putShortMSB</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> <font color='#979000'>16</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>putShortMSB</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>&amp;</font> <font color='#979000'>0xffff</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>;
    <font color='#009900'>/* If avail_out is zero, the application will call deflate again
     * to flush the rest.
     */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap; <font color='#009900'>/* write the trailer only once! */</font>
    <font color='#0000FF'>return</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> ? Z_OK : Z_STREAM_END;
<b>}</b>

<font color='#009900'>/* ========================================================================= */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateEnd'></a>deflateEnd</b> <font face='Lucida Console'>(</font>strm<font face='Lucida Console'>)</font>
    z_streamp strm;
<b>{</b>
    <font color='#0000FF'><u>int</u></font> status;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_STREAM_ERROR;

    status <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>status;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> INIT_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> EXTRA_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NAME_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> COMMENT_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> HCRC_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> BUSY_STATE <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
        status <font color='#5555FF'>!</font><font color='#5555FF'>=</font> FINISH_STATE<font face='Lucida Console'>)</font> <b>{</b>
      <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <b>}</b>

    <font color='#009900'>/* Deallocate in reverse order of allocations: */</font>
    <font color='#BB00BB'>TRY_FREE</font><font face='Lucida Console'>(</font>strm, strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf<font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>TRY_FREE</font><font face='Lucida Console'>(</font>strm, strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head<font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>TRY_FREE</font><font face='Lucida Console'>(</font>strm, strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev<font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>TRY_FREE</font><font face='Lucida Console'>(</font>strm, strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window<font face='Lucida Console'>)</font>;

    <font color='#BB00BB'>ZFREE</font><font face='Lucida Console'>(</font>strm, strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font face='Lucida Console'>)</font>;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font> Z_NULL;

    <font color='#0000FF'>return</font> status <font color='#5555FF'>=</font><font color='#5555FF'>=</font> BUSY_STATE ? Z_DATA_ERROR : Z_OK;
<b>}</b>

<font color='#009900'>/* =========================================================================
 * Copy the source state to the destination state.
 * To simplify the source, this is not supported for 16-bit MSDOS (which
 * doesn't have enough memory anyway to duplicate compression states).
 */</font>
<font color='#0000FF'><u>int</u></font> ZEXPORT <b><a name='deflateCopy'></a>deflateCopy</b> <font face='Lucida Console'>(</font>dest, source<font face='Lucida Console'>)</font>
    z_streamp dest;
    z_streamp source;
<b>{</b>
<font color='#0000FF'>#ifdef</font> MAXSEG_64K
    <font color='#0000FF'>return</font> Z_STREAM_ERROR;
<font color='#0000FF'>#else</font>
    deflate_state <font color='#5555FF'>*</font>ds;
    deflate_state <font color='#5555FF'>*</font>ss;
    ushf <font color='#5555FF'>*</font>overlay;


    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>source <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> dest <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#0000FF'>return</font> Z_STREAM_ERROR;
    <b>}</b>

    ss <font color='#5555FF'>=</font> source<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state;

    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>dest, <font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>source, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>z_stream<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

    ds <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>deflate_state <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>dest, <font color='#979000'>1</font>, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>deflate_state<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ds <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> Z_MEM_ERROR;
    dest<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'>struct</font> internal_state FAR <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> ds;
    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>ds, <font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>ss, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>deflate_state<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm <font color='#5555FF'>=</font> dest;

    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Bytef <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>dest, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size, <font color='#979000'>2</font><font color='#5555FF'>*</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Posf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>  <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>dest, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head   <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Posf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>  <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>dest, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    overlay <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ushf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> <font color='#BB00BB'>ZALLOC</font><font face='Lucida Console'>(</font>dest, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize, <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font><font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uchf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font> overlay;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
        ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NULL<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>deflateEnd</font> <font face='Lucida Console'>(</font>dest<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> Z_MEM_ERROR;
    <b>}</b>
    <font color='#009900'>/* following zmemcpy do not work for 16-bit MSDOS */</font>
    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window, ss<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size <font color='#5555FF'>*</font> <font color='#979000'>2</font> <font color='#5555FF'>*</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Byte<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev, <font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>ss<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size <font color='#5555FF'>*</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head, <font face='Lucida Console'>(</font>voidpf<font face='Lucida Console'>)</font>ss<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head, ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size <font color='#5555FF'>*</font> <font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf, ss<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf, <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size<font face='Lucida Console'>)</font>;

    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out <font color='#5555FF'>=</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>ss<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_out <font color='#5555FF'>-</font> ss<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf<font face='Lucida Console'>)</font>;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>d_buf <font color='#5555FF'>=</font> overlay <font color='#5555FF'>+</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize<font color='#5555FF'>/</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font>;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>l_buf <font color='#5555FF'>=</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font><font color='#5555FF'>+</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font>ush<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>*</font>ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lit_bufsize;

    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>l_desc.dyn_tree <font color='#5555FF'>=</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>dyn_ltree;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>d_desc.dyn_tree <font color='#5555FF'>=</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>dyn_dtree;
    ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bl_desc.dyn_tree <font color='#5555FF'>=</font> ds<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>bl_tree;

    <font color='#0000FF'>return</font> Z_OK;
<font color='#0000FF'>#endif</font> <font color='#009900'>/* MAXSEG_64K */</font>
<b>}</b>

<font color='#009900'>/* ===========================================================================
 * Read a new buffer from the current input stream, update the adler32
 * and total number of bytes read.  All deflate() input goes through
 * this function so some applications may wish to modify it to avoid
 * allocating a large strm-&gt;next_in buffer and copying from it.
 * (See also flush_pending()).
 */</font>
local <font color='#0000FF'><u>int</u></font> <b><a name='read_buf'></a>read_buf</b><font face='Lucida Console'>(</font>strm, buf, size<font face='Lucida Console'>)</font>
    z_streamp strm;
    Bytef <font color='#5555FF'>*</font>buf;
    <font color='#0000FF'><u>unsigned</u></font> size;
<b>{</b>
    <font color='#0000FF'><u>unsigned</u></font> len <font color='#5555FF'>=</font> strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>&gt;</font> size<font face='Lucida Console'>)</font> len <font color='#5555FF'>=</font> size;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font color='#979000'>0</font>;

    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in  <font color='#5555FF'>-</font><font color='#5555FF'>=</font> len;

    <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font>buf, strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_in, len<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>adler32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, buf, len<font face='Lucida Console'>)</font>;
    <b>}</b>
<font color='#0000FF'>#ifdef</font> GZIP
    <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>state<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>wrap <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <b>{</b>
        strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler <font color='#5555FF'>=</font> <font color='#BB00BB'>crc32</font><font face='Lucida Console'>(</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>adler, buf, len<font face='Lucida Console'>)</font>;
    <b>}</b>
<font color='#0000FF'>#endif</font>
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>next_in  <font color='#5555FF'>+</font><font color='#5555FF'>=</font> len;
    strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>total_in <font color='#5555FF'>+</font><font color='#5555FF'>=</font> len;

    <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font>len;
<b>}</b>

<font color='#009900'>/* ===========================================================================
 * Initialize the "longest match" routines for a new zlib stream
 */</font>
local <font color='#0000FF'><u>void</u></font> <b><a name='lm_init'></a>lm_init</b> <font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
<b>{</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font><font color='#979000'>2</font>L<font color='#5555FF'>*</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size;

    <font color='#BB00BB'>CLEAR_HASH</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;

    <font color='#009900'>/* Set the default configuration parameters:
     */</font>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_lazy_match   <font color='#5555FF'>=</font> configuration_table[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level].max_lazy;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>good_match       <font color='#5555FF'>=</font> configuration_table[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level].good_length;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nice_match       <font color='#5555FF'>=</font> configuration_table[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level].nice_length;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_chain_length <font color='#5555FF'>=</font> configuration_table[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>level].max_chain;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>=</font> <font color='#979000'>0</font>L;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>=</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
<font color='#0000FF'>#ifndef</font> FASTEST
<font color='#0000FF'>#ifdef</font> ASMV
    <font color='#BB00BB'>match_init</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#009900'>/* initialize the asm code */</font>
<font color='#0000FF'>#endif</font>
<font color='#0000FF'>#endif</font>
<b>}</b>

<font color='#0000FF'>#ifndef</font> FASTEST
<font color='#009900'>/* ===========================================================================
 * Set match_start to the longest match starting at the given string and
 * return its length. Matches shorter or equal to prev_length are discarded,
 * in which case the result is equal to prev_length and match_start is
 * garbage.
 * IN assertions: cur_match is the head of the hash chain for the current
 *   string (strstart) and its distance is &lt;= MAX_DIST, and prev_length &gt;= 1
 * OUT assertion: the match length is not greater than s-&gt;lookahead.
 */</font>
<font color='#0000FF'>#ifndef</font> ASMV
<font color='#009900'>/* For 80x86 and 680x0, an optimized version will be provided in match.asm or
 * match.S. The code will be functionally equivalent.
 */</font>
local uInt <b><a name='longest_match'></a>longest_match</b><font face='Lucida Console'>(</font>s, cur_match<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    IPos cur_match;                             <font color='#009900'>/* current match */</font>
<b>{</b>
    <font color='#0000FF'><u>unsigned</u></font> chain_length <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_chain_length;<font color='#009900'>/* max hash chain length */</font>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>scan <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart; <font color='#009900'>/* current string */</font>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>match;                       <font color='#009900'>/* matched string */</font>
    <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> len;                           <font color='#009900'>/* length of current match */</font>
    <font color='#0000FF'><u>int</u></font> best_len <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length;              <font color='#009900'>/* best match length so far */</font>
    <font color='#0000FF'><u>int</u></font> nice_match <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>nice_match;             <font color='#009900'>/* stop if match long enough */</font>
    IPos limit <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&gt;</font> <font face='Lucida Console'>(</font>IPos<font face='Lucida Console'>)</font><font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font> ?
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>IPos<font face='Lucida Console'>)</font><font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font> : NIL;
    <font color='#009900'>/* Stop when cur_match becomes &lt;= limit. To simplify the code,
     * we prevent matches with the string of window index 0.
     */</font>
    Posf <font color='#5555FF'>*</font>prev <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev;
    uInt wmask <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_mask;

<font color='#0000FF'>#ifdef</font> UNALIGNED_OK
    <font color='#009900'>/* Compare two bytes at a time. Note: this is not always beneficial.
     * Try with and without -DUNALIGNED_OK to check.
     */</font>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>strend <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> MAX_MATCH <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
    <font color='#0000FF'>register</font> ush scan_start <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font>scan;
    <font color='#0000FF'>register</font> ush scan_end   <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>scan<font color='#5555FF'>+</font>best_len<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>strend <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> MAX_MATCH;
    <font color='#0000FF'>register</font> Byte scan_end1  <font color='#5555FF'>=</font> scan[best_len<font color='#5555FF'>-</font><font color='#979000'>1</font>];
    <font color='#0000FF'>register</font> Byte scan_end   <font color='#5555FF'>=</font> scan[best_len];
<font color='#0000FF'>#endif</font>

    <font color='#009900'>/* The code is optimized for HASH_BITS &gt;= 8 and MAX_MATCH-2 multiple of 16.
     * It is easy to get rid of this optimization if necessary.
     */</font>
    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_bits <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> MAX_MATCH <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>258</font>, "<font color='#CC0000'>Code too clever</font>"<font face='Lucida Console'>)</font>;

    <font color='#009900'>/* Do not waste too much time if we already have a good match: */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>good_match<font face='Lucida Console'>)</font> <b>{</b>
        chain_length <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
    <b>}</b>
    <font color='#009900'>/* Do not look for matches beyond the end of the input. This is necessary
     * to make deflate deterministic.
     */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>nice_match <font color='#5555FF'>&gt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font face='Lucida Console'>)</font> nice_match <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;

    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font color='#5555FF'>-</font>MIN_LOOKAHEAD, "<font color='#CC0000'>need lookahead</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>do</font> <b>{</b>
        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>cur_match <font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, "<font color='#CC0000'>no future</font>"<font face='Lucida Console'>)</font>;
        match <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> cur_match;

        <font color='#009900'>/* Skip to next match if the match length cannot increase
         * or if the match length is less than 2.  Note that the checks below
         * for insufficient lookahead only occur occasionally for performance
         * reasons.  Therefore uninitialized memory will be accessed, and
         * conditional jumps will be made that depend on those values.
         * However the length of the match is limited to the lookahead, so
         * the output of deflate is not affected by the uninitialized values.
         */</font>
<font color='#0000FF'>#if</font> <font face='Lucida Console'>(</font>defined<font face='Lucida Console'>(</font>UNALIGNED_OK<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> MAX_MATCH <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>258</font><font face='Lucida Console'>)</font>
        <font color='#009900'>/* This code assumes sizeof(unsigned short) == 2. Do not use
         * UNALIGNED_OK if your compiler uses a different size.
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>match<font color='#5555FF'>+</font>best_len<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan_end <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font>match <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan_start<font face='Lucida Console'>)</font> <font color='#0000FF'>continue</font>;

        <font color='#009900'>/* It is not necessary to compare scan[2] and match[2] since they are
         * always equal when the other bytes match, given that the hash keys
         * are equal and that HASH_BITS &gt;= 8. Compare 2 bytes at a time at
         * strstart+3, +5, ... up to strstart+257. We check for insufficient
         * lookahead only every 4th comparison; the 128th check will be made
         * at strstart+257. If MAX_MATCH-2 is not a multiple of 8, it is
         * necessary to put more guard bytes at the end of the window, or
         * to check more often for insufficient lookahead.
         */</font>
        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>scan[<font color='#979000'>2</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> match[<font color='#979000'>2</font>], "<font color='#CC0000'>scan[2]?</font>"<font face='Lucida Console'>)</font>;
        scan<font color='#5555FF'>+</font><font color='#5555FF'>+</font>, match<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font color='#0000FF'>do</font> <b>{</b>
        <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>scan<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>match<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>scan<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>match<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>scan<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>match<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>scan<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>match<font color='#5555FF'>+</font><font color='#5555FF'>=</font><font color='#979000'>2</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 scan <font color='#5555FF'>&lt;</font> strend<font face='Lucida Console'>)</font>;
        <font color='#009900'>/* The funny "do {}" generates better code on most compilers */</font>

        <font color='#009900'>/* Here, scan &lt;= window+strstart+257 */</font>
        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>scan <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window<font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>wild scan</font>"<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>match<font face='Lucida Console'>)</font> scan<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

        len <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>MAX_MATCH <font color='#5555FF'>-</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strend<font color='#5555FF'>-</font>scan<font face='Lucida Console'>)</font>;
        scan <font color='#5555FF'>=</font> strend <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>MAX_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;

<font color='#0000FF'>#else</font> <font color='#009900'>/* UNALIGNED_OK */</font>

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>match[best_len]   <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan_end  <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            match[best_len<font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan_end1 <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font color='#5555FF'>*</font>match            <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>scan     <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
            <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match          <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan[<font color='#979000'>1</font>]<font face='Lucida Console'>)</font>      <font color='#0000FF'>continue</font>;

        <font color='#009900'>/* The check at best_len-1 can be removed because it will be made
         * again later. (This heuristic is not always a win.)
         * It is not necessary to compare scan[2] and match[2] since they
         * are always equal when the other bytes match, given that
         * the hash keys are equal and that HASH_BITS &gt;= 8.
         */</font>
        scan <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>, match<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>match, "<font color='#CC0000'>match[2]?</font>"<font face='Lucida Console'>)</font>;

        <font color='#009900'>/* We check for insufficient lookahead only every 8th comparison;
         * the 256th check will be made at strstart+258.
         */</font>
        <font color='#0000FF'>do</font> <b>{</b>
        <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                 scan <font color='#5555FF'>&lt;</font> strend<font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>scan <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window<font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>wild scan</font>"<font face='Lucida Console'>)</font>;

        len <font color='#5555FF'>=</font> MAX_MATCH <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strend <font color='#5555FF'>-</font> scan<font face='Lucida Console'>)</font>;
        scan <font color='#5555FF'>=</font> strend <font color='#5555FF'>-</font> MAX_MATCH;

<font color='#0000FF'>#endif</font> <font color='#009900'>/* UNALIGNED_OK */</font>

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>&gt;</font> best_len<font face='Lucida Console'>)</font> <b>{</b>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start <font color='#5555FF'>=</font> cur_match;
            best_len <font color='#5555FF'>=</font> len;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> nice_match<font face='Lucida Console'>)</font> <font color='#0000FF'>break</font>;
<font color='#0000FF'>#ifdef</font> UNALIGNED_OK
            scan_end <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font face='Lucida Console'>(</font>ushf<font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>scan<font color='#5555FF'>+</font>best_len<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
<font color='#0000FF'>#else</font>
            scan_end1  <font color='#5555FF'>=</font> scan[best_len<font color='#5555FF'>-</font><font color='#979000'>1</font>];
            scan_end   <font color='#5555FF'>=</font> scan[best_len];
<font color='#0000FF'>#endif</font>
        <b>}</b>
    <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>cur_match <font color='#5555FF'>=</font> prev[cur_match <font color='#5555FF'>&amp;</font> wmask]<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> limit
             <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>-</font><font color='#5555FF'>-</font>chain_length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>best_len <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>best_len;
    <font color='#0000FF'>return</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* ASMV */</font>

<font color='#0000FF'>#else</font> <font color='#009900'>/* FASTEST */</font>

<font color='#009900'>/* ---------------------------------------------------------------------------
 * Optimized version for FASTEST only
 */</font>
local uInt <b><a name='longest_match'></a>longest_match</b><font face='Lucida Console'>(</font>s, cur_match<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    IPos cur_match;                             <font color='#009900'>/* current match */</font>
<b>{</b>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>scan <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart; <font color='#009900'>/* current string */</font>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>match;                       <font color='#009900'>/* matched string */</font>
    <font color='#0000FF'>register</font> <font color='#0000FF'><u>int</u></font> len;                           <font color='#009900'>/* length of current match */</font>
    <font color='#0000FF'>register</font> Bytef <font color='#5555FF'>*</font>strend <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> MAX_MATCH;

    <font color='#009900'>/* The code is optimized for HASH_BITS &gt;= 8 and MAX_MATCH-2 multiple of 16.
     * It is easy to get rid of this optimization if necessary.
     */</font>
    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_bits <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>8</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> MAX_MATCH <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>258</font>, "<font color='#CC0000'>Code too clever</font>"<font face='Lucida Console'>)</font>;

    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font color='#5555FF'>-</font>MIN_LOOKAHEAD, "<font color='#CC0000'>need lookahead</font>"<font face='Lucida Console'>)</font>;

    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>cur_match <font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, "<font color='#CC0000'>no future</font>"<font face='Lucida Console'>)</font>;

    match <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> cur_match;

    <font color='#009900'>/* Return failure if the match length is less than 2:
     */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>match[<font color='#979000'>0</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan[<font color='#979000'>0</font>] <font color='#5555FF'>|</font><font color='#5555FF'>|</font> match[<font color='#979000'>1</font>] <font color='#5555FF'>!</font><font color='#5555FF'>=</font> scan[<font color='#979000'>1</font>]<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;

    <font color='#009900'>/* The check at best_len-1 can be removed because it will be made
     * again later. (This heuristic is not always a win.)
     * It is not necessary to compare scan[2] and match[2] since they
     * are always equal when the other bytes match, given that
     * the hash keys are equal and that HASH_BITS &gt;= 8.
     */</font>
    scan <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>, match <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font><font color='#5555FF'>*</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font>match, "<font color='#CC0000'>match[2]?</font>"<font face='Lucida Console'>)</font>;

    <font color='#009900'>/* We check for insufficient lookahead only every 8th comparison;
     * the 256th check will be made at strstart+258.
     */</font>
    <font color='#0000FF'>do</font> <b>{</b>
    <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
             scan <font color='#5555FF'>&lt;</font> strend<font face='Lucida Console'>)</font>;

    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>scan <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window<font color='#5555FF'>+</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>wild scan</font>"<font face='Lucida Console'>)</font>;

    len <font color='#5555FF'>=</font> MAX_MATCH <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strend <font color='#5555FF'>-</font> scan<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>len <font color='#5555FF'>&lt;</font> MIN_MATCH<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> MIN_MATCH <font color='#5555FF'>-</font> <font color='#979000'>1</font>;

    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start <font color='#5555FF'>=</font> cur_match;
    <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>len <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead ? <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>len : s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>/* FASTEST */</font>

<font color='#0000FF'>#ifdef</font> DEBUG
<font color='#009900'>/* ===========================================================================
 * Check that the match at match_start is indeed a match.
 */</font>
local <font color='#0000FF'><u>void</u></font> <b><a name='check_match'></a>check_match</b><font face='Lucida Console'>(</font>s, start, match, length<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    IPos start, match;
    <font color='#0000FF'><u>int</u></font> length;
<b>{</b>
    <font color='#009900'>/* check that the match is indeed a match */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>zmemcmp</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> match,
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> start, length<font face='Lucida Console'>)</font> <font color='#5555FF'>!</font><font color='#5555FF'>=</font> EQUAL<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>fprintf</font><font face='Lucida Console'>(</font>stderr, "<font color='#CC0000'> start %u, match %u, length %d\n</font>",
                start, match, length<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>do</font> <b>{</b>
            <font color='#BB00BB'>fprintf</font><font face='Lucida Console'>(</font>stderr, "<font color='#CC0000'>%c%c</font>", s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[match<font color='#5555FF'>+</font><font color='#5555FF'>+</font>], s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>]<font face='Lucida Console'>)</font>;
        <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>z_error</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>invalid match</font>"<font face='Lucida Console'>)</font>;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>z_verbose <font color='#5555FF'>&gt;</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>fprintf</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>\\[%d,%d]</font>", start<font color='#5555FF'>-</font>match, length<font face='Lucida Console'>)</font>;
        <font color='#0000FF'>do</font> <b>{</b> <font color='#BB00BB'>putc</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[start<font color='#5555FF'>+</font><font color='#5555FF'>+</font>], stderr<font face='Lucida Console'>)</font>; <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <b>}</b>
<b>}</b>
<font color='#0000FF'>#else</font>
#  define <b><a name='check_match'></a>check_match</b><font face='Lucida Console'>(</font>s, start, match, length<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* DEBUG */</font>

<font color='#009900'>/* ===========================================================================
 * Fill the window when the lookahead becomes insufficient.
 * Updates strstart and lookahead.
 *
 * IN assertion: lookahead &lt; MIN_LOOKAHEAD
 * OUT assertions: strstart &lt;= window_size-MIN_LOOKAHEAD
 *    At least one byte has been read, or avail_in == 0; reads are
 *    performed for at least two bytes (required for the zip translate_eol
 *    option -- not supported here).
 */</font>
local <font color='#0000FF'><u>void</u></font> <b><a name='fill_window'></a>fill_window</b><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
<b>{</b>
    <font color='#0000FF'>register</font> <font color='#0000FF'><u>unsigned</u></font> n, m;
    <font color='#0000FF'>register</font> Posf <font color='#5555FF'>*</font>p;
    <font color='#0000FF'><u>unsigned</u></font> more;    <font color='#009900'>/* Amount of free space at the end of the window. */</font>
    uInt wsize <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size;

    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font> MIN_LOOKAHEAD, "<font color='#CC0000'>already enough lookahead</font>"<font face='Lucida Console'>)</font>;

    <font color='#0000FF'>do</font> <b>{</b>
        more <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font face='Lucida Console'>)</font>;

        <font color='#009900'>/* Deal with !@#$% 64K limit: */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#0000FF'>sizeof</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>more <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
                more <font color='#5555FF'>=</font> wsize;

            <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>more <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#009900'>/* Very unlikely, but possible on 16 bit machine if
                 * strstart == 0 &amp;&amp; lookahead == 1 (input done a byte at time)
                 */</font>
                more<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <b>}</b>
        <b>}</b>

        <font color='#009900'>/* If the window is almost full and there is insufficient lookahead,
         * move the upper half to the lower one to make room in the upper half.
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> wsize<font color='#5555FF'>+</font><font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>

            <font color='#BB00BB'>zmemcpy</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window<font color='#5555FF'>+</font>wsize, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>wsize<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start <font color='#5555FF'>-</font><font color='#5555FF'>=</font> wsize;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart    <font color='#5555FF'>-</font><font color='#5555FF'>=</font> wsize; <font color='#009900'>/* we now have strstart &gt;= MAX_DIST */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font> wsize;

            <font color='#009900'>/* Slide the hash table (could be avoided with 32 bit values
               at the expense of memory usage). We slide even when level == 0
               to keep the hash table consistent if we switch back to level &gt; 0
               later. (Using level 0 permanently is not an optimal usage of
               zlib, so we don't care about this pathological case.)
             */</font>
            n <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>hash_size;
            p <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[n];
            <font color='#0000FF'>do</font> <b>{</b>
                m <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>p;
                <font color='#5555FF'>*</font>p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>m <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> wsize ? m<font color='#5555FF'>-</font>wsize : NIL<font face='Lucida Console'>)</font>;
            <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>n<font face='Lucida Console'>)</font>;

            n <font color='#5555FF'>=</font> wsize;
<font color='#0000FF'>#ifndef</font> FASTEST
            p <font color='#5555FF'>=</font> <font color='#5555FF'>&amp;</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev[n];
            <font color='#0000FF'>do</font> <b>{</b>
                m <font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>p;
                <font color='#5555FF'>*</font>p <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>m <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> wsize ? m<font color='#5555FF'>-</font>wsize : NIL<font face='Lucida Console'>)</font>;
                <font color='#009900'>/* If n is not on any hash chain, prev[n] is garbage but
                 * its value will never be used.
                 */</font>
            <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>n<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#endif</font>
            more <font color='#5555FF'>+</font><font color='#5555FF'>=</font> wsize;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>break</font>;

        <font color='#009900'>/* If there was no sliding:
         *    strstart &lt;= WSIZE+MAX_DIST-1 &amp;&amp; lookahead &lt;= MIN_LOOKAHEAD - 1 &amp;&amp;
         *    more == window_size - lookahead - strstart
         * =&gt; more &gt;= window_size - (MIN_LOOKAHEAD-1 + WSIZE + MAX_DIST-1)
         * =&gt; more &gt;= window_size - 2*WSIZE + 2
         * In the BIG_MEM or MMAP case (not yet supported),
         *   window_size == input_size + MIN_LOOKAHEAD  &amp;&amp;
         *   strstart + s-&gt;lookahead &lt;= input_size =&gt; more &gt;= MIN_LOOKAHEAD.
         * Otherwise, window_size == 2*WSIZE so more &gt;= 2.
         * If there was sliding, more &gt;= WSIZE. So in all cases, more &gt;= 2.
         */</font>
        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>more <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>, "<font color='#CC0000'>more &lt; 2</font>"<font face='Lucida Console'>)</font>;

        n <font color='#5555FF'>=</font> <font color='#BB00BB'>read_buf</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead, more<font face='Lucida Console'>)</font>;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>+</font><font color='#5555FF'>=</font> n;

        <font color='#009900'>/* Initialize the hash value now that we have some input: */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
            uInt str <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[str];
            <font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[str <font color='#5555FF'>+</font> <font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#if</font> MIN_MATCH <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>
            Call <font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>3</font> more times
<font color='#0000FF'>#endif</font>
            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[str <font color='#5555FF'>+</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#ifndef</font> FASTEST
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev[str <font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_mask] <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h];
<font color='#0000FF'>#endif</font>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>head[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h] <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>Pos<font face='Lucida Console'>)</font>str;
                str<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>&lt;</font> MIN_MATCH<font face='Lucida Console'>)</font>
                    <font color='#0000FF'>break</font>;
            <b>}</b>
        <b>}</b>
        <font color='#009900'>/* If the whole input has less than MIN_MATCH bytes, ins_h is garbage,
         * but this is not important since only literal bytes will be emitted.
         */</font>

    <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font> MIN_LOOKAHEAD <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_in <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

    <font color='#009900'>/* If the WIN_INIT bytes after the end of the current data have never been
     * written, then zero those bytes in order to avoid memory check reports of
     * the use of uninitialized (or uninitialised as Julian writes) bytes by
     * the longest match routines.  Update the high water mark for the next
     * time through here.  WIN_INIT is set to MAX_MATCH since the longest match
     * routines allow scanning to strstart + MAX_MATCH, ignoring lookahead.
     */</font>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water <font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font face='Lucida Console'>)</font> <b>{</b>
        ulg curr <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font face='Lucida Console'>)</font>;
        ulg init;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water <font color='#5555FF'>&lt;</font> curr<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* Previous high water mark below current data -- zero WIN_INIT
             * bytes or up to end of window, whichever is less.
             */</font>
            init <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size <font color='#5555FF'>-</font> curr;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>init <font color='#5555FF'>&gt;</font> WIN_INIT<font face='Lucida Console'>)</font>
                init <font color='#5555FF'>=</font> WIN_INIT;
            <font color='#BB00BB'>zmemzero</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> curr, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>init<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water <font color='#5555FF'>=</font> curr <font color='#5555FF'>+</font> init;
        <b>}</b>
        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water <font color='#5555FF'>&lt;</font> <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>curr <font color='#5555FF'>+</font> WIN_INIT<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* High water mark at or above current data, but below current data
             * plus WIN_INIT -- zero out to current data plus WIN_INIT, or up
             * to end of window, whichever is less.
             */</font>
            init <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>curr <font color='#5555FF'>+</font> WIN_INIT <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>init <font color='#5555FF'>&gt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water<font face='Lucida Console'>)</font>
                init <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water;
            <font color='#BB00BB'>zmemzero</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water, <font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>init<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>high_water <font color='#5555FF'>+</font><font color='#5555FF'>=</font> init;
        <b>}</b>
    <b>}</b>

    <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size <font color='#5555FF'>-</font> MIN_LOOKAHEAD,
           "<font color='#CC0000'>not enough room for search</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#009900'>/* ===========================================================================
 * Flush the current block, with given end-of-file flag.
 * IN assertion: strstart is set to the end of the current match.
 */</font>
<font color='#0000FF'>#define</font> FLUSH_BLOCK_ONLY<font face='Lucida Console'>(</font>s, last<font face='Lucida Console'>)</font> <b>{</b> \
   <font color='#BB00BB'>_tr_flush_block</font><font face='Lucida Console'>(</font>s, <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>L ? \
                   <font face='Lucida Console'>(</font>charf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font><font color='#5555FF'>&amp;</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[<font face='Lucida Console'>(</font><font color='#0000FF'><u>unsigned</u></font><font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start] : \
                   <font face='Lucida Console'>(</font>charf <font color='#5555FF'>*</font><font face='Lucida Console'>)</font>Z_NULL<font face='Lucida Console'>)</font>, \
                <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start<font face='Lucida Console'>)</font>, \
                <font face='Lucida Console'>(</font>last<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; \
   s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart; \
   <font color='#BB00BB'>flush_pending</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm<font face='Lucida Console'>)</font>; \
   <font color='#BB00BB'>Tracev</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>[FLUSH]</font>"<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>; \
<b>}</b>

<font color='#009900'>/* Same but force premature exit if necessary. */</font>
<font color='#0000FF'>#define</font> FLUSH_BLOCK<font face='Lucida Console'>(</font>s, last<font face='Lucida Console'>)</font> <b>{</b> \
   <font color='#BB00BB'>FLUSH_BLOCK_ONLY</font><font face='Lucida Console'>(</font>s, last<font face='Lucida Console'>)</font>; \
   <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font>last<font face='Lucida Console'>)</font> ? finish_started : need_more; \
<b>}</b>

<font color='#009900'>/* ===========================================================================
 * Copy without compression as much as possible from the input stream, return
 * the current block state.
 * This function does not insert new strings in the dictionary since
 * uncompressible data is probably not useful. This function is used
 * only for the level=0 compression option.
 * NOTE: this function should be optimized to avoid extra copying from
 * window to pending_buf.
 */</font>
local block_state <b><a name='deflate_stored'></a>deflate_stored</b><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> flush;
<b>{</b>
    <font color='#009900'>/* Stored blocks are limited to 0xffff bytes, pending_buf is limited
     * to pending_buf_size, and each stored block has a 5 byte header:
     */</font>
    ulg max_block_size <font color='#5555FF'>=</font> <font color='#979000'>0xffff</font>;
    ulg max_start;

    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>max_block_size <font color='#5555FF'>&gt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size <font color='#5555FF'>-</font> <font color='#979000'>5</font><font face='Lucida Console'>)</font> <b>{</b>
        max_block_size <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>pending_buf_size <font color='#5555FF'>-</font> <font color='#979000'>5</font>;
    <b>}</b>

    <font color='#009900'>/* Copy as much as possible from input to output: */</font>
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>/* Fill the window as much as possible: */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>1</font><font face='Lucida Console'>)</font> <b>{</b>

            <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size<font color='#5555FF'>+</font><font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font>
                   s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>w_size, "<font color='#CC0000'>slide too late</font>"<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NO_FLUSH<font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> need_more;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>break</font>; <font color='#009900'>/* flush the current block */</font>
        <b>}</b>
        <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font>L, "<font color='#CC0000'>block gone</font>"<font face='Lucida Console'>)</font>;

        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#009900'>/* Emit a stored block if pending_buf will be full: */</font>
        max_start <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>+</font> max_block_size;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>ulg<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> max_start<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* strstart == 0 is possible when wraparound on 16-bit machine */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> max_start<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>max_start;
            <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <b>}</b>
        <font color='#009900'>/* Flush if we may have to slide, otherwise block_start may become
         * negative and the data will be gone:
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <b>}</b>
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> finish_done;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font><font face='Lucida Console'>)</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&gt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>block_start<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> block_done;
<b>}</b>

<font color='#009900'>/* ===========================================================================
 * Compress as much as possible from the input stream, return the current
 * block state.
 * This function does not perform lazy evaluation of matches and inserts
 * new strings in the dictionary only for unmatched strings or for short
 * matches. It is used only for the fast compression options.
 */</font>
local block_state <b><a name='deflate_fast'></a>deflate_fast</b><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> flush;
<b>{</b>
    IPos hash_head;       <font color='#009900'>/* head of the hash chain */</font>
    <font color='#0000FF'><u>int</u></font> bflush;           <font color='#009900'>/* set if current block must be flushed */</font>

    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>/* Make sure that we always have enough lookahead, except
         * at the end of the input file. We need MAX_MATCH bytes
         * for the next match, plus MIN_MATCH bytes to insert the
         * string following the next match.
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font> MIN_LOOKAHEAD<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font> MIN_LOOKAHEAD <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NO_FLUSH<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>return</font> need_more;
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>break</font>; <font color='#009900'>/* flush the current block */</font>
        <b>}</b>

        <font color='#009900'>/* Insert the string window[strstart .. strstart+2] in the
         * dictionary, and set hash_head to the head of the hash chain:
         */</font>
        hash_head <font color='#5555FF'>=</font> NIL;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>INSERT_STRING</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, hash_head<font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#009900'>/* Find the longest match, discarding those &lt;= prev_length.
         * At this point we have always match_length &lt; MIN_MATCH
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>hash_head <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NIL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> hash_head <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* To simplify the code, we prevent matches with the string
             * of window index 0 (in particular we have to avoid a match
             * of the string with itself at the start of the input file).
             */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> <font color='#BB00BB'>longest_match</font> <font face='Lucida Console'>(</font>s, hash_head<font face='Lucida Console'>)</font>;
            <font color='#009900'>/* longest_match() sets match_start */</font>
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>check_match</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>_tr_tally_dist</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start,
                           s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>-</font> MIN_MATCH, bflush<font face='Lucida Console'>)</font>;

            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>-</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length;

            <font color='#009900'>/* Insert new strings in the hash table only if the match length
             * is not too large. This saves time but degrades compression.
             */</font>
<font color='#0000FF'>#ifndef</font> FASTEST
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_insert_length <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length<font color='#5555FF'>-</font><font color='#5555FF'>-</font>; <font color='#009900'>/* string at strstart already in table */</font>
                <font color='#0000FF'>do</font> <b>{</b>
                    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
                    <font color='#BB00BB'>INSERT_STRING</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, hash_head<font face='Lucida Console'>)</font>;
                    <font color='#009900'>/* strstart never exceeds WSIZE-MAX_MATCH, so there are
                     * always MIN_MATCH bytes ahead.
                     */</font>
                <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            <b>}</b> <font color='#0000FF'>else</font>
<font color='#0000FF'>#endif</font>
            <b>{</b>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart];
                <font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>ins_h, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
<font color='#0000FF'>#if</font> MIN_MATCH <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>3</font>
                Call <font color='#BB00BB'>UPDATE_HASH</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>3</font> more times
<font color='#0000FF'>#endif</font>
                <font color='#009900'>/* If lookahead &lt; MIN_MATCH, ins_h is garbage, but it does not
                 * matter since it will be recomputed at next deflate call.
                 */</font>
            <b>}</b>
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#009900'>/* No match, output a literal byte */</font>
            <font color='#BB00BB'>Tracevv</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>%c</font>", s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>_tr_tally_lit</font> <font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart], bflush<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bflush<font face='Lucida Console'>)</font> <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font> ? s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart : MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> finish_done;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_lit<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> block_done;
<b>}</b>

<font color='#0000FF'>#ifndef</font> FASTEST
<font color='#009900'>/* ===========================================================================
 * Same as above, but achieves better compression. We use a lazy
 * evaluation for matches: a match is finally adopted only if there is
 * no better match at the next window position.
 */</font>
local block_state <b><a name='deflate_slow'></a>deflate_slow</b><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> flush;
<b>{</b>
    IPos hash_head;          <font color='#009900'>/* head of hash chain */</font>
    <font color='#0000FF'><u>int</u></font> bflush;              <font color='#009900'>/* set if current block must be flushed */</font>

    <font color='#009900'>/* Process the input block. */</font>
    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>/* Make sure that we always have enough lookahead, except
         * at the end of the input file. We need MAX_MATCH bytes
         * for the next match, plus MIN_MATCH bytes to insert the
         * string following the next match.
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font> MIN_LOOKAHEAD<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font> MIN_LOOKAHEAD <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NO_FLUSH<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>return</font> need_more;
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>break</font>; <font color='#009900'>/* flush the current block */</font>
        <b>}</b>

        <font color='#009900'>/* Insert the string window[strstart .. strstart+2] in the
         * dictionary, and set hash_head to the head of the hash chain:
         */</font>
        hash_head <font color='#5555FF'>=</font> NIL;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>INSERT_STRING</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, hash_head<font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#009900'>/* Find the longest match, discarding those &lt;= prev_length.
         */</font>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_match <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>hash_head <font color='#5555FF'>!</font><font color='#5555FF'>=</font> NIL <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>&lt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>max_lazy_match <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> hash_head <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#BB00BB'>MAX_DIST</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* To simplify the code, we prevent matches with the string
             * of window index 0 (in particular we have to avoid a match
             * of the string with itself at the start of the input file).
             */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> <font color='#BB00BB'>longest_match</font> <font face='Lucida Console'>(</font>s, hash_head<font face='Lucida Console'>)</font>;
            <font color='#009900'>/* longest_match() sets match_start */</font>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>5</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strategy <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FILTERED
<font color='#0000FF'>#if</font> TOO_FAR <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>32767</font>
                <font color='#5555FF'>|</font><font color='#5555FF'>|</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font><font color='#5555FF'>=</font> MIN_MATCH <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_start <font color='#5555FF'>&gt;</font> TOO_FAR<font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>
                <font face='Lucida Console'>)</font><font face='Lucida Console'>)</font> <b>{</b>

                <font color='#009900'>/* If prev_match is also MIN_MATCH, match_start is garbage
                 * but we will ignore the current match anyway.
                 */</font>
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
            <b>}</b>
        <b>}</b>
        <font color='#009900'>/* If there was a match at the previous step and the current
         * match is not better, output the previous match:
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length<font face='Lucida Console'>)</font> <b>{</b>
            uInt max_insert <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>-</font> MIN_MATCH;
            <font color='#009900'>/* Do not insert strings in hash table beyond this. */</font>

            <font color='#BB00BB'>check_match</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>-</font><font color='#979000'>1</font>, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_match, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>_tr_tally_dist</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font><font color='#979000'>1</font> <font color='#5555FF'>-</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_match,
                           s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>-</font> MIN_MATCH, bflush<font face='Lucida Console'>)</font>;

            <font color='#009900'>/* Insert in hash table all strings up to the end of the match.
             * strstart-1 and strstart are already inserted. If there is not
             * enough lookahead, the last two strings are not inserted in
             * the hash table.
             */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>-</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length<font color='#5555FF'>-</font><font color='#979000'>1</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>-</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
            <font color='#0000FF'>do</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> max_insert<font face='Lucida Console'>)</font> <b>{</b>
                    <font color='#BB00BB'>INSERT_STRING</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, hash_head<font face='Lucida Console'>)</font>;
                <b>}</b>
            <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#5555FF'>-</font><font color='#5555FF'>-</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>prev_length <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bflush<font face='Lucida Console'>)</font> <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;

        <b>}</b> <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#009900'>/* If there was no match at the previous position, output a
             * single literal. If there was a match but the current match
             * is longer, truncate the previous match to a single literal.
             */</font>
            <font color='#BB00BB'>Tracevv</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>%c</font>", s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>-</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>_tr_tally_lit</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>-</font><font color='#979000'>1</font>], bflush<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bflush<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#BB00BB'>FLUSH_BLOCK_ONLY</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
            <b>}</b>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strm<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>avail_out <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>return</font> need_more;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#009900'>/* There is no previous match to compare with, wait for
             * the next step to decide.
             */</font>
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
        <b>}</b>
    <b>}</b>
    <font color='#BB00BB'>Assert</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>!</font><font color='#5555FF'>=</font> Z_NO_FLUSH, "<font color='#CC0000'>no flush?</font>"<font face='Lucida Console'>)</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>Tracevv</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>%c</font>", s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>-</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>_tr_tally_lit</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>-</font><font color='#979000'>1</font>], bflush<font face='Lucida Console'>)</font>;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_available <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&lt;</font> MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font> ? s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart : MIN_MATCH<font color='#5555FF'>-</font><font color='#979000'>1</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> finish_done;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_lit<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> block_done;
<b>}</b>
<font color='#0000FF'>#endif</font> <font color='#009900'>/* FASTEST */</font>

<font color='#009900'>/* ===========================================================================
 * For Z_RLE, simply look for runs of bytes, generate matches only of distance
 * one.  Do not maintain a hash table.  (It will be regenerated if this run of
 * deflate switches away from Z_RLE.)
 */</font>
local block_state <b><a name='deflate_rle'></a>deflate_rle</b><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> flush;
<b>{</b>
    <font color='#0000FF'><u>int</u></font> bflush;             <font color='#009900'>/* set if current block must be flushed */</font>
    uInt prev;              <font color='#009900'>/* byte at distance one to match */</font>
    Bytef <font color='#5555FF'>*</font>scan, <font color='#5555FF'>*</font>strend;   <font color='#009900'>/* scan goes up to strend for length of run */</font>

    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>/* Make sure that we always have enough lookahead, except
         * at the end of the input file. We need MAX_MATCH bytes
         * for the longest run, plus one for the unrolled loop.
         */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> MAX_MATCH<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> MAX_MATCH <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NO_FLUSH<font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>return</font> need_more;
            <b>}</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <font color='#0000FF'>break</font>; <font color='#009900'>/* flush the current block */</font>
        <b>}</b>

        <font color='#009900'>/* See how many times the previous byte repeats */</font>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
            scan <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
            prev <font color='#5555FF'>=</font> <font color='#5555FF'>*</font>scan;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan<font face='Lucida Console'>)</font> <b>{</b>
                strend <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window <font color='#5555FF'>+</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font> MAX_MATCH;
                <font color='#0000FF'>do</font> <b>{</b>
                <b>}</b> <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> prev <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#5555FF'>*</font><font color='#5555FF'>+</font><font color='#5555FF'>+</font>scan <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                         scan <font color='#5555FF'>&lt;</font> strend<font face='Lucida Console'>)</font>;
                s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> MAX_MATCH <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>int</u></font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>strend <font color='#5555FF'>-</font> scan<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>&gt;</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font face='Lucida Console'>)</font>
                    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead;
            <b>}</b>
            <font color='#BB00BB'>Assert</font><font face='Lucida Console'>(</font>scan <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window<font color='#5555FF'>+</font><font face='Lucida Console'>(</font>uInt<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window_size<font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>, "<font color='#CC0000'>wild scan</font>"<font face='Lucida Console'>)</font>;
        <b>}</b>

        <font color='#009900'>/* Emit match if have run of MIN_MATCH or longer, else emit literal */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> MIN_MATCH<font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>check_match</font><font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>-</font> <font color='#979000'>1</font>, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length<font face='Lucida Console'>)</font>;

            <font color='#BB00BB'>_tr_tally_dist</font><font face='Lucida Console'>(</font>s, <font color='#979000'>1</font>, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>-</font> MIN_MATCH, bflush<font face='Lucida Console'>)</font>;

            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>-</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart <font color='#5555FF'>+</font><font color='#5555FF'>=</font> s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <b>}</b> <font color='#0000FF'>else</font> <b>{</b>
            <font color='#009900'>/* No match, output a literal byte */</font>
            <font color='#BB00BB'>Tracevv</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>%c</font>", s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>_tr_tally_lit</font> <font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart], bflush<font face='Lucida Console'>)</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
            s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <b>}</b>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bflush<font face='Lucida Console'>)</font> <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> finish_done;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_lit<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> block_done;
<b>}</b>

<font color='#009900'>/* ===========================================================================
 * For Z_HUFFMAN_ONLY, do not look for matches.  Do not maintain a hash table.
 * (It will be regenerated if this run of deflate switches away from Huffman.)
 */</font>
local block_state <b><a name='deflate_huff'></a>deflate_huff</b><font face='Lucida Console'>(</font>s, flush<font face='Lucida Console'>)</font>
    deflate_state <font color='#5555FF'>*</font>s;
    <font color='#0000FF'><u>int</u></font> flush;
<b>{</b>
    <font color='#0000FF'><u>int</u></font> bflush;             <font color='#009900'>/* set if current block must be flushed */</font>

    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>;;<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#009900'>/* Make sure that we have a literal to write. */</font>
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
            <font color='#BB00BB'>fill_window</font><font face='Lucida Console'>(</font>s<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font> <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_NO_FLUSH<font face='Lucida Console'>)</font>
                    <font color='#0000FF'>return</font> need_more;
                <font color='#0000FF'>break</font>;      <font color='#009900'>/* flush the current block */</font>
            <b>}</b>
        <b>}</b>

        <font color='#009900'>/* Output a literal byte */</font>
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>match_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#BB00BB'>Tracevv</font><font face='Lucida Console'>(</font><font face='Lucida Console'>(</font>stderr,"<font color='#CC0000'>%c</font>", s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart]<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>_tr_tally_lit</font> <font face='Lucida Console'>(</font>s, s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>window[s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart], bflush<font face='Lucida Console'>)</font>;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>lookahead<font color='#5555FF'>-</font><font color='#5555FF'>-</font>;
        s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>strstart<font color='#5555FF'>+</font><font color='#5555FF'>+</font>;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>bflush<font face='Lucida Console'>)</font> <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <b>}</b>
    s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>insert <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>flush <font color='#5555FF'>=</font><font color='#5555FF'>=</font> Z_FINISH<font face='Lucida Console'>)</font> <b>{</b>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>1</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> finish_done;
    <b>}</b>
    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>s<font color='#5555FF'>-</font><font color='#5555FF'>&gt;</font>last_lit<font face='Lucida Console'>)</font>
        <font color='#BB00BB'>FLUSH_BLOCK</font><font face='Lucida Console'>(</font>s, <font color='#979000'>0</font><font face='Lucida Console'>)</font>;
    <font color='#0000FF'>return</font> block_done;
<b>}</b>

</pre></body></html>